/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var Oe=Object.defineProperty;var Ce=(i,e,t)=>e in i?Oe(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var Q=(i,e,t)=>(Ce(i,typeof e!="symbol"?e+"":e,t),t);import{Base as y,Delayable as B,Events as _e,Identifiable as Ie,EventHelper as M,DomDataStore as _,DomHelper as L,Objects as xe,Factoryable as Le,ObjectHelper as we,Tooltip as $e,StringHelper as Ue}from"./Editor.js";const X=()=>{throw new Error("Abstract method call!")};class D extends y{get type(){return this.constructor.name}undo(){X()}redo(){X()}}D._$name="ActionBase";const h=()=>{throw new Error("Abstract method call!")},c=()=>{throw new Error("Method cannot be called at this state!")};class T extends y{canUndo(e){h()}canRedo(e){h()}onUndo(e){h()}onRedo(e){h()}onStartTransaction(e){h()}onStopTransaction(e){h()}onStopTransactionDelayed(e){h()}onRejectTransaction(e){h()}onEnable(e){h()}onDisable(e){h()}onAutoRecordOn(e){h()}onAutoRecordOff(e){h()}onResetQueue(e){h()}onModelUpdate(e){h()}onStoreModelAdd(e){h()}onStoreModelInsert(e){h()}onStoreModelRemove(e){h()}onStoreModelRemoveAll(e){h()}onModelInsertChild(e){h()}onModelRemoveChild(e){h()}}T._$name="StateBase";const d=Symbol("STATE_PROP"),A=Symbol("STORES_PROP"),S=Symbol("QUEUE_PROP"),v=Symbol("POS_PROP"),g=Symbol("TRANSACTION_PROP"),p=Symbol("TRANSACTION_TIMER_PROP"),R=Symbol("AUTO_RECORD_PROP");Object.freeze([d,A,S,v,g,p,R]);const q=new Map,ke=(i,e)=>{q.set(i,e)},Ne=i=>(typeof i=="string"&&(i=q.get(i)),i);var b={registerStmState:ke,resolveStmState:Ne};const w=(i,e)=>{const{undo:t,redo:n}=e;let o;return t&&!n?o={[S]:i[S].slice(i.position),[v]:0}:n&&!t?o={[S]:i[S].slice(0,i.position)}:o={[S]:[],[v]:0},[o,()=>{i.notifyStoresAboutQueueReset(e)}]};class ze extends T{canUndo(){return!1}canRedo(){return!1}onUndo(){c()}onRedo(){c()}onEnable(e){return e.autoRecord?"autoreadystate":"readystate"}onDisable(){c()}onAutoRecordOn(){return{[R]:!0}}onAutoRecordOff(){return{[R]:!1}}onStartTransaction(){c()}onStopTransaction(){c()}onStopTransactionDelayed(){c()}onRejectTransaction(){c()}onResetQueue(e,t){return w(e,t)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}}const H=new ze;b.registerStmState("disabledstate",H);const P=Symbol("ACTION_QUEUE_PROP");class $ extends y{get defaultConfig(){return{title:null}}construct(...e){this[P]=[],super.construct(...e)}get queue(){return this[P].slice(0)}get length(){return this[P].length}addAction(e){this[P].push(e)}undo(){const e=this[P];for(let t=e.length-1;t>=0;--t)e[t].undo()}redo(){const e=this[P];for(let t=0,n=e.length;t<n;++t)e[t].redo()}}$._$name="Transaction";class W extends T{canUndo(e){return 0<e.position&&e.position<=e.length}canRedo(e){return 0<=e.position&&e.position<e.length}onUndo(e,t){let n=e.position;const o=e[S],r=Math.max(0,n-t),s=()=>{e.notifyStoresAboutStateRestoringStart();const a=[];for(;n!==r;){const l=o[--n];l.undo(),a.push(l)}return[e.autoRecord?"autoreadystate":"readystate",()=>{e.notifyStoresAboutStateRestoringStop({cause:"undo",transactions:a})}]};return[{[d]:"restoringstate",[v]:r},s]}onRedo(e,t){let n=e.position;const o=e[S],r=Math.min(o.length,n+t),s=()=>{e.notifyStoresAboutStateRestoringStart();const a=[];do{const l=o[n++];l.redo(),a.push(l)}while(n!==r);return[e.autoRecord?"autoreadystate":"readystate",()=>{e.notifyStoresAboutStateRestoringStop({cause:"redo",transactions:a})}]};return[{[d]:"restoringstate",[v]:r},s]}onEnable(){c()}onDisable(){return"disabledstate"}onAutoRecordOn(){return{[d]:"autoreadystate",[R]:!0}}onAutoRecordOff(){c()}onStartTransaction(e,t){const n=new $({title:t});return[{[d]:"recordingstate",[g]:n},()=>{e.notifyStoresAboutStateRecordingStart(n)}]}onStopTransaction(){c()}onStopTransactionDelayed(){c()}onRejectTransaction(){c()}onResetQueue(e,t){return w(e,t)}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}}const I=new W;b.registerStmState("readystate",I);class G extends T{canUndo(){return!1}canRedo(){return!1}onEnable(){}onDisable(e){const t=e[g];return e.notifyStoresAboutStateRecordingStop(t,{disabled:!0}),{[d]:"disabledstate",[g]:null}}onAutoRecordOn(e){return[{[d]:"autorecordingstate",[R]:!0},()=>{e.stopTransactionDelayed()}]}onAutoRecordOff(){c()}onStartTransaction(){c()}onStopTransaction(e,t){const n=e[g],o=e[S];let r=e[v];return n.length&&(!n.title&&!t&&e.getTransactionTitle?n.title=e.getTransactionTitle(n):t&&(n.title=t),o[r]=n,o.length=++r),[{[d]:"readystate",[v]:r,[g]:null},()=>{e.notifyStoresAboutStateRecordingStop(n,{stop:!0})}]}onRejectTransaction(e){const t=e[g];return[{[d]:"restoringstate",[g]:null},()=>(t.length&&t.undo(),["readystate",()=>{e.notifyStoresAboutStateRecordingStop(t,{rejected:!0})}])]}onStopTransactionDelayed(){c()}onResetQueue(e,t){return w(e,t)}onModelUpdate(e,t,n,o,r){e[g].addAction(e.makeModelUpdateAction(t,n,o,r))}onModelInsertChild(e,t,n,o,r,s){e[g].addAction(e.makeModelInsertChildAction(t,n,o,r,s))}onModelRemoveChild(e,t,n,o){e[g].addAction(e.makeModelRemoveChildAction(t,n,o))}onStoreModelAdd(e,t,n,o){e[g].addAction(e.makeStoreModelAddAction(t,n,o))}onStoreModelInsert(e,t,n,o,r,s){e[g].addAction(e.makeStoreModelInsertAction(t,n,o,r,s))}onStoreModelRemove(e,t,n,o,r){e[g].addAction(e.makeStoreModelRemoveAction(t,n,o,r))}onStoreRemoveAll(e,t,n,o){e[g].addAction(e.makeStoreRemoveAllAction(t,n,o))}}const Y=new G;b.registerStmState("recordingstate",Y);class Ke extends T{static get $name(){return"RestoringStateClass"}canUndo(){return!1}canRedo(){return!1}onUndo(){c()}onRedo(){c()}onEnable(){c()}onDisable(){c()}onAutoRecordOn(){return{[R]:!0}}onAutoRecordOff(){return{[R]:!1}}onStartTransaction(){c()}onStopTransaction(){c()}onStopTransactionDelayed(){c()}onRejectTransaction(){c()}onQueueReset(){c()}onModelUpdate(){}onModelInsertChild(){}onModelRemoveChild(){}onStoreModelAdd(){}onStoreModelInsert(){}onStoreModelRemove(){}onStoreRemoveAll(){}}const J=new Ke;b.registerStmState("restoringstate",J);class je extends W{onAutoRecordOn(){c()}onAutoRecordOff(){return{[d]:"readystate",[R]:!1}}onStartTransaction(e,t){const n=new $({title:t});return[{[d]:"autorecordingstate",[g]:n},()=>{e.notifyStoresAboutStateRecordingStart(n),e.stopTransactionDelayed()}]}onModelUpdate(e,t,n,o){e.startTransaction(),e.onModelUpdate(t,n,o)}onModelInsertChild(e,t,n,o,r){e.startTransaction(),e.onModelInsertChild(t,n,o,r)}onModelRemoveChild(e,t,n,o){e.startTransaction(),e.onModelRemoveChild(t,n,o)}onStoreModelAdd(e,t,n,o){e.startTransaction(),e.onStoreModelAdd(t,n,o)}onStoreModelInsert(e,t,n,o,r,s){e.startTransaction(),e.onStoreModelInsert(t,n,o,r,s)}onStoreModelRemove(e,t,n,o,r){e.startTransaction(),e.onStoreModelRemove(t,n,o,r)}onStoreRemoveAll(e,t,n,o){e.startTransaction(),e.onStoreRemoveAll(t,n,o)}}const U=new je;b.registerStmState("autoreadystate",U);class Fe extends G.mixin(B){onDisable(e){const t=e[g],n=e[p];return n&&this.clearTimeout(n),e.notifyStoresAboutStateRecordingStop(t,{disabled:!0}),{[d]:"disabledstate",[g]:null,[p]:null}}onAutoRecordOn(e){c()}onAutoRecordOff(e){const t=e[p];return t&&this.clearTimeout(t),{[d]:"recordingstate",[R]:!1,[p]:null}}onStopTransaction(e,t){const n=e[g],o=e[p],r=e[S];let s=e[v];return o&&this.clearTimeout(o),n.length&&(!n.title&&!t&&e.getTransactionTitle?n.title=e.getTransactionTitle(n):t&&(n.title=t),r[s]=n,r.length=++s),[{[d]:"autoreadystate",[v]:s,[g]:null,[p]:null},()=>{e.notifyStoresAboutStateRecordingStop(n,{stop:!0})}]}onStopTransactionDelayed(e){let t=e[p];return t&&this.clearTimeout(t),t=this.setTimeout(()=>{e.stopTransaction()},e.autoRecordTransactionStopTimeout),{[d]:N,[p]:t}}onResetQueue(e,t){return w(e,t)}onRejectTransaction(e){const t=e[g],n=e[p];return n&&this.clearTimeout(n),[{[d]:"restoringstate",[g]:null,[p]:null},()=>(t.length&&t.undo(),["autoreadystate",()=>{e.notifyStoresAboutStateRecordingStop(t,{rejected:!0})}])]}onModelUpdate(e,...t){super.onModelUpdate(e,...t),e.stopTransactionDelayed()}onModelInsertChild(e,...t){super.onModelInsertChild(e,...t),e.stopTransactionDelayed()}onModelRemoveChild(e,...t){super.onModelRemoveChild(e,...t),e.stopTransactionDelayed()}onStoreModelAdd(e,...t){super.onStoreModelAdd(e,...t),e.stopTransactionDelayed()}onStoreModelInsert(e,...t){super.onStoreModelInsert(e,...t),e.stopTransactionDelayed()}onStoreModelRemove(e,...t){super.onStoreModelRemove(e,...t),e.stopTransactionDelayed()}onStoreRemoveAll(e,...t){super.onStoreRemoveAll(e,...t),e.stopTransactionDelayed()}}const N=new Fe;b.registerStmState("autorecordingstate",N);const V=Symbol("MODEL_PROP"),Z=Symbol("NEW_DATA_PROP"),ee=Symbol("OLD_DATA_PROP");class z extends D{static get defaultConfig(){return{model:void 0,newData:void 0,oldData:void 0,isInitialUserAction:!1}}get type(){return"UpdateAction"}get model(){return this[V]}set model(e){this[V]=e}get newData(){return this[Z]}set newData(e){this[Z]={...e}}get oldData(){return this[ee]}set oldData(e){this[ee]={...e}}undo(){const{model:e,oldData:t}=this;e.$&&Object.assign(e,t),e.set(t,null,null,null,!!e.$)}redo(){const{model:e,newData:t}=this;e.$&&Object.assign(e,t),e.set(t,null,null,null,!!e.$)}}z._$name="UpdateAction";const te=Symbol("PARENT_MODEL_PROP"),ne=Symbol("CHILD_MODELS_PROP"),oe=Symbol("INSERT_INDEX_PROP"),re=Symbol("CONTEXT_PROP");class se extends D{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,insertIndex:void 0,context:void 0}}get type(){return"InsertChildAction"}get parentModel(){return this[te]}set parentModel(e){this[te]=e}get childModels(){return this[ne]}set childModels(e){this[ne]=e.slice(0)}get insertIndex(){return this[oe]}set insertIndex(e){this[oe]=e}get context(){return this[re]}set context(e){this[re]=e}undo(){const{parentModel:e,context:t,childModels:n}=this,o=new Map,r=new Set;for(const s of n){const a=t.get(s);if(!a)r.add(s);else{let l=o.get(a.parent);l||(l={moveRight:[],moveLeft:[],moveFromAnotherParent:[]},o.set(a.parent,l)),a.parent===e?a.index>s.parentIndex?l.moveRight.push({parent:a.parent,model:s,index:a.index+1}):l.moveLeft.push({parent:a.parent,model:s,index:a.index}):l.moveFromAnotherParent.push({parent:a.parent,model:s,index:a.index})}}for(const s of o.values()){const{moveRight:a,moveLeft:l}=s;l.sort((f,u)=>f.index-u.index),a.sort((f,u)=>u.index-f.index)}r.forEach(s=>s.parent.removeChild(s));for(const s of o.values()){const{moveRight:a,moveLeft:l,moveFromAnotherParent:f}=s;l.forEach(u=>{u.parent.insertChild(u.model,u.index)}),a.forEach(u=>{u.parent.insertChild(u.model,u.index)}),f.forEach(u=>{u.parent.insertChild(u.model,u.index)})}}redo(){const{parentModel:e,insertIndex:t,childModels:n}=this;e.insertChild(n,t)}}se._$name="InsertChildAction";const ie=Symbol("PARENT_MODEL_PROP"),ae=Symbol("CHILD_MODELS_PROP"),le=Symbol("CONTEXT_PROP");class de extends D{static get defaultConfig(){return{parentModel:void 0,childModels:void 0,context:void 0}}get type(){return"RemoveChildAction"}get parentModel(){return this[ie]}set parentModel(e){this[ie]=e}get childModels(){return this[ae]}set childModels(e){this[ae]=e.slice(0)}get context(){return this[le]}set context(e){this[le]=e}undo(){const{parentModel:e,context:t,childModels:n}=this;n.sort((o,r)=>{const s=t.get(o),a=t.get(r);return s-a}),n.forEach(o=>{e.insertChild(o,t.get(o))})}redo(){this.parentModel.removeChild(this.childModels)}}de._$name="RemoveChildAction";const ce=Symbol("STORE_PROP"),ue=Symbol("MODEL_LIST_PROP");class ge extends D{static get defaultConfig(){return{store:void 0,modelList:void 0,silent:!1}}get type(){return"AddAction"}get store(){return this[ce]}set store(e){this[ce]=e}get modelList(){return this[ue]}set modelList(e){this[ue]=e.slice(0)}undo(){this.store.remove(this.modelList,this.silent)}redo(){this.store.add(this.modelList,this.silent)}}ge._$name="AddAction";const he=Symbol("STORE_PROP"),fe=Symbol("MODEL_LIST_PROP"),me=Symbol("INSERT_INDEX_PROP"),Se=Symbol("CONTEXT_PROP");class pe extends D{static get defaultConfig(){return{store:void 0,modelList:void 0,insertIndex:void 0,context:void 0,silent:!1}}get type(){return"InsertAction"}get store(){return this[he]}set store(e){this[he]=e}get modelList(){return this[fe]}set modelList(e){this[fe]=e.slice(0)}get insertIndex(){return this[me]}set insertIndex(e){this[me]=e}get context(){return this[Se]}set context(e){this[Se]=e}undo(){const{store:e,modelList:t,context:n,silent:o}=this;t.sort((r,s)=>{const a=n.get(r),l=n.get(s);return a!==void 0&&l!==void 0?a-l:0}),t.forEach(r=>{const s=n.get(r);r._undoingInsertion=!0,s!==void 0?e.insert(s,r,o):e.remove(r,o),r._undoingInsertion=!1})}redo(){const e=this;e.store.insert(e.insertIndex,e.modelList,e.silent)}}pe._$name="InsertAction";const ve=Symbol("STORE_PROP"),Re=Symbol("MODEL_LIST_PROP"),ye=Symbol("CONTEXT_PROP");class be extends D{static get defaultConfig(){return{store:void 0,modelList:void 0,context:void 0,silent:!1}}get type(){return"RemoveAction"}get store(){return this[ve]}set store(e){this[ve]=e}get modelList(){return this[Re]}set modelList(e){this[Re]=e.slice(0)}get context(){return this[ye]}set context(e){this[ye]=e}undo(){const{store:e,context:t,modelList:n,silent:o}=this;n.sort((r,s)=>{const a=t.get(r),l=t.get(s);return a-l}),n.forEach(r=>{const s=t.get(r);e.insert(s,r,o)})}redo(){this.store.remove(this.modelList,this.silent)}}be._$name="RemoveAction";const De=Symbol("STORE_PROP"),Te=Symbol("ALL_RECORDS_PROP");class Ae extends D{static get defaultConfig(){return{store:void 0,allRecords:void 0,silent:!1}}get type(){return"RemoveAllAction"}get store(){return this[De]}set store(e){this[De]=e}get allRecords(){return this[Te]}set allRecords(e){this[Te]=e.slice(0)}undo(){const{store:e,allRecords:t,silent:n}=this;e.add(t,n)}redo(){this.store.removeAll(this.silent)}}Ae._$name="RemoveAllAction";const Qe=(i,e,t,n)=>new z({model:i,newData:e,oldData:t,isInitialUserAction:n}),Be=(i,e,t,n)=>new se({parentModel:i,childModels:t,insertIndex:e,context:n}),Xe=(i,e,t)=>new de({parentModel:i,childModels:e,context:t}),qe=(i,e,t)=>new ge({store:i,modelList:e,silent:t}),He=(i,e,t,n,o)=>new pe({store:i,insertIndex:e,modelList:t,context:n,silent:o}),We=(i,e,t,n)=>new be({store:i,modelList:e,context:t,silent:n}),Ge=(i,e,t)=>new Ae({store:i,allRecords:e,silent:t}),m=(i,e,...t)=>{const n=i.state,o=e.call(i[d],i,...t);if(typeof o=="string")i[d]=b.resolveStmState(o);else if(o instanceof T)i[d]=o;else if(Array.isArray(o)){const[r,s]=o;typeof r=="string"?i[d]=b.resolveStmState(r):r instanceof T?i[d]=r:r&&typeof r=="object"&&(i=Object.assign(i,r),i[d]=b.resolveStmState(i[d])),typeof s=="function"&&m(i,s,...t)}else o&&typeof o=="object"&&(i=Object.assign(i,o),i[d]=b.resolveStmState(i[d]));n!==I&&n!==U&&o!==I&&o!==U&&i.trigger("ready")};class Ee extends _e(y){static get defaultConfig(){return{disabled:!0,autoRecord:!1,autoRecordTransactionStopTimeout:100,makeModelUpdateAction:Qe,makeModelInsertChildAction:Be,makeModelRemoveChildAction:Xe,makeStoreModelAddAction:qe,makeStoreModelInsertAction:He,makeStoreModelRemoveAction:We,makeStoreRemoveAllAction:Ge,getTransactionTitle:null}}construct(...e){Object.assign(this,{[d]:I,[A]:[],[S]:[],[v]:0,[g]:null,[p]:null,[R]:!1}),super.construct(...e)}get state(){return this[d]}get position(){return this[v]}get length(){return this[S].length}get stores(){return Array.from(this[A])}hasStore(e){return this[A].includes(e)}addStore(e){this.hasStore(e)||(this[A].push(e),e.stm=this)}removeStore(e){this.hasStore(e)&&(this[A]=this[A].filter(t=>t!==e),e.stm=null)}forEachStore(e){this[A].forEach(t=>e(t,t.id))}get disabled(){return this.state===H}set disabled(e){const t=this;t.disabled!==e&&(e?m(t,t.state.onDisable,t):m(t,t.state.onEnable,t),t.trigger("stmDisabled",{disabled:e}),t.trigger("disabled",{disabled:e}))}get enabled(){return!this.disabled}enable(){this.disabled=!1}disable(){this.disabled=!0}get isReady(){return this.state===I||this.state===U}waitForReadiness(){return this.await("ready",!1)}get isRecording(){return this.state===Y||this.state===N}get autoRecord(){return this[R]}set autoRecord(e){const t=this;t.autoRecord!=e&&(e?m(t,t.state.onAutoRecordOn,t):m(t,t.state.onAutoRecordOff,t))}startTransaction(e=null){m(this,this.state.onStartTransaction,e)}stopTransaction(e=null){m(this,this.state.onStopTransaction,e)}stopTransactionDelayed(){m(this,this.state.onStopTransactionDelayed)}rejectTransaction(){m(this,this.state.onRejectTransaction)}get transaction(){return this[g]}get queue(){return this[S].map(e=>e.title)}get rawQueue(){return this[S]}get isRestoring(){return this.state===J}get canUndo(){return this.state.canUndo(this)}get canRedo(){return this.state.canRedo(this)}async undo(e=1){this.isReady||await this.waitForReadiness(),m(this,this.state.onUndo,e)}async undoAll(){this.isReady||await this.waitForReadiness(),this.undo(this.length)}async redo(e=1){this.isReady||await this.waitForReadiness(),m(this,this.state.onRedo,e)}async redoAll(){this.isReady||await this.waitForReadiness(),this.redo(this.length)}resetQueue(e={undo:!0,redo:!0}){m(this,this.state.onResetQueue,e)}resetUndoQueue(){this.resetQueue({undo:!0})}resetRedoQueue(){this.resetQueue({redo:!0})}notifyStoresAboutStateRecordingStart(e){this.forEachStore(t=>{var n;return(n=t.onStmRecordingStart)===null||n===void 0?void 0:n.call(t,this,e)}),this.trigger("recordingStart",{stm:this,transaction:e})}notifyStoresAboutStateRecordingStop(e,t){this.forEachStore(n=>{var o;return(o=n.onStmRecordingStop)===null||o===void 0?void 0:o.call(n,this,e,t)}),this.trigger("recordingStop",{stm:this,transaction:e,reason:t})}notifyStoresAboutStateRestoringStart(){this.forEachStore(e=>{var t;return(t=e.onStmRestoringStart)===null||t===void 0?void 0:t.call(e,this)}),this.trigger("restoringStart",{stm:this})}notifyStoresAboutStateRestoringStop({cause:e,transactions:t}){this.forEachStore(n=>{var o;return(o=n.onStmRestoringStop)===null||o===void 0?void 0:o.call(n,this)}),this.trigger("restoringStop",{stm:this,cause:e,transactions:t})}notifyStoresAboutQueueReset(e){this.forEachStore(t=>{var n;return(n=t.onStmQueueReset)===null||n===void 0?void 0:n.call(t,this,e)}),this.trigger("queueReset",{stm:this,options:e})}onModelUpdate(e,t,n,o){m(this,this.state.onModelUpdate,e,t,n,o)}onModelInsertChild(e,t,n,o){m(this,this.state.onModelInsertChild,e,t,n,o)}onModelRemoveChild(e,t,n){m(this,this.state.onModelRemoveChild,e,t,n)}onStoreModelAdd(e,t,n){m(this,this.state.onStoreModelAdd,e,t,n)}onStoreModelInsert(e,t,n,o,r){m(this,this.state.onStoreModelInsert,e,t,n,o,r)}onStoreModelRemove(e,t,n,o){m(this,this.state.onStoreModelRemove,e,t,n,o)}onStoreRemoveAll(e,t,n){m(this,this.state.onStoreRemoveAll,e,t,n)}onUndoKeyPress(e){const t=this;t.enabled&&(e.shiftKey?t.canRedo&&(e.preventDefault(),t.redo()):t.canUndo&&(e.preventDefault(),t.undo()))}stash(){this.transaction&&(this.stashedTransaction=this.transaction,this.rejectTransaction())}applyStash(){this.stashedTransaction&&(this.startTransaction(this.stashedTransaction.title),this.stashedTransaction.redo(),delete this.stashedTransaction)}}Ee._$name="StateTrackingManager";var Me=i=>class extends(i||y){static get $name(){return"Finalizable"}construct(...t){super.construct(...t),this.finalizer=null,this.finalizing=null,this.isFinalized=!1,this.isFinalizing=!1}doFinalize(){this.destroy()}finalize(){const t=this;let n=t.finalizing;return!n&&!t.isFinalized&&(t.isFinalizing=!0,t.finalizing=n=t._awaitFinalizer()),n}async _awaitFinalizer(){const t=this;try{await t.finalizer}finally{t.finalizing=null,t.isFinalized=!0,t.doFinalize()}}};const K=Symbol("dragAbort"),k=Symbol("dragInit"),Pe=Symbol("dragDrag"),j=Symbol("dragDrop"),Ye={x:"horizontal",y:"vertical"};class O extends y.mixin(Me,B,Ie){static get configurable(){return{itemElement:null,scrollManager:null,monitoringConfig:null,source:null,target:null,targetElement:null,threshold:5,touchStartDelay:300}}static get identifiable(){return{}}construct(...e){super.construct(...e);const t=this,{event:n}=t;Object.assign(t,{altKey:null,cleaners:[],ctrlKey:null,data:new Map,element:n.target,endEvent:null,lastMoveEvent:null,metaKey:null,previousTarget:null,scrollerAction:null,shiftKey:null,state:k,startEvent:n,touchStartTimer:null,_valid:!0}),"touches"in n&&t.touchStartDelay&&(t.touchStartTimer=t.setTimeout(()=>t.touchStartTimer=null,t.touchStartDelay,"touchStartDelay")),M.on({element:globalThis,blur:"onWindowBlur",thisObj:t})}doDestroy(){const e=this,{source:t,target:n}=e;e.cleanup(),(n==null?void 0:n.dropping)===e&&(n.dropping=null),(t==null?void 0:t.dragging)===e&&(t.dragging=null),super.doDestroy()}onWindowBlur(){this.started&&this.abort()}get aborted(){return this.state===K}get completed(){return this.isDestroying||this.aborted||this.endEvent!==null}get pending(){return this.state===k}get started(){return this.state!==k&&!this.aborted}get valid(){return this.started&&this.targetElement!=null&&this._valid}set valid(e){this._valid=e}async get(e){if(this.aborted)throw new Error("Data is not available on aborted drag");if(!this.completed)throw new Error("Data is not available until drag completion");if(Array.isArray(e))return Promise.all(e.map(n=>this.get(n)));let t=this.data.get(e);return typeof t=="function"&&(t=await t(),this.data.set(e,t)),t}has(e){return this.data.has(e)}peek(e){if(this.aborted)throw new Error("Data is not available on aborted drag");if(Array.isArray(e))return e.map(n=>this.peek(n));let t=this.data.get(e);return typeof t=="function"&&(t=!0),t}set(e,t){this.data.set(e,t)}changeTarget(e,t){if(e!==t){const n=this;n._target=e,n.previousTarget=t,t&&(t.dropping=null),e&&(e.dropping=n,e.dropping!==n&&(e=null,n.valid=!1)),n._target=t}return e}updateTarget(e,t){const n=this;t&&n.source.dragLeaveTarget(n,t),e&&(n.valid=!0,e.dragMove(n),n.source.dragEnterTarget(n))}updateTargetElement(e){let t,n,o,r,s;for(s=e;s;s=s.parentElement)if(n=_.get(s,"droppables"),n){for(r=0;r<n.length;++r)if(t=n[r],t.dropRootElement.contains(e)&&(o=t.droppableSelector,(!o||e.closest(`#${L.getId(t.dropRootElement)} ${o}`))&&(this.target=t,this.target===t)))return}}abort(){const e=this,{element:t,source:n}=e;t==null||t.getBoundingClientRect(),e.state!==j&&(e.state=K,e.cleanup()),n==null||n.endDrag(e)}begin(){const e=this,{source:t}=e,n=t.beforeDrag(e);return n!==!1&&(t.dragging=e),n}cleanup(){let e;for(;e=this.cleaners.pop();)e()}end(e){const t=this,{lastMoveEvent:n,target:o}=t,{dragSwallowClickTime:r}=t.source;t.event=t.endEvent=e,t.syncFlags(),t.started&&(((n==null?void 0:n.clientX)!==e.clientX||(n==null?void 0:n.clientY)!==e.clientY||(n==null?void 0:n.target)!==e.target)&&t.track(),r&&M.on({element:document,capture:!0,expires:r,once:!0,click(s){s.stopPropagation()}}),t.state=j,o!==t.source&&(o==null||o.dragDrop(t)))}fakeKey(e,t){const n=this,{lastMoveEvent:o}=n;if(o&&n.element){let r;o.isKey=!0,e.key==="Alt"?n.altKey!==t&&(n.altKey=t,r=!0):e.key==="Control"&&n.ctrlKey!==t&&(n.ctrlKey=t,r=!0),r&&(n.event=o,n.track())}}keyDown(e){this.completed||(e.key==="Escape"?this.abort():this.isDragToggleKey(e.key)&&this.fakeKey(e,!0))}keyUp(e){!this.completed&&this.isDragToggleKey(e.key)&&this.fakeKey(e,!1)}getDistance(e){return M.getDistanceBetween(this.startEvent,e)}isDragToggleKey(e){return e==="Control"||e==="Alt"}move(e){const t=this,{target:n}=e,o=t.getDistance(e),r=o>=t.threshold;if(t.syncFlags(),t.touchStartTimer){r&&t.abort();return}if(n&&n.nodeType===Node.ELEMENT_NODE){if(r&&!t.started&&(t.event=e,t.start()===!1)){t.abort();return}t.started&&!t.completed&&(t.lastMoveEvent=t.event=e,e.type==="touchmove"&&(e.preventDefault(),e.stopImmediatePropagation()),t.track())}}start(){const e=this,{scrollManager:t,monitoringConfig:n,source:o}=e,{draggingBodyCls:r,dragLock:s}=o,a=o.dragRootElement;if(e.state=Pe,t){const f=t.startMonitoring(xe.merge({scrollables:[{element:a}],direction:Ye[s]||s||"both",callback(u){const{lastMoveEvent:E}=e;E&&e.element&&(E.isScroll=!0,e.event=E,e.scrollerAction=u,e.track(),e.scrollerAction=null)}},n));e.cleaners.push(f)}const l=o.dragRootElement.closest(".b-outer")||document.body;if(l.classList.add(r),e.cleaners.push(()=>l.classList.remove(r)),o.startDrag(e)===!1)return e.cleanup(),!1}syncFlags(){const e=this,{event:t}=e;e.altKey=t.altKey,e.ctrlKey=t.ctrlKey||t.metaKey,e.metaKey=t.metaKey,e.shiftKey=t.shiftKey}track(){const e=this,{event:t,source:n,target:o}=e;let r=t.target,s;t.type==="touchmove"&&(s=t.changedTouches[0],r=L.elementFromPoint(s.clientX,s.clientY)),e.targetElement=r,o===e.target&&(o==null||o.dragMove(e)),n.trackDrag(e)}}Q(O,"$name","DragContext"),O.prototype.STATE=O.STATE=Object.freeze({ABORTED:K,INIT:k,DRAGGING:Pe,DROPPED:j}),O._$name="DragContext";class C extends y.mixin(Le){static get type(){return"default"}static get configurable(){return{dragging:null}}static get factoryable(){return{defaultType:C}}updateDragging(e,t){t&&this.close(t),e&&this.open(e)}close(e){}open(e){}dragStart(e){this.dragging=e}dragMove(e){}dragEnd(e){this.dragging=null}}C.initClass(),C._$name="DragProxy";var Je=i=>class extends(i||y){static get $name(){return"Draggable"}static get configurable(){return{dragging:{$config:"nullify",value:null},draggingClsSelector:null,dragDocumentListeners:{element:document,keydown:"onDragKeyDown",keyup:"onDragKeyUp",contextmenu:"onDragContextMenu",mousemove:"onDragPointerMove",mouseup:"onDragPointerUp",pointerup:"onDragPointerUp",touchend:"onDragPointerUp",touchmove:{handler:"onDragPointerMove",passive:!1}},dragItemSelector:null,dragItemOverCls:null,dragLock:null,dragMinDistance:1,dragProxy:{$config:["lazy","nullify"],value:null},dragRootElement:{$config:"nullify",value:null},dragSameTargetDrop:!1,dragSelector:null,ignoreSelector:null,dragSwallowClickTime:50,dragThreshold:5,dragTouchStartDelay:300,dropTargetSelector:null,overItem:null,testConfig:{dragSwallowClickTime:50}}}static get properties(){return{draggingCls:"b-draggable-active",draggingBodyCls:"b-draghelper-active",draggingItemCls:"b-dragging-item",draggingStartedCls:"b-draggable-started",draggableCls:"b-draggable"}}beforeDrag(t){const{dragRootElement:n,dragSelector:o,ignoreSelector:r}=this,s=o&&t.element.closest(o);return!o||!!(s&&s===n||n.contains(s)&&(!r||!t.element.matches(r)))}dragStart(t){}dragOver(t){}dragEnterTarget(t){}dragLeaveTarget(t,n){}dragDrop(t){}dragEnd(t){}get activeDrag(){const{dragging:t}=this;return t!=null&&t.started&&!t.completed?t:null}get dragEventer(){return this.trigger?this:null}get draggingClassElement(){const{draggingClsSelector:t,dragRootElement:n}=this;return t?n==null?void 0:n.closest(t):n}beginDrag(t){const{draggingCls:n,draggingClassElement:o}=this;n&&o&&(o.classList.add(n),t.cleaners.push(()=>o.classList.remove(n)))}async endDrag(t){const n=this,{dragEventer:o,dragProxy:r}=n;t.valid&&await n.dragDrop(t),!n.isDestroyed&&(t.pending?t.destroy():(n.dragEnd(t),r==null||r.dragEnd(t),o==null||o.trigger(t.valid?"drop":"dragCancel",{drag:t,event:t.event}),n.finalizeDrag(t)))}async finalizeDrag(t){var n;await((n=t.finalize)===null||n===void 0?void 0:n.call(t))}moveDrag(t){if(this.dragOver(t)!==!1){const{dragEventer:n,dragProxy:o}=this;o==null||o.dragMove(t),n==null||n.trigger("drag",{drag:t,event:t.event})}}setupDragContext(t){const n=this,{dragItemSelector:o,id:r}=n,{target:s}=t;return{event:t,id:r?`${r}-drag-${n._nextDragId=(n._nextDragId||0)+1}`:null,itemElement:o?s.closest(o):s,touchStartDelay:n.dragTouchStartDelay,source:n,threshold:n.dragThreshold}}startDrag(t){const{draggingStartedCls:n,draggingClassElement:o,draggingItemCls:r,dragEventer:s,dragProxy:a}=this,{itemElement:l}=t;if((s==null?void 0:s.trigger("beforeDragStart",{drag:t,event:t.event}))===!1)return!1;n&&o&&(o.classList.add(n),t.cleaners.push(()=>o.classList.remove(n))),r&&l&&(l.classList.add(r),t.cleaners.push(()=>l.classList.remove(r))),a==null||a.dragStart(t);const f=this.dragStart(t);return f!==!1&&(s==null||s.trigger("dragStart",{drag:t,event:t.event})),f}trackDrag(t){var n;const{dropTargetSelector:o}=this;t.valid=!(o&&!((n=t.targetElement)!==null&&n!==void 0&&n.closest(o))),this.moveDrag(t)}configureListeners(t){const n=this,o=we.assign({thisObj:n},n.dragDocumentListeners);return"touches"in t.startEvent?(delete o.mousemove,delete o.mouseup):(delete o.contextmenu,delete o.touchmove,delete o.touchend,delete o.pointerup),o}updateDragging(t,n){const o=this;if(t){const r=o.configureListeners(t);t.cleaners.push(M.on(r)),o.beginDrag(t)}else n&&n.destroy()}changeDragProxy(t,n){return C.reconfigure(n,t,{owner:this,defaults:{owner:this}})}updateDragRootElement(t,n){var o;const r=this,{draggableCls:s,dragItemSelector:a,onDragItemMouseMove:l}=r;if(n==null||n.classList.remove(s),(o=r._dragRootDetacher)===null||o===void 0||o.call(r),t){const f={thisObj:r,element:t,mousedown:"onDragMouseDown",touchstart:"onDragTouchStart",pointerdown:u=>{var E,F;return u.pointerId&&((E=(F=u.target).releasePointerCapture)===null||E===void 0?void 0:E.call(F,u.pointerId))}};l&&(f.mousemove={delegate:a,handler:"onDragItemMouseMove"}),(r.dragItemOverCls||l||r.onDragItemMouseEnter||r.onDragItemMouseLeave)&&Object.assign(f,{mouseover:{delegate:a,handler:"onDragItemMouseOver"},mouseout:{delegate:a,handler:"onDragItemMouseOut"}}),t.classList.add(s),r._dragRootDetacher=M.on(f)}}onDragItemMouseOver(t){this.overItem=t}onDragItemMouseOut(t){this.dragging||(this.overItem=t)}changeOverItem(t){if(this.enterLeaveEvent=t,t.type==="mouseout"){var n;return((n=t.relatedTarget)===null||n===void 0?void 0:n.closest(this.dragItemSelector))||null}else return t.target.closest(this.dragItemSelector)}updateOverItem(t,n){const o=this,{dragItemOverCls:r}=o;if(n){var s;r&&n.classList.remove(r),(s=o.onDragItemMouseLeave)===null||s===void 0||s.call(o,o.enterLeaveEvent,n)}if(t){var a;r&&t.classList.add(r),(a=o.onDragItemMouseEnter)===null||a===void 0||a.call(o,o.enterLeaveEvent,t)}}onDragContextMenu(t){t.preventDefault()}onDragKeyDown(t){this.dragging.keyDown(t)}onDragKeyUp(t){this.dragging.keyUp(t)}onDragMouseDown(t){t.button===0&&this.onDragPointerDown(t)}onDragPointerDown(t){let{dragging:n}=this;n?n.isFinalizing||n.abort():(n=this.setupDragContext(t),n&&(n=new O(n),n.begin()===!1&&n.destroy()))}changeDragging(t,n){return n==null||n.destroy(),t}onDragPointerMove(t){const{dragging:n}=this;n&&!n.completed&&(n==null||n.move(t))}onDragPointerUp(t){const{dragging:n}=this;n&&!n.completed&&(n.end(t),this.endDrag(n))}onDragTouchStart(t){t.touches.length===1&&this.onDragPointerDown(t)}},Ve=i=>class extends(i||y){static get $name(){return"Droppable"}static get configurable(){return{droppableSelector:null,dropping:null,dropRootElement:{$config:"nullify",value:null}}}get dropEventer(){return this.trigger?this:null}get droppableCls(){return"b-droppable"}dragEnter(t){var n;return(n=this.dropEventer)===null||n===void 0?void 0:n.trigger("dragEnter",{drag:t,event:t.event})}dragMove(t){var n;return(n=this.dropEventer)===null||n===void 0?void 0:n.trigger("dragMove",{drag:t,event:t.event})}dragDrop(t){var n;return(n=this.dropEventer)===null||n===void 0?void 0:n.trigger("drop",{drag:t,event:t.event})}dragLeave(t){var n;return(n=this.dropEventer)===null||n===void 0?void 0:n.trigger("dragLeave",{drag:t,event:t.event})}changeDropping(t,n){if(t!==n){const o=this;n&&(n.aborted||!n.completed)&&o.dragLeave(n),t&&(o._dropping=t,o.dragEnter(t)===!1&&(t=null),o._dropping=n)}return t}updateDropRootElement(t,n){const o=this,{droppableCls:r}=o;let s,a,l;n&&(s=_.get(n,"droppables"),l=!0,Array.isArray(s)&&(a=s.indexOf(o))>-1&&(s.length<2?_.remove(n,"droppables"):(s.splice(a,1),s.forEach(f=>{r===f.droppableCls&&(l=!1)}))),l&&n.classList.remove(r)),t&&(s=_.get(t,"droppables"),s?s.push(o):_.set(t,"droppables",[o]),t.classList.add(r))}};class x extends y{static get $name(){return"AvatarRendering"}static get configurable(){return{element:null,colorPrefix:"b-sch-",tooltip:null,size:null}}doDestroy(){var e;(e=this.tooltip)===null||e===void 0||e.destroy(),super.doDestroy()}updateElement(e){M.on({element:e,delegate:".b-resource-image",error:"onImageErrorEvent",thisObj:this,capture:!0})}changeTooltip(e){return $e.new({forElement:this.element,forSelector:".b-resource-avatar",cls:"b-resource-avatar-tooltip"},e)}static get failedUrls(){return this._failedUrls||(this._failedUrls=new Set),this._failedUrls}getResourceAvatar({initials:e,color:t,iconCls:n,imageUrl:o,defaultImageUrl:r,dataset:s={},resourceRecord:a,alt:l=Ue.encodeHtml(a==null?void 0:a.name)}){const f=this.getImageConfig(e,t,o,r,s,l)||this.getIconConfig(n,s)||this.getResourceInitialsConfig(e,t,s),{size:u}=this;return Object.assign(f.style,{...u?{height:u,width:u}:void 0}),f}getImageConfig(e,t,n,o,r,s){if(n=x.failedUrls.has(n)?o:n||o,n)return{tag:"img",draggable:"false",loading:"lazy",class:{"b-resource-avatar":1,"b-resource-image":1},style:{},alt:s,elementData:{defaultImageUrl:o,imageUrl:n,initials:e,color:t,dataset:r},src:n,dataset:r}}getIconConfig(e,t){if(e)return e&&{tag:"i",style:{},class:{"b-resource-avatar":1,"b-resource-icon":1,[e]:1},dataset:t}}getResourceInitialsConfig(e,t,n){const o=L.isNamedColor(t)&&t,r=!o&&t,{size:s}=this;return{tag:"div",class:{"b-resource-avatar":1,"b-resource-initials":1,[`${this.colorPrefix}${o}`]:o},style:{backgroundColor:r||null,...s?{height:s,width:s}:void 0},children:[e],dataset:n}}onImageErrorEvent({target:e}){if(!e.matches(".b-resource-avatar"))return;const{defaultImageUrl:t,initials:n,color:o,imageUrl:r,dataset:s}=e.elementData;if(t&&!e.src.endsWith(t.replace(/^[./]*/gm,"")))e.src=t;else{const a=L.createElement(this.getResourceInitialsConfig(n,o,s));a.elementData=e.elementData,e.parentElement.replaceChild(a,e)}x.failedUrls.add(r)}}x._$name="AvatarRendering";export{D as ActionBase,x as AvatarRendering,O as DragContext,C as DragProxy,Je as Draggable,Ve as Droppable,Me as Finalizable,T as StateBase,Ee as StateTrackingManager,$ as Transaction,z as UpdateAction};
//# sourceMappingURL=AvatarRendering.js.map
