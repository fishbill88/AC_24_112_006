/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{InstancePlugin as C,ObjectHelper as f,DomHelper as S,Base as H,DateHelper as T}from"./Editor.js";import{GridFeatureManager as E}from"./GridBase.js";import{SummaryFormatter as R}from"./PdfExport.js";class h extends R(C){static get $name(){return"GroupSummary"}static get configurable(){return{collapseToHeader:null,target:"footer"}}construct(e,t){if(this.grid=e,super.construct(e,t),!e.features.group)throw new Error("Requires Group feature to work, please enable");this.bindStore(e.store),e.rowManager.ion({beforeRenderRow:"onBeforeRenderRow",renderCell:"renderCell",prio:1e3,thisObj:this})}bindStore(e){this.detachListeners("store"),e.ion({name:"store",update:"onStoreUpdate",prio:1,thisObj:this})}get store(){return this.grid.store}doDisable(e){this.updateTarget(this.target),super.doDisable(e)}changeTarget(e){return f.assertString(e,"target"),e}updateTarget(e){this.store.useGroupFooters=!this.disabled&&e==="footer",this.isConfiguring||this.store.group()}changeCollapseToHeader(e){return f.assertBoolean(e,"collapseToHeader"),e}updateCollapseToHeader(){this.isConfiguring||this.store.group()}static get pluginConfig(){return{chain:["bindStore"]}}onBeforeRenderRow({row:e,record:t}){e.isGroupFooter&&!("groupFooterFor"in t.meta)?(e.isGroupFooter=!1,e.forceInnerHTML=!0):e.isGroupHeader&&!t.meta.collapsed&&e.eachElement(this.removeSummaryElements)}removeSummaryElements(e){}renderCell({column:e,cellElement:t,row:r,record:o,size:i,isFirstColumn:s}){const l=this,{meta:n}=o,{rowHeight:a}=l.grid,u="groupRowFor"in n,p="groupFooterFor"in n,m=l.target==="header",c={"b-group-footer":0,"b-header-summary":0},F=u&&(m||l.collapseToHeader&&n.collapsed)&&!s||p&&!m;if((u||p)&&(i.height=u&&i.height||a),l.store.isGrouped&&F&&!l.disabled){e.clearCell(t);const G=u?o:n.groupRecord;r.isGroupFooter=p,r.isGroupHeader=u,p?c["b-group-footer"]=1:c["b-header-summary"]=1;const d=l.updateSummaryHtml(t,e,G),y=typeof d=="number"?d:d.count;y>1&&(i.height+=n.collapsed&&!m?0:y*a*.1),d.height&&(i.height+=d.height)}r.assignCls(c)}updateSummaryHtml(e,t,r){const o=r.groupChildren.slice();o[o.length-1].isGroupFooter&&o.pop();const i=this.generateHtml(t,o,"b-grid-group-summary",r,r.meta.groupField,r.meta.groupRowFor);return e.children.length?S.sync(i,e.firstElementChild):e.innerHTML=i,t.summaries?t.summaries.length:t.sum?1:0}onStoreUpdate({source:e,changes:t}){if(!this.disabled&&e.isGrouped){if(t&&e.groupers.find(o=>o.field in t))return;Object.keys(t).some(o=>{const i=this.grid.columns.get(o);return!!i&&(!!i.sum||!!i.summaries)})&&(this.grid.forceFullRefresh=!0)}}refresh(){this.grid.columns.visibleColumns.forEach(e=>{this.hasSummary(e)&&this.grid.refreshColumn(e)})}hasSummary(e){return e.sum||e.summaries}}h.featureClass="b-group-summary",h._$name="GroupSummary",E.registerFeature(h);class x extends H{static get defaultConfig(){return{target:null,defaultColumnWidth:100,exportDateAsInstance:!0,showGroupHeader:!0,columns:null,indent:!0,indentationSymbol:"\xA0\xA0\xA0\xA0"}}export(e={}){const t=this;return e=f.assign({},t.config,e),t.normalizeColumns(e),t.generateExportData(e)}generateExportData(e){const t=this,r=t.generateColumns(e);return{rows:t.generateRows(e),columns:r}}normalizeColumns(e){const t=e.columns||this.target.columns.visibleColumns.filter(r=>r.exportable!==!1);e.columns=t.map(r=>typeof r=="string"?this.target.columns.find(o=>o.field===r)||{field:r}:r)}generateColumns(e){return e.columns.map(t=>this.processColumn(t,e))}generateRows(e){const{columns:t,rows:r}=e;if(t.length===0||(r==null?void 0:r.length)===0)return[];const o=this,{target:i}=o;return(r||i.store).map(s=>o.processRecord(s,t,e)).filter(s=>s==null?void 0:s.length)}getColumnType(e,t=this.target.store){let r=e.exportedType||"object";if(e.exportedType===void 0&&e.field){const o=t.modelClass.getFieldDefinition(e.field);o&&o.type!=="auto"&&(r=o.type)}return r}processColumn(e,t){const r=this,{target:o}=r,{defaultColumnWidth:i}=t;let{field:s,text:l,width:n,minWidth:a}=e;if(s in o.store.modelClass.fieldMap||(s=""),!l||!n){const u=o.columns.find(p=>p.field===s);l||(l=u&&u.text||s),n==null&&(n=u&&u.width||i)}return n=Math.max(n||i,a||i),{field:s,value:l,width:n,type:r.getColumnType(e)}}processRecord(e,t,r){const{target:o}=this,{showGroupHeader:i,indent:s,indentationSymbol:l}=r;let n;return e?e.isSpecialRow?i&&e.meta.groupRowFor&&(n=t.map(a=>o.features.group.buildGroupHeader({cellElement:S.createElement(),grid:o,record:e,column:a}))):n=t.map(a=>{var u;let p=(u=a.field)!==null&&u!==void 0&&u.includes(".")?e.get(a.field):e[a.field];const m=a.renderer||a.defaultRenderer;return m&&!(p&&a.isDateColumn&&r.exportDateAsInstance)&&(p=m.call(a,{value:p,record:e,column:a,grid:o,isExport:!0})),s&&a.tree&&(p=`${l.repeat(e.childLevel)}${p}`),p}):n=t.map(()=>""),n}}x._$name="TableExporter";class w{constructor(e){this._value=e}get value(){return this._value}toString(){return this.value?"\u2713":""}}w._$name="BooleanUnicodeSymbol";class b extends C{static get $name(){return"ExcelExporter"}static get defaultConfig(){return{filename:null,dateFormat:"YYYY-MM-DD",exporterClass:x,exporterConfig:null,zipcelx:null,convertEmptyValueToEmptyString:!0}}processValue(e){return e==null||Number.isNaN(e)||typeof e=="function"||typeof e=="object"&&String(e)==="[object Object]"?"":e}generateExportData(e){const t=this,{rows:r,columns:o}=t.exporter.export(e.exporterConfig);return{rows:r.map(i=>i.map((s,l)=>{var n;s instanceof Date?s=T.format(s,e.dateFormat):typeof s=="boolean"&&(s=new w(s)),t.convertEmptyValueToEmptyString&&(s=t.processValue(s));const a=((n=o[l])===null||n===void 0?void 0:n.type)==="number"?"number":"string";return{value:s,type:a}})),columns:o.map(i=>{let{field:s,value:l,width:n,type:a}=i;return a="string",{field:s,value:l,width:n,type:a}})}}export(e={}){const t=this,r=t.zipcelx||globalThis.zipcelx;if(!r)throw new Error('ExcelExporter: "zipcelx" library is required');if(t.disabled)return;e=f.assign({},t.config,e),e.filename||(e.filename=t.client.$$name);const{filename:o}=e,{rows:i,columns:s}=t.generateExportData(e);return r({filename:o,sheet:{data:[s].concat(i),cols:s}})}construct(e,t){super.construct(e,t),this.zipcelx||typeof zipcelx!="undefined"&&(this.zipcelx=globalThis.zipcelx)}get exporter(){const e=this;return e._exporter||(e._exporter=e.exporterClass.new({target:e.client},e.exporterConfig))}}b._$name="ExcelExporter",E.registerFeature(b,!1,"Grid");export{b as ExcelExporter,h as GroupSummary,x as TableExporter};
//# sourceMappingURL=ExcelExporter.js.map
