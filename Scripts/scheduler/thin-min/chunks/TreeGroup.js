/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var E=Object.defineProperty;var L=(h,e,r)=>e in h?E(h,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):h[e]=r;var p=(h,e,r)=>(L(h,typeof e!="symbol"?e+"":e,r),r);import{GridFeatureManager as R}from"./GridBase.js";import{DragHelper as A}from"./MessageDialog.js";import{Delayable as B,InstancePlugin as C,Rectangle as I,DomHelper as m,ObjectHelper as D}from"./Editor.js";import{TreeColumn as M}from"./Tree.js";class u extends B(C){static get deprecatedEvents(){return{gridRowBeforeDragStart:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowBeforeDragStart` event is deprecated, listen on this event on the Grid instead."},gridRowDragStart:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDragStart` event is deprecated, listen on this event on the Grid instead."},gridRowDrag:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDrag` event is deprecated, listen on this event on the Grid instead."},gridRowBeforeDropFinalize:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowBeforeDropFinalize` event is deprecated, listen on this event on the Grid instead."},gridRowDrop:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowDrop` event is deprecated, listen on this event on the Grid instead."},gridRowAbort:{product:"Grid",invalidAsOfVersion:"6.0.0",message:"`gridRowAbort` event is deprecated, listen on this event on the Grid instead."}}}construct(e,r){this.grid=e,super.construct(...arguments)}doDestroy(){var e;(e=this.dragHelper)===null||e===void 0||e.destroy(),super.doDestroy()}init(){const e=this,{grid:r}=e;e.dragHelper=A.new({name:"rowReorder",cloneTarget:!0,dragThreshold:10,proxyTopOffset:10,targetSelector:".b-grid-row",lockX:!0,dragWithin:r.bodyContainer,allowDropOutside:!0,scrollManager:r.scrollManager,outerElement:e.targetSubGridElement,touchStartDelay:e.touchStartDelay,isElementDraggable:e.isElementDraggable.bind(e),monitoringConfig:{scrollables:[{element:r.scrollable.element,direction:"vertical"}]},setXY(t,o,i){const{context:a}=this;if(!a.started){const s=I.from(a.element,this.dragWithin),l=a.startPageY-globalThis.pageYOffset-a.element.getBoundingClientRect().top;i=s.top+l+this.proxyTopOffset}m.setTranslateXY(t,o,i)},ignoreSamePositionDrop:!1,createProxy(t){const o=t.cloneNode(!0),i=document.createElement("div");if(i.classList.add("b-row-reorder-proxy"),o.removeAttribute("id"),o.style.transform="",o.style.width="",i.appendChild(o),r.selectedRecords.length>1){const a=o.cloneNode(!0);a.classList.add("b-row-dragging-multiple"),i.appendChild(a)}return m.removeClsGlobally(i,"b-selected","b-hover","b-focused"),i},internalListeners:{beforedragstart:"onBeforeDragStart",dragstart:"onDragStart",drag:"onDrag",drop:"onDrop",reset:"onReset",prio:1e4,thisObj:e}},e.dragHelperConfig),e.relayEvents(e.dragHelper,["beforeDragStart","dragStart","drag","abort"],"gridRow"),r.relayEvents(e.dragHelper,["beforeDragStart","dragStart","drag","abort"],"gridRow"),e.dropIndicator=m.createElement({className:"b-row-drop-indicator"}),e.dropOverTargetCls=["b-row-reordering-target","b-hover"]}get targetSubGridElement(){const e=this.grid.regions[0];return this.grid.subGrids[e].element}isElementDraggable(e,r){if(!e.closest(".b-grid-cell .b-widget"))if(this.gripOnly){const t=e.closest(".b-grid-cell:first-child");if(t){const o=getComputedStyle(t,":before"),i=this.grid.rtl?t.getBoundingClientRect().width-r.borderOffsetX:r.borderOffsetX,a=m.roundPx(i)<=m.roundPx(parseFloat(o.width));return a&&(this.client.preventDragSelect=!0),a}}else return!0}onBeforeDragStart({event:e,source:r,context:t}){const o=this,{grid:i}=o,a=o.targetSubGridElement;if(o.disabled||i.readOnly||i.isTreeGrouped||!a.contains(t.element))return!1;const s=t.startRecord=i.getRecordFromElement(t.element);if(s.readOnly||s.isSpecialRow)return!1;t.originalRowTop=i.rowManager.getRowFor(s).top,i.selectionMode.checkboxOnly||(r.startEvent.pointerType==="touch"?i.isSelected(s)||i.selectRow({record:s,addToSelection:!1}):!i.isSelected(s)&&!e.shiftKey&&!e.ctrlKey&&i.selectRow({record:s}));const l=i.selectedRecords.filter(d=>!d.readOnly);return t.records=[s],l.includes(s)&&(t.records.push(...l.filter(d=>d!==s)),t.records.sort((d,n)=>i.store.indexOf(d)-i.store.indexOf(n))),!0}onDragStart({context:e}){var r,t;const o=this,{grid:i}=o,{cellEdit:a,cellMenu:s,headerMenu:l}=i.features;a&&(o.cellEditDisabledState=a.disabled,a.disabled=!0),s==null||(r=s.hideContextMenu)===null||r===void 0||r.call(s,!1),l==null||(t=l.hideContextMenu)===null||t===void 0||t.call(l,!1),i.element.classList.add("b-row-reordering");const d=e.element.querySelector(".b-focused");d==null||d.classList.remove("b-focused"),e.element.firstElementChild.classList.remove("b-selected","b-hover"),i.bodyContainer.appendChild(o.dropIndicator)}onDrag({context:e,event:r}){const t=this,{grid:o}=t,{store:i,rowManager:a}=o,{clientY:s}=r;let l=!0,d=a.getRowAt(s),n,c,g,f,w;if(d){const b=d.top+o.scrollable.element.getBoundingClientRect().top-o.scrollable.y,S=d.height/4,O=b+S,G=b+d.height/2,T=b+S*3;c=d.dataIndex,n=i.getAt(c),i.tree?f=(n.isParent||t.dropOnLeaf)&&s>O&&s<T:i.isGrouped&&(f=n.isGroupHeader&&n.meta.collapsed),g=!f&&r.clientY>=G}else r.pageY<o._bodyRectangle.y?(c=0,n=i.first,g=!1):(c=i.count-1,n=i.last,g=!0),d=o.rowManager.getRow(c);if(n===t.overRecord&&t.after===g&&t.over===f){e.valid=t.reorderValid;return}if(t.overRecord!==n){var y;(y=a.getRowById(t.overRecord))===null||y===void 0||y.removeCls(t.dropOverTargetCls)}t.overRecord=n,t.after=g,t.over=f,(n===e.startRecord||!g&&!f&&c===0&&i.isGrouped||g&&n.isGroupHeader&&n.meta.collapsed&&i.indexOf(n)===i.count-1)&&(l=!1),i.tree?(w=g?n.nextSibling:n,e.records.some(b=>b.contains(n))&&(l=!1),e.parent=l&&f?n:n.parent,t.clearTimeout(t.hoverTimer),n&&n.isParent&&!n.isExpanded(i)&&(t.hoverTimer=t.setTimeout(()=>o.expand(n),t.hoverExpandTimeout))):w=g?i.getAt(c+1):n,d.toggleCls(t.dropOverTargetCls,l&&f),!f&&c===i.indexOf(e.startRecord)+(g?-1:1)&&e.parent&&e.startRecord.parent===e.parent&&(l=!1),d&&m.setTranslateY(t.dropIndicator,Math.max(d.top+(g?d.element.getBoundingClientRect().height:0),1)),t.dropIndicator.style.visibility=f?"hidden":"visible",t.dropIndicator.classList.toggle("b-drag-invalid",!l),e.insertBefore=w,e.valid=t.reorderValid=l}async onDrop(e){const r=this,{client:t}=r,{context:o}=e;if(o.valid=o.valid&&r.reorderValid,o.valid){o.async=!0,t.store.tree&&(o.oldPositionContext=o.records.map(a=>{var s;return{record:a,parentId:(s=a.parent)===null||s===void 0?void 0:s.id,parentIndex:a.parentIndex}}));let i=await r.trigger("gridRowBeforeDropFinalize",e);i===!1&&(o.valid=!1),i=await t.trigger("gridRowBeforeDropFinalize",e),i===!1&&(o.valid=!1),await r.dragHelper.animateProxyTo(r.dropIndicator,{align:"l0-l0"}),await r.finalizeReorder(o)}r.clearTimeout(r.hoverTimer),r.overRecord=r.after=r.over=null,r.trigger("gridRowDrop",e),t.trigger("gridRowDrop",e)}async finalizeReorder(e){const r=this,{grid:t}=r,{store:o,focusedCell:i}=t;let{records:a}=e;if(e.valid=e.valid&&!a.some(d=>!o.includes(d)),e.valid){let d;if(o.tree){var s,l;a=a.filter(n=>!n.parent||n.bubbleWhile(c=>!a.includes(c),!0)),d=await e.parent.tryInsertChild(a,r.over?(s=e.parent.children)===null||s===void 0?void 0:s[0]:e.insertBefore),t.rowManager.forEach(n=>n.removeCls(r.dropOverTargetCls)),!e.parent.isExpanded()&&(l=e.parent.children)!==null&&l!==void 0&&l.length&&t.expand(e.parent),e.valid=d!==!1}else o.isGrouped&&r.over?o.move(a,o.getAt(o.indexOf(e.insertBefore)+1)):o.move(a,e.insertBefore);(i==null?void 0:i._rowIndex)>=0&&(t._focusedCell=null,t.focusCell({grid:t,record:i.record,columnId:i.columnId})),o.clearSorters()}e.finalize(e.valid),t.element.classList.remove("b-row-reordering")}onReset(){const e=this,{grid:r}=e,t=r.features.cellEdit;r.element.classList.remove("b-row-reordering"),t&&(t.disabled=e.cellEditDisabledState),e.dropIndicator.remove(),m.removeClsGlobally(r.element,...e.dropOverTargetCls)}onPaint({firstPaint:e}){e&&this.init()}updateShowGrip(e){this.grid.element.classList.toggle("b-row-reorder-with-grip",e)}}p(u,"$name","RowReorder"),p(u,"configurable",{showGrip:null,gripOnly:null,hoverExpandTimeout:1e3,touchStartDelay:300,dropOnLeaf:!1,dragHelperConfig:null}),p(u,"pluginConfig",{after:["onPaint"]}),u.featureClass="",u._$name="RowReorder",R.registerFeature(u,!1),R.registerFeature(u,!0,"Gantt");class v extends C{construct(e,r){if(super.construct(e,r),!e.hasFeature("tree"))throw new Error("The TreeGroup feature requires the Tree feature to be enabled")}processParentData(e){this.parentCls&&(e.cls=this.parentCls)}processTransformedData(e){}async waitForReadiness(){if(this.originalStore.isLoading&&(await this.originalStore.await("load",!1),this.isDestroyed))return;const{crudManager:e}=this.client;if(e){if((e.isLoadingOrSyncing||e._autoLoadPromise)&&(await e.await("requestDone"),this.isDestroyed))return;await this.client.project.commitAsync()}}async applyLevels(e){const r=this,{client:t}=r,o=t.columns.find(l=>l instanceof M);let{store:i}=t,a=null;if(r._levels=e,r.isApplying++,t.suspendRefresh(),e&&!r.originalStore){var s;r.originalStore=i,i=new i.constructor({tree:!0,modelClass:i.modelClass,load:(s=i.load)===null||s===void 0?void 0:s.bind(i),commit:i.commit.bind(i)}),t.store=i,r.originalStore.ion({name:"originalStore",refresh:r.onOriginalStoreRefresh,add:r.onOriginalStoreChanged,remove:r.onOriginalStoreChanged,removeAll:r.onOriginalStoreChanged,thisObj:r})}if(await r.waitForReadiness(),!r.isDestroyed)return e?(i.data=r.originalStore.allRecords.flatMap(l=>l.isLeaf?[l.link()]:[]),a=i.treeify(e,l=>{D.setPath(l,i.modelClass.getFieldDataSource(o.field),l.key),r.processParentData(l)}),r.processTransformedData(a),i.data=a.children):(t.store=r.originalStore,r.detachListeners("originalStore"),r.originalStore=null),r.isApplying--,t.resumeRefresh(),t.rowManager.reinitialize(),a}onOriginalStoreChanged(){this.applyLevels(this._levels)}onOriginalStoreRefresh({action:e}){e==="dataset"&&this.applyLevels(this.levels)}updateLevels(e){(e||!this.isConfiguring)&&this.applyLevels(e)}async group(e){D.assertArray(e,"group()"),await this.applyLevels(e)}async clearGroups(){this.isGrouped&&await this.applyLevels(null)}get isGrouped(){return!!this._levels}}p(v,"$name","TreeGroup"),p(v,"configurable",{levels:null,parentCls:"b-generated-parent"}),p(v,"pluginConfig",{assign:["group","clearGroups"]}),p(v,"properties",{isApplying:0,originalStore:null}),v._$name="TreeGroup",R.registerFeature(v);export{u as RowReorder,v as TreeGroup};
//# sourceMappingURL=TreeGroup.js.map
