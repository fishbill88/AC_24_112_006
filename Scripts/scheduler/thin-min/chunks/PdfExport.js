/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
import{Base as X,InstancePlugin as B,DomHelper as z,Combo as _,Popup as Y,LocaleManagerSingleton as K,Field as Q,BrowserHelper as Z,VersionHelper as ee,ObjectHelper as I,Toast as S,AjaxHelper as te,EventHelper as re}from"./Editor.js";import{GridFeatureManager as U}from"./GridBase.js";import{RowsRange as v,Orientation as T,FileFormat as j,PaperFormat as k,Exporter as G,FileMIMEType as oe}from"./Exporter.js";import{Checkbox as ae}from"./MessageDialog.js";var q=M=>class extends(M||X){static get $name(){return"SummaryFormatter"}generateHtml(e,r,o,a,i,l){const s=this.store,p=e.summaries||(e.sum?[{sum:e.sum,renderer:e.summaryRenderer}]:[]);let n=`<table class="${o}">`;return p.forEach(f=>{let c=f.sum,g=null;switch(c===!0&&(c="sum"),c){case"sum":case"add":g=s.sum(e.field,r);break;case"max":g=s.max(e.field,r);break;case"min":g=s.min(e.field,r);break;case"average":case"avg":g=s.average(e.field,r);break;case"count":g=r.length;break;case"countNotEmpty":g=r.reduce((h,x)=>{const m=x[e.field];return h+(m!=null?1:0)},0);break}if(typeof c=="function"&&(g=r.reduce(c,"seed"in f?f.seed:0)),g!==null){const h="b-grid-summary-value",x=f.label?`<td class="b-grid-summary-label">${f.label}</td>`:"";let m=f.renderer?f.renderer({config:f,sum:g}):g,u;m==null&&(m=""),String(m).includes("<td>")?u=m:u=x?`${x}<td class="${h}">${m}</td>`:`<td colspan="2" class="${h}">${m}</td>`,n+=`<tr>${u}</tr>`}}),n+"</table>"}};class $ extends q(B){static get configurable(){return{selectedOnly:null,hideFooters:!1}}static get pluginConfig(){return{chain:["renderRows","bindStore"]}}static get $name(){return"Summary"}construct(t,e){this.grid=t,super.construct(t,e),this.bindStore(t.store),t.hideFooters=this.hideFooters}bindStore(t){this.detachListeners("store"),t.ion({name:"store",change:"onStoreChange",thisObj:this})}get store(){return this.grid.store}doDestroy(){super.doDestroy()}doDisable(t){super.doDisable(t);const{client:e}=this;t?e.element.classList.add("b-summary-disabled"):(this.updateSummaries(),e.element.classList.remove("b-summary-disabled"),e.eachSubGrid(r=>r.scrollable.syncPartners()))}renderRows(){this.updateSummaries()}updateSummaries(){const t=this,{grid:e,store:r}=t,o=z.children(e.element,".b-grid-footer"),a=t.selectedOnly&&e.selectedRecords.length>0,i=(r.isFiltered?r.storage.values:r.allRecords).filter(l=>!l.isSpecialRow&&(!a||e.isSelected(l)));e.columns.forEach(l=>{var s;(s=l.summaries)===null||s===void 0||s.forEach(p=>{"seed"in p&&("initialSeed"in p||(p.initialSeed=p.seed),["number","string","date"].includes(typeof p.initialSeed)?p.seed=p.initialSeed:p.seed=Object.assign({},p.initialSeed))})}),o.forEach(l=>{if(!l.dataset.column)return;const s=e.columns.get(l.dataset.column),p=t.generateHtml(s,i,"b-grid-footer-summary");(s.summaries?s.summaries.length:s.sum)&&(l.children.length?z.sync(p,l.firstElementChild):l.innerHTML=p)})}onStoreChange({action:t,changes:e}){let r=!0;this.disabled||(t==="update"&&(r=Object.keys(e).some(o=>{const a=this.grid.columns.get(o);return!!a&&(!!a.sum||!!a.summaries)})),r&&this.updateSummaries())}updateSelectedOnly(t){const e=this;e.detachListeners("selectionChange"),t&&e.grid.ion({name:"selectionChange",selectionChange:e.refresh,thisObj:e}),e.refresh()}refresh(){this.updateSummaries()}}$.featureClass="b-summary",$._$name="Summary",U.registerFeature($);class W extends _{static get $name(){return"ExportRowsCombo"}static get type(){return"exportrowscombo"}static get defaultConfig(){return{editable:!1}}buildItems(){const t=this;return[{id:v.all,text:t.L("L{all}")},{id:v.visible,text:t.L("L{visible}")}]}}W.initClass(),W._$name="ExportRowsCombo";class A extends _{static get $name(){return"ExportOrientationCombo"}static get type(){return"exportorientationcombo"}static get defaultConfig(){return{editable:!1}}buildItems(){const t=this;return[{id:T.portrait,text:t.L("L{portrait}")},{id:T.landscape,text:t.L("L{landscape}")}]}}A.initClass(),A._$name="ExportOrientationCombo";function J(M,t=e=>e){return Object.keys(M).map(e=>({id:e,text:t(e)}))}class D extends Y{static get $name(){return"ExportDialog"}static get type(){return"exportdialog"}static get configurable(){return{autoShow:!1,autoClose:!1,closable:!0,centered:!0,client:null,autoSelectVisibleColumns:!0,hidePNGMultipageOption:!0,title:"L{exportSettings}",maxHeight:"80%",scrollable:{overflowY:!0},defaults:{localeClass:this},items:{columnsField:{type:"combo",label:"L{ExportDialog.columns}",store:{},valueField:"id",displayField:"text",multiSelect:!0,weight:100,maxHeight:100},rowsRangeField:{type:"exportrowscombo",label:"L{ExportDialog.rows}",value:"all",weight:200},exporterTypeField:{type:"combo",label:"L{ExportDialog.exporterType}",editable:!1,value:"singlepage",displayField:"text",buildItems(){const t=this.parent;return t.exporters.map(e=>({id:e.type,text:t.optionalL(e.title,this)}))},onChange({value:t}){this.owner.widgetMap.alignRowsField.hidden=t==="singlepage",this.owner.widgetMap.repeatHeaderField.hidden=t!=="multipagevertical"},weight:300},alignRowsField:{type:"checkbox",label:"L{ExportDialog.alignRows}",checked:!1,hidden:!0,weight:400},repeatHeaderField:{type:"checkbox",label:"L{ExportDialog.repeatHeader}",localeClass:this,hidden:!0,weight:500},fileFormatField:{type:"combo",label:"L{ExportDialog.fileFormat}",localeClass:this,editable:!1,value:"pdf",items:[],onChange({value:t,oldValue:e}){const r=this.parent;if(r.hidePNGMultipageOption){const o=r.widgetMap.exporterTypeField,a=o.store.find(i=>i.id==="singlepage");t===j.png&&a?(this._previousDisabled=o.disabled,o.disabled=!0,this._previousValue=o.value,o.value="singlepage"):e===j.png&&this._previousValue&&(o.disabled=this._previousDisabled,o.value=this._previousValue)}},weight:600},paperFormatField:{type:"combo",label:"L{ExportDialog.paperFormat}",editable:!1,value:"A4",items:[],weight:700},orientationField:{type:"exportorientationcombo",label:"L{ExportDialog.orientation}",value:"portrait",weight:800}},bbar:{defaults:{localeClass:this},items:{exportButton:{color:"b-green",text:"L{ExportDialog.export}",weight:100,onClick:"up.onExportClick"},cancelButton:{color:"b-gray",text:"L{ExportDialog.cancel}",weight:200,onClick:"up.onCancelClick"}}}}}construct(t={}){const e=this,{client:r}=t;if(!r)throw new Error("`client` config is required");e.columnsStore=r.columns.chain(o=>o.isLeaf&&o.exportable,null,{excludeCollapsedRecords:!1}),e.applyInitialValues(t),super.construct(t),K.ion({locale:"onLocaleChange",prio:-1,thisObj:e})}applyInitialValues(t){const e=this,r=t.items=t.items||{};t.width=t.width||e.L("L{width}"),t.defaults=t.defaults||{},t.defaults.labelWidth=t.defaults.labelWidth||e.L("L{ExportDialog.labelWidth}"),r.columnsField=r.columnsField||{},r.fileFormatField=r.fileFormatField||{},r.paperFormatField=r.paperFormatField||{},r.fileFormatField.items=J(j,o=>o.toUpperCase()),r.paperFormatField.items=J(k),r.columnsField.store=e.columnsStore}onBeforeShow(){var t;const{columnsField:e,alignRowsField:r,exporterTypeField:o,repeatHeaderField:a}=this.widgetMap;this.autoSelectVisibleColumns&&(e.value=this.columnsStore.query(i=>!i.hidden)),r.hidden=o.value==="singlepage",a.hidden=o.value!=="multipagevertical",(t=super.onBeforeShow)===null||t===void 0||t.call(this,...arguments)}onLocaleChange(){const t=this.L("L{labelWidth}");this.width=this.L("L{width}"),this.eachWidget(e=>{e instanceof Q&&(e.labelWidth=t)})}onExportClick(){const t=this.values;this.trigger("export",{values:t})}onCancelClick(){this.trigger("cancel"),this.hide()}get values(){const t=/field/i,e={};return this.eachWidget(r=>{t.test(r.ref)&&(e[r.ref.replace(t,"")]=r instanceof ae?r.checked:r.value)}),e}}D.initClass(),D._$name="ExportDialog";class F extends G{static get $name(){return"MultiPageExporter"}static get type(){return"multipage"}static get title(){return this.L("L{multipage}")}static get exportingPageText(){return"L{exportingPage}"}async stateNextPage({client:t,rowsRange:e,enableDirectRendering:r}){const{exportMeta:o}=this;++o.currentPage,++o.verticalPosition,delete o.lastExportedRowBottom,o.verticalPosition>=o.verticalPages&&(Object.assign(o,{verticalPosition:0,horizontalPosition:o.horizontalPosition+1,currentPageTopMargin:0,lastTop:0,lastRowIndex:e===v.visible?t.rowManager.firstVisibleRow.dataIndex:0}),delete o.lastRowDataIndex,r||await this.scrollRowIntoView(t,o.firstVisibleDataIndex,{block:"start"}))}async prepareComponent(t){await super.prepareComponent(t);const e=this,{exportMeta:r}=e,{client:o,headerTpl:a,footerTpl:i,alignRows:l,rowsRange:s,enableDirectRendering:p}=t,n=k[t.paperFormat],f=t.orientation===T.portrait,c=f?n.width:n.height,g=f?n.height:n.width,h=e.inchToPx(c),x=e.inchToPx(g),m=s===v.visible,u=Math.ceil(r.totalWidth/h);let d=x;a&&(d-=e.measureElement(a({totalWidth:r.totalWidth,totalPages:-1,currentPage:-1}))),i&&(d-=e.measureElement(i({totalWidth:r.totalWidth,totalPages:-1,currentPage:-1})));let H,R,b=o.store.count;if(m?(b=e.getVisibleRowsCount(o),H=r.totalHeight+o.headerHeight+o.footerHeight+o.bodyHeight):H=r.totalHeight+o.headerHeight+o.footerHeight+o.scrollable.scrollHeight,l&&!m){const y=o.rowManager.rowOffsetHeight,P=Math.floor((d-o.headerHeight)/y),w=Math.floor(d/y),C=b-P;R=1+Math.ceil(C/w)}else R=Math.ceil(H/d);Object.assign(r,{paperWidth:c,paperHeight:g,pageWidth:h,pageHeight:x,horizontalPages:u,verticalPages:R,totalHeight:H,contentHeight:d,totalRows:b,totalPages:u*R,currentPage:0,verticalPosition:0,horizontalPosition:0,currentPageTopMargin:0,lastTop:0,lastRowIndex:m?o.rowManager.firstVisibleRow.dataIndex:0}),p||this.adjustRowBuffer(o)}async restoreComponent(t){await super.restoreComponent(t),t.enableDirectRendering||this.restoreRowBuffer(t.client)}async collectRows(t){const e=this,{exportMeta:r}=e,{client:o,alignRows:a,rowsRange:i}=t,{subGrids:l,currentPageTopMargin:s,verticalPosition:p,contentHeight:n,totalRows:f,lastRowDataIndex:c}=r,{rowManager:g}=o,{rows:h}=g,x=i===v.visible,m=o.hasActiveFeature("mergeCells");let u,d;x&&c!=null?c===h[h.length-1].dataIndex?d=h.length-1:d=h.findIndex(w=>w.dataIndex===c):d=x?h.findIndex(w=>w.bottom>Math.ceil(o.scrollable.y)):h.findIndex(w=>w.bottom+s+o.headerHeight>0);const H=d,R=x||p===0?0:h[d].top+s+o.headerHeight;u=n-R,p===0&&(u-=o.headerHeight);let b,y=0;for(;u>0;){const w=h[d];a&&u<w.offsetHeight?(y=-u,u=0,e.exportMeta.lastExportedRowBottom=h[d-1].bottom):(e.collectRow(w),u-=w.offsetHeight,b=w.dataIndex,(++d===h.length&&u>0||x&&d-H===f)&&(u=0))}if(m)for(const w in l){const C=l[w],E=o.subGrids[w].element.querySelectorAll(".b-grid-merged-cells");C.mergedCellsHtml=[];for(const V of E)C.mergedCellsHtml.push(V.outerHTML)}const P=h[d-1];if(P&&(r.exactGridHeight=P.bottom+o.footerContainer.offsetHeight+o.headerContainer.offsetHeight,r.lastRowDataIndex=P.dataIndex+1),await e.onRowsCollected(h.slice(H,d),t),x)r.exactGridHeight-=r.scrollableTopMargin=o.scrollable.y;else{const w=g.ion({offsetRows:({offset:C})=>y+=C});await e.scrollRowIntoView(o,b+1),w()}return y}async renderRows(t){const e=this,{exportMeta:r}=e,{client:o,alignRows:a,rowsRange:i}=t,{currentPageTopMargin:l,verticalPosition:s,contentHeight:p,totalRows:n,lastRowIndex:f,fakeRow:c}=r,{store:g}=o,h=o.hasActiveFeature("mergeCells"),x=i===v.visible;let m=f,{lastTop:u}=r,d;const H=m,R=x||s===0?0:u+l+o.headerHeight,b=[];d=p-R,s===0&&(d-=o.headerHeight);let y,P,w=0;for(;d>0;)c.render(m,g.getAt(m),!0,!1,!0),a&&d<c.offsetHeight?(w=-d,d=0,e.exportMeta.lastExportedRowBottom=u):(P=u,y=m,u=c.translate(u),d-=c.offsetHeight,e.collectRow(c),b.push({top:c.top,bottom:c.bottom,offsetHeight:c.offsetHeight,dataIndex:c.dataIndex}),(++m===g.count&&d>0||x&&m-H===n)&&(d=0));return h&&e.renderMergedCells(t,H,m,b),r.lastRowIndex=a?m:y,r.lastTop=a?u:P,c&&(r.exactGridHeight=c.bottom+o.footerContainer.offsetHeight+o.headerContainer.offsetHeight),await e.onRowsCollected(b,t),w}async buildPage(t){const e=this,{exportMeta:r}=e,{client:o,headerTpl:a,footerTpl:i,enableDirectRendering:l}=t,{totalWidth:s,totalPages:p,currentPage:n,subGrids:f}=r;Object.values(f).forEach(m=>m.rows=[]),t.rowsRange===v.all&&(r.totalHeight=o.height-o.bodyHeight+o.scrollable.scrollHeight-e.getVirtualScrollerHeight(o));let c,g;a&&(c=e.prepareHTML(a({totalWidth:s,totalPages:p,currentPage:n}))),i&&(g=e.prepareHTML(i({totalWidth:s,totalPages:p,currentPage:n})));let h;return l?h=await e.renderRows(t):h=await e.collectRows(t),{html:e.buildPageHtml(t),header:c,footer:g,offset:h}}async onRowsCollected(){}buildPageHtml(){const t=this,{subGrids:e}=t.exportMeta;let r=t.prepareExportElement();return Object.values(e).forEach(({placeHolder:o,rows:a,mergedCellsHtml:i})=>{const l=o.outerHTML;let s=a.reduce((p,n)=>(p+=n[0],p),"");i!=null&&i.length&&(s+=`<div class="b-grid-merged-cells-container">${i.join("")}</div>`),r=r.replace(l,s)}),r}prepareExportElement(){const t=this,{element:e,exportMeta:r}=t;return r.scrollableTopMargin&&(e.querySelector(".b-grid-vertical-scroller").style.marginTop=`-${r.scrollableTopMargin}px`),super.prepareExportElement()}}F.prototype.pagesExtractor=async function*(t){const e=this,{exportMeta:r,stylesheets:o}=e,{totalWidth:a,totalPages:i,paperWidth:l,paperHeight:s,contentHeight:p}=r;let n;for(;(n=r.currentPage)<i;){e.trigger("exportStep",{text:e.L(F.exportingPageText,{currentPage:n,totalPages:i}),progress:Math.round((n+1)/i*90)});const{html:f,header:c,footer:g,offset:h}=await e.buildPage(t),x=[...o,`
                <style>
                    #${t.client.id} {
                        height: ${r.exactGridHeight}px !important;
                        width: ${a}px !important;
                    }
                    .b-export-body .b-export-viewport {
                        margin-inline-start : ${-l*r.horizontalPosition}in;
                        margin-top  : ${r.currentPageTopMargin}px;
                    }
                </style>
            `];r.currentPageTopMargin-=p+h,await e.stateNextPage(t),yield{html:e.pageTpl({html:f,header:c,footer:g,styles:x,paperWidth:l,paperHeight:s})}}},F._$name="MultiPageExporter";class L extends G{static get $name(){return"MultiPageVerticalExporter"}static get type(){return"multipagevertical"}static get title(){return this.L("L{multipagevertical}")}static get exportingPageText(){return"L{exportingPage}"}async stateNextPage({client:t}){const{exportMeta:e}=this,{totalRows:r,processedRows:o,totalPages:a}=e;++e.currentPage,++e.verticalPosition,e.currentPage===a&&o.size!==r&&(++e.totalPages,++e.verticalPages)}estimateTotalPages(t){const e=this,{exportMeta:r}=e,{client:o,headerTpl:a,footerTpl:i,alignRows:l,rowsRange:s,repeatHeader:p,enableDirectRendering:n}=t,{pageWidth:f,pageHeight:c,totalWidth:g}=r,h=e.getScaleValue(f,g);let x=0-e.getVirtualScrollerHeight(o)+o.height-o.bodyElement.offsetHeight+o.scrollable.scrollHeight,m=c/h,u=o.store.count,d=0,H=x,R;if(a&&(m-=e.measureElement(a({totalWidth:g,totalPages:-1,currentPage:-1}))),i&&(m-=e.measureElement(i({totalWidth:g,totalPages:-1,currentPage:-1}))),p&&(m-=o.headerHeight+o.footerHeight,x-=o.headerHeight+o.footerHeight),s===v.visible){const b=o.rowManager,y=b.firstVisibleRow,P=b.lastVisibleRow;n||(d=y.top),u=e.getVisibleRowsCount(o),n?(x=o.headerHeight+o.footerHeight+P.bottom-y.top,H=P.bottom-y.top):H=x=x-o.scrollable.scrollHeight+P.bottom-y.top,r.lastRowIndex=y.dataIndex,r.finishRowIndex=P.dataIndex}else r.finishRowIndex=o.store.count-1;if(l&&!p&&s!==v.visible){const b=o.rowManager.rowOffsetHeight,y=Math.floor((m-o.headerHeight)/b),P=Math.floor(m/b),w=u-y;R=1+Math.ceil(w/P)}else R=Math.ceil(H/m);Object.assign(r,{scale:h,contentHeight:m,totalRows:u,totalHeight:x,verticalPages:R,initialScroll:d,horizontalPages:1,totalPages:R})}async prepareComponent(t){await super.prepareComponent(t);const e=this,{exportMeta:r}=e,{client:o}=t,a=k[t.paperFormat],i=t.orientation===T.portrait,l=i?a.width:a.height,s=i?a.height:a.width,p=e.inchToPx(l),n=e.inchToPx(s);Object.assign(r,{paperWidth:l,paperHeight:s,pageWidth:p,pageHeight:n,horizontalPages:1,currentPage:0,verticalPosition:0,horizontalPosition:0,currentPageTopMargin:0,lastTop:0,lastRowIndex:0,processedRows:new Set}),e.estimateTotalPages(t),t.enableDirectRendering||e.adjustRowBuffer(o)}async restoreComponent(t){await super.restoreComponent(t),t.enableDirectRendering||this.restoreRowBuffer(t.client)}async collectRows(t){const e=this,{exportMeta:r}=e,{client:o,alignRows:a,repeatHeader:i}=t,{subGrids:l,currentPageTopMargin:s,verticalPosition:p,totalRows:n,contentHeight:f}=r,c=i?0:o.headerHeight,{rowManager:g}=o,{rows:h}=g,x=t.rowsRange===v.visible,m=o.hasActiveFeature("mergeCells");let u=x?h.findIndex(w=>w.bottom>o.scrollable.y):h.findIndex(w=>w.bottom+s+c>0),d;const H=u,R=p===0?0:h[u].top+s+c;d=f-R,p===0&&(d-=c);let b,y=0;for(;d>0;){const w=h[u];a&&d<w.offsetHeight?(y=-d,d=0):(e.collectRow(w),d-=w.offsetHeight,d>0&&r.processedRows.add(w.dataIndex),b=w.dataIndex,(++u===h.length&&d>0||x&&u-H===n)&&(d=0))}if(m)for(const w in l){const C=l[w],E=o.subGrids[w].element.querySelectorAll(".b-grid-merged-cells");C.mergedCellsHtml=[];for(const V of E)C.mergedCellsHtml.push(V.outerHTML)}const P=h[u-1];if(P&&(r.exactGridHeight=P.bottom+o.footerContainer.offsetHeight+o.headerContainer.offsetHeight),await e.onRowsCollected(h.slice(H,u),t),x)r.scrollableTopMargin=o.scrollable.y;else{const w=g.ion({offsetRows:({offset:C})=>y+=C});await e.scrollRowIntoView(o,b+1),w()}return y}async renderRows(t){const e=this,{exportMeta:r}=e,{client:o,alignRows:a,repeatHeader:i}=t,{currentPageTopMargin:l,verticalPosition:s,totalRows:p,contentHeight:n,lastRowIndex:f,finishRowIndex:c,fakeRow:g}=r,h=i?0:o.headerHeight,{store:x}=o,m=o.hasActiveFeature("mergeCells"),u=t.rowsRange===v.visible;let d=f,{lastTop:H}=r,R;const b=d,y=s===0?0:H+l+h,P=[];R=n-y,s===0&&(R-=h);let w,C,E=0;for(;R>0;)g.render(d,x.getAt(d),!0,!1,!0),a&&R<g.offsetHeight?(E=-R,R=0):(C=H,w=d,H=g.translate(H),R-=g.offsetHeight,e.collectRow(g),P.push({top:g.top,bottom:g.bottom,offsetHeight:g.offsetHeight,dataIndex:g.dataIndex}),R>0&&r.processedRows.add(d),(d===c||++d-b===p&&u)&&(R=0));return m&&e.renderMergedCells(t,b,d,P),r.lastRowIndex=w,r.lastTop=C,g&&(r.exactGridHeight=g.bottom+o.footerContainer.offsetHeight+o.headerContainer.offsetHeight),await e.onRowsCollected(P,t),E}async buildPage(t){const e=this,{exportMeta:r}=e,{client:o,headerTpl:a,footerTpl:i,enableDirectRendering:l}=t,{totalWidth:s,totalPages:p,currentPage:n,subGrids:f}=r;Object.values(f).forEach(m=>m.rows=[]),t.rowsRange===v.all&&(r.totalHeight=o.headerHeight+o.footerHeight+o.scrollable.scrollHeight,l||(r.totalHeight-=e.getVirtualScrollerHeight(o)));let c,g,h;return a&&(c=e.prepareHTML(a({totalWidth:s,totalPages:p,currentPage:n}))),i&&(g=e.prepareHTML(i({totalWidth:s,totalPages:p,currentPage:n}))),l?h=await e.renderRows(t):h=await e.collectRows(t),{html:e.buildPageHtml(t),header:c,footer:g,offset:h}}async onRowsCollected(){}buildPageHtml(){const t=this,{subGrids:e}=t.exportMeta;let r=t.prepareExportElement();return Object.values(e).forEach(({placeHolder:o,rows:a,mergedCellsHtml:i})=>{const l=o.outerHTML;let s=a.reduce((p,n)=>(p+=n[0],p),"");i!=null&&i.length&&(s+=`<div class="b-grid-merged-cells-container">${i.join("")}</div>`),r=r.replace(l,s)}),r}}L.prototype.pagesExtractor=async function*(t){const e=this,{exportMeta:r,stylesheets:o}=e,{totalWidth:a,paperWidth:i,paperHeight:l,contentHeight:s,scale:p,initialScroll:n}=r;let{totalPages:f}=r,c;for(;(c=r.currentPage)<f;){e.trigger("exportStep",{text:e.L(L.exportingPageText,{currentPage:c,totalPages:f}),progress:Math.round((c+1)/f*90)});const{html:g,header:h,footer:x,offset:m}=await e.buildPage(t),u=[...o,`
                <style>
                    #${t.client.id} {
                        width: ${a}px !important;
                    }
                    .b-export .b-export-content {
                        transform: scale(${p});
                        transform-origin: top left;
                        height: auto;
                    }
                </style>
            `];if(t.repeatHeader){const d=r.exactGridHeight?`${r.exactGridHeight+r.currentPageTopMargin}px`:"100%";u.push(`
                <style>
                    #${t.client.id} {
                        height: ${d} !important;
                    }
                    .b-export .b-export-content {
                        height: ${100/p}%;
                    }
                    .b-export-body {
                        height: 100%;
                        display: flex;
                    }
                    .b-export-viewport {
                        height: 100%;
                    }
                    .b-grid-vertical-scroller {
                        margin-top: ${r.currentPageTopMargin-n}px;
                    }
                </style>
                `)}else{const d=r.exactGridHeight||s-r.currentPageTopMargin;u.push(`
                <style>
                    #${t.client.id} {
                        height: ${d}px !important;
                    }
                    .b-export-body {
                        overflow: hidden;
                    }
                    .b-export .b-export-content {
                        height: ${100/p}%;
                    }
                    .b-export-body .b-export-viewport {
                        margin-top: ${r.currentPageTopMargin}px;
                    }
                    .b-grid-vertical-scroller {
                        margin-top: -${n}px;
                    }
                </style>
                `)}r.currentPageTopMargin-=s+m,await e.stateNextPage(t),{totalPages:f}=r,yield{html:e.pageTpl({html:g,header:h,footer:x,styles:u,paperWidth:i,paperHeight:l})}}},L._$name="MultiPageVerticalExporter";class O extends G{static get $name(){return"SinglePageExporter"}static get type(){return"singlepage"}static get title(){return this.localize("L{singlepage}")}static get defaultConfig(){return{centerContentHorizontally:!1}}async prepareComponent(t){await super.prepareComponent(t),Object.assign(this.exportMeta,{verticalPages:1,horizontalPages:1,totalPages:1,currentPage:0,verticalPosition:0,horizontalPosition:0})}async onRowsCollected(){}positionRows(t,e){if(e.enableDirectRendering)return t.map(r=>r[0]);{let r=0;return t.map(([o,,a])=>{const i=o.replace(/translate\(\d+px, \d+px\)/,`translate(0px, ${r}px)`);return r+=a,i})}}async collectRows(t){const e=this,{client:r}=t,{rowManager:o,store:a}=r,i=r.hasActiveFeature("mergeCells"),{subGrids:l}=e.exportMeta,s=t.rowsRange===v.visible&&a.count?e.getVisibleRowsCount(r):a.count;let{totalHeight:p}=e.exportMeta,n=0,f=-1;if(o.rows.length>0){if(t.rowsRange===v.visible&&(f=o.firstVisibleRow.dataIndex-1),i)for(const c of Object.values(l))c.mergedCellsHtml=[];for(;n<s;){const c=o.rows,g=c[c.length-1],h=n;if(c.forEach(u=>{u.dataIndex>f&&n<s&&(++n,p+=u.offsetHeight,e.collectRow(u))}),i)for(const u in l){const d=l[u],H=r.subGrids[u].element.querySelectorAll(".b-grid-merged-cells");for(const R of H)d.mergedCellsHtml.push(R.outerHTML)}const x=c.findIndex(u=>u.dataIndex===f+1),m=x+(n-h);await e.onRowsCollected(c.slice(x,m),t),n<s&&(f=g.dataIndex,await e.scrollRowIntoView(r,f+1))}}return p}async renderRows(t){const e=this,{client:r,rowsRange:o}=t,{rowManager:a,store:i}=r,l=r.hasActiveFeature("mergeCells"),s=o===v.visible;let{totalHeight:p}=e.exportMeta;if(i.count){const{fakeRow:n}=e.exportMeta,{firstVisibleRow:f}=a,c=s?f.dataIndex:0,g=s?a.lastVisibleRow.dataIndex:i.count-1,h=[];let x=0;if(n.cells.length){for(let m=c;m<=g;m++)n.render(m,i.getAt(m),!0,!1,!0),x=n.translate(x),e.collectRow(n),h.push({top:n.top,bottom:n.bottom,offsetHeight:n.offsetHeight,dataIndex:n.dataIndex});await e.onRowsCollected(h,t)}p+=x,l&&e.renderMergedCells(t,c,g,h)}return p}buildPageHtml(t){const e=this,{subGrids:r}=e.exportMeta;let o=e.prepareExportElement();return Object.values(r).forEach(({placeHolder:a,rows:i,mergedCellsHtml:l})=>{const s=a.outerHTML;let p=e.positionRows(i,t).join("");l!=null&&l.length&&(p+=`<div class="b-grid-merged-cells-container">${l.join("")}</div>`),o=o.replace(s,p)}),o}}O.prototype.pagesExtractor=async function*(t){const e=this,{client:r}=t,{totalWidth:o}=e.exportMeta,a=e.stylesheets,i=t.orientation===T.portrait,l=k[t.paperFormat],s=i?l.width:l.height,p=i?l.height:l.width;let n,f,c;t.enableDirectRendering?(n=await e.renderRows(t),n+=r.headerHeight+r.footerHeight):(n=await e.collectRows(t),n+=r.height-r.bodyHeight);const g=e.buildPageHtml(t),h=n;if(t.headerTpl){f=e.prepareHTML(t.headerTpl({totalWidth:o}));const d=e.measureElement(f);n+=d}if(t.footerTpl){c=e.prepareHTML(t.footerTpl({totalWidth:o}));const d=e.measureElement(c);n+=d}const x=Math.min(1,e.getScaleValue(e.inchToPx(s),o)),m=Math.min(1,e.getScaleValue(e.inchToPx(p),n)),u=Math.min(x,m);a.push(`<style>
                #${r.id} {
                    height: ${h}px !important;
                    width: ${o}px !important;
                }
                .b-export-content {
                    ${e.centerContentHorizontally?"left: 50%;":""}
                    transform: scale(${u}) ${e.centerContentHorizontally?"translateX(-50%)":""};
                    transform-origin: top left;
                    height: ${u===1?"inherit":"auto !important"};
                }
            </style>`),Z.isIE11&&a.push(`<style>
                .b-export-body {
                   min-height: ${h}px !important;
                }
         </style>`),yield{html:e.pageTpl({html:g,header:f,footer:c,styles:a,paperWidth:s,paperHeight:p})}},O._$name="SinglePageExporter";class N extends B{static get $name(){return"PdfExport"}static get configurable(){return{dialogClass:D,exportServer:void 0,exportDialog:{value:!0,$config:["lazy"]},fileName:null,fileFormat:"pdf",clientURL:null,paperFormat:"A4",orientation:"portrait",rowsRange:"all",alignRows:!1,repeatHeader:!1,keepRegionSizes:null,pagesPerRequest:0,exporterConfig:null,exporterType:"singlepage",exporters:[O,F,L],translateURLsToAbsolute:!0,keepPathName:!0,openAfterExport:!0,sendAsBinary:!1,openInNewTab:!1,headerTpl:null,footerTpl:null,fetchOptions:null,exportMask:"L{Generating pages}",exportProgressMask:"L{Waiting for response from server}",showErrorToast:!0,localizableProperties:["exportMask","exportProgressMask"],filterStyles:t=>t,enableDirectRendering:!0}}updateEnableDirectRendering(t){t||ee.deprecate("Grid","6.0.0","Indirect rendering is deprecated")}doDestroy(){var t;(t=this.exportDialog)===null||t===void 0||t.destroy(),this.exportersMap.forEach(e=>e.destroy()),super.doDestroy()}get currentExportPromise(){return this._currentExportPromise}set currentExportPromise(t){this._currentExportPromise=t}get exportersMap(){return this._exportersMap||(this._exportersMap=new Map)}getExporter(t={}){const e=this,{exportersMap:r}=e,{type:o}=t;let a;if(r.has(o))a=r.get(o),Object.assign(a,t);else{const i=this.exporters.find(l=>l.type===o);if(!i)throw new Error(`Exporter type ${o} is not found. Make sure you've configured it`);t=I.clone(t),delete t.type,a=new i(t),a.relayAll(e),r.set(o,a)}return a}buildExportConfig(t={}){const e=this,{client:r,exportServer:o,clientURL:a,fileFormat:i,fileName:l,paperFormat:s,rowsRange:p,alignRows:n,repeatHeader:f,keepRegionSizes:c,orientation:g,translateURLsToAbsolute:h,keepPathName:x,sendAsBinary:m,headerTpl:u,footerTpl:d,filterStyles:H,enableDirectRendering:R}=e;t.columns||(t.columns=r.columns.visibleColumns.filter(y=>y.exportable).map(y=>y.id));const b=I.assign({client:r,exportServer:o,clientURL:a,fileFormat:i,paperFormat:s,rowsRange:p,alignRows:n,repeatHeader:f,keepRegionSizes:c,orientation:g,translateURLsToAbsolute:h,keepPathName:x,sendAsBinary:m,headerTpl:u,footerTpl:d,enableDirectRendering:R,exporterType:e.exporterType,fileName:l||r.$$name},t);return b.columns=t.columns.slice(),b.exporterType!=="multipagevertical"&&(b.repeatHeader=!1),!("alignRows"in t)&&t.repeatHeader&&(b.alignRows=!0),b.exporterConfig=I.assign({type:b.exporterType,translateURLsToAbsolute:b.translateURLsToAbsolute,keepPathName:b.keepPathName,filterStyles:H},b.exporterConfig||{}),delete b.exporterType,delete b.translateURLsToAbsolute,delete b.keepPathName,b}async export(t={}){const e=this,{client:r,pagesPerRequest:o}=e;t=e.buildExportConfig(t);let a;if(r.trigger("beforePdfExport",{config:t})!==!1){r.isExporting=!0,r.mask(e.exportMask);try{const s=e.getExporter(t.exporterConfig);if(o===0){var i;const p=await s.export(t);if(e.isDestroying)return;(i=e.exportDialog)===null||i===void 0||i.close(),r.unmask(),e.trigger("exportStep",{progress:90,text:e.exportProgressMask,contentGenerated:!0});const n=e.receiveExportContent(p,t);e.toast=e.showLoadingToast(n);const f=await n;a={response:f},await e.processExportContent(f,t)}}catch(s){throw s instanceof Response?a={response:s}:a={error:s},s}finally{if(e.toast&&!e.toast.isDestroying&&e.toast.hide(),!e.isDestroying){var l;(l=e.exportDialog)===null||l===void 0||l.close(),r.unmask(),e.showErrorToast&&(a.error?a.error.name!=="AbortError"&&S.show({html:e.L("L{Export failed}"),rootElement:e.rootElement}):a.response.ok||S.show({html:e.L("L{Server error}"),rootElement:e.rootElement})),r.trigger("pdfExport",a),r.isExporting=!1}}}return a}receiveExportContent(t,e){return te.fetch(e.exportServer,Object.assign({method:"POST",credentials:"omit",headers:{"Content-Type":"application/json"},body:JSON.stringify({html:t,orientation:e.orientation,format:e.paperFormat,fileFormat:e.fileFormat,fileName:e.fileName,clientURL:e.clientURL,sendAsBinary:e.sendAsBinary})},this.fetchOptions))}async processExportContent(t,e){const r=this;if(t.ok&&r.openAfterExport){t=t.clone();const o=t.headers.get("content-type");if(o.match(/application\/octet-stream/)){const a=oe[e.fileFormat],i=await r.responseBlobToObjectURL(t,a);r.getDownloadLink(e.fileName,i).click()}else if(o.match(/application\/json/)){const a=await t.json();a.success?r.getDownloadLink(e.fileName,a.url).click():S.show({html:a.msg,rootElement:this.rootElement})}}}async responseBlobToObjectURL(t,e){const r=await t.blob();return URL.createObjectURL(r.slice(0,r.size,e))}getDownloadLink(t,e){const r=document.createElement("a");return r.download=t,r.href=e,this.openInNewTab&&(r.target="_blank"),r}get defaultExportDialogConfig(){return I.copyProperties({},this,["client","exporters","exporterType","orientation","fileFormat","paperFormat","alignRows","rowsRange","repeatHeader"])}changeExportDialog(t,e){const r=this;if(e==null||e.destroy(),t){const o=r.dialogClass.mergeConfigs({rootElement:r.rootElement,client:r.client,items:{rowsRangeField:{value:r.rowsRange},exporterTypeField:{value:r.exporterType},orientationField:{value:r.orientation},paperFormatField:{value:r.paperFormat},repeatHeaderField:{value:r.repeatHeader},fileFormatField:{value:r.fileFormat},alignRowsField:{checked:r.alignRows}}},r.defaultExportDialogConfig,t);t=r.dialogClass.new(o),t.ion({export:r.onExportButtonClick,thisObj:r})}return t}async showExportDialog(){return this.exportDialog.show()}onExportButtonClick({values:t}){const e=this,r=e.exportDialog.mask({progress:0,maxProgress:100,text:e.exportMask}),o=e.ion({exportstep({progress:a,text:i,contentGenerated:l}){l?(e.exportDialog.unmask(),o()):(r.progress=a,i!=null&&(r.text=i))}});e.currentExportPromise=e.export(t),e.currentExportPromise.catch(()=>{}).finally(()=>{var a;o(),(a=e.exportDialog)===null||a===void 0||a.unmask(),e.currentExportPromise=null})}showLoadingToast(t){const e=S.show({timeout:0,showProgress:!1,rootElement:this.rootElement,html:`
    <span class="b-mask-icon b-icon b-icon-spinner"></span>
    <span>${this.L("L{Waiting for response from server}")}</span>
    <button class="b-button">${this.L("L{Click to abort}")}</button>`});return re.on({element:e.element,click(){var r;(r=t.abort)===null||r===void 0||r.call(t)}}),e}}N._$name="PdfExport",U.registerFeature(N,!1,"Grid");export{D as ExportDialog,A as ExportOrientationCombo,W as ExportRowsCombo,F as MultiPageExporter,L as MultiPageVerticalExporter,N as PdfExport,O as SinglePageExporter,$ as Summary,q as SummaryFormatter};
//# sourceMappingURL=PdfExport.js.map
