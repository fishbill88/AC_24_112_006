/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var R=Object.defineProperty;var D=(d,t,e)=>t in d?R(d,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):d[t]=e;var v=(d,t,e)=>(D(d,typeof t!="symbol"?t+"":t,e),e);import{AbstractCrudManagerMixin as O,ProjectCrudManager as F,AjaxTransport as $,JsonEncoder as k,ProjectModel as T,ResourceStore as M,EventStore as I,AssignmentStore as j,DependencyStore as L}from"./ProjectModel.js";import{Base as p,StringHelper as _,ObjectHelper as B,Store as x,DateHelper as S,Collection as b,ArrayHelper as C}from"./Editor.js";class E extends p.mixin(O){get revision(){return this.crudRevision}set revision(t){this.crudRevision=t}get json(){return _.safeJsonStringify(this)}set json(t){typeof t=="string"&&(t=_.safeJsonParse(t)),this.forEachCrudStore(e=>{const s=`${e.storeId}Data`;t[s]&&(e.data=t[s])})}static get defaultConfig(){return{stores:null}}construct(t={}){t.stores&&(t.crudStores=t.stores,delete t.stores),super.construct(t)}toJSON(){const t={};return this.forEachCrudStore((e,s)=>t[`${s}Data`]=e.toJSON()),t}get inlineData(){return this.toJSON()}set inlineData(t){this.json=t}set stores(t){t!==this.crudStores&&(this.crudStores=t)}get stores(){return this.crudStores}get isLoading(){return this.isCrudManagerLoading}addStore(...t){return this.addCrudStore(...t)}removeStore(...t){return this.removeCrudStore(...t)}getStore(...t){return this.getCrudStore(...t)}hasChanges(...t){return this.crudStoreHasChanges(...t)}loadData(...t){return this.loadCrudManagerData(...t)}}E._$name="AbstractCrudManager";class A extends E.mixin(F,$,k){static get defaultConfig(){return{projectClass:T,resourceStoreClass:M,eventStoreClass:I,assignmentStoreClass:j,dependencyStoreClass:L,resourceStore:{},eventStore:{},assignmentStore:{},dependencyStore:{},project:null}}buildProject(){return new this.projectClass(this.buildProjectConfig())}buildProjectConfig(){return B.cleanupProperties({eventStore:this.eventStore,resourceStore:this.resourceStore,assignmentStore:this.assignmentStore,dependencyStore:this.dependencyStore,resourceTimeRangeStore:this.resourceTimeRangeStore})}set project(t){const e=this;t!==e._project&&(e.detachListeners("beforeDataReady"),e.detachListeners("afterDataReady"),e._project=t,t&&(e.eventStore=t.eventStore,e.resourceStore=t.resourceStore,e.assignmentStore=t.assignmentStore,e.dependencyStore=t.dependencyStore,e.timeRangeStore=t.timeRangeStore,e.resourceTimeRangeStore=t.resourceTimeRangeStore,t.ion({name:"beforeDataReady",dataReady:()=>e.suspendChangesTracking(),prio:100,thisObj:e}),t.ion({name:"afterDataReady",dataReady:()=>e.resumeChangesTracking(),prio:-100,thisObj:e})),e.eventStore||(e.eventStore={}),e.resourceStore||(e.resourceStore={}),e.assignmentStore||(e.assignmentStore={}),e.dependencyStore||(e.dependencyStore={}))}get project(){return this._project}get timeRangeStore(){var t;return(t=this._timeRangeStore)===null||t===void 0?void 0:t.store}set timeRangeStore(t){var e;this.setFeaturedStore("_timeRangeStore",t,(e=this.project)===null||e===void 0?void 0:e.timeRangeStoreClass)}get resourceTimeRangeStore(){var t;return(t=this._resourceTimeRangeStore)===null||t===void 0?void 0:t.store}set resourceTimeRangeStore(t){var e;this.setFeaturedStore("_resourceTimeRangeStore",t,(e=this.project)===null||e===void 0?void 0:e.resourceTimeRangeStoreClass)}get resourceStore(){var t;return(t=this._resourceStore)===null||t===void 0?void 0:t.store}set resourceStore(t){const e=this;e.setFeaturedStore("_resourceStore",t,e.resourceStoreClass)}get eventStore(){var t;return(t=this._eventStore)===null||t===void 0?void 0:t.store}set eventStore(t){const e=this;e.setFeaturedStore("_eventStore",t,e.eventStoreClass)}get assignmentStore(){var t;return(t=this._assignmentStore)===null||t===void 0?void 0:t.store}set assignmentStore(t){this.setFeaturedStore("_assignmentStore",t,this.assignmentStoreClass)}get dependencyStore(){var t;return(t=this._dependencyStore)===null||t===void 0?void 0:t.store}set dependencyStore(t){this.setFeaturedStore("_dependencyStore",t,this.dependencyStoreClass)}setFeaturedStore(t,e,s){var n;const r=this,a=(n=r[t])===null||n===void 0?void 0:n.store;if(a!==e){var o;e=x.getStore(e,((o=e)===null||o===void 0?void 0:o.storeClass)||s),a&&r.removeStore(a),r[t]=e&&{store:e}||null,r.addPrioritizedStore(r[t])}return r[t]}getChangesetPackage(){const t=super.getChangesetPackage();return t&&this.eventStore.usesSingleAssignment&&(delete t[this.assignmentStore.storeId],!this.crudStores.some(e=>t[e.storeId]))?null:t}get crudLoadValidationMandatoryStores(){return[this._eventStore.storeId,this._resourceStore.storeId]}}v(A,"$name","CrudManager"),A._$name="CrudManager";var H=d=>class extends(d||p){static get $name(){return"PackMixin"}static get defaultConfig(){return{coordProp:"top",sizeProp:"height",inBandCoordProp:"inBandTop",inBandSizeProp:"inBandHeight"}}isSameGroup(e,s){return this.grouped?e.group===s.group:!0}packEventsInBands(e,s){const n=this,{coordProp:r,sizeProp:a}=n;let o,c,i,l;for(let h=0,g=e.length;h<g;h++){if(c=e[h],o=n.findStartSlot(e,c),i=n.getCluster(e,h),i.length>1){for(c[r]=o.start,c[a]=o.end-o.start,l=1;l<i.length-1&&i[l+1].start-c.start===0;)l++;const f=n.findStartSlot(e,i[l]);f&&f.start<.8&&(i.length=l)}const m=i.length,u=(o.end-o.start)/m;for(l=0;l<m;l++)s(i[l],l,o,u);h+=m-1}return 1}findStartSlot(e,s){const{inBandSizeProp:n,inBandCoordProp:r,coordProp:a,sizeProp:o}=this,c=this.getPriorOverlappingEvents(e,s);let i;if(c.length===0)return{start:0,end:1};for(i=0;i<c.length;i++){const l=c[i],h=r in l?r:a,g=n in l?n:o;if(i===0&&l[h]>0)return{start:0,end:l[h]};if(l[h]+l[g]<(i<c.length-1?c[i+1][h]:1))return{start:l[h]+l[g],end:i<c.length-1?c[i+1][h]:1}}return!1}getPriorOverlappingEvents(e,s){const n=s.start,r=s.end,a=[];for(let o=0,c=e.indexOf(s);o<c;o++){const i=e[o];this.isSameGroup(i,s)&&S.intersectSpans(n,r,i.start,i.end)&&a.push(i)}return a.sort(this.sortOverlappers.bind(this)),a}sortOverlappers(e,s){const{coordProp:n}=this;return e[n]-s[n]}getCluster(e,s){const n=e[s],r=[n];if(s>=e.length-1)return r;let{start:a,end:o}=n;for(let c=s+1,i=e.length;c<i;c++){const l=e[c];if(!this.isSameGroup(l,n)||!S.intersectSpans(a,o,l.start,l.end))break;r.push(l),a=S.max(a,l.start),o=S.min(l.end,o)}return r}};const y=d=>!d||Array.isArray(d)?d:[d],P=(d,t,e)=>d&&d[t]!==!0?d[t]:e;var N=d=>{var t;return t=class extends(d||p){get dateBounds(){return[this.date]}get description(){const s=this,{descriptionRenderer:n}=s;return n?s.callback(n,s,[s]):s.formattedDescription}get formattedDescription(){var l;const s=this,{dateBounds:n,dateFormat:r}=s,a=(l=s.descriptionFormat)!=null?l:y(s.defaultDescriptionFormat),o=P(a,0,r),c=n.length>1&&(a==null?void 0:a.length)>1&&S.format(n[0],o)!==S.format(n[1],o);let i=S.format(n[0],o);return c&&(i=S.formatRange(n,P(a,1,`S${r}${s.dateSeparator}E${r}`))),i}changeDescriptionFormat(s){return y(s)}get widgetClass(){}},v(t,"$name","Describable"),v(t,"configurable",{dateFormat:"MMMM d, YYYY",dateSeparator:" - ",descriptionFormat:null,descriptionRenderer:null}),t},w=d=>class extends(d||p){static get $name(){return"EventSelection"}static get configurable(){return{highlightPredecessors:!1,highlightSuccessors:!1,deselectOnClick:!1,deselectAllOnScheduleClick:!0}}static get defaultConfig(){return{multiEventSelect:!1,eventSelectionDisabled:!1,eventSelectedCls:"b-sch-event-selected",triggerSelectionChangeOnRemove:!1,maintainSelectionOnDatasetChange:!0,eventAssignHighlightCls:"b-sch-event-assign-selected",selectedCollection:{}}}afterConstruct(){var e;super.afterConstruct(),(e=this.navigator)===null||e===void 0||e.ion({navigate:"onEventNavigate",thisObj:this})}set selectedCollection(e){e instanceof b||(e=new b(e)),this._selectedCollection=e,e.ion({change:(...s)=>this.project.deferUntilRepopulationIfNeeded("onSelectedCollectionChange",(...n)=>!this.isDestroying&&this.onSelectedCollectionChange(...n),s),beforeSplice:"onBeforeSelectedCollectionSplice",thisObj:this})}get selectedCollection(){return this._selectedCollection}getActionType(e,s,n){return e.length>0?s.length>0&&n.length>0?"update":s.length>0?"select":"deselect":"clear"}getEventsFromAssignments(e){return C.unique(e.map(s=>s.event))}get selectedEvents(){return this.getEventsFromAssignments(this.selectedCollection.values)}set selectedEvents(e){var s;const n=[];e=C.asArray(e),(s=e)===null||s===void 0||s.forEach(r=>{this.isEventSelectable(r)!==!1&&(r.isOccurrence?r.assignments.forEach(a=>{n.push(this.assignmentStore.getOccurrence(a,r))}):n.push(...r.assignments))}),this.selectedCollection.splice(0,this.selectedCollection.count,n)}get selectedAssignments(){return this.selectedCollection.values}set selectedAssignments(e){this.selectedCollection.splice(0,this.selectedCollection.count,e||[])}isEventSelected(e){const{selectedCollection:s}=this;return!!(s.count&&s.includes(e.assignments))}isEventSelectable(e){}isAssignmentSelected(e){return this.selectedCollection.includes(e)}select(e,s=!1){e.isAssignment?this.selectAssignment(e,s):this.selectEvent(e,s)}selectEvent(e,s=!1){this.isEventSelected(e)||this.selectEvents([e],s)}selectAssignment(e,s=!1,n){this.isAssignmentSelected(e)||(s?this.selectedCollection.add(e):this.selectedAssignments=e)}deselect(e){e.isAssignment?this.deselectAssignment(e):this.deselectEvent(e)}deselectEvent(e){this.isEventSelected(e)&&this.selectedCollection.remove(...e.assignments)}deselectAssignment(e){this.isAssignmentSelected(e)&&this.selectedCollection.remove(e)}selectEvents(e,s=!1){if(s){const n=e.reduce((r,a)=>(this.isEventSelectable(a)!==!1&&r.push(...a.assignments),r),[]);this.selectedCollection.add(n)}else this.selectedEvents=e}deselectEvents(e){this.selectedCollection.remove(e.reduce((s,n)=>(s.push(...n.assignments),s),[]))}selectAssignments(e){this.selectedCollection.add(e)}deselectAssignments(e){this.selectedCollection.remove(e)}clearEventSelection(){this.selectedAssignments=[]}onBeforeSelectedCollectionSplice({toAdd:e,toRemove:s,index:n}){const r=this,a=r._selectedCollection.values,o=e,c=s>0?o.slice(n,s+n):[],i=r.getActionType(a,o,c);if(r.trigger("beforeEventSelectionChange",{action:i,selection:r.getEventsFromAssignments(a)||[],selected:r.getEventsFromAssignments(o)||[],deselected:r.getEventsFromAssignments(c)||[]})===!1||r.trigger("beforeAssignmentSelectionChange",{action:i,selection:a,selected:o,deselected:c})===!1)return!1}onSelectedCollectionChange({added:e,removed:s}){const n=this,r=n.selectedAssignments,a=e||[],o=s||[];function c(i,l){const h=i.event;if(h){const{eventAssignHighlightCls:g}=n,m=n.getElementFromAssignmentRecord(i);n.currentOrientation.toggleCls(i,n.eventSelectedCls,l),g&&n.getElementsFromEventRecord(h).forEach(u=>{if(u!==m){const f=n.resolveAssignmentRecord(u);n.currentOrientation.toggleCls(f,g,l),l&&(u.style.animation="none",u.offsetHeight,u.style.animation=""),u.classList.toggle(g,l)}})}}if(o.forEach(i=>c(i,!1)),a.forEach(i=>c(i,!0)),(n.highlightSuccessors||n.highlightPredecessors)&&n.highlightLinkedEvents(n.selectedEvents),n.$selectedAssignments=r.map(i=>({eventId:i.eventId,resourceId:i.resourceId})),!n.silent){const i=this.getActionType(r,a,o);n.trigger("assignmentSelectionChange",{action:i,selection:r,selected:a,deselected:o}),n.trigger("eventSelectionChange",{action:i,selection:n.selectedEvents,selected:n.getEventsFromAssignments(a),deselected:n.getEventsFromAssignments(o)})}}onAssignmentChange(e){super.onAssignmentChange(e);const s=this,{action:n,records:r}=e;if(s.silent=!s.triggerSelectionChangeOnRemove,n==="remove")s.deselectAssignments(r);else if(n==="removeall"&&!s.eventStore.isSettingData)s.clearEventSelection();else if(n==="dataset"&&s.$selectedAssignments)if(!s.maintainSelectionOnDatasetChange)s.clearEventSelection();else{const a=s.$selectedAssignments.map(o=>r.find(c=>c.eventId===o.eventId&&c.resourceId===o.resourceId));s.selectedAssignments=C.clean(a)}s.silent=!1}onInternalEventStoreChange({source:e,action:s,records:n}){!e.isResourceTimeRangeStore&&s==="dataset"&&!n.length&&this.clearEventSelection(),super.onInternalEventStoreChange(...arguments)}onAssignmentSelectionClick(e,s){const n=this;n.isAssignmentSelected(s)?(n.deselectOnClick||e.ctrlKey)&&n.deselectAssignment(s,n.multiEventSelect,e):this.isEventSelectable(s.event)!==!1&&n.selectAssignment(s,e.ctrlKey&&n.multiEventSelect,e)}onEventNavigate({event:e,item:s}){if(!this.eventSelectionDisabled){const n=s&&(s.nodeType===Element.ELEMENT_NODE?this.resolveAssignmentRecord(s):s);n?this.onAssignmentSelectionClick(e,n):this.deselectAllOnScheduleClick&&this.clearEventSelection()}}changeHighlightSuccessors(e){return this.changeLinkedEvents(e)}changeHighlightPredecessors(e){return this.changeLinkedEvents(e)}changeLinkedEvents(e){const s=this;return e?(s.highlighted=s.highlighted||new Set,s.highlightLinkedEvents(s.selectedEvents)):s.highlighted&&s.highlightLinkedEvents(),e}highlightLinkedEvents(e=[]){const s=this,{highlighted:n,eventStore:r}=s,a=s.features.dependencies;n.forEach(o=>{e.includes(o)||(o.meta.highlight=!1,n.delete(o),r.includes(o)&&o.dependencies.forEach(c=>a.unhighlight(c,"b-highlight")))}),e.forEach(o=>{const c=[o];for(;c.length;){const i=c.pop();n.add(i),s.highlightSuccessors&&i.outgoingDeps.forEach(l=>{a.highlight(l,"b-highlight"),!n.has(l.toEvent)&&c.push(l.toEvent)}),s.highlightPredecessors&&i.incomingDeps.forEach(l=>{a.highlight(l,"b-highlight"),!n.has(l.fromEvent)&&c.push(l.fromEvent)})}n.forEach(i=>i.meta.highlight=!0)}),s.element.classList.toggle("b-highlighting",e.length>0),s.refreshWithTransition()}onEventDataGenerated(e){(this.highlightSuccessors||this.highlightPredecessors)&&(e.cls["b-highlight"]=e.eventRecord.meta.highlight),super.onEventDataGenerated(e)}updateProject(e,s){this.clearEventSelection(),super.updateProject(e,s)}doDestroy(){var e;(e=this._selectedCollection)===null||e===void 0||e.destroy(),super.doDestroy()}get widgetClass(){}};export{E as AbstractCrudManager,A as CrudManager,N as Describable,H as PackMixin,w as SchedulerEventSelection};
//# sourceMappingURL=EventSelection.js.map
