/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var Ke=Object.defineProperty;var Xe=(y,t,e)=>t in y?Ke(y,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):y[t]=e;var F=(y,t,e)=>(Xe(y,typeof t!="symbol"?t+"":t,e),e);import{Base as j,InstancePlugin as se,EventHelper as X,StringHelper as ie,Popup as qe,ObjectHelper as V,Rectangle as L,Duration as Ze,Delayable as Oe,DomHelper as A,DateHelper as x,DomSync as q,parseAlign as Je,VersionHelper as Fe,DomClassList as Z,BrowserHelper as ye,Store as Qe,GlobalEvents as et,ArrayHelper as tt,Model as nt}from"./Editor.js";import{AttachToProjectMixin as oe,ProjectConsumer as rt,SchedulerEventNavigation as st,CurrentConfig as it}from"./EventNavigation.js";import{ColumnStore as at,Column as ot,GridFeatureManager as H}from"./GridBase.js";import"./MessageDialog.js";import{DependencyModel as ke,TimeSpan as lt,CrudManagerView as ct}from"./ProjectModel.js";import{TimeAxisBase as dt,DragBase as ut,DragCreateBase as ht,TooltipBase as gt,AbstractTimeRanges as mt,TimelineBase as ft}from"./TimelineBase.js";import{PackMixin as Le,Describable as vt,SchedulerEventSelection as pt,CrudManager as Et}from"./EventSelection.js";import"./RegionResize.js";class Be extends dt{static get $name(){return"VerticalTimeAxis"}static get configurable(){return{cls:"b-verticaltimeaxis",sizeProperty:"height",positionProperty:"top",wrapText:!0}}buildHorizontalCells(){const t=this,{client:e}=t,n=e==null?void 0:e.stickyHeaders,r=[],s=t.levels.reduce((i,a,o)=>{if(a.cells){var l;i.push(...(l=a.cells)===null||l===void 0?void 0:l.filter(c=>c.start<t.endDate&&c.end>t.startDate).map((c,d,u)=>({role:"presentation",className:{"b-sch-header-timeaxis-cell":1,[c.headerCellCls]:c.headerCellCls,[`b-align-${c.align}`]:c.align,"b-last":d===u.length-1,"b-lowest":o===t.levels.length-1},dataset:{tickIndex:c.index,cellId:`${o}-${c.index}`,headerPosition:o,...globalThis.DEBUG&&{date:c.start.getTime()}},style:{top:c.coord,height:c.width,minHeight:c.width},children:[{role:"presentation",className:{"b-sch-header-text":1,"b-sticky-header":n},html:c.value}]})))}return i},[]);return e==null||e.getHeaderDomConfigs(r),s.push(...r),{className:t.widgetClassList,dataset:{headerFeature:"headerRow0",headerPosition:0},syncOptions:{releaseThreshold:5,syncIdField:"cellId"},children:s}}get height(){return this.size}}Be._$name="VerticalTimeAxis";class le extends ot{static get type(){return"verticalTimeAxis"}static get defaults(){return{draggable:!1,groupable:!1,hideable:!1,showColumnPicker:!1,filterable:!1,sortable:!1,searchable:!1,editor:!1,enableCellContextMenu:!1,tooltipRenderer:!1,minWidth:0,resizable:!1,cellCls:"b-verticaltimeaxiscolumn",locked:!0,flex:1,alwaysClearCell:!1}}get isFocusable(){return!1}construct(t){super.construct(...arguments),this.view=new Be({model:this.grid.timeAxisViewModel,client:this.grid})}renderer({cellElement:t,size:e}){this.view.render(t),e.height=this.view.height}getCurrentConfig(t){const e=super.getCurrentConfig(t);return delete e.id,delete e.region,delete e.type,delete e.field,delete e.ariaLabel,delete e.cellAriaLabel,e}}F(le,"$name","VerticalTimeAxisColumn"),at.registerColumnType(le),le._$name="VerticalTimeAxisColumn";class Re extends j{static get defaultConfig(){return{nbrOfBandsByResource:{},bandIndexToPxConvertFn:null,bandIndexToPxConvertThisObj:null}}clearCache(t){t?delete this.nbrOfBandsByResource[t.id]:this.nbrOfBandsByResource={}}applyLayout(t,e){return this.nbrOfBandsByResource[e.id]=this.layoutEventsInBands(t,e)}layoutEventsInBands(t,e){throw new Error("Implement in subclass")}}Re._$name="HorizontalLayout";class Ce extends Re.mixin(Le){static get $name(){return"HorizontalLayoutPack"}static get configurable(){return{type:"pack"}}layoutEventsInBands(t){const e=this.packEventsInBands(t,(n,r,s,i)=>{n.height=i,n.top=s.start+r*i});return t.forEach(n=>{Object.assign(n,this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertThisObj||this,n.top,n.height,n.eventRecord,n.resourceRecord))}),e}}Ce._$name="HorizontalLayoutPack";class Se extends Re{static get $name(){return"HorizontalLayoutStack"}static get configurable(){return{type:"stack"}}layoutEventsInBands(t,e,n=!1){let r=0;do{let s=0,i=t[0];for(;i;)n||(i.top=this.bandIndexToPxConvertFn.call(this.bandIndexToPxConvertThisObj||this,r,i.eventRecord,i.resourceRecord)),t.splice(s,1),s=this.findClosestSuccessor(i,t),i=t[s];r++}while(t.length>0);return r}findClosestSuccessor(t,e){const{endMS:n,group:r}=t,s=t.eventRecord&&t.eventRecord.duration===0;let i=1/0,a,o,l;for(let c=0,d=e.length;c<d;c++)if(l=e[c],o=l.startMS-n,o>=0&&o<i&&(o>0||l.endMS-l.startMS>0||!s)){if(this.grouped&&r!==l.group)break;a=c,i=o}return a}}Se._$name="HorizontalLayoutStack";class ce extends se.mixin(oe){static get pluginConfig(){return{chain:["getEventsToRender","onEventDataGenerated","noFeatureElementsInAxis"],override:["matchScheduleCell","resolveResourceRecord"]}}noFeatureElementsInAxis(){const{timeAxis:t}=this.client;return!this.needsRefresh&&this.store&&!this.store.storage.values.some(e=>t.isTimeSpanInAxis(e))}doDisable(t){this.client.isPainted&&this.client.refresh(),super.doDisable(t)}updateTabIndex(){this.isConfiguring||this.client.refresh()}getEventsToRender(t,e){throw new Error("Implement in subclass")}onEventDataGenerated(t){const e=this,{eventRecord:n,iconCls:r}=t;e.shouldInclude(n)&&(e.client.isVertical?t.width=t.resourceRecord.columnWidth||e.client.resourceColumnWidth:t.top=0,t.fillSize=!0,t.wrapperCls["b-sch-resourcetimerange"]=1,e.rangeCls&&(t.wrapperCls[e.rangeCls]=1),t.wrapperCls[`b-sch-color-${n.timeRangeColor}`]=n.timeRangeColor,t.eventContent.text=n.name,t.children.push(t.eventContent),t.tabIndex=e.tabIndex!=null?String(e.tabIndex):null,(r==null?void 0:r.length)>0&&t.children.unshift({tag:"i",className:r.toString()}),t.eventId=e.generateElementId(n))}generateElementId(t){return t.domId}resolveResourceTimeRangeRecord(t){var e;return t==null||(e=t.closest(`.${this.rangeCls}`))===null||e===void 0?void 0:e.elementData.eventRecord}getElementFromResourceTimeRangeRecord(t){return this.client.foregroundCanvas.syncIdMap[t.domId]}resolveResourceRecord(t){var e;return this.overridden.resolveResourceRecord(...arguments)||((e=this.resolveResourceTimeRangeRecord(t.target||t))===null||e===void 0?void 0:e.resource)}shouldInclude(t){throw new Error("Implement in subclass")}onStoreChange(t){(t.action==="removeall"||t.action==="dataset")&&(this.needsRefresh=!0),this.client.onInternalEventStoreChange(t),this.needsRefresh=!1}matchScheduleCell(t){let e=this.overridden.matchScheduleCell(t);if(!e&&this.enableMouseEvents){const{client:n}=this,r=t.closest(`.${this.rangeCls}`);e=r&&n.getCell({record:n.isHorizontal?r.elementData.resource:n.store.first,column:n.timeAxisColumn})}return e}handleRangeMouseEvent(t){var r;const e=this,n=t.target.closest(`.${e.rangeCls}`);if(n){const s=(r=X.eventNameMap[t.type])!=null?r:ie.capitalize(t.type),i=e.resolveResourceTimeRangeRecord(n);e.client.trigger(e.entityName+s,{feature:e,[`${e.entityName}Record`]:i,resourceRecord:e.client.resourceStore.getById(i.resourceId),domEvent:t})}}updateEnableMouseEvents(t){var e;const n=this,{client:r}=n;if((e=n.mouseEventsDetacher)===null||e===void 0||e.call(n),n.mouseEventsDetacher=null,t){let s=function(){n.mouseEventsDetacher=X.on({element:r.foregroundCanvas,delegate:`.${n.rangeCls}`,mousedown:"handleRangeMouseEvent",mouseup:"handleRangeMouseEvent",click:"handleRangeMouseEvent",dblclick:"handleRangeMouseEvent",contextmenu:"handleRangeMouseEvent",mouseover:"handleRangeMouseEvent",mouseout:"handleRangeMouseEvent",thisObj:n})};r.whenVisible(s)}r.element.classList.toggle("b-interactive-resourcetimeranges",!!t)}}F(ce,"configurable",{tabIndex:null,entityName:"resourceTimeRange"}),ce.featureClass="",ce._$name="ResourceTimeRangesBase";class Pe extends qe{static get $name(){return"DependencyEditor"}static get defaultConfig(){return{items:[],draggable:{handleSelector:":not(button,.b-field-inner)"},axisLock:"flexible"}}processWidgetConfig(t){const{dependencyEditFeature:e}=this;return t.ref==="lagField"&&!e.showLagField||t.ref==="deleteButton"&&!e.showDeleteButton?!1:super.processWidgetConfig(t)}afterShow(...t){const{deleteButton:e}=this.widgetMap;e&&(e.hidden=!this.record.isPartOfStore()),super.afterShow(...t)}onInternalKeyDown(t){this.trigger("keyDown",{event:t}),super.onInternalKeyDown(t)}}Pe._$name="DependencyEditor";class we extends se{static get $name(){return"DependencyEdit"}static get configurable(){return{autoClose:!0,saveAndCloseOnEnter:!0,showDeleteButton:!0,triggerEvent:"dependencydblclick",showLagField:!1,dependencyRecord:null,editorConfig:{title:"L{Edit dependency}",localeClass:this,closable:!0,defaults:{localeClass:this},items:{fromNameField:{type:"display",weight:100,label:"L{From}"},toNameField:{type:"display",weight:200,label:"L{To}"},typeField:{type:"combo",weight:300,label:"L{Type}",name:"type",editable:!1,valueField:"id",displayField:"name",localizeDisplayFields:!0,buildItems:function(){const t=this.parent;return Object.keys(ke.Type).map(e=>({id:ke.Type[e],name:t.L(e),localeKey:e}))}},lagField:{type:"duration",weight:400,label:"L{Lag}",name:"lag",allowNegative:!0}},bbar:{defaults:{localeClass:this},items:{foo:{type:"widget",cls:"b-label-filler"},saveButton:{color:"b-green",text:"L{Save}"},deleteButton:{color:"b-gray",text:"L{Delete}"},cancelButton:{color:"b-gray",text:"L{Object.Cancel}"}}}}}}construct(t,e){const n=this;if(t.dependencyEdit=n,super.construct(t,e),!t.features.dependencies)throw new Error("Dependencies feature required when using DependencyEdit");n.clientListenersDetacher=t.ion({[n.triggerEvent]:n.onActivateEditor,thisObj:n})}doDestroy(){var t;this.clientListenersDetacher(),(t=this.editor)===null||t===void 0||t.destroy(),super.doDestroy()}changeEditorConfig(t){const e=this,{autoClose:n,cls:r,client:s}=e;return V.assign({owner:s,align:"b-t",id:`${s.id}-dependency-editor`,autoShow:!1,anchor:!0,scrollAction:"realign",clippedBy:[s.timeAxisSubGridElement,s.bodyContainer],constrainTo:globalThis,autoClose:n,cls:r},t)}get isValid(){return Object.values(this.editor.widgetMap).every(t=>!t.name||t.hidden?!0:t.isValid!==!1)}get values(){const t={};return this.editor.eachWidget(e=>{!e.name||e.hidden||(t[e.name]=e.value)},!0),t}onBeforeSave(t){}onAfterSave(t){}updateRecord(t){const{values:e}=this;e.lag&&(e.lagUnit=e.lag.unit,e.lag=e.lag.magnitude),"type"in e&&(t.fromSide!=null&&(e.fromSide=null),t.toSide!=null&&(e.toSide=null)),V.cleanupProperties(e,!0),t.set(e)}onPopupKeyDown({event:t}){t.key==="Enter"&&this.saveAndCloseOnEnter&&t.target.tagName.toLowerCase()==="input"&&(t.preventDefault(),this.onSaveClick())}onSaveClick(){this.save()&&this.editor.hide()}onDeleteClick(){this.deleteDependency(),this.editor.hide()}onCancelClick(){this.editor.hide()}internalShowEditor(t){const e=this,{client:n}=e;let r=e.lastPointerDownCoordinate;if(n.trigger("beforeDependencyEdit",{dependencyEdit:e,dependencyRecord:t})===!1)return;const s=e.getEditor(t);if(e.loadRecord(t),n.trigger("beforeDependencyEditShow",{dependencyEdit:e,dependencyRecord:t,editor:s}),!r){const i=L.from(e.client.element).center;r=[i.x-s.width/2,i.y-s.height/2]}s.showBy(r)}editDependency(t){this.client.readOnly||t.readOnly||this.internalShowEditor(t)}getEditor(){var t,e,n;const r=this;let{editor:s}=r;return s||(s=r.editor=Pe.new({dependencyEditFeature:r,autoShow:!1,anchor:!0,scrollAction:"realign",constrainTo:globalThis,autoClose:r.autoClose,cls:r.cls,rootElement:r.client.rootElement,internalListeners:{keydown:r.onPopupKeyDown,thisObj:r}},r.editorConfig),s.items.length===0&&console.warn("Editor configured without any `items`"),s.eachWidget(i=>{const a=i.ref||i.id;a&&!r[a]&&(r[a]=i)}),(t=r.saveButton)===null||t===void 0||t.ion({click:"onSaveClick",thisObj:r}),(e=r.deleteButton)===null||e===void 0||e.ion({click:"onDeleteClick",thisObj:r}),(n=r.cancelButton)===null||n===void 0||n.ion({click:"onCancelClick",thisObj:r}),r.editor)}loadRecord(t){const e=this;e.fromNameField.value=t.fromEvent.name,e.toNameField.value=t.toEvent.name,e.lagField&&(e.lagField.value=new Ze(t.lag,t.lagUnit)),e.editor.record=e.dependencyRecord=t}async save(){const t=this,{client:e,dependencyRecord:n}=t;if(!n||!t.isValid)return;const{dependencyStore:r,values:s}=t;if(e.trigger("beforeDependencySave",{dependencyRecord:n,values:s})!==!1){var i;if(t.onBeforeSave(n),t.updateRecord(n),r&&!n.stores.length){if(e.trigger("beforeDependencyAdd",{dependencyRecord:n,dependencyEdit:t})===!1)return;r.add(n)}await((i=e.project)===null||i===void 0?void 0:i.commitAsync()),e.trigger("afterDependencySave",{dependencyRecord:n}),t.onAfterSave(n)}return n}async deleteDependency(){const{client:t,editor:e,dependencyRecord:n}=this;if(t.trigger("beforeDependencyDelete",{dependencyRecord:n})!==!1){var r;return e.containsFocus&&e.revertFocus(),t.dependencyStore.remove(n),await((r=t.project)===null||r===void 0?void 0:r.commitAsync()),!0}return!1}get dependencyStore(){return this.client.dependencyStore}onActivateEditor({dependency:t,event:e}){this.disabled||(this.lastPointerDownCoordinate=[e.clientX,e.clientY],this.editDependency(t))}}we._$name="DependencyEdit",H.registerFeature(we,!1);class J extends se.mixin(Oe){static get $name(){return"ScheduleContext"}construct(t,e){super.construct(t,e);const{triggerEvent:n}=this,r={datachange:"syncContextElement",timeaxisviewmodelupdate:"onTimeAxisViewModelUpdate",presetchange:"clearContext",thisObj:this};n==="mouseover"?r.timelineContextChange="onTimelineContextChange":((n==="click"||n==="mousedown")&&(r.schedulecontextmenu="onScheduleContextGesture"),Object.assign(r,{[`schedule${n}`]:"onScheduleContextGesture",[`event${n}`]:"onScheduleContextGesture",...r})),t.useBackgroundCanvas=!0,t.ion(r),t.rowManager.ion({rowheight:"syncContextElement",thisObj:this})}changeTriggerEvent(t){return(t==="hover"||t==="mousemove")&&(t="mouseover"),t}get element(){return this._element||(this._element=A.createElement({parent:this.client.backgroundCanvas,className:"b-schedule-selected-tick"}))}onTimelineContextChange({context:t}){this.context=t}onScheduleContextGesture(t){this.context=t}onTimeAxisViewModelUpdate({source:t}){var e;t.timeAxis.includes((e=this.context)===null||e===void 0?void 0:e.tick)?this.syncContextElement():this.clearContext()}clearContext(){this.context=null}updateContext(t,e){this.syncContextElement()}syncContextElement(){if(this.context&&this.enabled){const t=this,{client:e,element:n,context:r,renderer:s}=t,{isVertical:i}=e,{style:a}=n,o=i?e.rowManager.rows[0]:e.getRowFor(r.resourceRecord);if(o){const{tickStartDate:l,tickEndDate:c,resourceRecord:d}=r,u=e.currentOrientation.getTimeSpanRenderData({startDate:l,endDate:c,startDateMS:l.getTime(),endDateMS:c.getTime()},d);let g,h,f;i?(g=u.top,h=u.resourceWidth,f=u.height):(g=o.top,h=u.width,f=o.height),a.display="",a.width=`${h}px`,a.height=`${f}px`,A.setTranslateXY(n,u.left,g),r.index=o.index,n.innerHTML="",s&&t.callback(s,t,[r,n])}else a.display="none"}else this.element.style.display="none"}}F(J,"delayable",{syncContextElement:"raf"}),F(J,"configurable",{triggerEvent:"click",renderer:null,context:{$config:{equal(t,e){return(t==null?void 0:t.index)===(e==null?void 0:e.index)&&(t==null?void 0:t.tickParentIndex)===(e==null?void 0:e.tickParentIndex)&&!(((t==null?void 0:t.tickStartDate)||0)-((e==null?void 0:e.tickStartDate)||0))}}}}),J.featureClass="b-scheduler-context",J._$name="ScheduleContext",H.registerFeature(J,!1,["Scheduler"]);class G extends se{constructor(){super(...arguments);F(this,"clipboardRecords",[]);F(this,"entityName","event")}construct(e,n){super.construct(e,n),e.ion({eventclick:this.onEventClick,scheduleclick:this.onScheduleClick,projectChange:()=>{this.clearClipboard(),this._cellClickedContext=null},thisObj:this}),this.scheduler=e}onEventDataGenerated(e){const{assignmentRecord:n}=e;n&&(e.cls["b-cut-item"]=n.meta.isCut)}onEventClick(e){this._cellClickedContext=null}onScheduleClick(e){this._cellClickedContext=e}isActionAvailable({event:e}){var n;const r=this.client.features.cellEdit;return!this.disabled&&globalThis.getSelection().toString().length===0&&!(r!=null&&r.isEditing)&&!!e.target.closest(".b-timeaxissubgrid")&&!((n=this.client.focusedCell)!==null&&n!==void 0&&n.isSpecialRow)}copy(){this.copyEvents()}cut(){this.copyEvents(void 0,!0)}paste(){this.pasteEvents()}copyEvents(e=this.scheduler.selectedAssignments,n=!1){const r=this,{scheduler:s,entityName:i}=r;if(!(e!=null&&e.length))return;let a=e.slice();e[0].isEventModel&&(a=e.map(l=>l.assignments).flat()),n&&(a=a.filter(l=>!l.event.readOnly));const o=a.map(l=>l.event);!a.length||s.readOnly||s.trigger("beforeCopy",{assignmentRecords:a,records:o,eventRecords:o,isCut:n,entityName:i})===!1||(a.length>0&&s.trigger("copy",{assignmentRecords:a,eventRecords:o,isCut:n,entityName:i}),r._isCut=n,r.clipboard={assignmentRecords:a,eventRecords:o},s.assignmentStore.forEach(l=>{l.meta.isCut=n&&a.includes(l)}),s.refreshWithTransition())}pasteEvents(e,n){const r=this,{clipboard:s,scheduler:i,entityName:a}=r;if(!s)return;const{assignmentRecords:o,eventRecords:l}=s,c=r._isCut;let d;if(arguments.length===0){const m=r._cellClickedContext||{};e=m.date,n=m.resourceRecord}if(n&&(n.readOnly&&(d="resourceReadOnly"),n=n.$original),i.allowOverlap||o.some(v=>!i.isDateRangeAvailable(v.event.startDate,v.event.endDate,c?v.event:null,v.resource))&&(d="overlappingEvents"),d){i.trigger("pasteNotAllowed",{assignmentRecords:o,records:l,eventRecords:l,resourceRecord:n||o[0].resource,date:e,isCut:c,entityName:a,reason:d});return}if(!s||i.trigger("beforePaste",{assignmentRecords:o,records:l,eventRecords:l,resourceRecord:n||o[0].resource,date:e,isCut:c,entityName:a})===!1)return;let u=null;const g=new Set,h=[];for(const m of o){let{event:v}=m;const p=n||m.resource,R=e||m.event.startDate;if(g.has(v)){c&&m.remove();continue}if(g.add(v),c)m.meta.isCut=!1,m.resource=p,u=m;else if(i.eventStore.usesSingleAssignment||r.copyPasteAction==="clone")v=v.copy(),v.name=r.generateNewName(v),i.eventStore.add(v),v.assign(p),u=i.assignmentStore.last;else if(!v.resources.includes(p)){const S=m.copy();S.resource=p,[u]=i.assignmentStore.add(S)}v.startDate=R,v.constraintDate&&(v.constraintDate=null),h.push(v)}s&&i.trigger("paste",{assignmentRecords:o,pastedEventRecords:h,eventRecords:l,resourceRecord:n,date:e,isCut:c,entityName:a});const f=i.ion({renderEvent({assignmentRecord:m}){m===u&&(i.navigateTo(m,{scrollIntoView:!1}),f())}});c&&r.clearClipboard()}clearClipboard(){const e=this;e._isCut&&(e.clipboard.assignmentRecords.forEach(n=>{n.meta.isCut=!1}),e.scheduler.refreshWithTransition(),e._isCut=!1),e.clipboard=null}populateEventMenu({assignmentRecord:e,items:n}){const r=this,{scheduler:s}=r;s.readOnly||(n.copyEvent={text:"L{copyEvent}",localeClass:r,icon:"b-icon b-icon-copy",weight:110,onItem:()=>{const i=s.isAssignmentSelected(e)?s.selectedAssignments:[e];r.copyEvents(i)}},n.cutEvent={text:"L{cutEvent}",localeClass:r,icon:"b-icon b-icon-cut",weight:120,disabled:e.event.readOnly,onItem:()=>{const i=s.isAssignmentSelected(e)?s.selectedAssignments:[e];r.copyEvents(i,!0)}})}populateScheduleMenu({items:e,resourceRecord:n}){const r=this,{scheduler:s}=r;!s.readOnly&&r.clipboard&&(e.pasteEvent={text:"L{pasteEvent}",localeClass:r,icon:"b-icon b-icon-paste",disabled:s.resourceStore.count===0||n.readOnly,weight:110,onItem:({date:i,resourceRecord:a})=>r.pasteEvents(i,a,s.getRowFor(a))})}generateNewName(e){const n=e[this.nameField];let r=2;for(;this.client.eventStore.findRecord(this.nameField,`${n} - ${r}`);)r++;return`${n} - ${r}`}}F(G,"$name","EventCopyPaste"),F(G,"pluginConfig",{assign:["copyEvents","pasteEvents"],chain:["populateEventMenu","populateScheduleMenu","onEventDataGenerated"]}),F(G,"configurable",{nameField:"name",keyMap:{"Ctrl+C":"copy","Ctrl+X":"cut","Ctrl+V":"paste"},copyPasteAction:"clone"}),G.featureClass="b-event-copypaste",G._$name="EventCopyPaste",H.registerFeature(G,!0,"Scheduler");class de extends ut{static get $name(){return"EventDrag"}static get configurable(){return{constrainDragToResource:!1,constrainDragToTimeSlot:!1,externalDropTargetSelector:null,validatorFn:(t,e)=>{},validatorFnThisObj:null,unifiedDrag:null,snapToPosition:null,copyKey:"SHIFT",copyMode:"auto",mode:"move",capitalizedEventName:null}}afterConstruct(){this.capitalizedEventName=this.capitalizedEventName||this.client.capitalizedEventName,super.afterConstruct(...arguments)}changeMode(t){const{dragData:e,copyMode:n}=this;if((n==="event"||n==="auto"||n==="assignment"&&!this.scheduler.eventStore.usesSingleAssignment)&&(!e||e.eventRecords.every(r=>!r.isRecurring)))return t}updateMode(t){this.dragData&&(t==="copy"?this.setCopying():this.setMoving(),this.client.trigger("eventDragModeChange",{mode:t}))}setCopying(){const{dragData:t}=this;t&&(t.eventBarCopies.some(e=>e.isConnected)?t.eventBarCopies.forEach(e=>{e.classList.remove("b-hidden")}):t.eventBarCopies.forEach(e=>{e.classList.add("b-drag-proxy-copy"),e.classList.remove("b-hidden"),t.context.grabbedParent.appendChild(e),e.retainElement=!0}))}setMoving(){const{dragData:t}=this;t&&t.eventBarCopies.forEach(e=>{e.classList.add("b-hidden")})}get scheduler(){return this.client}onAfterDragStart(t){const e=this,{context:{element:n}}=t;super.onAfterDragStart(t),e.handleKeyDownOrMove(t.event),e.keyEventDetacher=X.on({element:A.getRootElement(n),keydown:e.handleKeyDownOrMove,keyup:e.handleKeyUp,thisObj:e})}onDragReset(t){var e;super.onDragReset(t),(e=this.keyEventDetacher)===null||e===void 0||e.call(this),this.mode="move"}onDrop(t){var e;return(e=this.dragData.eventBarCopies)===null||e===void 0||e.forEach(n=>n.remove()),super.onDrop(t)}getDraggableElement(t){return t==null?void 0:t.closest(this.drag.targetSelector)}resolveEventRecord(t,e=this.client){return e.resolveEventRecord(t)}isElementDraggable(t,e){var n;const r=this,{client:s}=r,i=r.getDraggableElement(t);if(!i||r.disabled||s.readOnly||t.matches('[class$="-handle"]'))return!1;const a=r.resolveEventRecord(i,s);return!a||!a.isDraggable||a.readOnly?!1:!(((n=s[`is${r.capitalizedEventName}ElementDraggable`])===null||n===void 0?void 0:n.call(s,i,a,t,e))===!1)}getTriggerParams(t){const{assignmentRecords:e,eventRecords:n,resourceRecord:r,browserEvent:s}=t;return{context:t,eventRecords:n,resourceRecord:r,assignmentRecords:e,event:s,domEvent:s}}triggerBeforeEventDrag(t,e){return this.client.trigger(t,e)}triggerEventDrag(t,e){this.client.trigger("eventDrag",Object.assign(this.getTriggerParams(t),{startDate:t.startDate,endDate:t.endDate,newResource:t.newResource}))}triggerDragStart(t){this.client.navigator.skipNextClick=!0,this.client.trigger("eventDragStart",this.getTriggerParams(t))}triggerDragAbort(t){this.client.trigger("eventDragAbort",this.getTriggerParams(t))}triggerDragAbortFinalized(t){this.client.trigger("eventDragAbortFinalized",this.getTriggerParams(t))}triggerAfterDrop(t,e){const n=this;if(n.currentOverClient.trigger("afterEventDrop",Object.assign(n.getTriggerParams(t),{valid:e})),!e){const{assignmentStore:r,eventStore:s}=n.client;n.dragData.initialAssignmentsState.find(({resource:a,assignment:o},l)=>{var c;return!r.includes(o)||!s.includes(o.event)||a.id!==((c=n.dragData.assignmentRecords[l])===null||c===void 0?void 0:c.resourceId)})&&n.client.refresh()}n.client.setTimeout(()=>n.client.navigator.skipNextClick=!1,10)}handleKeyDownOrMove(t){this.mode!=="copy"&&(t.key&&X.specialKeyFromEventKey(t.key)===this.copyKey.toLowerCase()||t[`${this.copyKey.toLowerCase()}Key`])&&(this.mode="copy")}handleKeyUp(t){X.specialKeyFromEventKey(t.key)===this.copyKey.toLowerCase()&&(this.mode="move")}isValidDrop(t){const{newResource:e,resourceRecord:n}=t,r=t.draggedEntities[0];return e?e.isSpecialRow||e.readOnly?!1:n!==e?!r.event.resources.includes(e):!0:!this.constrainDragToTimeline&&this.externalDropTargetSelector?!!t.browserEvent.target.closest(this.externalDropTargetSelector):!1}checkDragValidity(t,e){var o;var n;const r=this,s=r.currentOverClient;let i;if((n=t.newResource)!==null&&n!==void 0&&n.readOnly)return!1;if(!s.allowOverlap&&!s.isDateRangeAvailable(t.startDate,t.endDate,t.draggedEntities[0],t.newResource)?i={valid:!1,message:r.L("L{eventOverlapsExisting}")}:i=r.validatorFn.call(r.validatorFnThisObj||r,t,e),!i||i.valid){var a;i=(o=(a=s.checkEventDragValidity)===null||a===void 0?void 0:a.call(s,t,e))!=null?o:i}return i}async updateRecords(t){const e=this,n=e.client,r=e.currentOverClient,s=e.mode==="copy",{draggedEntities:i,timeDiff:a,initialAssignmentsState:o}=t,l=o[0].startDate,c=e.adjustStartDate(l,a);let d;return t.externalDropTarget||(r.timeAxis.timeSpanInAxis(c,x.add(c,i[0].event.durationMS,"ms"))||(t.valid=!1),t.valid&&(n.eventStore.suspendAutoCommit(),r.eventStore.suspendAutoCommit(),d=await e.updateAssignments(n,r,t,s),n.eventStore.resumeAutoCommit(),r.eventStore.resumeAutoCommit())),t.valid&&r.trigger("eventDrop",Object.assign(e.getTriggerParams(t),{isCopy:s,copyMode:e.copyMode,domEvent:t.browserEvent,targetEventRecord:t.targetEventRecord,targetResourceRecord:t.newResource,externalDropTarget:t.externalDropTarget})),d}async updateAssignments(t,e,n,r){const s=this,{copyMode:i}=s,a=t!==e,{isVertical:o}=e,{assignmentStore:l,eventStore:c}=t,{assignmentStore:d,eventStore:u}=e,g=t.isVertical?t.resourceStore:t.store,h=o?e.resourceStore:e.store,{eventRecords:f,assignmentRecords:m,timeDiff:v,initialAssignmentsState:p,resourceRecord:R,newResource:S}=n,{unifiedDrag:T}=s,b=u.usesSingleAssignment||u.usesSingleAssignment!==!1&&c.usesSingleAssignment,M=i==="event"?"event":i==="assignment"?"assignment":b?"event":"assignment",w=s.adjustStartDate(m[0].event.startDate,v),I=[],$=[],z=[],fe=[],ve=[],ee=new Set,te=g.getAllDataRecords();t.suspendRefresh(),e.suspendRefresh();let K=!1,xe=!1,_;a?_=h.indexOf(S)-g.indexOf(R):s.constainDragToResource?_=0:o&&h.isGrouped?_=te.indexOf(R)-te.indexOf(S):_=g.indexOf(R)-g.indexOf(S),o&&f.forEach((D,B)=>{const E=n.eventBarEls[B];delete D.instanceMeta(t).hasTemporaryDragElement,E.dataset.transient&&E.remove()});const pe=n.eventBarEls.slice(),N=[],ae={};for(let D=0;D<m.length;D++){const B=m[D];let E=B.event,C;if(r?(C=B.copy(),ae[B.id]=C):C=B,!C.isOccurrenceAssignment&&(!l.includes(B)||!c.includes(E))){pe[D].remove(),pe.splice(D,1),m.splice(D,1),D--;continue}const ne=p[D],W=E,re=ne.startDate,U=ne.resource,Ae=this.constrainDragToTimeSlot?re:T?w:s.adjustStartDate(re,v);if(l!==d){const P=W.assignments.length>1||r;let k;r?k=C:(k=C.copy(),ae[C.id]=k),k.event&&!b&&(k.event=k.event.id,k.resource=k.resource.id),r||fe.push(C),P||$.push(W),(r&&(i==="event"||i==="auto"&&u.usesSingleAssignment)||!u.getById(W.id))&&(E=u.createRecord({...W.data,id:r&&(i==="event"||i==="auto")?void 0:W.id,calendar:null}),k.set({eventId:E.id,event:E}),I.push(E)),b||z.push(k),C=k}let O=S,Me=null;if(!T)if(a){if(D>0){const P=g.indexOf(U);O=h.getAt(P+_)||O}}else if(_!==0){var Ee;let P;o&&h.isGrouped?(P=Math.max(Math.min(te.indexOf(U)-_,te.length-1),0),O=te[P]):(P=Math.max(Math.min(g.indexOf(U)-_,g.count-1),0),O=g.getAt(P),O.isSpecialRow&&(O=g.getNext(O,!1,!0)||g.getPrevious(O,!1,!0))),O=(Ee=O)===null||Ee===void 0?void 0:Ee.$original}else O=U;const Ie=C.resourceId!==O.id;if(Ie){if(Me=g.getById(C.resourceId),r&&l===d){C.setData({resource:null,resourceId:null}),C.resource=O,C.event=u.getById(C.eventId);const P=i==="event"||c.usesSingleAssignment&&i==="auto";P&&(E=E.copy(),E.meta.endDateCached=s.adjustStartDate(E.endDate,v),E.endDate=null,C.event=E,u.usesSingleAssignment&&(E.resource=O,E.resourceId=O.id)),!d.find(k=>k.eventId===C.eventId&&k.resourceId===C.resourceId)&&!z.find(k=>k.eventId===C.eventId&&k.resourceId===C.resourceId)&&(P&&I.push(E),z.push(C))}else C.resource=O;E.isEvent&&ee.add(E),K=!0,E.isOccurrence&&E.set("newResource",O),a&&b&&(E.resourceId=O.id)}else r&&(i==="event"||i==="auto"&&c.usesSingleAssignment)&&!I.includes(E)&&(E=E.copy(),E.meta.endDateCached=s.adjustStartDate(E.endDate,v),E.endDate=null,I.push(E),C.event=E,u.usesSingleAssignment&&E.set({resource:O,resourceId:O.id}),z.push(C));if(!ve.find(P=>P.draggedEvent===E)&&!x.isEqual(E.startDate,Ae)){for(;!E.isOccurrence&&E.isBatchUpdating;)E.endBatch(!0);r&&!a&&!b&&M==="assignment"&&Ie||(E.startDate=Ae,ve.push({draggedEvent:E,originalStartDate:re})),E.isEvent&&ee.add(E),xe=!0}e.processEventDrop({eventRecord:E,resourceRecord:O,element:D===0?n.context.element:n.context.relatedElements[D-1],context:n,toScheduler:e,reassignedFrom:Me,eventsToAdd:I,addedEvents:N,draggedAssignment:C}),e.trigger("processEventDrop",{originalAssignment:B,draggedAssignment:C,context:n,copyMode:i,isCopy:r})}if(l.remove(fe),c.remove($),d.add(z),r&&l===d){const{syncIdMap:D}=t.foregroundCanvas;Object.entries(ae).forEach(([B,E])=>{const C=D[B];delete D[B],D[E.id]=C})}if(I.length&&N.push(...u.add(I)),!s.constrainDragToTimeline)for(let D=0;D<m.length;D++){const B=ae[m[D].id]||m[D],E=B.event,C=(N==null?void 0:N.find(U=>U.id===E.id))||E,ne=n.eventBarEls[D],W=D===0?n.context.element:n.context.relatedElements[D-1],re=e.isInTimeAxis(C);if(delete C.meta.endDateCached,r||q.removeChild(ne.parentElement,ne),C.resource&&(o||e.rowManager.getRowFor(C.resource))&&re){if(!C.parent||C.parent.isRoot){const U=L.from(W,e.foregroundCanvas,!0);A.setTopLeft(W,U.y,U.x),q.addChild(e.foregroundCanvas,W,C.assignments[0].id),a&&e.processCrossSchedulerEventDrop({eventRecord:C,toScheduler:e})}W.classList.remove("b-sch-event-hover","b-active","b-drag-proxy","b-dragging"),W.retainElement=!1}}N==null||N.forEach(D=>ee.add(D)),(fe.length||$.length||z.length||I.length)&&(K=!0),(K||xe)&&(b&&ee.forEach(D=>D.beginBatch()),await Promise.all([e.project!==t.project?e.project.commitAsync():null,t.project.commitAsync()]),b&&ee.forEach(D=>D.endBatch(!1,!0))),K||(K=ve.some(({draggedEvent:D,originalStartDate:B})=>!x.isEqual(D.startDate,B))),e.resumeRefresh(),t.resumeRefresh(),m.length>0&&(K?(pe.forEach(D=>delete D.lastDomConfig),e.refreshWithTransition(),a&&(t.refreshWithTransition(),e.selectedEvents=N)):n.valid=!1)}getProductDragContext(t){const e=this,{currentOverClient:n}=e,r=t.browserEvent.target,s=t.newResource||t.resourceRecord,i=t.targetEventRecord;let a=n?e.resolveEventRecord(r,n):null,o,l;t.eventRecords.includes(a)&&(a=null),e.constrainDragToResource?o=t.resourceRecord:e.constrainDragToTimeline?n&&(o=e.resolveResource()||t.newResource||t.resourceRecord):o=e.resolveResource();const{assignmentRecords:c,eventRecords:d}=t,u=s!==o;let g=!!(o&&!o.isSpecialRow);return!o&&e.externalDropTargetSelector&&(l=r.closest(e.externalDropTargetSelector),g=!!l),{valid:g,externalDropTarget:l,eventRecords:d,assignmentRecords:c,newResource:o,targetEventRecord:a,dirty:u||a!==i,proxyElements:[t.context.element,...t.context.relatedElements||[]]}}getMinimalDragData(t){const e=this,{scheduler:n}=e,r=e.getElementFromContext(t),s=e.resolveEventRecord(r,n),i=n.resolveResourceRecord(r),a=n.resolveAssignmentRecord(r),o=a?[a]:[];a&&(n.isAssignmentSelected(o[0])||e.drag.startEvent.ctrlKey&&n.multiEventSelect)&&o.push.apply(o,e.getRelatedRecords(a));const l=[...new Set(o.map(c=>c.event))];return{eventRecord:s,resourceRecord:i,assignmentRecord:a,eventRecords:l,assignmentRecords:o}}setupProductDragData(t){var e;const n=this,{scheduler:r}=n,s=n.getElementFromContext(t),{eventRecord:i,resourceRecord:a,assignmentRecord:o,assignmentRecords:l}=n.getMinimalDragData(t),c=[];if(n.constrainDragToResource&&!a)throw new Error("Resource could not be resolved for event: "+i.id);let d;if(n.constrainDragToTimeline){var u;d=(u=n.getDateConstraints)===null||u===void 0?void 0:u.call(n,a,i);const g=n.constrainRectangle=n.getConstrainingRectangle(d,a,i),h=L.from(s,r.timeAxisSubGridElement);super.setupConstraints(g,h,r.timeAxisViewModel.snapPixelAmount,!!d.start)}return l.forEach(g=>{let h=r.getElementFromAssignmentRecord(g,!0);h||(h=r.currentOrientation.addTemporaryDragElement(g.event,g.resource)),c.push(h)}),{record:o,draggedEntities:l,dateConstraints:(e=d)!==null&&e!==void 0&&e.start?d:null,eventBarCopies:c.map(g=>n.createProxy(g)),eventBarEls:c}}getDateConstraints(t,e){var n;const{scheduler:r}=this,s=(n=r.getDateConstraints)===null||n===void 0?void 0:n.call(r,t,e);let i,a;return this.constrainDragToTimeSlot?(i=e.startDate,a=e.endDate):s&&(i=s.start,a=s.end),{start:i,end:a}}getConstrainingRectangle(t,e,n){return this.scheduler.getScheduleRegion(this.constrainDragToResource&&e,n,!0,t&&{start:t.start,end:t.end})}getDragData(t){const e=this.getMinimalDragData(t)||{};return{...super.getDragData(t),...e,initialAssignmentsState:e.assignmentRecords.map(n=>({startDate:n.event.startDate,resource:n.resource,assignment:n}))}}getRelatedRecords(t){return this.scheduler.selectedAssignments.filter(e=>e!==t&&!e.resource.readOnly&&e.event.isDraggable)}getCoordinate(t,e,n){const r=this.currentOverClient;if(r.isHorizontal){let s=n[0];if(r.milestoneLayoutMode!=="default"&&t.isMilestone)switch(r.milestoneAlign){case"center":s+=e.offsetWidth/2;break;case"end":s+=e.offsetWidth;break}return s}else{let s=n[1];if(r.milestoneLayoutMode!=="default"&&t.isMilestone)switch(r.milestoneAlign){case"center":s+=e.offsetHeight/2;break;case"end":s+=e.offsetHeight;break}return s}}resolveResource(){const t=this,e=t.currentOverClient,{isHorizontal:n}=e,{context:r,browserEvent:s,dragProxy:i}=t.dragData,a=i||r.element,o=L.from(a,null,!0),l=e.isVertical||t.unifiedDrag?r.clientY:o.center.y,c=L.from(a,e.timeAxisSubGridElement,!0),{x:d,y:u}=c.center,g=t.getMouseMoveEventTarget(s);let h=null;if(e.element.contains(g))if(n){const f=e.rowManager.getRowAt(l);h=f&&e.store.getAt(f.dataIndex)}else h=e.resolveResourceRecord(e.timeAxisSubGridElement.querySelector(".b-sch-timeaxis-cell"),[d,u]);return h}adjustStartDate(t,e){const n=this.currentOverClient;return t=n.timeAxis.roundDate(new Date(t-0+e),n.snapRelativeToEventStartDate?t:!1),this.constrainStartDate(t)}getRecordElement(t){return this.client.getElementFromAssignmentRecord(t,!0)}getProxyElement(t){if(this.isDragging){const e=this.dragData.assignmentRecords.indexOf(t);if(e>=0)return this.dragData.proxyElements[e]}return null}getMouseMoveEventTarget(t){return t.target}}de._$name="EventDrag",H.registerFeature(de,!0,"Scheduler"),H.registerFeature(de,!1,"ResourceHistogram");class Q extends ht{get scheduler(){return this.client}get store(){return this.client.eventStore}get project(){return this.client.project}updateLockLayout(t){this.dragActiveCls=`b-dragcreating${t?" b-dragcreate-lock":""}`}handleBeforeDragCreate(t,e,n){var r;const{resourceRecord:s}=t;if(s.readOnly||!this.scheduler.resourceStore.isAvailable(s))return!1;const{scheduler:i}=this,a=!i.isSchedulerPro||e.ignoreResourceCalendar||s.isWorkingTime(t.mousedownDate),o=a&&i.trigger("beforeDragCreate",{resourceRecord:s,date:t.mousedownDate,event:n});return this.dateConstraints=(r=i.getDateConstraints)===null||r===void 0?void 0:r.call(i,s,e),o}dragStart(t){var e;const n=this,{client:r}=n,{eventStore:s,assignmentStore:i,enableEventAnimations:a}=r,{resourceRecord:o}=t,l=n.createEventRecord(t),c=[o];if(l.set("duration",x.diff(l.startDate,l.endDate,l.durationUnit,!0)),l.isCreating=!0,l.meta.isDragCreating=!0,r.features.taskEdit&&r.features.taskEdit.doCancel(),n.handleBeforeDragCreate(t,l,t.event)===!1)return!1;n.captureStm(!0);let d=[];return o&&(d=i.assignEventToResource(l,o)),r.trigger("beforeEventAdd",{eventRecord:l,resourceRecords:c,assignmentRecords:d})===!1?(i.remove(d),!1):(n.lockLayout&&(l.meta.excludeFromLayout=!0),(e=r.onEventCreated)===null||e===void 0||e.call(r,l),r.enableEventAnimations=!1,s.addAsync(l).then(()=>r.enableEventAnimations=a),r.isCreating=!0,r.refreshRows(),r.isCreating=!1,t.itemElement=t.element=r.getElementFromEventRecord(l),A.isInView(t.itemElement)||r.scrollable.scrollIntoView(t.itemElement,{animate:!0,edgeOffset:r.barMargin}),super.dragStart(t))}checkValidity(t,e){const n=this,{client:r}=n;return t.resourceRecord=n.dragging.resourceRecord,(r.allowOverlap||r.isDateRangeAvailable(t.startDate,t.endDate,t.eventRecord,t.resourceRecord))&&n.createValidatorFn.call(n.validatorFnThisObj||n,t,e)}isRowEmpty(t){const e=this.store.getEventsForResource(t);return!e||!e.length}triggerBeforeFinalize(t){this.client.trigger("beforeDragCreateFinalize",t)}createEventRecord(t){const e=this,{client:n}=e,r=n.isHorizontal?"X":"Y",{timeAxis:s,eventStore:i,weekStartDay:a}=n,{event:o,mousedownDate:l}=t,c=e.draggingEnd=o[`page${r}`]>t.startEvent[`page${r}`],d={name:i.modelClass.fieldMap.name.defaultValue||e.L("L{Object.newEvent}"),startDate:c?x.floor(l,s.resolution,null,a):l,endDate:c?l:x.ceil(l,s.resolution,null,a)};return n.project.isGanttProjectMixin&&V.assign(d,{constraintDate:d.startDate,constraintType:"startnoearlierthan"}),i.createRecord(d)}async internalUpdateRecord(t,e){await super.internalUpdateRecord(t,e),this.client.hasEventEditor||(t.eventRecord.isCreating=!1)}async finalizeDragCreate(t){const{meta:e}=t.eventRecord;e.excludeFromLayout=!1,e.isDragCreating=!1;const n=await super.finalizeDragCreate(t);return n?this.hasStmCapture=!1:this.freeStm(!0),n}async cancelDragCreate(t){await super.cancelDragCreate(t),this.freeStm(!1)}getTipHtml(...t){const e=super.getTipHtml(...t),{element:n}=this.tip;return n.classList.add("b-sch-dragcreate-tooltip"),n.classList.toggle("b-too-narrow",this.dragging.context.tooNarrow),e}onAborted(t){var e,n;const{eventRecord:r,resourceRecord:s}=t;(e=(n=this.store).unassignEventFromResource)===null||e===void 0||e.call(n,r,s),this.store.remove(r)}}F(Q,"$name","EventDragCreate"),F(Q,"configurable",{validatorFn:()=>!0,lockLayout:!1}),Q._$name="EventDragCreate",H.registerFeature(Q,!0,"Scheduler"),H.registerFeature(Q,!1,"ResourceHistogram");const ze=[0,0],yt=[null,[0,10],[10,0]];class ue extends gt{static get $name(){return"EventTooltip"}static get defaultConfig(){return{template:t=>`
                ${t.eventRecord.name?ie.xss`<div class="b-sch-event-title">${t.eventRecord.name}</div>`:""}
                ${t.startClockHtml}
                ${t.endClockHtml}`,cls:"b-sch-event-tooltip",monitorRecordUpdate:!0,scrollAction:"hide"}}construct(t,e){const n=this;super.construct(t,e),typeof n.align=="string"&&(n.align={align:n.align})}onPaint({firstPaint:t}){if(super.onPaint(...arguments),t){const e=this,n=e.client.features.dependencies;n&&e.tooltip.ion({beforeAlign({source:r,offset:s=ze}){const{edgeAligned:i}=Je(r.align.align),a=n.disabled?ze:yt[i];arguments[0].offset=[s[0]+a[0],s[1]+a[1]]}})}}}ue._$name="EventTooltip",H.registerFeature(ue,!0,"Scheduler"),H.registerFeature(ue,!1,"ResourceHistogram");const Rt={width:0,height:0};class Y extends se{construct(t,e){super.construct(t,e),t.isVertical&&(this.toUpdate=new Set,t.ion({scroll:"onSchedulerScroll",horizontalScroll:"onHorizontalScroll",thisObj:this,prio:1e4}))}onEventDataGenerated(t){this.client.isHorizontal?t.wrapperCls["b-disable-sticky"]=t.eventRecord.stickyContents===!1:(this.syncEventContentPosition(t,void 0,!0),this.updateStyles())}onSchedulerScroll(){this.disabled||this.verticalSyncAllEventsContentPosition(this.client)}onHorizontalScroll({subGrid:t}){t===this.client.timeAxisSubGrid&&this.verticalSyncAllEventsContentPosition(this.client)}updateStyles(){for(const{contentEl:t,style:e}of this.toUpdate)A.applyStyle(t,e);this.toUpdate.clear()}verticalSyncAllEventsContentPosition(t){const{resourceMap:e}=t.currentOrientation;for(const n of e.values())for(const{renderData:r,elementConfig:s}of Object.values(n)){const i=[r];s&&r.eventRecord.isResourceTimeRange&&i.push(s.children[0]),this.syncEventContentPosition.apply(this,i)}this.toUpdate.size&&this.updateStyles()}syncEventContentPosition(t,e=t.eventContent,n=!1){if(this.disabled||t.eventRecord.stickyContents===!1)return;const{client:r}=this,{eventRecord:s,resourceRecord:i,useEventBuffer:a,bufferAfterWidth:o,bufferBeforeWidth:l,top:c,height:d}=t,u=r.scrollable.y,g=n?null:r.getElementFromEventRecord(s,i,!0),h=g&&q.getChild(g,"event.content"),f=s.instanceMeta(r),m=typeof e.style=="string"?e.style=A.parseStyle(e.style):e.style||(e.style={});if(g!=null&&g.classList.contains("b-dragging"))return;let v=c,p=d,R=v+p;if(a&&(v+=l,p=p-l-o,R=v+p),v<u&&R>=u&&!s.isMilestone){const S=h==null?void 0:h.offsetWidth,T=(h==null?void 0:h.parentNode)&&A.getStyleValue(h.parentNode,"justifyContent"),b=T==="center"?(t.width-S)/2:0,M=v,w=M+p-1;if((!h||S)&&M<u&&w>=u){const I=this.getEventContentMargins(h),$=h?p-h.offsetHeight-I.height-b:Number.MAX_SAFE_INTEGER,z=Math.min(u-M,$-2);m.transform=z>0?`translateY(${z}px)`:"",f.stuck=!0}else m.transform="",f.stuck=!1;h&&this.toUpdate.add({contentEl:h,style:m})}else h&&f.stuck&&(m.transform="",f.stuck=!1,this.toUpdate.add({contentEl:h,style:m}))}getEventContentMargins(t){return t!=null&&t.classList.contains("b-sch-event-content")?A.getEdgeSize(t,"margin"):Rt}doDisable(){super.doDisable(...arguments),this.isConfiguring||this.client.refreshWithTransition()}}F(Y,"$name","StickyEvents"),F(Y,"type","stickyEvents"),F(Y,"pluginConfig",{chain:["onEventDataGenerated"]}),Y._$name="StickyEvents",H.registerFeature(Y,!0,"Scheduler"),H.registerFeature(Y,!1,"ResourceHistogram");class he extends mt.mixin(oe){static get $name(){return"TimeRanges"}static get defaultConfig(){return{store:!0}}doDestroy(){var t;(t=this.storeDetacher)===null||t===void 0||t.call(this),super.doDestroy()}get timeRanges(){const t=this;if(!t._timeRanges){const{store:e}=t;let{records:n}=e;if(e.recurringEvents){const{startDate:r,endDate:s}=t.client.timeAxis;n=n.flatMap(i=>i.isRecurring?i.getOccurrencesForDateRange(r,s):i)}t.currentTimeLine&&(e.recurringEvents||(n=n.slice()),n.push(t.currentTimeLine)),t._timeRanges=n}return t._timeRanges}attachToProject(t){var e;super.attachToProject(t);const n=this;if((e=n.projectTimeZoneChangeDetacher)===null||e===void 0||e.call(n),n.showCurrentTimeLine){var r;n.projectTimeZoneChangeDetacher=(r=n.client.project)===null||r===void 0?void 0:r.ion({timeZoneChange:()=>n.updateCurrentTimeLine()}),n.currentTimeLine&&n.updateCurrentTimeLine()}}initCurrentTimeLine(){const t=this;if(t.currentTimeLine||!t.showCurrentTimeLine)return;const e=typeof t.showCurrentTimeLine=="object"?t.showCurrentTimeLine:{};t.currentTimeLine=t.store.modelClass.new({id:"currentTime",cls:"b-sch-current-time"},e),t.currentTimeInterval=t.setInterval(()=>t.updateCurrentTimeLine(),t.currentTimeLineUpdateInterval),t._timeRanges=null,t.updateCurrentTimeLine()}updateCurrentTimeLine(){var t;const e=this,{currentTimeLine:n}=e;n.timeZone=(t=e.project)===null||t===void 0?void 0:t.timeZone,n.setLocalDate("startDate",new Date),n.endDate=n.startDate,n.originalData.name||(n.name=x.format(n.startDate,e.currentDateFormat)),e.renderRanges()}hideCurrentTimeLine(){const t=this;t.currentTimeLine&&(t.clearInterval(t.currentTimeInterval),t.currentTimeLine=null,t.refresh())}updateShowCurrentTimeLine(t){t?this.initCurrentTimeLine():this.hideCurrentTimeLine()}populateTimeAxisHeaderMenu({column:t,items:e}){e.currentTimeLine={weight:400,text:this.L("L{showCurrentTimeLine}"),checked:this.showCurrentTimeLine,onToggle:({checked:n})=>{this.showCurrentTimeLine=n}}}attachToStore(t){const e=this;let n=!1;e.storeDetacher&&(e.storeDetacher(),n=!0),e.storeDetacher=t.ion({change:"onStoreChange",refresh:"onStoreChange",thisObj:e}),e._timeRanges=null,n&&e.renderRanges()}get store(){return this.client.project.timeRangeStore}updateStore(t){const e=this,{client:n}=e,{project:r}=n;t=r.timeRangeStore,e.attachToStore(t),n.timeRanges&&!n._timeRangesExposed&&(t.add(n.timeRanges),delete n.timeRanges)}attachToTimeRangeStore(t){this.store=t}resolveTimeRangeRecord(t){return this.store.getById(t.closest(this.baseSelector).dataset.id)}onStoreChange({type:t,action:e}){const n=this;n._timeRanges=null,!(n.disabled||!n.client.isVisible||n.isConfiguring||t==="refresh"&&e!=="batch")&&n.client.runWithTransition(()=>n.renderRanges(),!n.client.refreshSuspended)}onDragStart(t){const e=this,{context:n}=t,r=e.resolveTimeRangeRecord(n.element.closest(e.baseSelector)),s=e.getBodyElementByRecord(r);n.relatedElements=[s],Object.assign(n,{record:r,rangeBodyEl:s,originRangeX:A.getTranslateX(s),originRangeY:A.getTranslateY(s)}),super.onDragStart(t),e.showTip(n)}onDrop(t){const{context:e}=t;if(!e.valid)return this.onInvalidDrop({context:e});const n=this,{client:r}=n,{record:s}=e,i=L.from(e.rangeBodyEl),a=r.getDateFromCoordinate(i.getStart(r.rtl,r.isHorizontal),"round",!1);s.startDate-a!==0?s.setStartDate(a):n.onInvalidDrop(),n.destroyTip(),super.onDrop(t)}onResizeStart({context:t}){const e=this,n=e.resolveTimeRangeRecord(t.element.closest(e.baseSelector)),r=e.getBodyElementByRecord(n);Object.assign(t,{record:n,rangeBodyEl:r}),e.showTip(t)}onResizeDrag({context:t}){const e=this,{rangeBodyEl:n}=t;e.client.isVertical?(t.edge==="top"&&A.setTranslateY(n,t.newY),n.style.height=t.newHeight+"px"):(t.edge==="left"&&A.setTranslateX(n,t.newX),n.style.width=t.newWidth+"px")}onResize({context:t}){if(!t.valid)return this.onInvalidDrop({context:t});const e=this,{client:n}=e,{rtl:r}=n,s=t.record,i=L.from(t.element),a=i.getStart(r,n.isHorizontal),o=i.getEnd(r,n.isHorizontal),l=n.getDateFromCoordinate(a,"round",!1),c=r&&t.edge==="right"||!r&&t.edge==="left"||t.edge==="top",d=n.getDateFromCoordinate(o,"round",!1);(c&&s.startDate-l!==0||d&&s.endDate-d!==0)&&d>l?c?s.setStartDate(l,!1):s.setEndDate(d,!1):e.onInvalidResize({context:t}),e.destroyTip()}onInvalidResize({context:t}){const e=this;e.resize.reset(),t.rangeBodyEl.parentElement.lastDomConfig=t.rangeBodyEl.lastDomConfig=null,e.renderRanges(),e.destroyTip()}}F(he,"configurable",{store:{modelClass:lt},currentTimeLineUpdateInterval:1e4,currentDateFormat:"HH:mm",showCurrentTimeLine:!1}),he._$name="TimeRanges",H.registerFeature(he,!1,["Scheduler","Gantt"]);var Ve=y=>class extends(y||j){static get $name(){return"SchedulerDom"}getElementFromAssignmentRecord(e,n=!1){if(this.isPainted&&e){var r,s,i;let o=(r=this.foregroundCanvas.syncIdMap)===null||r===void 0?void 0:r[e.id];if(!o&&e.resource.hasLinks)for(const l of e.resource.$links){var a;if(o=(a=this.foregroundCanvas.syncIdMap)===null||a===void 0?void 0:a[`${e.id}_${l.id}`],o)break}return n?o:(s=o)===null||s===void 0||(i=s.syncIdMap)===null||i===void 0?void 0:i.event}return null}getElementFromEventRecord(e,n=(()=>{var s;return(s=e.resources)===null||s===void 0?void 0:s[0]})(),r=!1){if(e.isResourceTimeRange){var s;const a=(s=this.foregroundCanvas.syncIdMap)===null||s===void 0?void 0:s[e.domId];return r?a:a==null?void 0:a.syncIdMap.event}const i=this.assignmentStore.getAssignmentForEventAndResource(e,n);return this.getElementFromAssignmentRecord(i,r)}getElementsFromEventRecord(e,n,r=!1){return n?[this.getElementFromEventRecord(e,n,r)]:e.resources.reduce((s,i)=>{const a=this.getElementFromEventRecord(e,i,r);return a&&s.push(a),s},[])}resolveResourceRecord(e,n){return this.currentOrientation.resolveRowRecord(e,n)}resolveRowRecord(e){return this.resolveResourceRecord(e)}resolveEventRecord(e){var n;e instanceof Event&&(e=e.target);const r=(n=e)===null||n===void 0?void 0:n.closest(this.eventSelector);if(r){if(r.dataset.eventId)return this.eventStore.getById(r.dataset.eventId);if(r.dataset.assignmentId)return this.assignmentStore.getById(r.dataset.assignmentId).event}return null}resolveTimeSpanRecord(e){return this.resolveEventRecord(e)}resolveAssignmentRecord(e){const n=e.closest(this.eventSelector),r=n&&this.assignmentStore.getById(n.dataset.assignmentId),s=n&&this.eventStore.getById(n.dataset.eventId);return this.assignmentStore.getOccurrence(r,s)}isRowVisible(e){return this.store.indexOf(e)>=0}get widgetClass(){}},He=y=>class extends(y||j){static get $name(){return"SchedulerDomEvents"}getTimeSpanMouseEventParams(e,n){const r=this.resolveEventRecord(e);return r&&{eventRecord:r,resourceRecord:this.resolveResourceRecord(e),assignmentRecord:this.resolveAssignmentRecord(e),eventElement:e,event:n}}getScheduleMouseEventParams(e,n){return{resourceRecord:this.isVertical?this.resolveResourceRecord(n):this.store.getById(e.id)}}onElementKeyDown(e){const n=super.onElementKeyDown(e),r=this;return r.selectedEvents.length&&r.trigger(r.scheduledEventName+"KeyDown",{eventRecords:r.selectedEvents,assignmentRecords:r.selectedAssignments,event:e,eventRecord:r.selectedEvents,assignmentRecord:r.selectedAssignments}),n}onElementKeyUp(e){super.onElementKeyUp(e);const n=this;n.selectedEvents.length&&n.trigger(n.scheduledEventName+"KeyUp",{eventRecords:n.selectedEvents,assignmentRecords:n.selectedAssignments,event:e,eventRecord:n.selectedEvents,assignmentRecord:n.selectedAssignments})}get widgetClass(){}},We=y=>class extends(y||j){static get $name(){return"SchedulerEventRendering"}static get configurable(){return{milestoneTextPosition:"outside",milestoneAlign:"center",milestoneCharWidth:10,milestoneLayoutMode:"default",eventLayout:"stack",overlappingEventSorter:null,horizontalEventSorterFn:null,resourceMargin:null,useInitialAnimation:!0,eventRenderer:null,eventRendererThisObj:null,eventBarTextField:"name",eventBodyTemplate:null,horizontalLayoutPackClass:Ce,horizontalLayoutStackClass:Se,resourceColumns:null,resourceImagePath:null,defaultResourceImageName:null,resourceImageExtension:".jpg",isFirstRender:!0,initialAnimationDuration:2e3,narrowEventWidth:10,internalEventLayout:null,eventPositionMode:"translate",eventScrollMode:"move"}}changeEventLayout(e){return this.internalEventLayout=e,this.internalEventLayout.type}changeInternalEventLayout(e){return this.getEventLayout(e)}updateInternalEventLayout(e,n){const r=this;n&&r.element.classList.remove(`b-eventlayout-${n.type}`),r.element.classList.add(`b-eventlayout-${e.type}`),r.isConfiguring||(r.refreshWithTransition(),r.trigger("stateChange"))}changeHorizontalEventSorterFn(e){Fe.deprecate("Scheduler","6.0.0","Replaced by overlappingEventSorter()"),this.overlappingEventSorter=e}updateOverlappingEventSorter(e){this.isConfiguring||this.refreshWithTransition()}getEventLayout(e){var n;return(n=e)!==null&&n!==void 0&&n.isModel&&(e=e.eventLayout||this.internalEventLayout),typeof e=="string"&&(e={type:e}),e}getEventLayoutHandler(e){const n=this;if(!n.isHorizontal)return null;const{timeAxisViewModel:r,horizontal:s}=n,{type:i}=e;switch(n.layouts||(n.layouts={}),i){case"stack":return n.layouts.horizontalStack||(n.layouts.horizontalStack=new n.horizontalLayoutStackClass(V.assign({scheduler:n,timeAxisViewModel:r,bandIndexToPxConvertFn:s.layoutEventVerticallyStack,bandIndexToPxConvertThisObj:s},e))),n.layouts.horizontalStack;case"pack":return n.layouts.horizontalPack||(n.layouts.horizontalPack=new n.horizontalLayoutPackClass(V.assign({scheduler:n,timeAxisViewModel:r,bandIndexToPxConvertFn:s.layoutEventVerticallyPack,bandIndexToPxConvertThisObj:s},e))),n.layouts.horizontalPack;default:return null}}get resourceColumns(){var e;return((e=this.timeAxisColumn)===null||e===void 0?void 0:e.resourceColumns)||this._resourceColumns}get resourceColumnWidth(){var e;return((e=this.resourceColumns)===null||e===void 0?void 0:e.columnWidth)||null}getEventsToRender(e,n){return n}repaintEventsForResource(e){this.currentOrientation.repaintEventsForResource(e)}repaintEvent(e){this.eventStore.getResourcesForEvent(e).forEach(r=>this.repaintEventsForResource(r))}getResourceMargin(e){var n;return(n=e==null?void 0:e.resourceMargin)!=null?n:this.resourceMargin}getBarMargin(e){var n;return(n=e==null?void 0:e.barMargin)!=null?n:this.barMargin}getResourceHeight(e){var n;return(n=e.rowHeight)!=null?n:this.isHorizontal?this.rowHeight:this.getResourceWidth(e)}getResourceWidth(e){var n;return(n=e.columnWidth)!=null?n:this.resourceColumnWidth}getAppliedResourceHeight(e){var r;const n=this.getRowById(e);return(r=n==null?void 0:n.maxRequestedHeight)!=null?r:this.getResourceHeight(e)}getResourceLayoutSettings(e,n=null){const r=this.getResourceMargin(e,n),s=this.getAppliedResourceHeight(e,n);return{barMargin:this.getBarMargin(e,n),contentHeight:Math.max(s-r*2,1),rowHeight:s,resourceMargin:r}}getEventStyle(e,n){return e.eventStyle||n.eventStyle||this.eventStyle}getEventColor(e,n){var r,s;return e.eventColor||((r=e.event)===null||r===void 0?void 0:r.eventColor)||((s=e.parent)===null||s===void 0?void 0:s.eventColor)||n.eventColor||this.eventColor}generateRenderData(e,n,r={viewport:!0}){const s=this,i=s.currentOrientation.getTimeSpanRenderData(e,n,r),{isEvent:a}=e,{eventResize:o}=s.features,l=!e.meta.isDragCreating&&e.isMilestone,c=a&&e.assignments.find(h=>h.resourceId===n.$originalId),d={className:"b-sch-event-content",role:"presentation",dataset:{taskBarFeature:"content"}};if(i){var u;i.tabIndex="0";let h=e.isResizable;o&&h&&(i.startsOutsideView&&(h===!0?h="end":h==="start"&&(h=!1)),i.endsOutsideView&&(h===!0?h="start":h==="end"&&(h=!1)),h&&(s.isHorizontal?!s.rtl&&!o.leftHandle||s.rtl&&!o.rightHandle?h=h==="start"?!1:"end":(!s.rtl&&!o.rightHandle||s.rtl&&!o.leftHandle)&&(h=h==="end"?!1:"start"):o.topHandle?o.bottomHandle||(h=h==="end"?!1:"start"):h=h==="start"?!1:"end"));const f=!!(e.hasPersistableChanges||c!=null&&c.hasPersistableChanges),m={[n.cls]:n.cls,[s.generatedIdCls]:!e.isOccurrence&&e.hasGeneratedId,[s.dirtyCls]:f,[s.committingCls]:e.isCommitting,[s.endsOutsideViewCls]:i.endsOutsideView,[s.startsOutsideViewCls]:i.startsOutsideView,"b-clipped-start":i.clippedStart,"b-clipped-end":i.clippedEnd,"b-iscreating":e.isCreating,"b-rtl":s.rtl},v={[`${s.eventCls}-parent`]:n.isParent,"b-readonly":e.readOnly||(c==null?void 0:c.readOnly),"b-linked-resource":n.isLinked,"b-original-resource":n.hasLinks},p=e.isResourceTimeRange?new Z:e.internalCls.clone(),R=e.isResourceTimeRange?e.internalCls.clone():new Z;if(i.wrapperStyle="",i.isWrap=!0,a){const b=c&&s.isAssignmentSelected(c);V.assign(m,{[s.eventCls]:1,"b-milestone":l,"b-sch-event-narrow":!l&&i.width<s.narrowEventWidth,[s.fixedEventCls]:e.isDraggable===!1,[`b-sch-event-resizable-${h}`]:!!(o&&!e.readOnly),[s.eventSelectedCls]:b,[s.eventAssignHighlightCls]:s.eventAssignHighlightCls&&!b&&s.isEventSelected(e),"b-recurring":e.isRecurring,"b-occurrence":e.isOccurrence,"b-inactive":e.inactive}),i.eventId=e.id;const M=s.getEventStyle(e,n),w=s.getEventColor(e,n),I=s.isFirstRender&&s.useInitialAnimation&&globalThis.bryntum.noAnimations!==!0;if(V.assign(v,{[`${s.eventCls}-wrap`]:1,"b-milestone-wrap":l}),I){const $=i.row?i.row.index:(i.top-s.scrollTop)/s.tickSize,z=$/20*1e3;i.wrapperStyle=`animation-delay: ${z}ms;`,s.maxDelay=Math.max(s.maxDelay||0,z),s.initialAnimationDetacher||(s.initialAnimationDetacher=X.on({element:s.foregroundCanvas,delegate:s.eventSelector,once:!0,animationend:()=>s.setTimeout({fn:"stopInitialAnimation",delay:s.maxDelay,cancelOutstanding:!0}),expires:{alt:"stopInitialAnimation",delay:s.initialAnimationDuration+s.maxDelay},thisObj:s}))}i.eventColor=w,i.eventStyle=M,i.assignmentRecord=i.assignment=c}if(i.wrapperCls=V.assign(R,v),i.cls=V.assign(p,m),i.iconCls=new Z(e.get(s.eventBarIconClsField)||e.iconCls),e.isResourceTimeRange?(i.style="",i.wrapperStyle+=e.style||""):i.style=e.style||"",i.resource=i.resourceRecord=n,i.resourceId=i.rowId,a){let b=null,M=null,w;if(s.eventRenderer){const I=s.eventRenderer.call(s.eventRendererThisObj||s,{eventRecord:e,resourceRecord:n,assignmentRecord:i.assignmentRecord,renderData:i});typeof i.cls=="string"&&(i.cls=new Z(i.cls)),typeof i.wrapperCls=="string"&&(i.wrapperCls=new Z(i.wrapperCls)),typeof i.iconCls=="string"&&(i.iconCls=new Z(i.iconCls)),s.eventBodyTemplate?w=s.eventBodyTemplate(I):w=I}else s.eventBodyTemplate?w=s.eventBodyTemplate(e):s.eventBarTextField&&(w=ie.encodeHtml(e[s.eventBarTextField]||""));if(!s.eventBodyTemplate||Array.isArray(w)){var g;d.children=[],l&&(s.milestoneLayoutMode==="default"||s.milestoneTextPosition==="always-outside")&&w!=null&&w!==""&&d.children.unshift(M={tag:"label",children:[]}),(g=i.iconCls)!==null&&g!==void 0&&g.length&&d.children.unshift({tag:"i",className:i.iconCls}),Array.isArray(w)?(M||d).children.push(...w):ie.isHtml(w)?d.children.length?b={tag:"span",class:"b-event-text-wrap",html:w}:(d.children=null,d.html=w):typeof w=="string"||typeof w=="object"?b=w:w!=null&&(b=String(w)),b!=null&&((M||d).children.push(b),i.cls.add("b-has-content")),(d.html!=null||d.children.length)&&i.children.push(d)}else d.html=w,i.children.push(d)}const{eventStyle:S,eventColor:T}=i;if(i.wrapperCls[`b-sch-style-${S||"none"}`]=1,A.isNamedColor(T))i.wrapperCls[`b-sch-color-${T}`]=T;else if(T){const b=S?"color":"background-color";i.style=`${b}:${T};`+i.style,i.wrapperCls["b-sch-custom-color"]=1}else i.wrapperCls["b-sch-color-none"]=1;i.style&&l&&d&&(d.style=i.style,delete i.style),i.cls["b-sch-event-withicon"]=(u=i.iconCls)===null||u===void 0?void 0:u.length,i.eventContent=d,i.wrapperChildren=[],s.onEventDataGenerated(i)}return i}onEventDataGenerated(e){}changeUseInitialAnimation(e){return e===!0?"fade-in":e}updateUseInitialAnimation(e,n){const{classList:r}=this.element;n&&r.remove(`b-initial-${n}`),e&&(r.add(`b-initial-${e}`),ye.isFirefox&&r.add("b-prevent-event-transitions"))}restartInitialAnimation(e){var n;const r=this;(n=r.initialAnimationDetacher)===null||n===void 0||n.call(r),r.initialAnimationDetacher=null,r.useInitialAnimation=e,r.isFirstRender=!0,r.refresh()}stopInitialAnimation(){const e=this;e.initialAnimationDetacher(),e.isFirstRender=!1,e.useInitialAnimation=!1,ye.isFirefox&&e.setTimeout(()=>e.element.classList.remove("b-prevent-event-transitions"),100)}getMilestoneLabelWidth(e,n){const r=this,s=r.milestoneLayoutMode,i=r.getResourceLayoutSettings(n).contentHeight;if(s==="measure"){const a=ie.encodeHtml(e.name),o=r.getEventColor(e,n),l=r.getEventStyle(e,n),c=r.milestoneMeasureElement||(r.milestoneMeasureElement=A.createElement({className:{"b-sch-event-wrap":1,"b-milestone-wrap":1,"b-measure":1,[`b-sch-color-${o}`]:o,[`b-sch-style-${l}`]:l},children:[{className:"b-sch-event b-milestone",children:[{className:"b-sch-event-content",children:[{tag:"label"}]}]}],parent:r.foregroundCanvas}));if(c.retainElement=!0,c.style.fontSize=`${i}px`,r.milestoneTextPosition==="always-outside"){const d=c.firstElementChild.firstElementChild.firstElementChild;d.innerHTML=a;const u=L.from(d,d.parentElement);return u.left+u.width+2}else return c.firstElementChild.firstElementChild.innerHTML=`<label></label>${a}`,c.firstElementChild.offsetWidth}return s==="estimate"?e.name.length*r.milestoneCharWidth+(r.milestoneTextPosition==="always-outside"?i:0):s==="data"?e.milestoneWidth:0}updateMilestoneLayoutMode(e){const n=this,r=n.milestoneTextPosition==="always-outside";n.element.classList.toggle("b-sch-layout-milestones",e!=="default"&&!r),n.element.classList.toggle("b-sch-layout-milestone-labels",e!=="default"&&r),n.isConfiguring||n.refreshWithTransition()}updateMilestoneTextPosition(e){this.element.classList.toggle("b-sch-layout-milestone-text-position-inside",e==="inside"),this.updateMilestoneLayoutMode(this.milestoneLayoutMode)}updateMilestoneAlign(){this.isConfiguring||this.refreshWithTransition()}updateMilestoneCharWidth(){this.isConfiguring||this.refreshWithTransition()}get widgetClass(){}},je=y=>class extends rt(y||j){static get $name(){return"SchedulerStores"}static get projectStores(){return{resourceStore:{dataName:"resources"},eventStore:{dataName:"events",listeners:{batchedUpdate:"onEventStoreBatchedUpdate",changePreCommit:"onInternalEventStoreChange",commitStart:"onEventCommitStart",commit:"onEventCommit",exception:"onEventException",idchange:"onEventIdChange",beforeLoad:"onBeforeLoad"}},assignmentStore:{dataName:"assignments",listeners:{changePreCommit:"onAssignmentChange",commitStart:"onAssignmentCommitStart",commit:"onAssignmentCommit",exception:"onAssignmentException",beforeRemove:{fn:"onAssignmentBeforeRemove",prio:-1e3}}},dependencyStore:{dataName:"dependencies"},calendarManagerStore:{},timeRangeStore:{},resourceTimeRangeStore:{}}}static get configurable(){return{store:null,startParamName:"startDate",endParamName:"endDate",passStartEndParameters:Fe.checkVersion("core","6.0",">="),crudManagerClass:null,crudManager:null}}updateProject(e,n){super.updateProject(e,n),this.detachListeners("schedulerStores"),e.ion({name:"schedulerStores",refresh:"onProjectRefresh",thisObj:this})}onProjectRefresh({isInitialCommit:e}){const n=this;n.isVisible?(e&&n.isVertical&&(n.refreshAfterProjectRefresh=!1,n.refreshWithTransition()),n.navigateToAfterRefresh&&(n.navigateTo(n.navigateToAfterRefresh),n.navigateToAfterRefresh=null),n.refreshAfterProjectRefresh&&(n.refreshWithTransition(!1,!e),n.refreshAfterProjectRefresh=!1)):n.whenVisible("refresh",n,[!0])}changeCrudManager(e){const n=this;e&&!e.isCrudManager&&(e=n.crudManagerClass.new({scheduler:n},e)),n._crudManager=e,n.bindCrudManager(e)}get store(){return!this._store&&this.isVertical&&(this._store=new Qe({data:[{id:"verticalTimeAxisRow",cls:"b-verticaltimeaxis-row"}]})),super.store}set store(e){super.store=e}refreshFromRowOnStoreAdd(e,{isExpand:n,records:r}){const s=arguments;this.runWithTransition(()=>{this.currentOrientation.suspended=!n&&!r.some(i=>i.isLinked),super.refreshFromRowOnStoreAdd(e,...s),this.currentOrientation.suspended=!1},!n)}onStoreAdd(e){super.onStoreAdd(e),this.isPainted&&this.calculateRowHeights(e.records)}onStoreUpdateRecord({source:e,record:n,changes:r}){let s=0;"assigned"in r&&s++,"calendar"in r&&s++,s!==Object.keys(r).length&&super.onStoreUpdateRecord(...arguments)}updateResourceStore(e){e&&this.isHorizontal&&(e.metaMapId=this.id,this.store=e)}get usesDisplayStore(){return this.store!==this.resourceStore}onEventIdChange(e){this.currentOrientation.onEventStoreIdChange&&this.currentOrientation.onEventStoreIdChange(e)}onEventStoreBatchedUpdate(e){if(this.listenToBatchedUpdates)return this.onInternalEventStoreChange(e)}onInternalEventStoreChange(e){!this.isPainted||!this._mode||e.isAssign||this.assignmentStore.isRemovingAssignment||(this.isVisible?this.currentOrientation.onEventStoreChange(e):this.whenVisible(this.onInternalEventStoreChange,this,[e]))}onEventCommit({changes:e}){let n=[...e.added,...e.modified].map(r=>this.eventStore.getResourcesForEvent(r));n=Array.prototype.concat.apply([],n),new Set(n).forEach(r=>this.repaintEventsForResource(r))}onEventCommitStart({changes:e}){const{currentOrientation:n,committingCls:r}=this;[...e.added,...e.modified].forEach(s=>s.assignments.forEach(i=>n.toggleCls(i,r,!0)))}onEventException({action:e}){if(e==="commit"){const{changes:n}=this.eventStore;[...n.added,...n.modified,...n.removed].forEach(r=>this.repaintEvent(r))}}onAssignmentCommit({changes:e}){this.repaintEventsForAssignmentChanges(e)}onAssignmentCommitStart({changes:e}){const{currentOrientation:n,committingCls:r}=this;[...e.added,...e.modified].forEach(s=>{n.toggleCls(s,r,!0)})}onAssignmentException({action:e}){e==="commit"&&this.repaintEventsForAssignmentChanges(this.assignmentStore.changes)}repaintEventsForAssignmentChanges(e){const n=[...e.added,...e.modified,...e.removed].map(r=>r.getResource());new Set(n).forEach(r=>this.repaintEventsForResource(r))}onAssignmentBeforeRemove({records:e,removingAll:n}){if(n)return;const r=this;let s;if(!r.isConfiguring&&(r.navigateToAfterRefresh||r.activeAssignment&&e.includes(r.activeAssignment))){if(e.includes(r.navigateToAfterRefresh)&&(r.navigateToAfterRefresh=null),et.lastInteractionType==="key")for(let i=0,a=e.length;i<a&&!s;i++){const o=e[i];if(o.resource&&o.resource.isModel){let l=r.getNext(o);(!l||e.includes(l))&&(l=r.getPrevious(o)),l&&!e.includes(l)&&(s=l)}}s?(r.navigateTo(s),r.navigateToAfterRefresh=s):A.focusWithoutScrolling(r.focusElement)}}set timeRanges(e){this.project.timeRanges=e}get timeRanges(){return this.project.timeRanges}set resourceTimeRanges(e){this.project.resourceTimeRanges=e}get resourceTimeRanges(){return this.project.resourceTimeRanges}onBeforeLoad({params:e}){this.applyStartEndParameters(e)}getResourcesEventsPerTick(e,n){const{timeAxis:r,resourceStore:s}=this,i=[];return e=e||s.records,e.forEach(a=>{a.events.forEach(o=>{if(!r.isTimeSpanInAxis(o)||n&&!n.call(this,{resource:a,event:o}))return;let l=Math.floor(r.getTickFromDate(o.startDate)),c=Math.ceil(r.getTickFromDate(o.endDate));l==-1&&(l=0),c===-1&&(c=r.ticks.length);do i[l]?i[l].push(o):i[l]=[o];while(++l<c)})}),i}get widgetClass(){}};const ge={block:"nearest",edgeOffset:20},Ct={highlight:!1,focus:!1};var $e=y=>class extends(y||j){static get $name(){return"SchedulerScroll"}async scrollEventIntoView(e,n=ge){const r=this,s=e.resources||[e];if(s.length>1)throw new Error("scrollEventIntoView() is not applicable for events with multiple assignments, please use scrollResourceEventIntoView() instead.");s.length||console.warn("You have asked to scroll to an event which is not assigned to a resource"),await r.scrollResourceEventIntoView(s[0],e,n)}scrollAssignmentIntoView(e,...n){return this.scrollResourceEventIntoView(e.resource,e.event,...n)}async scrollResourceEventIntoView(e,n,r=ge){const s=this,i=n.startDate,a=n.endDate,o=n.isScheduled&&i<s.timeAxis.startDate|(a>s.timeAxis.endDate)<<1;arguments.length>3&&(r=arguments[3]);let l;if(r.edgeOffset==null&&(r.edgeOffset=20),o&&r.extendTimeAxis!==!1){const d=s.timeAxis.endDate-s.timeAxis.startDate;if(o===3)s.setTimeSpan(new Date(i.valueOf()-d/2),new Date(a.valueOf()+d/2));else if(s.infiniteScroll){const{visibleDateRange:u}=s,g=u.endMS-u.startMS,h=o&1?1:-1;await s.setTimeSpan(new Date(i.valueOf()-d/2),new Date(i.valueOf()+d/2),{visibleDate:new Date(a.valueOf()+h*g)})}else o&1?s.setTimeSpan(new Date(i),new Date(i.valueOf()+d)):s.setTimeSpan(new Date(a.valueOf()-d),new Date(a))}if(s.store.tree){var c;await((c=s.expandTo)===null||c===void 0?void 0:c.call(s,e))}if(n.parent&&!n.parent.isRoot&&await this.scrollEventIntoView(n.parent),l=s.getElementFromEventRecord(n,e),l){A.isFocusable(l)||(l=l.parentNode);const d=s.timeAxisSubGrid.scrollable;s.timeAxisSubGrid.forceScrollUpdate=!0,await d.scrollIntoView(l,r)}else o===3&&r.extendTimeAxis===!1?console.warn("You have asked to scroll to an event which is outside the current view and extending timeaxis is disabled"):!n.isOccurrence&&!s.eventStore.isAvailable(n)?console.warn("You have asked to scroll to an event which is not available"):n.isScheduled?await s.scrollUnrenderedEventIntoView(e,n,r):await s.scrollResourceIntoView(e,r)}scrollUnrenderedEventIntoView(e,n,r=ge){return new Promise(s=>{const i=this,a=Object.assign({edgeOffset:20},r,Ct),o=i.timeAxisSubGrid.scrollable,l=i.getResourceEventBox(n,e),c=o.viewport;if(!c||!l){s();return}l.x=Math.ceil(l.x),l.y=Math.ceil(l.y),i.rtl&&l.translate(-i.timeAxisViewModel.totalSize+c.width,0),l.translate(c.x-o.scrollLeft,c.y-o.y);const d=async({eventRecord:h,element:f,targetElement:m})=>{if(h===n){const v=f||m;u(),await g,r.highlight&&A.highlight(v),r.focus&&v.focus(),s()}},u=i.ion({renderEvent:d}),g=o.scrollIntoView(l,a)})}scrollResourceIntoView(e,n=ge){return this.isVertical?this.currentOrientation.scrollResourceIntoView(e,n):this.scrollRowIntoView(e,n)}get widgetClass(){}},Ne=y=>class extends(y||j){static get $name(){return"SchedulerRegions"}getScheduleRegion(e,n,r=!0,s){return this.currentOrientation.getScheduleRegion(...arguments)}getResourceRegion(e,n,r){return this.currentOrientation.getRowRegion(...arguments)}getAssignmentEventBox(e,n){return this.getResourceEventBox(e.event,e.resource,n)}getResourceEventBox(e,n,r=!1,s=!1){return this.currentOrientation.getResourceEventBox(...arguments)}getItemBox(e,n=!1){return e.resources.map(r=>this.getResourceEventBox(e,r,n))}get widgetClass(){}};const Ue=["eventLayout","mode","eventColor","eventStyle","tickSize","fillTicks"];var _e=y=>class extends(y||j){static get $name(){return"SchedulerState"}getState(){return V.copyProperties(super.getState(),this,Ue)}applyState(e){var n;this.suspendRefresh();let r=Ue.slice();(e==null?void 0:e.eventLayout)==="layoutFn"&&(delete e.eventLayout,r.splice(r.indexOf("eventLayout"),1)),e!=null&&(n=e.zoomLevelOptions)!==null&&n!==void 0&&n.width&&(r=r.filter(s=>s!=="tickSize")),V.copyProperties(this,e,r),super.applyState(e),this.resumeRefresh(!0)}get widgetClass(){}};const St={releaseElement:1,reuseElement:1},wt={newElement:1,reuseOwnElement:1,reuseElement:1},De=9999999,Dt=({startDateMS:y},{startDateMS:t})=>y-t,bt={startDate:1,endDate:1,duration:1};function Ge(y,t,e,n,r){var s,i;const{timeAxis:a}=y,o=t.isBatchUpdating&&!r?t.get(n):t[n],l=(s=t.hasBatchedChange)===null||s===void 0?void 0:s.call(t,n);if(y.fillTicks&&(!((i=t.meta)!==null&&i!==void 0&&i.isResizing)||!l)){let d=a.getTickFromDate(o);if(d>=0){e&&d===Math.round(d)&&d>0&&d--;const u=Math.floor(d);return a.getAt(u)[n].getTime()}}return o==null?void 0:o.getTime()}class me extends j.mixin(oe){static get configurable(){return{scrollBuffer:0,bufferSize:150,verticalBufferSize:150}}static get properties(){return{resourceMap:new Map,rowMap:new Map,eventConfigs:[],isFirstRefresh:!0,toDrawOnProjectRefresh:new Set,toDrawOnDataReady:new Set}}construct(t){const e=this;e.client=e.scheduler=t,e.eventSorter=e.eventSorter.bind(t),t.scrollable.ion({scroll:"onEarlyScroll",prio:1,thisObj:e}),t.rowManager.ion({name:"rowManager",renderDone:"onRenderDone",removeRows:"onRemoveRows",translateRow:"onTranslateRow",offsetRows:"onOffsetRows",beforeRowHeight:"onBeforeRowHeightChange",thisObj:e}),super.construct({})}init(){}updateVerticalBufferSize(){const{rowManager:t}=this.scheduler;this.scheduler.isPainted&&t.renderRows(t.rows)}get visibleDateRange(){return this._visibleDateRange}getDateFromXY(t,e,n,r=!1){const{scheduler:s}=this;let i=t[0];return n||(i=this.translateToScheduleCoordinate(i)),i=s.getRtlX(i),s.timeAxisViewModel.getDateFromPosition(i,e,r)}translateToScheduleCoordinate(t){const{scheduler:e}=this,{scrollable:n}=e.timeAxisSubGrid;let r=t-e.timeAxisSubGridElement.getBoundingClientRect().left-globalThis.scrollX;return e.rtl?r+=n.maxX-Math.abs(e.scrollLeft):r+=e.scrollLeft,r}translateToPageCoordinate(t){const{scheduler:e}=this,{scrollable:n}=e.timeAxisSubGrid;let r=t+e.timeAxisSubGridElement.getBoundingClientRect().left;return e.rtl?r-=n.maxX-Math.abs(e.scrollLeft):r-=e.scrollLeft,r}getScheduleRegion(t,e,n=!0,r,s=!1){var i,a;const o=this,{scheduler:l}=o,{timeAxisSubGridElement:c,timeAxis:d}=l,u=(!s||t)&&l.getResourceMargin(t)||0;let g;if(t){const p=e&&l.getElementsFromEventRecord(e,t)[0];if(g=L.from(l.getRowById(t.id).getElement("normal"),c),p){const R=L.from(p,c);g.y=R.y,g.bottom=R.bottom}else g.y=g.y+u,g.bottom=g.bottom-u}else g=L.from(c).moveTo(null,0),g.width=c.scrollWidth,g.y=g.y+u,g.bottom=g.bottom-u;const h=d.startDate,f=d.endDate;r=((i=r)===null||i===void 0?void 0:i.start)&&r||((a=l.getDateConstraints)===null||a===void 0?void 0:a.call(l,t,e))||{start:h,end:f};let m=l.getCoordinateFromDate(r.start?x.max(h,r.start):h),v=l.getCoordinateFromDate(r.end?x.min(f,r.end):f);return n||(m=o.translateToPageCoordinate(m),v=o.translateToPageCoordinate(v)),g.left=Math.min(m,v),g.right=Math.max(m,v),g}getRowRegion(t,e,n){const{scheduler:r}=this,{timeAxis:s}=r,i=r.getRowById(t.id);if(!i)return null;const a=s.startDate,o=s.endDate,l=e?x.max(a,e):a,c=n?x.min(o,n):o,d=r.getCoordinateFromDate(l),u=r.getCoordinateFromDate(c,!0,!0),g=i.top,h=Math.min(d,u),f=g+i.offsetHeight;return new L(h,g,Math.max(d,u)-h,f-g)}getResourceEventBox(t,e,n,r=!1){const s=this.resourceMap.get(e.id);let i=null,a=!1;if(s&&(i=s.eventsData.find(o=>o.eventRecord===t)),i||(i=this.getTimeSpanRenderData(t,e,{viewport:!0,timeAxis:n}),a=!0),i){const o=this.scheduler.rowManager.getRecordCoords(e,!0,r),l=i.top+o.top,c=new L(i.left,l,i.width,i.height);return c.layout=!a,c.rowTop=o.top,c.rowBottom=o.bottom,c.resourceId=e.id,c}return null}resolveRowRecord(t){const e=this,{scheduler:n}=e,r=t.nodeType?t:t.target,s=r.nodeType===Element.TEXT_NODE?r.parentElement:r,i=s.closest(n.eventSelector);return i?e.resourceStore.getById(i.dataset.resourceId):n.getRecordFromElement(s)}attachToProject(t){super.attachToProject(t),this.refreshAllWhenReady=!0,this.scheduler.isConfiguring||this.clearAll({clearDom:!0}),t==null||t.ion({name:"project",refresh:"onProjectRefresh",commitFinalized:"onProjectCommitFinalized",thisObj:this})}onProjectCommitFinalized(){const{scheduler:t,toDrawOnDataReady:e,project:n}=this;t.isVisible?t.isPainted&&!t.refreshSuspended&&(!e.size&&n.timeZone!=null&&n.ignoreRecordChanges&&n.resourceStore.forEach(r=>e.add(r.id)),e.size&&(this.clearResources(e),this.refreshResources(e)),e.clear()):t.whenVisible("refreshRows")}onProjectRefresh({isCalculated:t,isInitialCommit:e}){const n=this,{scheduler:r,toDrawOnProjectRefresh:s}=n;if(r.isVisible){if(r.isPainted&&!r.isConfiguring&&!r.refreshSuspended){if(n.refreshAllWhenReady||e&&t){r.calculateAllRowHeights(!0);const{rowManager:i}=r;i.topRow?(n.clearAll(),r.refreshAfterProjectRefresh||(i.topRow.dataIndex>=r.store.count?r.renderRows(!1):r.refreshWithTransition(!1,!n.isFirstRefresh&&t&&!e)),n.isFirstRefresh=!1):i.reinitialize(),n.refreshAllWhenReady=!1}else s.size&&n.refreshResources(s);s.clear()}}else r.whenVisible("refresh",r,[!0])}attachToAssignmentStore(t){this.refreshAllWhenReady=!0,super.attachToAssignmentStore(t),t&&t.ion({name:"assignmentStore",changePreCommit:"onAssignmentStoreChange",refreshPreCommit:"onAssignmentStoreRefresh",thisObj:this})}onAssignmentStoreChange({source:t,action:e,records:n=[],replaced:r,changes:s}){const i=this,{scheduler:a}=i,o=new Set(n.flatMap(l=>{var u;var c,d;return[l.resourceId,...(u=(c=l.resource)===null||c===void 0||(d=c.$links)===null||d===void 0?void 0:d.map(g=>g.id))!=null?u:[]]}));if(!(i.resourceStore.isRemoving||i.resourceStore.isChangingId))switch(e){case"dataset":{i.eventStore.usesSingleAssignment||(o.size?i.refreshResourcesWhenReady(o):(i.clearAll(),a.refreshWithTransition()));return}case"add":case"remove":case"updateMultiple":i.refreshResourcesWhenReady(o);return;case"removeall":i.refreshAllWhenReady=!0;return;case"replace":r.forEach(([l,c])=>{o.add(l.resourceId),o.add(c.resourceId)}),i.refreshResourcesWhenReady(o);return;case"filter":i.clearAll(),a.calculateAllRowHeights(!0),a.refreshWithTransition();return;case"update":{("eventId"in s||"resourceId"in s||"id"in s)&&("resourceId"in s&&o.add(s.resourceId.oldValue),t===a.project.assignmentStore?i.refreshResourcesOnDataReady(o):i.refreshResources(o));break}case"clearchanges":{const{added:l,modified:c,removed:d}=s;c.length?a.refreshWithTransition():(l.forEach(u=>o.add(u.resourceId)),d.forEach(u=>o.add(u.resourceId)),i.refreshResourcesOnDataReady(o))}}}onAssignmentStoreRefresh({action:t,records:e}){t==="batch"&&(this.clearAll(),this.scheduler.refreshWithTransition())}attachToEventStore(t){this.refreshAllWhenReady=!0,super.attachToEventStore(t),t&&t.ion({name:"eventStore",refreshPreCommit:"onEventStoreRefresh",thisObj:this})}onEventStoreRefresh({action:t}){if(t==="batch"){const{scheduler:e}=this;e.isEngineReady&&e.isPainted&&(this.clearAll(),e.refreshWithTransition())}}onEventStoreChange({action:t,records:e=[],record:n,replaced:r,changes:s,source:i}){const a=this,{scheduler:o}=a,l=i.isResourceTimeRangeStore,c=new Set;if(o.isPainted)if(e.forEach(g=>{var h;const f=(h=g.$linkedResources)===null||h===void 0?void 0:h.filter(m=>a.resourceStore.includes(m));f==null||f.forEach(m=>c.add(m.id))}),l){switch(t){case"removeall":case"dataset":a.clearAll(),o.refreshWithTransition();return}a.refreshResources(c)}else{switch(t){case"batch":case"sort":case"group":case"move":return;case"remove":return;case"clearchanges":a.clearAll(),o.refreshWithTransition();return;case"dataset":{a.clearAll(),o.isEngineReady?o.refreshWithTransition():a.refreshAllWhenReady=!0;return}case"add":case"updateMultiple":break;case"replace":r.forEach(([,g])=>{g.resources.map(h=>c.add(h.id))});break;case"removeall":case"filter":if(!o.isEngineReady){a.refreshAllWhenReady=!0;return}a.clearAll(),o.calculateAllRowHeights(!0),o.refreshWithTransition();return;case"update":{const g=n.$entity?!Object.keys(s).some(f=>!n.$entity.getField(f)):!Object.keys(s).some(f=>!bt[f]);let h=0;if("startDate"in s&&h++,"endDate"in s&&h++,"duration"in s&&h++,"resourceId"in s&&c.add(s.resourceId.oldValue),c.size&&(!g||h&&!("duration"in s&&h===1)||"percentDone"in s||"inactive"in s||"constraintDate"in s||"constraintType"in s||"segments"in s)){var d,u;(d=a.project)!==null&&d!==void 0&&d.propagatingLoadChanges||(u=a.project)!==null&&u!==void 0&&u.isWritingData?a.refreshResourcesOnDataReady(c):a.refreshResources(c)}return}}a.refreshResourcesWhenReady(c)}}attachToResourceStore(t){this.refreshAllWhenReady=!0,super.attachToResourceStore(t),t&&(this.clearAll({clearLayoutCache:!0}),t.ion({name:"resourceStore",changePreCommit:"onResourceStoreChange",thisObj:this}))}get resourceStore(){return this.client.store}onResourceStoreChange({action:t,isExpand:e,records:n,changes:r}){const s=this,i=n==null?void 0:n.flatMap(a=>a.isLinked?[a.id,a.$originalId]:[a.id]);if(s.scheduler.isPainted){switch(t){case"add":e||(n.every(a=>a.isLinked)?s.refreshResources(i):s.refreshResourcesWhenReady(i));return;case"update":{!s.project.isBatchingChanges&&!r.isLeaf&&s.refreshResources(i);return}case"filter":return;case"removeall":s.clearAll({clearLayoutCache:!0});return;case"dataset":return}i&&s.clearResources(i)}}onTranslateRow({row:t}){t.id!=null&&this.refreshEventsForResource(t,!1)}onOffsetRows(){this.clearAll(),this.doUpdateTimeView()}calculateRowHeight(t){var e;const{scheduler:n}=this,r=n.getResourceHeight(t),s=n.getEventLayout(t);if(s.type==="stack"&&n.isEngineReady&&!t.isSpecialRow&&((e=t.assigned)===null||e===void 0?void 0:e.size)>1){const{assignmentStore:a,eventStore:o,timeAxis:l}=n,{barMargin:c,resourceMargin:d,contentHeight:u}=n.getResourceLayoutSettings(t),g=(o.isFiltered||a.isFiltered)&&(v=>v.assignments.some(p=>p.resource===t.$original&&a.includes(p))),h=o.getEvents({resourceRecord:t,includeOccurrences:n.enableRecurringEvents,startDate:l.startDate,endDate:l.endDate,filter:g}).sort(Dt).map(v=>{const p=v.isBatchUpdating?v.get("startDate"):v.startDate,R=v.isBatchUpdating?v.get("endDate"):v.endDate||p;return{eventRecord:v,resourceRecord:t,startMS:p.getTime(),endMS:R.getTime()}}),f=n.getEventLayoutHandler(s),m=f.layoutEventsInBands(h,t,!0);return f.type==="layoutFn"?m:m*u+(m-1)*c+d*2}return r}doUpdateTimeView(){const{scrollable:t}=this.scheduler.timeAxisSubGrid;this.updateFromHorizontalScroll(t.x)}onTimeAxisViewModelUpdate(){const t=this,{scheduler:e}=t;t.clearAll(),e.refreshSuspended&&(t.detachListeners("renderingSuspend"),e.ion({name:"renderingSuspend",resumeRefresh({trigger:n}){e.isEngineReady&&n&&t.doUpdateTimeView()},thisObj:t,once:!0})),t.doUpdateTimeView()}getConnectorStartSide(t){return"start"}getConnectorEndSide(t){return"end"}refreshRows(t){t&&this.clearAll()}onLocaleChange(){this.clearAll()}onViewportResize(t,e,n,r){e>r&&this.onRenderDone()}onDragAbort({context:t,dragData:e}){this.resourceStore.indexOf(e.record.resource)<this.scheduler.topRow.dataIndex&&t.element.remove()}toggleCls(t,e,n=!0,r=!1){const s=this.client.getElementFromAssignmentRecord(t,r),i=this.resourceMap.get(t.isModel?t.get("resourceId"):t.resourceId),a=i==null?void 0:i.eventsData.find(o=>o.eventId===t.eventId);a&&(a[r?"wrapperCls":"cls"][e]=n),s&&(s.classList[n?"add":"remove"](e),s.lastDomConfig.className[e]=n)}onRemoveRows({rows:t}){t.forEach(e=>this.rowMap.delete(e)),this.onRenderDone()}onEarlyScroll(){this.rendererCalled=!1}updateFromVerticalScroll(){this.fromScroll=!0,this.rendererCalled||this.onRenderDone()}updateFromHorizontalScroll(t){const e=this,{scheduler:n,scrollBuffer:r}=e,{timeAxisSubGrid:s,timeAxis:i,rtl:a}=n,{width:o}=s,{totalSize:l}=n.timeAxisViewModel,c=t,d=s.scrollable.maxX!==0&&Math.abs(s.scrollable.maxX)<=Math.round(c)+5,u=n.getDateFromCoord({coord:Math.max(0,c-r),ignoreRTL:!0}),g=d?i.endDate:n.getDateFromCoord({coord:c+o+r,ignoreRTL:!0})||i.endDate;if(u&&!n._viewPresetChanging){e._visibleDateRange={startDate:u,endDate:g,startMS:u.getTime(),endMS:g.getTime()},e.viewportCoords=a?{left:l-t-o+r,right:l-t-r}:{left:t-r,right:t+o+r};const h=n.timeView.range={startDate:u,endDate:g};if(n.onVisibleDateRangeChange(h),!n.refreshSuspended&&n.rowManager.rows.length){if(n.rowManager.rows[0].id===null)return;e.fromScroll=!0,n.rowManager.rows.forEach(f=>e.refreshEventsForResource(f,!1,!1)),e.onRenderDone()}}}repaintEventsForResource(t){this.refreshResources([t.id])}onBeforeRowHeightChange(){this.clearAll()}refreshResourcesOnDataReady(t){t.forEach(e=>this.toDrawOnDataReady.add(e))}refreshResourcesWhenReady(t){this.clearResources(t),t.forEach(e=>this.toDrawOnProjectRefresh.add(e))}refreshResources(t,e=!0){const n=this,{scheduler:r}=n,s=[],i=[];n.clearResources(t),r.refreshSuspended||(t.forEach(a=>{const o=r.getRowById(a);o?s.push(o):i.push(o)}),r.runWithTransition(()=>{r.calculateRowHeights(i.map(a=>this.resourceStore.getById(a)),!0),r.rowManager.renderRows(s)},e))}layoutEventVerticallyStack(t,e,n){const{barMargin:r,resourceMargin:s,contentHeight:i}=this.scheduler.getResourceLayoutSettings(n,e.parent);return t===0?s:s+t*i+t*r}layoutEventVerticallyPack(t,e,n,r){const{barMargin:s,resourceMargin:i,contentHeight:a}=this.scheduler.getResourceLayoutSettings(r,n.parent),o=1/e,l=t*o,c=(a-(o-1)*s)*e;return{top:i+l*c+l*s,height:c}}addTemporaryDragElement(t,e=t.resource){const{scheduler:n}=this,r=n.generateRenderData(t,e,{timeAxis:!0,viewport:!0});r.absoluteTop=r.row?r.top+r.row.top:n.getResourceEventBox(t,e,!0).top;const s=this.renderEvent(r),{dataset:i}=s;delete s.tabIndex,delete i.eventId,delete i.resourceId,delete i.assignmentId,delete i.syncId,i.transient=!0,s.parent=this.scheduler.foregroundCanvas,s.retainElement=!0;const a=A.createElement(s);return a.innerElement=a.firstChild,t.instanceMeta(n).hasTemporaryDragElement=!0,a}eventSorter(t,e){if(this.overlappingEventSorter)return this.overlappingEventSorter(t.eventRecord||t,e.eventRecord||e);const n=t.isModel?t.startDateMS:t.dataStartMS||t.startMS,r=t.isModel?t.endDateMS:t.dataEndMS||t.endMS,s=e.isModel?e.startDateMS:e.dataStartMS||e.startMS,i=e.isModel?e.endDateMS:e.dataEndMS||e.endMS,a=t.isModel?t.name:t.eventRecord.name,o=e.isModel?e.name:e.eventRecord.name;return n-s||i-r||(a<o?-1:a==o?0:1)}calculateMS(t,e,n,r,s){const i=this,{scheduler:a}=i,{timeAxisViewModel:o}=a;let l=Ge(a,t,!1,e,r),c=Ge(a,t,!0,n,r),d=c-l;if(a.milestoneLayoutMode!=="default"&&d===0){const u=o.getSingleUnitInPixels("minute");if(d=a.getMilestoneLabelWidth(t,s)*(1/u)*60*1e3,a.milestoneTextPosition==="always-outside"){const f=a.getResourceLayoutSettings(s,t.parent).contentHeight,m=f*(1/u)*60*1e3;l-=m/2,c=l+d}else switch(a.milestoneAlign){case"start":case"left":c=l+d;break;case"end":case"right":c=l,l=c-d;break;default:c=l+d/2,l=c-d;break}}return{startMS:l,endMS:c,durationMS:d}}setupRenderData(t,e){var n;const r=this,{scheduler:s}=r,{timeAxis:i,timeAxisViewModel:a}=s,{preamble:o,postamble:l}=t,c=r.isProHorizontalRendering&&((n=s.features.eventBuffer)===null||n===void 0?void 0:n.enabled)&&(o||l)&&!t.isMilestone,d=a.getSingleUnitInPixels("minute"),{isBatchUpdating:u}=t,g=c?"wrapStartDate":"startDate",h=c?"wrapEndDate":"endDate",f=u&&!c?t.get(g):t[g],m=u&&!c?t.get(h):t[h]||f,v=i.startMS,p=i.endMS,{startMS:R,endMS:S,durationMS:T}=r.calculateMS(t,g,h,c,e),b=R<v|(R>p)<<1,M=S>p|(S<=v)<<1,w=T/(1e3*60),I=M?d*w:null,$=s.getRowById(e);return{eventRecord:t,taskRecord:t,start:f,end:m,rowId:e.id,children:[],startMS:R,endMS:S,durationMS:T,startsOutsideView:b,endsOutsideView:M,width:I,row:$,useEventBuffer:c}}fillTimeSpanHorizontalPosition(t){const{startMS:e,endMS:n,durationMS:r}=t,s=e!=null&&n!=null&&this.calculateHorizontalPosition(t,e,n,r);return s?(Object.assign(t,s),!0):!1}calculateHorizontalPosition(t,e,n,r){const{scheduler:s}=this,{timeAxis:i,timeAxisViewModel:a}=s,{startsOutsideView:o,endsOutsideView:l,eventRecord:c}=t,d=i.startMS,u=a.getSingleUnitInPixels("minute"),g=r/(1e3*60),h=l?u*g:null;let f=s.getCoordinateFromDate(n,{local:!0,respectExclusion:!0,isEnd:!0}),m,v=!1,p=!1;return o?(m=(e-d)/(1e3*60)*u,s.rtl&&(m=s.timeAxisSubGrid.scrollable.scrollWidth-m)):(m=s.getCoordinateFromDate(e,{local:!0,respectExclusion:!0,isEnd:!1,snapToNextIncluded:f!==-1}),v=m===-1),l?ye.isSafari&&s.features.stickyEvents&&i.endMS||f===-1&&!i.continuous?f=s.getCoordinateFromDate(i.endMS):f=m+h*(s.rtl?-1:1):p=f===-1,p&&!v&&(f=s.getCoordinateFromDate(n,{local:!0,respectExclusion:!0,isEnd:!0,snapToNextIncluded:!0})),h>De&&(o===1?l===1?(m=-100,f=s.timeAxisColumn.width+100):m=f-De:l===1&&(f=m+De)),v&&p&&(m=s.getCoordinateFromDate(e,{local:!0,respectExclusion:!0,isEnd:!1,snapToNextIncluded:!0,max:n}),f=s.getCoordinateFromDate(n,{local:!0,respectExclusion:!0,isEnd:!0,snapToNextIncluded:!0,min:e}),m===f)?(c.instanceMeta(s).excluded=!0,null):{left:Math.min(m,f),width:Math.abs(f-m)||(c.isMilestone&&!c.meta.isDragCreating?0:6),clippedStart:v,clippedEnd:p}}fillTimeSpanVerticalPosition(t,e){const{scheduler:n}=this,{start:r,end:s}=t,{resourceMargin:i,contentHeight:a}=n.getResourceLayoutSettings(e);n.fillTicks&&(t.dataStartMS=r.getTime(),t.dataEndMS=s.getTime()),t.top=Math.max(0,i),n.managedEventSizing&&(t.height=a)}getTimeSpanRenderData(t,e,n=!1){const r=this,{scheduler:s}=r,{timeAxis:i}=s,a=n===!0||n.timeAxis,o=n===!0||n.viewport;if((a||i.isTimeSpanInAxis(t))&&(s.getRowById(e)||o)){const c=r.setupRenderData(t,e);return r.fillTimeSpanHorizontalPosition(c)?(r.fillTimeSpanVerticalPosition(c,e),c):null}}layoutEvents(t,e,n=!1,r,s){const i=this,{scheduler:a}=i,{timeAxis:o}=a,l=e.reduce((h,f)=>{if(n||o.isTimeSpanInAxis(f)){const m=a.generateRenderData(f,t,!1);m&&h.push(m)}return h},[]);l.sort(s!=null?s:i.eventSorter);let c=a.getAppliedResourceHeight(t,r);const d=l.filter(({eventRecord:h})=>h.isEvent&&!h.meta.excludeFromLayout),u=a.getEventLayout(t,r),g=a.getEventLayoutHandler(u);if(g){const{barMargin:h,resourceMargin:f,contentHeight:m}=a.getResourceLayoutSettings(t,r),v=g.applyLayout(d,t)||1;g.type==="layoutFn"?c=v:c=v*m+(v-1)*h+f*2}else if(d.length>0)for(let h=0;h<d.length;h++){const f=d[h];f.wrapperStyle+=`;z-index:${h+5}`}return{rowHeight:c,eventsData:l}}layoutResourceEvents(t,e=!1){const n=this,{scheduler:r}=n,{eventStore:s,assignmentStore:i,timeAxis:a}=r,o=s.getEvents({includeOccurrences:r.enableRecurringEvents,resourceRecord:t,startDate:a.startDate,endDate:a.endDate,filter:(i.isFiltered||s.isFiltered)&&(c=>c.assignments.some(d=>d.resource===t.$original&&i.includes(d)))}),l=r.getEventsToRender(t,o)||[];return n.layoutEvents(t,l,e)}renderEvent(t,e){const{scheduler:n}=this,{resourceRecord:r,assignmentRecord:s,eventRecord:i}=t,{milestoneLayoutMode:a,milestoneTextPosition:o}=n,l=s?this.assignmentStore.getOccurrence(s,i).id:t.eventId,c={className:t.cls,style:t.style||"",children:t.children,role:"presentation",dataset:{taskFeature:"event"},syncOptions:{syncIdField:"taskBarFeature"}},d={className:t.wrapperCls,tabIndex:"tabIndex"in t?t.tabIndex:-1,children:[c,...t.wrapperChildren],style:{top:t.absoluteTop,left:t.left,height:t.fillSize?e:t.height,width:i.isMilestone&&!i.meta.isDragCreating&&(a==="default"&&(o==="outside"||o==="inside"&&!t.width)||o==="always-outside")?t.height:t.width,style:t.wrapperStyle,fontSize:t.height+"px"},dataset:{resourceId:r.id,eventId:t.eventId,syncId:r.isLinked?`${l}_${r.id}`:l},elementData:t,retainElement:(s==null?void 0:s.instanceMeta(n).retainElement)||i.instanceMeta(n).retainElement,syncOptions:{syncIdField:"taskFeature",releaseThreshold:0}};return t.fillSize&&(t.height=e),t.zIndex&&(d.zIndex=t.zIndex),s&&(d.dataset.assignmentId=s.id),t.elementConfig=d,d}refreshEventsForResource(t,e=!0,n=!0){const r=this,s=r.scheduler.store.getById(t.isRow?t.id:t),i=r.scheduler.rowManager.getRowFor(s);e&&r.clearResources([s]),i&&s&&(r.renderer({row:i,record:s}),e&&n&&r.onRenderDone())}getResourceLayout(t){const e=this;let n=e.resourceMap.get(t.id);if(!n||n.invalid){if(e.suspended)return;n=e.layoutResourceEvents(t,!1),e.resourceMap.set(t.id,n)}return n}getEventDOMConfigForCurrentView(t,e,n,r){const s=this,{bufferSize:i,scheduler:a}=s,{labels:o,eventBuffer:l}=a.features,c=(l==null?void 0:l.enabled)||(o==null?void 0:o.enabled)&&(o.left||o.right||o.before||o.after),{eventsData:d}=t,u=s.fromScroll?s.rowMap.get(e):null,g=[];let h,f;for(let m=0;m<d.length;m++){const v=d[m];if(h=n,f=r,(c||v.width===0)&&(h-=i,f+=i),v.left+v.width>=h&&v.left<=f){v.absoluteTop=v.top+e.top;const p=u==null?void 0:u.find(R=>R.elementData.eventId===v.eventId&&R.elementData.resourceId===v.resourceId);g.push(p!=null?p:s.renderEvent(v,t.rowHeight))}}return g}renderer({row:t,record:e,size:n={}}){const r=this;if(e.isSpecialRow){r.rowMap.delete(t);return}const{left:s,right:i}=r.viewportCoords,a=r.getResourceLayout(e);if(!a)return;n.height=a.rowHeight,n.transient=!0;const o=r.getEventDOMConfigForCurrentView(a,t,s,i);r.rowMap.set(t,o),r.rendererCalled=!0}onRenderDone(){var c;const{scheduler:t,rowMap:e,verticalBufferSize:n}=this,r=[],s=(c=t._scrollTop)!=null?c:0,i=s-n,a=s+t._bodyRectangle.height+n,o=n<0,l=!t.managedEventSizing;e.forEach((d,u)=>{if(o||u.bottom>i&&u.top<a)for(let g=0;g<d.length;g++){const h=d[g],f=h.elementData,{absoluteTop:m,eventRecord:v}=f;(o||l||v.meta.isDragCreating||v.meta.isResizing||m+f.height>i&&m<a)&&r.push(h)}for(let g=0;g<d.length;g++)d[g]={...d[g]}}),this.fromScroll=!1,this.visibleEventDOMConfigs=r,q.sync({domConfig:{onlyChildren:!0,children:r},targetElement:t.foregroundCanvas,syncIdField:"syncId",callback({action:d,domConfig:u,lastDomConfig:g,targetElement:h,jsx:f}){var m,v;const{reactComponent:p}=t,R=St[d],S=wt[d];if(!R&&((m=t.processEventContent)===null||m===void 0||m.call(t,{jsx:f,action:d,domConfig:u,targetElement:h,isRelease:R,reactComponent:p})),!(d==="none"||!(u!=null&&(v=u.elementData)!==null&&v!==void 0&&v.isWrap))){if(R&&g!==null&&g!==void 0&&g.elementData){var T;const{eventRecord:b,resourceRecord:M,assignmentRecord:w}=g.elementData,I={renderData:g.elementData,element:h,eventRecord:b,resourceRecord:M,assignmentRecord:w};(T=t.processEventContent)===null||T===void 0||T.call(t,{isRelease:R,targetElement:h,reactComponent:p,assignmentRecord:w}),h===A.getActiveElement(h)&&t.focusElement.focus(),t.trigger("releaseEvent",I)}if(S){const{eventRecord:b,resourceRecord:M,assignmentRecord:w}=u.elementData,I={renderData:u.elementData,element:h,isReusingElement:d==="reuseElement",isRepaint:d==="reuseOwnElement",eventRecord:b,resourceRecord:M,assignmentRecord:w};t.trigger("renderEvent",I)}}}})}clearResources(t){t=tt.asArray(t),t.map(nt.asId).forEach(n=>{const r=this.resourceMap.get(n);r&&(r.invalid=!0);const s=this.scheduler.getRowById(n);s&&this.rowMap.delete(s)})}clearAll({clearDom:t=!1,clearLayoutCache:e=!1}={}){const n=this,{layouts:r,foregroundCanvas:s}=n.scheduler;if(e&&r)for(const i in r)r[i].clearCache();if(s&&t){s.syncIdMap=s.lastDomConfig=null;for(const i of s.children)i.lastDomConfig=i.elementData=null}n.resourceMap.clear(),n.rowMap.clear()}}F(me,"$name","HorizontalRendering"),me._$name="HorizontalRendering";class Ye extends Le(){static get defaultConfig(){return{coordProp:"leftFactor",sizeProp:"widthFactor"}}applyLayout(t,e,n,r,s,i){const a=this,o=i.type;return a.packEventsInBands(t,(l,c,d,u)=>{if(o==="none")l.width=e-n*2,l.left+=n;else{l.widthFactor=u;const g=l.leftFactor=d.start+c*u,h=Math.round(1/u),f=g/u,m=e-n*2-r*(h-1);o==="mixed"&&h===2?(l.left+=g*e/5+r,l.width=e-g*e/5-r*2,l.zIndex=5+f):(l.width=u*m,l.left+=g*m+n+r*f)}l.cls["b-sch-event-narrow"]=l.width<a.scheduler.narrowEventWidth})}}Ye._$name="VerticalLayout";const Tt={releaseElement:1,reuseElement:1},xt={newElement:1,reuseOwnElement:1,reuseElement:1},At={startDate:1,endDate:1,duration:1},Mt=Object.freeze({});class be extends j.mixin(Oe,oe){static get properties(){return{eventMap:new Map,resourceMap:new Map,releasedElements:{},toDrawOnProjectRefresh:new Set,resourceBufferSize:1}}construct(t){this.client=this.scheduler=t,this.verticalLayout=new Ye({scheduler:t}),super.construct({})}init(){const t=this,{scheduler:e,resourceColumns:n}=t;n.resourceStore=t.resourceStore,n.ion({name:"resourceColumns",columnWidthChange:"onResourceColumnWidthChange",thisObj:t}),t.initialized=!0,e.isPainted&&t.renderer(),n.availableWidth=e.timeAxisSubGridElement.offsetWidth}resolveRowRecord(t,e){const n=this,{scheduler:r}=n,s=t.nodeType?null:t,i=s?s.target:t,a=s?[s.borderOffsetX,s.borderOffsetY]:e,o=i.nodeType===Element.TEXT_NODE?i.parentElement:i,l=o.closest(r.eventSelector);if(l)return r.resourceStore.getById(l.dataset.resourceId);if(!i.closest(".b-sch-timeaxis-cell"))return null;if(!a)throw new Error(`Vertical mode needs coordinates to resolve this element. Can also be called with a browser
                event instead of element to extract element and coordinates from`);if(r.variableColumnWidths||r.resourceStore.isGrouped){let d=0;for(const u of n.resourceStore)if(u.isSpecialRow||(d+=u.columnWidth||n.resourceColumns.columnWidth),d>=a[0])return u;return null}const c=Math.floor(a[0]/n.resourceColumns.columnWidth);return n.allResourceRecords[c]}toggleCls(t,e,n=!0,r=!1){var s;const i=(s=this.eventMap.get(t.eventId))===null||s===void 0?void 0:s[t.resourceId];if(i){i.renderData[r?"wrapperCls":"cls"][e]=n;const a=this.client.getElementFromAssignmentRecord(t,r);a&&a.classList[n?"add":"remove"](e)}}getDateFromXY(t,e,n,r=!1){let s=t[1];return n||(s=this.translateToScheduleCoordinate(s)),this.scheduler.timeAxisViewModel.getDateFromPosition(s,e,r)}translateToScheduleCoordinate(t){return t-this.scheduler.timeAxisSubGridElement.getBoundingClientRect().top-globalThis.scrollY}translateToPageCoordinate(t){return t+this.scheduler.timeAxisSubGridElement.getBoundingClientRect().top+globalThis.scrollY}getResourceEventBox(t,e){var n;const r=t.id,s=e.id;let{renderData:i}=((n=this.eventMap.get(r))===null||n===void 0?void 0:n[s])||Mt;if(!i){var a,o;this.layoutResourceEvents(this.scheduler.resourceStore.getById(s)),i=(a=this.eventMap.get(r))===null||a===void 0||(o=a[s])===null||o===void 0?void 0:o.renderData}return i?new L(i.left,i.top,i.width,i.bottom-i.top):null}getScheduleRegion(t,e,n){var r;const s=this,{scheduler:i}=s,a=L.from(i.timeAxisSubGridElement,i.timeAxisSubGridElement);t&&(a.left=s.allResourceRecords.indexOf(t)*i.resourceColumnWidth,a.right=a.left+i.resourceColumnWidth);const o=i.timeAxis.startDate,l=i.timeAxis.endDate,c=((r=i.getDateConstraints)===null||r===void 0?void 0:r.call(i,t,e))||{start:o,end:l},d=i.getCoordinateFromDate(x.max(o,c.start)),u=i.getCoordinateFromDate(x.min(l,c.end));return n?(a.top=d,a.bottom=u):(a.top=s.translateToPageCoordinate(d),a.bottom=s.translateToPageCoordinate(u)),a}getRowRegion(t,e,n){const r=this,{scheduler:s}=r,i=r.allResourceRecords.indexOf(t)*s.resourceColumnWidth,a=s.timeAxis.startDate,o=s.timeAxis.endDate,l=e?x.max(a,e):a,c=n?x.min(o,n):o,d=s.getCoordinateFromDate(l),u=s.getCoordinateFromDate(c,!0,!0),g=Math.min(d,u),h=Math.abs(d-u);return new L(i,g,s.resourceColumnWidth,h)}get visibleDateRange(){const t=this.scheduler,e=t.scrollable.y,n=t.scrollable.clientHeight,r=t.getDateFromCoordinate(e)||t.timeAxis.startDate,s=t.getDateFromCoordinate(e+n)||t.timeAxis.endDate;return{startDate:r,endDate:s,startMS:r.getTime(),endMS:s.getTime()}}onResourceColumnWidthChange({width:t,oldWidth:e}){const n=this,{scheduler:r}=n;n.resourceColumns.width=r.timeAxisColumn.width=n.allResourceRecords.length*t,n.clearAll(),n.refresh(Math.abs(t-e)>30)}attachToProject(t){super.attachToProject(t),t&&t.ion({name:"project",refresh:"onProjectRefresh",thisObj:this})}onProjectRefresh(){const t=this,{scheduler:e,toDrawOnProjectRefresh:n}=t;e.isVisible?e.rendered&&!e.refreshSuspended&&(t.refreshAllWhenReady?(t.clearAll(),t.refresh(),t.refreshAllWhenReady=!1):n.size&&t.refresh(),n.clear()):e.whenVisible("refresh",e,[!0])}attachToEventStore(t){super.attachToEventStore(t),this.refreshAllWhenReady=!0,t&&t.ion({name:"eventStore",refreshPreCommit:"onEventStoreRefresh",thisObj:this})}onEventStoreRefresh({action:t}){t==="batch"&&(this.refreshAllWhenReady=!0)}onEventStoreChange({action:t,records:e=[],record:n,replaced:r,changes:s,isAssign:i}){const a=this,o=new Set;switch(e.forEach(l=>{var c;const d=(c=l.$linkedResources)===null||c===void 0?void 0:c.filter(u=>a.resourceStore.includes(u));d==null||d.forEach(u=>o.add(u.id))}),t){case"sort":case"group":case"move":case"remove":return;case"dataset":a.refreshAllResourcesWhenReady();return;case"add":case"updateMultiple":break;case"replace":r.forEach(([,l])=>{l.resources.map(c=>o.add(c.id))}),a.clearResources(o);break;case"removeall":case"filter":a.clearAll(),a.refresh();return;case"update":{const l=n.$entity?!Object.keys(s).some(d=>!n.$entity.getField(d)):!Object.keys(s).some(d=>!At[d]);let c=0;"startDate"in s&&c++,"endDate"in s&&c++,"duration"in s&&c++,(!l||c||"percentDone"in s||"inactive"in s||"segments"in s)&&(a.shouldWaitForInitializeAndEngineReady?a.refreshResourcesWhenReady(o):(a.clearResources(o),a.refresh()));return}}a.refreshResourcesWhenReady(o)}attachToResourceStore(t){const e=this;super.attachToResourceStore(t),e.refreshAllWhenReady=!0,e.resourceColumns&&(e.resourceColumns.resourceStore=t),t.ion({name:"resourceStore",changePreCommit:"onResourceStoreChange",refreshPreCommit:"onResourceStoreRefresh",load:()=>e.scheduler.unmaskBody(),thisObj:e,prio:1}),e.initialized&&e.scheduler.isPainted&&(e.firstResource=e.lastResource=null,e.clearAll(),e.renderer())}onResourceStoreChange({source:t,action:e,records:n=[],record:r,replaced:s,changes:i}){const a=this,o=s?s.map(d=>d[1]):n,l=new Set(o.map(d=>d.id));a.firstResource=a.lastResource=null,t._allResourceRecords=null;const{allResourceRecords:c}=t;if(a.scheduler.isEngineReady){switch(e){case"update":i!=null&&i.id?a.clearResources([i.id.oldValue,i.id.value]):a.clearResources([r.id]);break;case"filter":a.clearAll();break}i&&"columnWidth"in i&&a.clearAll(),a.refresh(!0)}else{switch(e){case"dataset":case"remove":case"removeall":a.refreshAllResourcesWhenReady();return;case"replace":case"add":if(!t.isGrouped){const d=o.reduce((u,g)=>Math.min(u,c.indexOf(g)),c.length);for(let u=d;u<c.length;u++)l.add(c[u].id)}}a.refreshResourcesWhenReady(l)}}onResourceStoreRefresh({action:t}){const e=this;(t==="sort"||t==="group")&&(e.firstResource=e.lastResource=e.resourceStore._allResourceRecords=null,e.clearAll(),e.refresh())}attachToAssignmentStore(t){super.attachToAssignmentStore(t),this.refreshAllWhenReady=!0,t&&t.ion({name:"assignmentStore",changePreCommit:"onAssignmentStoreChange",refreshPreCommit:"onAssignmentStoreRefresh",thisObj:this})}onAssignmentStoreChange({action:t,records:e=[],replaced:n,changes:r}){const s=this,i=new Set(e.map(a=>a.resourceId));if(s.scheduler.isEngineReady){switch(t){case"remove":s.clearResources(i);break;case"filter":s.clearAll();break;case"update":{if("resourceId"in r&&i.add(r.resourceId.oldValue),!Object.keys(r).filter(a=>a!=="resource"&&a!=="event").length)return;s.clearResources(i)}}s.refresh(!0)}else{switch(r&&"resourceId"in r&&i.add(r.resourceId.oldValue),t){case"removeall":s.refreshAllResourcesWhenReady();return;case"replace":n.forEach(([a,o])=>{i.add(a.resourceId),i.add(o.resourceId)})}s.refreshResourcesWhenReady(i)}}onAssignmentStoreRefresh({action:t,records:e}){t==="batch"&&(this.clearAll(),this.refreshAllResourcesWhenReady())}refreshRows(t){t&&(this.clearAll(),this.scheduler.refreshFromRerender=!1)}repaintEventsForResource(t){this.renderResource(t)}updateFromHorizontalScroll(t){t!==this.prevScrollX&&(this.renderer(),this.prevScrollX=t)}updateFromVerticalScroll(){this.renderer()}scrollResourceIntoView(t,e){const{scheduler:n}=this,r=this.allResourceRecords.indexOf(t)*n.resourceColumnWidth;return n.scrollHorizontallyTo(r,e)}get allResourceRecords(){return this.scheduler.resourceStore.allResourceRecords}onViewportResize(t){this.resourceColumns.availableWidth=t,this.renderer()}get resourceColumns(){var t;return(t=this.scheduler.timeAxisColumn)===null||t===void 0?void 0:t.resourceColumns}onLocaleChange(){this.clearAll()}onDragAbort(){}onBeforeRowHeightChange(){}onTimeAxisViewModelUpdate(){}updateElementId(){}releaseTimeSpanDiv(){}getConnectorStartSide(t){return"top"}getConnectorEndSide(t){return"bottom"}refreshResourcesWhenReady(t){this.clearResources(t),t.forEach(e=>this.toDrawOnProjectRefresh.add(e))}refreshAllResourcesWhenReady(){this.clearAll(),this.refreshAllWhenReady=!0}get resourceRange(){return this.getResourceRange(!0)}get visibleResources(){const{first:t,last:e}=this.getResourceRange();return{first:this.allResourceRecords[t],last:this.allResourceRecords[e]}}getResourceRange(t){const{scheduler:e,resourceStore:n}=this,{resourceColumnWidth:r,scrollX:s}=e,{scrollWidth:i}=e.timeAxisSubGrid.scrollable,a=t?this.resourceBufferSize:0,o=s-a,l=s+i+a;if(!(n!=null&&n.count))return{first:-1,last:-1};if(e.variableColumnWidths){let c,d=0,u,g=0;return this.allResourceRecords.forEach((h,f)=>{if(h.instanceMeta(e).insetStart=u=g,g=u+h.columnWidth,u>l)return!1;g>o&&c==null?c=f:u<l&&(d=f)}),{first:c,last:d}}else return{first:Math.max(Math.floor(s/r)-a,0),last:Math.min(Math.floor((s+e.timeAxisSubGrid.width)/r)+a,this.allResourceRecords.length-1)}}get dateRange(){const{scheduler:t}=this;let e=t.getDateFromCoordinate(Math.min(t.scrollTop+t.bodyHeight+t.tickSize-1,(t.virtualScrollHeight||t.scrollable.scrollHeight)-1));e||(e=t.timeAxis.last.endDate);let n=t.getDateFromCoordinate(Math.max(t.scrollTop-t.tickSize,0));return n||(n=t.timeAxis.first.startDate,e=t.getDateFromCoordinate(t.bodyHeight+t.tickSize-1)),{topDate:n,bottomDate:e}}getTimeSpanRenderData(t,e,n=!1){var r;const s=this,{scheduler:i}=s,{preamble:a,postamble:o}=t,{variableColumnWidths:l}=i,c=((r=i.features.eventBuffer)===null||r===void 0?void 0:r.enabled)&&s.isProVerticalRendering&&(a||o)&&!t.isMilestone,d=c?"wrapStartDate":"startDate",u=c?"wrapEndDate":"endDate",g=t.isBatchUpdating&&t.hasBatchedChange(d)&&!c?t.get(d):t[d],h=t.isBatchUpdating&&t.hasBatchedChange(u)&&!c?t.get(u):t[u],f=i.getResourceMargin(e),m=i.getCoordinateFromDate(g),v=e.instanceMeta(i),p=l?v.insetStart:s.allResourceRecords.indexOf(e)*i.resourceColumnWidth,R=i.getResourceWidth(e),S=R-f*2,T=g.getTime(),b=h.getTime();let M=i.getCoordinateFromDate(h),w=M-m;return M===-1&&(w=Math.round((b-T)*i.timeAxisViewModel.getSingleUnitInPixels("millisecond")),M=m+w),{eventRecord:t,resourceRecord:e,left:p,top:m,bottom:M,resourceWidth:R,width:S,height:w,startDate:g,endDate:h,startDateMS:T,endDateMS:b,useEventBuffer:c,children:[],start:g,end:h,startMS:T,endMS:b}}eventSorter(t,e){const n=t.dataStartMs||t.startDateMS,r=t.dataEndMs||t.endDateMS,s=e.dataStartMs||e.startDateMS,i=e.dataEndMs||e.endDateMS,a=t.isModel?t.name:t.eventRecord.name,o=e.isModel?e.name:e.eventRecord.name;return n-s||i-r||(a<o?-1:a==o?0:1)}layoutEvents(t,e,n=!1,r,s){const i=this,{scheduler:a}=i,{variableColumnWidths:o}=a,{id:l}=t,c=t.instanceMeta(a),d=r?`${l}-${r.id}`:l,u=i.resourceMap.set(d,{}).get(d),g=i.allResourceRecords.indexOf(t),{barMargin:h,resourceMargin:f}=a.getResourceLayoutSettings(t,r),m=e.reduce((v,p)=>{if(p.isScheduled){const R=a.generateRenderData(p,t,!1),S={renderData:R},T=V.getMapPath(i.eventMap,R.eventId,{});T[l]=S,u[R.eventId]=S,R.fillSize?(R.left=o?c.insetStart:g*a.resourceColumnWidth,R.width=a.getResourceWidth(t)):v.push(R)}return v},[]);return m.sort(s!=null?s:i.eventSorter),i.verticalLayout.applyLayout(m,a.getResourceWidth(t,r),f,h,g,a.getEventLayout(t,r)),u}layoutResourceEvents(t){const e=this,{scheduler:n}=e,{assignmentStore:r,eventStore:s,timeAxis:i}=n;let a=s.getEvents({includeOccurrences:n.enableRecurringEvents,resourceRecord:t,startDate:i.startDate,endDate:i.endDate,filter:(r.isFiltered||s.isFiltered)&&(o=>o.assignments.some(l=>l.resource===t&&r.includes(l)))});return a=n.getEventsToRender(t,a),e.layoutEvents(t,a)}addTemporaryDragElement(t){const{scheduler:e}=this,n=e.generateRenderData(t,t.resource,{timeAxis:!0,viewport:!0});n.top=n.row?n.top+n.row.top:e.getResourceEventBox(t,t.resource,!0).top;const r=this.renderEvent({renderData:n}),{dataset:s}=r;delete r.tabIndex,delete s.eventId,delete s.resourceId,delete s.assignmentId,delete s.syncId,s.transient=!0,r.parent=this.scheduler.foregroundCanvas,r.retainElement=!0;const i=A.createElement(r);return i.innerElement=i.firstChild,t.instanceMeta(e).hasTemporaryDragElement=!0,i}renderEvent(t){const{scheduler:e}=this,n=t.renderData,{resourceRecord:r,assignmentRecord:s,eventRecord:i}=n,a={className:n.wrapperCls,tabIndex:-1,children:[{role:"presentation",className:n.cls,style:(n.internalStyle||"")+(n.style||""),children:n.children,dataset:{taskFeature:"event"},syncOptions:{syncIdField:"taskBarFeature"}},...n.wrapperChildren],style:{top:n.top,[e.rtl?"right":"left"]:n.left,height:i.isMilestone?"1em":n.height,width:n.width,style:n.wrapperStyle||"",fontSize:i.isMilestone?Math.min(n.width,40):null},dataset:{resourceId:r.id,eventId:n.eventId,syncId:s?this.assignmentStore.getOccurrence(s,i).id:n.eventId},elementData:t,retainElement:(s||i).instanceMeta(this.scheduler).retainElement,syncOptions:{syncIdField:"taskFeature",releaseThreshold:0}};return a.className["b-sch-vertical"]=1,n.zIndex&&(a.zIndex=n.zIndex),s&&(a.dataset.assignmentId=s.id),t.elementConfig=a,a}renderResource(t){const e=this,{topDateMS:n,bottomDateMS:r}=e,s=[];let i=e.resourceMap.get(t.id);i||(i=e.layoutResourceEvents(t));for(const o in i){const l=i[o],{endDateMS:c,startDateMS:d,eventRecord:u}=l.renderData;if(c>=n&&d<=r&&!u.instanceMeta(e.scheduler).hasTemporaryDragElement){var a;const g=((a=l.elementConfig)===null||a===void 0?void 0:a.className)!=="b-released"&&l.elementConfig||e.renderEvent(l);s.push(g)}}return s}isEventElement(t){const e=t&&t.className;return e&&e[this.scheduler.eventCls+"-wrap"]}get shouldWaitForInitializeAndEngineReady(){return!this.initialized||!this.scheduler.isEngineReady&&!this.scheduler.isCreating}renderer(){const t=this,{scheduler:e}=t,{first:n,last:r}=t.resourceRange,{topDate:s,bottomDate:i}=t.dateRange,a=[],o=[];if(!t.shouldWaitForInitializeAndEngineReady){if(!x.isEqual(s,t.topDate)||!x.isEqual(i,t.bottomDate)){t.topDate=s,t.bottomDate=i,t.topDateMS=s.getTime(),t.bottomDateMS=i.getTime();const l=t.timeView.range={startDate:s,endDate:i};e.onVisibleDateRangeChange(l)}if(n!==-1&&r!==-1)for(let l=n;l<=r;l++)a.push.apply(a,t.renderResource(t.allResourceRecords[l]));if(e.getForegroundDomConfigs(o),a.push.apply(a,o),q.sync({domConfig:{onlyChildren:!0,children:a},targetElement:e.foregroundCanvas,syncIdField:"syncId",callback({action:l,domConfig:c,lastDomConfig:d,targetElement:u,jsx:g}){var h;const{reactComponent:f}=e;if(t.isEventElement(c)||g||c!=null&&(h=c.elementData)!==null&&h!==void 0&&h.jsx){var m;const p=Tt[l],R=xt[l];if((m=e.processEventContent)!==null&&m!==void 0&&m.call(e,{action:l,domConfig:c,isRelease:!1,targetElement:u,reactComponent:f,jsx:g}))return;if(p&&t.isEventElement(d)&&!d.isReleased){var v;const S=d.elementData.renderData,T={renderData:S,assignmentRecord:S.assignmentRecord,eventRecord:S.eventRecord,resourceRecord:S.resourceRecord,element:u};(v=e.processEventContent)===null||v===void 0||v.call(e,{isRelease:p,targetElement:u,reactComponent:f,assignmentRecord:S.assignmentRecord}),u===A.getActiveElement(u)&&e.focusElement.focus(),e.trigger("releaseEvent",T)}if(R){const S=c.elementData.renderData,T={renderData:S,assignmentRecord:S.assignmentRecord,eventRecord:S.eventRecord,resourceRecord:S.resourceRecord,element:u,isReusingElement:l==="reuseElement",isRepaint:l==="reuseOwnElement"};T.reusingElement=l==="reuseElement",e.trigger("renderEvent",T)}}}}),t.firstResource!==n||t.lastResource!==r){const l=t.resourceColumns.visibleResources={firstResource:n,lastResource:r};t.firstResource=n,t.lastResource=r,e.onVisibleResourceRangeChange(l),e.trigger("resourceRangeChange",l)}}}refresh(t){this.scheduler.runWithTransition(()=>this.renderer(),t)}refreshResources(t){this.clearResources(t),this.refresh()}refreshEventsForResource(t,e=!0,n=!0){this.refreshResources([t.id])}onRenderDone(){}get timeView(){return this.scheduler.timeView}clearResources(t){const{resourceMap:e,eventMap:n}=this;t.forEach(r=>{e.has(r)&&(Object.values(e.get(r)).forEach(({renderData:{eventId:s}})=>{delete n.get(s)[r]}),e.delete(r))})}clearAll(){this.resourceMap.clear(),this.eventMap.clear()}}be._$name="VerticalRendering";const It={month:"MMMM, YYYY",week:["MMMM YYYY (Wp)","S{MMM} - E{MMM YYYY} (S{Wp})"],day:"MMMM D, YYYY"};class Te extends ft.mixin(ct,vt,Ve,He,je,$e,_e,We,Ne,pt,st,it){constructor(){super(...arguments);F(this,"timeCellSelector",".b-sch-timeaxis-cell");F(this,"resourceTimeRangeSelector",".b-sch-resourcetimerange")}static get $name(){return"SchedulerBase"}static get type(){return"schedulerbase"}static get configurable(){return{date:{value:null,$config:{equal:"date"}},stepUnit:"week",range:"week",getDateConstraints:null,verticalTimeAxisColumn:{},createEventOnDblClick:!0,schedulableAreaSelector:".b-sch-timeaxis-cell",scheduledEventName:"event",sortFeatureStore:"resourceStore"}}static get defaultConfig(){return{mode:"horizontal",eventCls:"b-sch-event",timeCellCls:"b-sch-timeaxis-cell",overScheduledEventClass:"b-sch-event-hover",allowOverlap:!0,rowHeight:60,preCalculateHeightLimit:1e4,crudManagerClass:Et,testConfig:{loadMaskError:{autoClose:10,showDelay:0}}}}afterConstruct(){const e=this;super.afterConstruct(),e.ion({scroll:"onVerticalScroll",thisObj:e}),e.createEventOnDblClick&&e.ion({scheduledblclick:e.onTimeAxisCellDblClick})}onPaintOverride(){}get store(){return super.store}set store(e){super.store=e}get visibleResources(){var e,n;const r=this;return r.isVertical?r.currentOrientation.visibleResources:{first:r.store.getById((e=r.firstVisibleRow)===null||e===void 0?void 0:e.id),last:r.store.getById((n=r.lastVisibleRow)===null||n===void 0?void 0:n.id)}}onLocaleChange(){this.currentOrientation.onLocaleChange(),super.onLocaleChange()}onTimeAxisCellDblClick({date:e,resourceRecord:n,row:r}){this.createEvent(e,n,r)}onVerticalScroll({scrollTop:e}){this.currentOrientation.updateFromVerticalScroll(e)}onEventCreated(e){}get isHorizontal(){return this.mode==="horizontal"}get isVertical(){return this.mode==="vertical"}get mode(){return this._mode}set mode(e){const n=this;n._mode=e,n[e]||(n.element.classList.add(`b-sch-${e}`),e==="horizontal"?(n.horizontal=new me(n),n.isPainted&&n.horizontal.init()):e==="vertical"&&(n.vertical=new be(n),n.rendered&&n.vertical.init()))}get currentOrientation(){return this[this.mode]}onElementKeyDown(e){return super.onElementKeyDown(e)}onElementKeyUp(e){return super.onElementKeyUp(e)}onElementMouseOver(e){return super.onElementMouseOver(e)}onElementMouseOut(e){return super.onElementMouseOut(e)}processEventDrop(){}processCrossSchedulerEventDrop(){}beforeEventDragStart(){}afterEventDragStart(){}afterEventDragAbortFinalized(){}checkEventDragValidity(){}afterEventResizeStart(){}get hasEventEditor(){return!!this.eventEditingFeature}get eventEditingFeature(){const{eventEdit:e,taskEdit:n,simpleEventEdit:r}=this.features;return e!=null&&e.enabled?e:n!=null&&n.enabled?n:r!=null&&r.enabled?r:null}editEvent(e,n,r){const s=this,{eventStore:i,assignmentStore:a}=s;if(!s.hasEventEditor)return!1;if(e.eventStore!==i){const{enableEventAnimations:o}=s,l=[];e.isCreating=!0;let c=[];if(n&&(l.push(n),c=a.assignEventToResource(e,n)),s.trigger("beforeEventAdd",{eventRecord:e,resourceRecords:l,assignmentRecords:c})===!1)return a==null||a.remove(c),!1;s.enableEventAnimations=!1,i.add(e),s.project.commitAsync().then(()=>s.enableEventAnimations=o),s.refreshRows()}}async createEvent(e,n){var r;const s=this,{enableEventAnimations:i,eventStore:a,assignmentStore:o,hasEventEditor:l}=s,c=[n],d=s.createEventOnDblClick.useEventModelDefaults,u=d?a.modelClass.defaultValues.duration:1,g=d?a.modelClass.defaultValues.durationUnit:s.timeAxis.unit,h=a.createRecord({startDate:e,endDate:x.add(e,u,g),duration:u,durationUnit:g,name:s.L("L{Object.newEvent}")});if(s.readOnly||n.isSpecialRow||n.readOnly||!s.allowOverlap&&!s.isDateRangeAvailable(h.startDate,h.endDate,null,n))return;(r=s.eventEditingFeature)===null||r===void 0||r.captureStm(!0),h.isCreating=l,s.onEventCreated(h);const f=o==null?void 0:o.assignEventToResource(h,n);if(s.trigger("beforeEventAdd",{eventRecord:h,resourceRecords:c,assignmentRecords:f})===!1){var m;o==null||o.remove(f),(m=s.eventEditingFeature)===null||m===void 0||m.freeStm(!1);return}s.enableEventAnimations=!1,a.add(h),s.project.commitAsync().then(()=>s.enableEventAnimations=i),s.isCreating=!0,s.refreshRows(),s.isCreating=!1,s.trigger("eventAutoCreated",{eventRecord:h,resourceRecord:n}),l&&s.editEvent(h,n,s.getEventElement(h))}isDateRangeAvailable(e,n,r,s){return this.eventStore.isDateRangeAvailable(e,n,r,s)}async resumeRefresh(e){super.resumeRefresh(!1);const n=this;if(!n.refreshSuspended&&e){if(!n.isEngineReady)return n.currentOrientation.refreshAllWhenReady=!0,n.project.commitAsync();n.isDestroyed||n.refreshWithTransition()}}toggleEmptyText(){const e=this;if(e.bodyContainer){var n;A.toggleClasses(e.bodyContainer,"b-grid-empty",!(e.resourceStore.count>0||(n=e.crudManager)!==null&&n!==void 0&&n.isLoading))}}getRowHeight(e){if(this.isHorizontal){const n=this.currentOrientation.calculateRowHeight(e);return this.rowManager.storeKnownHeight(e.id,n),n}}calculateRowHeights(e,n=!1){e.forEach(r=>r&&this.getRowHeight(r)),n||this.rowManager.estimateTotalHeight(!0)}calculateAllRowHeights(e=!1){const{store:n,rowManager:r}=this,s=Math.min(n.count,this.preCalculateHeightLimit);if(s){r.clearKnownHeights();for(let i=0;i<s;i++)this.getRowHeight(n.getAt(i));e||r.estimateTotalHeight(!0)}}get dateBounds(){const e=this,n=[e.startDate];return e.range==="week"&&n.push(e.lastDate),n}get defaultDescriptionFormat(){return It[this.range]}get lastDate(){const e=this.endDate;return e&&x.add(e,-1,"day")}getEventRecord(e){return e=A.getEventElement(e),this.resolveEventRecord(e)}getEventElement(e){return this.getElementFromEventRecord(e)}changeRange(e){return x.normalizeUnit(e)}updateRange(e){if(!this.isConfiguring){const n=this.date,r=this.date=x.startOf(n,e);n.getTime()===r.getTime()&&this.updateDate(r)}}changeStepUnit(e){return x.normalizeUnit(e)}updateDate(e){const n=this,r=x.startOf(e,n.range);n.setTimeSpan(r,x.add(r,1,n.range)),n.visibleDate={date:x.max(e,n.timeAxis.startDate),block:"start",animate:!0},n.trigger("descriptionChange")}previous(){this.date=x.add(this.date,-1,this.stepUnit)}next(){this.date=x.add(this.date,1,this.stepUnit)}async scheduleEvent({startDate:e,eventRecord:n,resourceRecord:r,element:s}){const i=this;if(i.eventStore.includes(n)||([n]=i.eventStore.add(n)),n.startDate=e,n.assign(r),s){const a=L.from(s,i.foregroundCanvas);A.setTranslateXY(s,0,0),A.setTopLeft(s,a.y,a.x),q.addChild(i.foregroundCanvas,s,n.assignments[0].id)}await i.project.commitAsync()}}Te.initClass(),Te._$name="SchedulerBase";export{we as DependencyEdit,G as EventCopyPaste,de as EventDrag,Q as EventDragCreate,ue as EventTooltip,Ce as HorizontalLayoutPack,Se as HorizontalLayoutStack,me as HorizontalRendering,ce as ResourceTimeRangesBase,J as ScheduleContext,Te as SchedulerBase,Ve as SchedulerDom,He as SchedulerDomEvents,We as SchedulerEventRendering,Ne as SchedulerRegions,$e as SchedulerScroll,_e as SchedulerState,je as SchedulerStores,Y as StickyEvents,he as TimeRanges,be as VerticalRendering,le as VerticalTimeAxisColumn};
//# sourceMappingURL=SchedulerBase.js.map
