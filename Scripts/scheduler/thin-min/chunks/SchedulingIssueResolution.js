/*!
 *
 * Bryntum Scheduler Pro 5.3.7
 *
 * Copyright(c) 2023 Bryntum AB
 * https://bryntum.com/contact
 * https://bryntum.com/license
 *
 */
var Po=Object.defineProperty;var Ro=(o,e,t)=>e in o?Po(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var B=(o,e,t)=>(Ro(o,typeof e!="symbol"?e+"":e,t),t);import{Mixin as y,CI as Oe,map as yi,uniqueOnly as To,concatIterable as $o,MixinAny as vr,concat as Cr,isInstanceOf as bn,MAX_DATE as le,MIN_DATE as ve,EdgeInclusion as vi,format as Be,AbstractPartOfProjectGenericMixin as Io,AbstractPartOfProjectStoreMixin as Mo,AbstractPartOfProjectModelMixin as Oo,AbstractCalendarMixin as xo,AbstractAssignmentStoreMixin as jo,AbstractCalendarManagerStoreMixin as Ao,AbstractDependencyStoreMixin as Fo,stripDuplicates as ko,TimeUnit as b,Direction as G,isNotNumber as Bo,AbstractHasAssignmentsMixin as _o,AbstractEventStoreMixin as Lo,AbstractResourceStoreMixin as Vo,DependencyType as _t,AbstractProjectMixin as No,ProjectType as Lt,ConstraintIntervalSide as ce,isDateFinite as ct,ConstraintType as j,DependenciesCalendar as wn,CalendarIteratorResult as Ci,SchedulingMode as N,CalendarIntervalMixin as Dr,CalendarIntervalStore as Wo,DependencyValidationResult as dt,AssignmentModelMixin as zo,AssignmentStoreMixin as Go,DependencyBaseModel as Uo,DependencyStoreMixin as Ho,TimeSpan as qo,EventModelMixin as Ko,ResourceModelMixin as Qo,ResourceStoreMixin as Xo,ProjectCrudManager as Jo}from"./ProjectModel.js";import{DateHelper as I,Model as ut,ObjectHelper as K,LocaleHelper as Sr,Base as de,Localizable as pe,Store as xe,Combo as Pn,AjaxStore as Rn,ArrayHelper as ht,DomSync as Ce,InstancePlugin as Tn,DomHelper as Vt,Editor as Zo,DomClassList as Yo,Rectangle as Nt,EventHelper as el,Events as tl,Popup as Er,Toast as nl,Widget as Di,Container as br,LocaleManagerSingleton as il,StringHelper as Wt,Delayable as sl,WalkHelper as rl,Promissory as al}from"./Editor.js";import{Base as U,CalendarCacheMultiple as ol,EventResize as ll}from"./TimelineBase.js";import{StateTrackingManager as Si,UpdateAction as wr}from"./AvatarRendering.js";import{GridFeatureManager as De}from"./GridBase.js";import{DragHelper as cl,DateField as Pr,DurationField as dl,MessageDialog as Ei}from"./MessageDialog.js";import{TaskEditStm as ul,AttachToProjectMixin as hl}from"./EventNavigation.js";import"./Grid.js";import"./RegionResize.js";import"./TextAreaField.js";import{WebSocketManager as fl,RadioGroup as pl}from"./TabPanel.js";import"./Card.js";import{GridRowModel as gl}from"./GridRowModel.js";const ml=-Math.pow(2,30),_e=Math.pow(2,30)-1,bi=o=>o.slice(0,1).toUpperCase()+o.slice(1),$n=o=>Object(o)!==o,wi=(o,e,t)=>(Object.defineProperty(o,e,{value:t,enumerable:!0,configurable:!0}),t),E=o=>function(e,t){e[t]=o},yl=(o,e)=>{for(const t of o)e.add(t);return e},zt=o=>new Promise(e=>setTimeout(e,o));let Pi=null;const Ri=function(o){return Pi===null&&(Pi=typeof regeneratorRuntime!="undefined"),Pi===!0?regeneratorRuntime.isGeneratorFunction(o):o.constructor.name==="GeneratorFunction"},In=function(o){return o&&typeof o.then=="function"},vl=(...o)=>{},Rr=o=>vl,Tr=Rr(),Cl=Rr();var Se;(function(o){o.Cancel="Cancel",o.Resume="Resume"})(Se||(Se={}));const $r=Symbol("WalkSource"),ft=-1,Ue=-2;class Ti extends U{constructor(){super(...arguments),this.visited=new Map,this.toVisit=[],this.currentEpoch=0}startFrom(e){this.continueFrom(e)}continueFrom(e){this.toVisit.push.apply(this.toVisit,e.map(t=>({node:t,from:$r,label:void 0}))),this.walkDepth()}onNode(e,t){}onTopologicalNode(e){}onCycle(e,t){return Se.Cancel}forEachNext(e,t){throw new Error("Abstract method called")}collectNext(e,t,i){throw new Error("Abstract method called")}getVisitedInfo(e){return this.visited.get(e)}setVisitedInfo(e,t,i){return i?(i.visitedAt=t,i.visitEpoch=this.currentEpoch):(i={visitedAt:t,visitEpoch:this.currentEpoch},this.visited.set(e,i)),i}walkDepth(){this.visited;const e=this.toVisit;let t;for(;t=e.length;){const i=e[t-1].node,s=this.getVisitedInfo(i);if(s&&s.visitedAt===Ue&&s.visitEpoch===this.currentEpoch){e.pop();continue}if(s&&s.visitEpoch===this.currentEpoch&&s.visitedAt!==ft){if(s.visitedAt<t){if(this.onCycle(i,e)!==Se.Resume)break}else s.visitedAt=Ue,this.onTopologicalNode(i);e.pop()}else{if(this.onNode(i,e[t-1])===!1)break;const n=this.setVisitedInfo(i,t,s),r=e.length;this.collectNext(i,e,n),e.length===r&&(n.visitedAt=Ue,this.onTopologicalNode(i),e.pop())}}}}function Ir(o){const e=o.length;if(e===0)return[];const t=o[e-1].node,i=[t];let s=e-1,n=s;for(;s>=0&&o[s].from!==t;){for(;s>=0&&o[s].from===o[n].from;)s--;s>=0&&(i.push(o[s].node),n=s)}return s<0?[]:(i.push(t),i.reverse())}var Dl=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};let Mr=0;const J=Mr++;class L extends U{constructor(){super(...arguments),this.formulaId=Mr++,this.inputs=new Set}}class Or extends Ti{collectNext(e,t){if(e instanceof L)t.push({node:e.output,from:e,label:void 0});else{const i=this.cache.formulasByInput.get(e);i&&i.forEach(s=>t.push({node:s,from:e,label:void 0}))}}}class Mn extends y([U],e=>class extends e{constructor(){super(...arguments),this.variables=new Set,this.formulas=new Set,this.$formulasByInput=void 0,this.$formulasByOutput=void 0}get formulasByInput(){return this.$formulasByInput!==void 0?this.$formulasByInput:(this.fillCache(),this.$formulasByInput)}get formulasByOutput(){return this.$formulasByOutput!==void 0?this.$formulasByOutput:(this.fillCache(),this.$formulasByOutput)}add(i){this.$formulasByInput=void 0,this.$formulasByOutput=void 0,this.formulas.add(i)}has(i){return this.formulas.has(i)}fillCache(){this.$formulasByInput=new Map,this.$formulasByOutput=new Map,this.formulas.forEach(i=>{let s=this.$formulasByOutput.get(i.output);s||(s=new Set,this.$formulasByOutput.set(i.output,s)),s.add(i),i.inputs.forEach(n=>{let r=this.$formulasByInput.get(n);r||(r=new Set,this.$formulasByInput.set(n,r)),r.add(i)})})}allInputVariables(){return To($o(yi(this.formulas,i=>i.inputs.values())))}isCyclic(){let i=!1;return Or.new({cache:this,onCycle:()=>(i=!0,Se.Cancel)}).startFrom(Array.from(this.allInputVariables())),i}}){}class pt extends Mn{}class Ee extends U{constructor(){super(...arguments),this.description=void 0,this.defaultResolutionFormulas=new Set,this.resolutionsByInputHash=new Map}clear(){this.resolutionsByInputHash.clear()}resolve(e){const t=this.resolutionsByInputHash.get(e.hash);if(t!==void 0)return t;const i=this.buildResolution(e);return this.resolutionsByInputHash.set(e.hash,i),i}buildResolution(e){const t=gi.new({context:this,input:e}),i=Array.from(t.next()).map(s=>({resolution:s.asResolution(),nbrOfDefaultFormulas:Array.from(s.activatedFormulas.formulas).reduce((n,r)=>s.formulaIsDefault(r)?n+1:n,0),unCoveredInputWeight:s.unCoveredInputWeight()}));if(i.sort((s,n)=>s.unCoveredInputWeight<n.unCoveredInputWeight?-1:s.unCoveredInputWeight>n.unCoveredInputWeight?1:n.nbrOfDefaultFormulas-s.nbrOfDefaultFormulas),i.length>0)return i[0].resolution;debugger}}var be;(function(o){o[o.NoInput=0]="NoInput",o[o.HasPreviousValue=1]="HasPreviousValue",o[o.HasProposedValue=2]="HasProposedValue",o[o.KeepIfPossible=4]="KeepIfPossible"})(be||(be={}));class $i extends U{constructor(){super(...arguments),this.context=void 0,this.input=void 0,this.$hash=""}get hash(){return this.$hash!==""?this.$hash:this.$hash=this.buildHash()}get description(){return this.context.description}get resolution(){return this.context.resolve(this)}initialize(...e){super.initialize(...e),this.input=new Map(Oe(this.description.variables).map(t=>[t,be.NoInput]))}buildHash(){return String.fromCharCode(...Oe(this.description.variables).inBatchesBySize(5).map(e=>this.batchToCharCode(e)))}batchToCharCode(e){return e.reduceRight((t,i,s)=>t|this.input.get(i)<<s*3,0)}addProposedValueFlag(e){const t=this.input.get(e);this.input.set(e,t|be.HasProposedValue)}hasProposedValue(e){return!!(this.input.get(e)&be.HasProposedValue)}hasProposedValueVars(){return Oe(this.description.variables).filter(e=>this.hasProposedValue(e))}addPreviousValueFlag(e){const t=this.input.get(e);this.input.set(e,t|be.HasPreviousValue)}hasPreviousValue(e){return!!(this.input.get(e)&be.HasPreviousValue)}hasPreviousValueVars(){return Oe(this.description.variables).filter(e=>this.hasPreviousValue(e))}addKeepIfPossibleFlag(e){const t=this.input.get(e);this.input.set(e,t|be.KeepIfPossible)}keepIfPossible(e){return!!(this.input.get(e)&be.KeepIfPossible)}keepIfPossibleVars(){return Oe(this.description.variables).filter(e=>this.keepIfPossible(e))}}Dl([Tr],$i.prototype,"context",void 0);class gi extends U{constructor(){super(...arguments),this.context=void 0,this.input=void 0,this.previous=void 0,this.activatedFormula=void 0,this.$activatedFormulas=void 0}get activatedFormulas(){if(this.$activatedFormulas!==void 0)return this.$activatedFormulas;const e=Mn.new({variables:this.description.variables,formulas:Oe(this.thisAndPreviousStates()).map(t=>t.activatedFormula).toSet()});return this.$activatedFormulas=e}get description(){return this.context.description}*thisAndPreviousStates(){let e=this;for(;e&&e.activatedFormula;)yield e,e=e.previous}formulaHasProposedValueInInput(e){return Array.from(e.inputs).some(t=>this.input.hasProposedValue(t))}unCoveredInputWeight(){const e=yi(this.input.hasProposedValueVars(),s=>({variable:s,isProposed:!0})),t=yi(this.input.keepIfPossibleVars(),s=>({variable:s,isProposed:!1}));return Oe([e,t]).concat().uniqueOnlyBy(s=>s.variable).reduce((s,{variable:n,isProposed:r})=>{let a=0;const l=this.activatedFormulas.formulasByOutput.get(n);if(l){const d=l.size===1?Array.from(l)[0]:null;d&&this.formulaIsDefault(d)&&this.formulaHasProposedValueInInput(d)?r?a+=1e6:a+=1e4:r?a+=1e7:a+=1e5}const c=this.activatedFormulas.formulasByInput.get(n);return c&&c.size>0||(r?a+=1e3:a+=100),s+a},0)}preferFormula(e,t){const i=this.formulaAllInputsHasProposed(e),s=this.formulaAllInputsHasProposed(t);if(i&&!s)return-1;if(s&&!i)return 1;const n=this.formulaCountInputsWithProposedOrKeep(e),r=this.formulaCountInputsWithProposedOrKeep(t);return n>r?-1:n<r?1:this.formulaIsDefault(e)&&!this.formulaIsDefault(t)?-1:this.formulaIsDefault(t)&&!this.formulaIsDefault(e)?1:0}formulaIsDefault(e){return this.context.defaultResolutionFormulas.has(e)}formulaCountInputsWithProposedOrKeep(e){let t=0;return Array.from(e.inputs).forEach(i=>{(this.input.hasProposedValue(i)||this.input.keepIfPossible(i))&&t++}),t}formulaAllInputsHasProposedOrKeep(e){return Array.from(e.inputs).every(t=>this.input.hasProposedValue(t)||this.input.keepIfPossible(t))}formulaAllInputsHasProposed(e){return Array.from(e.inputs).every(t=>this.input.hasProposedValue(t))}formulaIsApplicable(e){const t=Array.from(e.inputs).every(s=>this.input.hasProposedValue(s)||this.input.hasPreviousValue(s)||this.activatedFormulas.formulasByOutput.has(s)),i=Mn.new({formulas:new Set(this.activatedFormulas.formulas)});return i.add(e),t&&!i.isCyclic()}formulaIsInsignificant(e){const t=this.activatedFormulas.formulasByOutput.has(e.output),i=this.input.hasPreviousValue(e.output);return t||i&&Array.from(e.inputs).some(s=>!this.input.hasPreviousValue(s)&&!this.input.hasProposedValue(s)&&!this.activatedFormulas.formulasByOutput.has(s))}unvisitedFormulas(){return Array.from(this.description.formulas).filter(e=>!this.activatedFormulas.has(e))}*next(){const e=this.unvisitedFormulas();e.sort(this.preferFormula.bind(this));let t=!0;for(const i of e){if(!this.formulaIsApplicable(i)||this.formulaIsInsignificant(i))continue;yield*gi.new({previous:this,context:this.context,input:this.input,activatedFormula:i}).next(),t=!1}t&&(yield this)}asResolution(){return new Map(Oe(this.description.variables).map(e=>{const t=this.activatedFormulas.formulasByOutput.get(e);if(t)for(const i of t)return[e,i.formulaId];return[e,J]}))}}var Gt=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const gt=Symbol("BreakCurrentStackExecution");class W extends U{}Gt([E(!0)],W.prototype,"sync",void 0),Gt([E(!0)],W.prototype,"pure",void 0);const Ii=Symbol("ProposedOrPreviousSymbol"),A=W.new({handler:Ii}),Ut=Symbol("RejectSymbol");class mt extends W{constructor(){super(...arguments),this.handler=Ut}}Gt([E(!1)],mt.prototype,"pure",void 0);const He=o=>mt.new({reason:o}),Mi=Symbol("TransactionSymbol"),Sl=W.new({handler:Mi}),Oi=Symbol("OwnQuarkSymbol"),El=W.new({handler:Oi}),xi=Symbol("OwnIdentifierSymbol"),bl=W.new({handler:xi}),ji=Symbol("WriteSymbol");class Ai extends W{constructor(){super(...arguments),this.handler=ji}}Gt([E(!1)],Ai.prototype,"pure",void 0);const xr=(o,e,...t)=>Ai.new({identifier:o,proposedArgs:[e,...t]}),Fi=Symbol("WriteSeveralSymbol");class ki extends W{constructor(){super(...arguments),this.handler=Fi}}Gt([E(!1)],ki.prototype,"pure",void 0);const jr=o=>ki.new({writes:o}),Bi=Symbol("PreviousValueOfSymbol");class Ar extends W{constructor(){super(...arguments),this.handler=Bi}}const On=o=>Ar.new({identifier:o}),_i=Symbol("ProposedValueOfSymbol");class Fr extends W{constructor(){super(...arguments),this.handler=_i}}const kr=o=>Fr.new({identifier:o}),Li=Symbol("HasProposedValueSymbol");class Br extends W{constructor(){super(...arguments),this.handler=Li}}const we=o=>Br.new({identifier:o}),Vi=Symbol("HasProposedNotPreviousValueSymbol");class _r extends W{constructor(){super(...arguments),this.handler=Vi}}const Lr=o=>_r.new({identifier:o}),Ni=Symbol("ProposedOrPreviousValueOfSymbol");class Vr extends W{constructor(){super(...arguments),this.handler=Ni}}const V=o=>Vr.new({identifier:o}),Wi=Symbol("ProposedArgumentsOfSymbol");class Nr extends W{constructor(){super(...arguments),this.handler=Wi}}const qe=o=>Nr.new({identifier:o}),zi=Symbol("UnsafeProposedOrPreviousValueOfSymbol");class Wr extends W{constructor(){super(...arguments),this.handler=zi}}const wl=o=>Wr.new({identifier:o}),Gi=Symbol("UnsafePreviousValueOfSymbol");class zr extends W{constructor(){super(...arguments),this.handler=Gi}}const Pl=o=>zr.new({identifier:o});class Gr extends $i{collectInfo(e,t,i){e(On(t))!=null&&this.addPreviousValueFlag(i),e(Lr(t))&&this.addProposedValueFlag(i)}}const Rl=Symbol("ContextSync"),Tl=Symbol("ContextGen");class Ur extends y([],e=>class extends e{constructor(){super(...arguments),this.iterator=void 0,this.iterationResult=void 0}isCalculationStarted(){return!!(this.iterator||this.iterationResult)}isCalculationCompleted(){return!!(this.iterationResult&&this.iterationResult.done)}get result(){return this.iterationResult&&this.iterationResult.done?this.iterationResult.value:void 0}startCalculation(i,...s){const n=this.iterator=this.calculation.call(this.context||this,i,...s);return this.iterationResult=n.next()}continueCalculation(i){return this.iterationResult=this.iterator.next(i)}cleanupCalculation(){this.iterationResult=void 0,this.iterator=void 0}*calculation(i,...s){throw new Error("Abstract method `calculation` called")}runSyncWithEffect(i,...s){for(this.startCalculation(i,...s);!this.isCalculationCompleted();)this.continueCalculation(i(this.iterationResult.value));return this.iterator=void 0,this.result}async runAsyncWithEffect(i,...s){for(this.startCalculation(i,...s);!this.isCalculationCompleted();)this.continueCalculation(await i(this.iterationResult.value));return this.iterator=void 0,this.result}}){}const xn=Symbol("SynchronousCalculationStarted"),$l={value:xn};class Hr extends y([],e=>class extends e{constructor(){super(...arguments),this.iterationResult=void 0}isCalculationStarted(){return!!this.iterationResult}isCalculationCompleted(){return!!(this.iterationResult&&this.iterationResult.done)}get result(){return this.iterationResult&&this.iterationResult.done?this.iterationResult.value:void 0}startCalculation(i,...s){return this.iterationResult=$l,this.iterationResult={done:!0,value:this.calculation.call(this.context||this,i,...s)}}continueCalculation(i){throw new Error("Can not continue synchronous calculation")}cleanupCalculation(){this.iterationResult=void 0}calculation(i,...s){throw new Error("Abstract method `calculation` called")}runSyncWithEffect(i,...s){return this.startCalculation(i,...s),this.result}async runAsyncWithEffect(i,...s){throw new Error("Can not run synchronous calculation asynchronously")}}){}function qr(o,e,t,i){const s=e.apply(i||null,t);let n=s.next();for(;!n.done;)n=s.next(o(n.value));return n.value}async function Ht(o,e,t,i){const s=e.apply(i||null,t);let n=s.next();for(;!n.done;){let r,a=!1;do{a=!1;try{r=o(n.value)}catch(l){if(l instanceof W)if(await o(l)==="Cancel"){o(He(l));return}else a=!0}}while(a);In(r)?n=s.next(await r):n=s.next(r)}return n.value}var yt;(function(o){o[o.Normal=1]="Normal",o[o.Past=2]="Past"})(yt||(yt={}));let Il=0;class jn extends vr([Map],e=>class extends e{constructor(){super(...arguments),this.createdAt=void 0,this.identifier=void 0,this.value=void 0,this.proposedValue=void 0,this.proposedIsPrevious=!1,this.proposedArguments=void 0,this.usedProposedOrPrevious=!1,this.previous=void 0,this.origin=void 0,this.originId=ml,this.needToBuildProposedValue=!1,this.edgesFlow=0,this.visitedAt=ft,this.visitEpoch=0,this.promise=void 0,this.$outgoingPast=void 0}static new(i){const s=new this;return i&&Object.assign(s,i),s}get level(){return this.identifier.level}get calculation(){return this.identifier.calculation}get context(){return this.identifier.context||this.identifier}forceCalculation(){this.edgesFlow=_e}cleanup(){this.cleanupCalculation()}isShadow(){return!!(this.origin&&this.origin!==this)}resetToEpoch(i){this.visitEpoch=i,this.visitedAt=ft,this.edgesFlow<0&&(this.edgesFlow=0),this.usedProposedOrPrevious=!1,this.cleanupCalculation(),this.clearOutgoing(),this.promise=void 0,this.origin&&this.origin===this?(this.proposedArguments=void 0,this.value!==void 0&&(this.proposedValue=this.value),this.value=void 0):(this.origin=void 0,this.value=void 0),this.identifier.proposedValueIsBuilt&&this.proposedValue!==O&&(this.needToBuildProposedValue=!0,this.proposedValue=void 0)}copyFrom(i){this.value=i.value,this.proposedValue=i.proposedValue,this.proposedArguments=i.proposedArguments,this.usedProposedOrPrevious=i.usedProposedOrPrevious}clearProperties(){this.value=void 0,this.proposedValue=void 0,this.proposedArguments=void 0}mergePreviousOrigin(i){const s=this.origin;if(s!==this.previous)throw new Error("Invalid state");this.copyFrom(s);const n=this.getOutgoing();for(const[r,a]of s.getOutgoing())if(!n.get(r)){const c=i.get(r);(!c||c.originId===a.originId)&&n.set(r,c||a)}if(s.$outgoingPast!==void 0){const r=this.getOutgoingPast();for(const[a,l]of s.getOutgoingPast())if(!r.get(a)){const d=i.get(a);(!d||d.originId===l.originId)&&r.set(a,d||l)}}this.origin=this,s.clearProperties(),s.clear()}setOrigin(i){this.origin=i,this.originId=i.originId}getOrigin(){return this.origin?this.origin:this.startOrigin()}startOrigin(){return this.originId=Il++,this.origin=this}getOutgoing(){return this}getOutgoingPast(){return this.$outgoingPast!==void 0?this.$outgoingPast:this.$outgoingPast=new Map}addOutgoingTo(i,s){(s===yt.Normal?this:this.getOutgoingPast()).set(i.identifier,i)}clearOutgoing(){this.clear(),this.$outgoingPast!==void 0&&this.$outgoingPast.clear()}getValue(){const i=this.origin;return i===this?this.value:i?i.getValue():void 0}setValue(i){if(this.origin&&this.origin!==this)throw new Error("Can not set value to the shadow entry");this.getOrigin().value=i}hasValue(){return this.getValue()!==void 0}hasProposedValue(){return this.isShadow()?!1:this.hasProposedValueInner()}hasProposedValueInner(){return this.proposedValue!==void 0}getProposedValue(i){return this.needToBuildProposedValue&&(this.proposedValue=this.identifier.buildProposedValue.call(this.identifier.context||this.identifier,this.identifier,this,i),this.needToBuildProposedValue=!1),this.proposedValue}outgoingInTheFutureCb(i,s){let n=this;for(;n;){for(const r of n.getOutgoing().values())r.originId===i.getLatestEntryFor(r.identifier).originId&&s(r);n.isShadow()?n=n.previous:n=null}}outgoingInTheFutureAndPastCb(i,s){let n=this;for(;n;){for(const r of n.getOutgoing().values()){const a=i.getLatestEntryFor(r.identifier);a&&r.originId===a.originId&&s(r)}if(n.$outgoingPast!==void 0)for(const r of n.$outgoingPast.values()){const a=i.getLatestEntryFor(r.identifier);a&&r.originId===a.originId&&s(r)}n.isShadow()?n=n.previous:n=null}}outgoingInTheFutureAndPastTransactionCb(i,s){let n=this;for(;n;){for(const r of n.getOutgoing().values()){const a=i.getLatestStableEntryFor(r.identifier);a&&r.originId===a.originId&&s(r)}if(n.$outgoingPast!==void 0)for(const r of n.$outgoingPast.values()){const a=i.getLatestStableEntryFor(r.identifier);a&&r.originId===a.originId&&s(r)}n.isShadow()?n=n.previous:n=null}}outgoingInTheFutureTransactionCb(i,s){let n=this;for(;n;){for(const r of n.getOutgoing().values()){const a=i.getLatestEntryFor(r.identifier);a&&r.originId===a.originId&&s(r)}n.isShadow()?n=n.previous:n=null}}}){}const O=Symbol("Tombstone");var vt=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n},Pe;(function(o){o[o.UserInput=0]="UserInput",o[o.DependsOnlyOnUserInput=1]="DependsOnlyOnUserInput",o[o.DependsOnlyOnDependsOnlyOnUserInput=2]="DependsOnlyOnDependsOnlyOnUserInput",o[o.DependsOnSelfKind=3]="DependsOnSelfKind"})(Pe||(Pe={}));class qt extends U{constructor(){super(...arguments),this.name=void 0,this.lazy=!1,this.total=!0,this.pure=!0,this.proposedValueIsBuilt=!1}calculation(e){throw new Error("Abstract method `calculation` called")}equality(e,t){return e===t}}vt([E(Pe.DependsOnSelfKind)],qt.prototype,"level",void 0),vt([E(!0)],qt.prototype,"sync",void 0);class re extends qt{constructor(){super(...arguments),this.context=void 0,this.isWritingUndefined=!1}newQuark(e){const t=this.quarkClass.new();return t.createdAt=e,t.identifier=this,t.needToBuildProposedValue=this.proposedValueIsBuilt,t}write(e,t,i,s,...n){i=i||t.getWriteTarget(e),i.proposedValue=s,i.proposedArguments=n.length>0?n:void 0,i.proposedIsPrevious=t.graph.isWritingPreviousData}writeToTransaction(e,t,...i){e.write(this,t,...i)}writeToGraph(e,t,...i){e.write(this,t,...i)}readFromGraphAsync(e){return e.readAsync(this)}readFromGraph(e){return e.read(this)}readFromTransaction(e){return e.read(this)}readFromTransactionAsync(e){return e.readAsync(this)}buildProposedValue(e,t,i){}enterGraph(e){}leaveGraph(e){}}const Ml=o=>re.new(o),Ct=jn.mix(Hr.mix(Map)),Kr=jn.mix(Ur.mix(Map));class Kt extends re{calculation(e){throw new Error("The 'calculation' method of the variables should never be called. Instead, the value will be set directly to quark")}write(e,t,i,s,...n){i=i||t.getWriteTarget(e),i.value=s,i.proposedArguments=n.length>0?n:void 0}}vt([E(Pe.UserInput)],Kt.prototype,"level",void 0),vt([E(Ct)],Kt.prototype,"quarkClass",void 0);function Ui(...o){return Kt.new(...o)}class Dt extends re{calculation(e){return e(A)}}vt([E(Ct)],Dt.prototype,"quarkClass",void 0);function Hi(...o){return Dt.new(...o)}class Re extends re{*calculation(e){return yield A}}vt([E(Kr)],Re.prototype,"quarkClass",void 0);function qi(...o){return Re.new(...o)}const ge=o=>{throw new Error(`Unknown identifier ${o}`)};let Ol=0;class An extends U{constructor(){super(...arguments),this.createdAt=Ol++,this.name="revision-"+this.createdAt,this.previous=void 0,this.scope=new Map,this.reachableCount=0,this.referenceCount=0,this.selfDependent=new Set}getLatestEntryFor(e){let t=this;for(;t;){const i=t.scope.get(e);if(i)return i;t=t.previous}return null}hasIdentifier(e){const t=this.getLatestEntryFor(e);return!!(t&&t.getValue()!==O)}*previousAxis(){let e=this;for(;e;)yield e,e=e.previous}}class xl{constructor(){this.length=0,this.levels=[],this.lowestLevel=_e}getLowestLevel(){for(let e=this.lowestLevel!==_e?this.lowestLevel:0;e<this.levels.length;e++)if(this.levels[e])return this.lowestLevel=e;return this.lowestLevel=_e}takeLowestLevel(){for(let e=this.lowestLevel!==_e?this.lowestLevel:0;e<this.levels.length;e++){const t=this.levels[e];if(t)return this.length-=t.length,this.levels[e]=null,this.lowestLevel=e+1,t}}pop(){for(let e=this.lowestLevel!==_e?this.lowestLevel:0;e<this.levels.length;e++){const t=this.levels[e];if(this.lowestLevel=e,t&&t.length>0)return this.length--,t.pop()}this.lowestLevel=_e}push(e){const t=e.level;let i=this.levels[t];if(!i){for(let s=this.levels.length;s<t;s++)this.levels[s]=null;i=this.levels[t]=[]}i.push(e),this.length++,t<this.lowestLevel&&(this.lowestLevel=t)}*[Symbol.iterator](){for(let e=0;e<this.levels.length;e++){const t=this.levels[e];t&&(yield*t)}}}class Fn extends U{toString(){const e=[],t=[];return this.cycle.forEach(({name:i,context:s})=>{e.push(i),t[t.length-1]!==s&&t.push(s)}),`events: 
`+t.map(i=>"#"+i.id).join(" => ")+`

identifiers: 
`+e.join(`
`)}}class Qr extends Ti{constructor(){super(...arguments),this.transaction=void 0}onCycle(e,t){return Se.Cancel}doCollectNext(e,t,i){let s=this.visited.get(t);s||(s={visitedAt:ft,visitEpoch:this.currentEpoch},this.visited.set(t,s)),i.push({node:t,from:e,label:void 0})}collectNext(e,t){const i=this.transaction.getLatestEntryFor(e);i&&i.outgoingInTheFutureTransactionCb(this.transaction,s=>{this.doCollectNext(e,s.identifier,t)})}}class Xr extends U{constructor(){super(...arguments),this.visited=new Map,this.transaction=void 0,this.baseRevision=void 0,this.pushTo=void 0,this.toVisit=[],this.currentEpoch=0}startFrom(e){this.continueFrom(e)}continueFrom(e){this.toVisit.push.apply(this.toVisit,e),this.walkDepth()}startNewEpoch(){if(this.toVisit.length)throw new Error("Can not start new walk epoch in the middle of the walk");this.currentEpoch++}onTopologicalNode(e,t){!e.lazy&&e.level!==Pe.UserInput&&this.pushTo.push(t)}onCycle(e,t){return Se.Resume}doCollectNext(e,t,i){let s=this.visited.get(t);s||(s=t.newQuark(this.baseRevision),s.visitEpoch=this.currentEpoch,this.visited.set(t,s)),i.push(t)}collectNext(e,t,i){const s=this.baseRevision.getLatestEntryFor(e);s&&(i.previous=s,s.outgoingInTheFutureAndPastTransactionCb(this.transaction,n=>{this.doCollectNext(e,n.identifier,t)}));for(const n of i.getOutgoing().keys())this.doCollectNext(e,n,t);if(i.$outgoingPast!==void 0)for(const n of i.getOutgoingPast().keys())this.doCollectNext(e,n,t)}walkDepth(){const e=this.visited,t=this.toVisit;let i;for(;i=t.length;){const s=t[i-1];let n=e.get(s);if(n&&n.visitedAt===Ue&&n.visitEpoch===this.currentEpoch){n.edgesFlow++,t.pop();continue}if(n&&n.visitEpoch===this.currentEpoch&&n.visitedAt!==ft){if(n.visitedAt<i){if(this.onCycle(s,t)!==Se.Resume)break;n.edgesFlow++}else n.visitedAt=Ue,this.onTopologicalNode(s,n);t.pop()}else{const r=t.length;n||(n=s.newQuark(this.baseRevision),n.visitEpoch=this.currentEpoch,e.set(s,n)),this.collectNext(s,t,n),n.visitEpoch<this.currentEpoch&&n.resetToEpoch(this.currentEpoch),n.visitedAt=i,n.edgesFlow++,t.length===r&&(n.visitedAt=Ue,this.onTopologicalNode(s,n),t.pop())}}}}const Qt=yt.Normal,Ke=yt.Past;class Ki extends U{constructor(){super(...arguments),this.baseRevision=void 0,this.candidateClass=An,this.candidate=void 0,this.graph=void 0,this.isClosed=!1,this.walkContext=void 0,this.entries=new Map,this.stackGen=new xl,this.activeStack=[],this.onEffectSync=void 0,this.onEffectAsync=void 0,this.propagationStartDate=0,this.lastProgressNotificationDate=0,this.startProgressNotificationsAfterMs=500,this.emitProgressNotificationsEveryMs=200,this.emitProgressNotificationsEveryCalculations=100,this.plannedTotalIdentifiersToCalculate=0,this.ongoing=Promise.resolve(),this.selfDependedMarked=!1,this.rejectedWith=void 0,this.stopped=!1,this.hasEntryWithProposedValue=!1,this.hasVariableEntry=!1}initialize(...e){super.initialize(...e),this.walkContext=Xr.new({visited:this.entries,transaction:this,baseRevision:this.baseRevision,pushTo:this.stackGen}),this.candidate||(this.candidate=this.candidateClass.new({previous:this.baseRevision})),this.onEffectSync=this.read.bind(this),this.onEffectAsync=this.readAsync.bind(this)}get dirty(){return this.entries.size>0}markSelfDependent(){if(!this.selfDependedMarked){this.selfDependedMarked=!0;for(const e of this.baseRevision.selfDependent){const t=this.entries.get(e);t&&t.getValue()===O||this.touch(e)}}}getActiveEntry(){return this.activeStack[this.activeStack.length-1]}yieldAsync(e){return In(e)?e:this.graph[e.handler](e,this)}yieldSync(e){if(In(e))throw new Error("Can not yield a promise in the synchronous context");return this.graph[e.handler](e,this)}readAsync(e){if(!(e instanceof re))return this.yieldAsync(e);let t;const i=this.getActiveEntry();if(i)t=this.addEdge(e,i,Qt);else if(t=this.entries.get(e),!t){const s=this.baseRevision.getLatestEntryFor(e);s||ge(e),t=s.hasValue()?s:this.touch(e)}return t.hasValue()?t.getValue():t.promise?t.promise:((!t.previous||!t.previous.hasValue())&&t.forceCalculation(),this.ongoing=t.promise=this.ongoing.then(()=>(async()=>{for(;this.stackGen.lowestLevel<e.level;)await Ht(this.onEffectAsync,this.calculateTransitionsStackGen,[this.onEffectAsync,this.stackGen.takeLowestLevel()],this);if(this.markSelfDependent(),t.getValue()===void 0)return Ht(this.onEffectAsync,this.calculateTransitionsStackGen,[this.onEffectAsync,[t]],this)})()).then(()=>{if(this.rejectedWith)throw new Error(`Transaction rejected: ${String(this.rejectedWith.reason)}`);if(!t.hasValue())throw new Error("Computation cycle. Sync");return t.getValue()}))}get(e){if(!(e instanceof re))return this.yieldSync(e);let t;const i=this.getActiveEntry();if(i)t=this.addEdge(e,i,Qt);else if(t=this.entries.get(e),!t){const n=this.baseRevision.getLatestEntryFor(e);n||ge(e),t=n.hasValue()?n:this.touch(e)}const s=t.getValue();if(s===O&&ge(e),s!==void 0&&t.hasValue())return s;if(t.promise)return t.promise;for((!t.previous||!t.previous.hasValue())&&t.forceCalculation();this.stackGen.getLowestLevel()<e.level;)this.calculateTransitionsStackSync(this.onEffectSync,this.stackGen.takeLowestLevel());if(this.markSelfDependent(),e.sync){this.calculateTransitionsStackSync(this.onEffectSync,[t]);const n=t.getValue();if(n===void 0)throw new Error("Cycle during synchronous computation");return n===O&&ge(e),n}else return this.ongoing=t.promise=this.ongoing.then(()=>{if(t.getValue()===void 0)return Ht(this.onEffectAsync,this.calculateTransitionsStackGen,[this.onEffectAsync,[t]],this)}).then(()=>{if(this.rejectedWith)throw new Error(`Transaction rejected: ${String(this.rejectedWith.reason)}`);const r=t.getValue();if(r===void 0)throw new Error("Computation cycle. Async get");return r===O&&ge(e),r})}read(e){if(!(e instanceof re))return this.yieldSync(e);let t;const i=this.getActiveEntry();if(i)t=this.addEdge(e,i,Qt);else if(t=this.entries.get(e),!t){const r=this.baseRevision.getLatestEntryFor(e);r||ge(e),t=r.hasValue()?r:this.touch(e)}const s=t.getValue();if(s===O&&ge(e),s!==void 0)return s;for((!t.previous||!t.previous.hasValue())&&t.forceCalculation();this.stackGen.getLowestLevel()<e.level;)this.calculateTransitionsStackSync(this.onEffectSync,this.stackGen.takeLowestLevel());this.markSelfDependent(),this.calculateTransitionsStackSync(this.onEffectSync,[t]);const n=t.getValue();if(n===void 0)throw new Error("Cycle during synchronous computation");return n===O&&ge(e),n}readCurrentOrProposedOrPrevious(e){const t=this.entries.get(e);if(t){const i=t.getValue();if(i!==void 0)return i;if(t.proposedValue!==void 0)return t.proposedValue}return this.readPrevious(e)}readCurrentOrProposedOrPreviousAsync(e){const t=this.entries.get(e);if(t){const i=t.getValue();if(i!==void 0)return i;if(t.proposedValue!==void 0)return t.proposedValue}return this.readPreviousAsync(e)}readPrevious(e){const t=this.baseRevision.getLatestEntryFor(e);if(!t)return;const i=t.getValue();return i!==O?i===void 0&&e.lazy?this.read(e):i:void 0}readPreviousAsync(e){const t=this.baseRevision.getLatestEntryFor(e);if(!t)return;const i=t.getValue();return i!==O?i!==void 0?i:this.readAsync(e):void 0}readProposedOrPrevious(e){const t=this.entries.get(e);return t&&t.proposedValue!==void 0?t.proposedValue:this.readPrevious(e)}readProposedOrPreviousAsync(e){const t=this.entries.get(e);return t&&t.proposedValue!==void 0?t.proposedValue:this.readPreviousAsync(e)}write(e,t,...i){t===void 0&&(t=null),e.write.call(e.context||e,e,this,null,t,...i);const s=this.entries.get(e);this.hasVariableEntry=this.hasVariableEntry||!s.isShadow()&&e.level===Pe.UserInput,this.hasEntryWithProposedValue=this.hasEntryWithProposedValue||s.hasProposedValue()}getWriteTarget(e){return this.touch(e).startOrigin()}acquireQuarkIfExists(e){const t=this.entries.get(e);return t&&t.origin===t?t.origin:void 0}touch(e){const t=this.entries.get(e);(!t||t.visitEpoch<this.walkContext.currentEpoch)&&this.walkContext.continueFrom([e]);const i=t||this.entries.get(e);return i.forceCalculation(),i}hasIdentifier(e){const t=this.entries.get(e);return t&&t.getValue()===O?!1:!!(t||this.baseRevision.getLatestEntryFor(e))}addIdentifier(e,t,...i){let s=this.entries.get(e);const n=!!s,r=e.level===Pe.UserInput;return s||(s=e.newQuark(this.baseRevision),s.previous=this.baseRevision.getLatestEntryFor(e),s.forceCalculation(),this.entries.set(e,s),!e.lazy&&!r&&this.stackGen.push(s),this.hasVariableEntry=this.hasVariableEntry||!s.isShadow()&&r,this.hasEntryWithProposedValue=this.hasEntryWithProposedValue||s.hasProposedValue()),(t!==void 0||r)&&(s.startOrigin(),(!(n&&(s.proposedValue!==void 0||s.value!==void 0))||s.proposedValue===O||s.value===O)&&(e.isWritingUndefined=t===void 0,e.write.call(e.context||e,e,this,s,t===void 0&&r?null:t,...i),e.isWritingUndefined=!1)),s.getValue()===O&&(s.value=void 0),s.proposedValue===O&&(s.proposedValue=void 0),e.enterGraph(this.graph),s}removeIdentifier(e){e.leaveGraph(this.graph),this.touch(e).startOrigin().setValue(O),this.candidate.selfDependent.delete(e)}populateCandidateScopeFromTransitions(e,t){if(e.scope.size===0)e.scope=t;else for(const[i,s]of t)if(s.isShadow()){const n=e.getLatestEntryFor(i);s.getOutgoing().forEach((r,a)=>n.getOutgoing().set(a,r))}else e.scope.set(i,s)}preCommit(e){if(this.isClosed)throw new Error("Can not propagate closed revision");this.markSelfDependent(),this.isClosed=!0,this.propagationStartDate=Date.now(),this.plannedTotalIdentifiersToCalculate=this.stackGen.length}postCommit(){this.populateCandidateScopeFromTransitions(this.candidate,this.entries);const e=this.entries;return this.walkContext=void 0,{revision:this.candidate,entries:e,transaction:this}}commit(e){return this.preCommit(e),this.calculateTransitionsSync(this.onEffectSync),this.postCommit()}reject(e=mt.new()){this.rejectedWith=e,this.walkContext=void 0}stop(){this.stopped=!0}clearRejected(){for(const e of this.entries.values())e.cleanup();this.entries.clear()}async commitAsync(e){return this.preCommit(e),this.ongoing=this.ongoing.then(()=>Ht(this.onEffectAsync,this.calculateTransitions,[this.onEffectAsync],this)).then(()=>this.postCommit())}getLatestEntryFor(e){let t=this.entries.get(e)||this.baseRevision.getLatestEntryFor(e);if(!(t&&t.getValue()===O))return t}getLatestStableEntryFor(e){let t=this.entries.get(e);if(t){const i=t.getValue();return i===O?void 0:i===void 0?this.baseRevision.getLatestEntryFor(e):t}else return this.baseRevision.getLatestEntryFor(e)}addEdge(e,t,i){if(t.identifier.level<e.level)throw new Error("Identifier can not read from higher level identifier");let n=this.entries.get(e);if(!n){const r=this.baseRevision.getLatestEntryFor(e);r||ge(e),n=e.newQuark(this.baseRevision),n.setOrigin(r),n.previous=r,this.entries.set(e,n)}return n.addOutgoingTo(t,i),n}onQuarkCalculationCompleted(e,t){e.cleanup();const i=e.identifier,s=e.previous,n=!!(s&&s.hasValue()&&i.equality(t,s.getValue()));n?(s.outgoingInTheFutureAndPastTransactionCb(this,a=>{const l=this.entries.get(a.identifier);l&&l.edgesFlow--}),e.edgesFlow=_e,e.setOrigin(s.origin),e.value=t):(e.startOrigin(),e.setValue(t));let r=!1;e.usedProposedOrPrevious&&(e.proposedValue!==void 0?i.equality(t,e.proposedValue)&&(r=!0):(n||!s&&t===null)&&(r=!0),r||this.candidate.selfDependent.add(i))}onReadIdentifier(e,t,i){const s=this.addEdge(e,t,Qt);if(s.hasValue()||s.value!==void 0){const n=s.getValue();return n===O&&ge(e),t.continueCalculation(n)}else if(s.isShadow()){s.startOrigin(),s.forceCalculation(),i.push(s);return}else if(s.isCalculationStarted()){let n;return Qr.new({transaction:this,onCycle(a,l){return n=Fn.new({cycle:Ir(l),requestedEntry:s,activeEntry:t}),Se.Cancel}}).startFrom([s.identifier]),n}else{i.push(s),(!s.previous||!s.previous.hasValue())&&s.forceCalculation();return}}*calculateTransitions(e){const t=this.stackGen;for(;t.length;)yield*this.calculateTransitionsStackGen(e,t.takeLowestLevel())}calculateTransitionsSync(e){const t=this.stackGen;for(;t.length;)this.calculateTransitionsStackSync(e,t.takeLowestLevel())}*calculateTransitionsStackGen(e,t){if(this.rejectedWith||this.stopped)return;this.walkContext.startNewEpoch();const i=this.entries,s=this.propagationStartDate,n=this.graph?this.graph.enableProgressNotifications:!1;let r=0;const a=this.activeStack;for(this.activeStack=t;t.length&&!this.rejectedWith&&!this.stopped;){if(n&&!(r++%this.emitProgressNotificationsEveryCalculations)){const f=Date.now();if(f-s>this.startProgressNotificationsAfterMs){const g=this.lastProgressNotificationDate;(!g||f-g>this.emitProgressNotificationsEveryMs)&&(this.lastProgressNotificationDate=f,this.graph.onPropagationProgressNotification({total:this.plannedTotalIdentifiersToCalculate,remaining:this.stackGen.length+t.length,phase:"propagating"}),this.activeStack=a,yield zt(0),this.activeStack=t)}}if(this.rejectedWith||this.stopped)break;const l=t[t.length-1],c=l.identifier;if(i.get(c)!==l){l.cleanup(),t.pop();continue}if(l.edgesFlow==0){l.edgesFlow--;const f=l.previous;f&&f.outgoingInTheFutureAndPastTransactionCb(this,p=>{const g=i.get(p.identifier);g&&g.edgesFlow--})}if(l.edgesFlow<0&&l.previous&&l.previous.origin){l.setOrigin(l.previous.origin),l.size===0&&i.delete(c),l.cleanup(),t.pop();continue}if(l.hasValue()||l.proposedValue===O){l.cleanup(),t.pop();continue}const u=l.visitEpoch;let h=l.isCalculationStarted()?l.iterationResult:l.startCalculation(this.onEffectSync);for(;h&&!this.rejectedWith&&!this.stopped;){const f=h.value===void 0?null:h.value;if(l.isCalculationCompleted()){l.visitEpoch==u&&this.onQuarkCalculationCompleted(l,f),t.pop();break}else if(f instanceof re){const p=this.onReadIdentifier(f,l,t);p instanceof Fn?(this.walkContext.startNewEpoch(),yield*this.graph.onComputationCycleHandler(p),l.cleanupCalculation(),h=void 0):h=p}else if(f===xn){t.pop();break}else{const p=yield f;if(p===gt)break;if(l.visitEpoch===u)h=l.continueCalculation(p);else{t.pop();break}}}}this.activeStack=a}calculateTransitionsStackSync(e,t){if(this.rejectedWith||this.stopped)return;this.walkContext.startNewEpoch();const i=this.entries,s=this.activeStack;for(this.activeStack=t;t.length&&!this.rejectedWith&&!this.stopped;){const n=t[t.length-1],r=n.identifier;if(i.get(r)!==n){n.cleanup(),t.pop();continue}if(n.edgesFlow==0){n.edgesFlow--;const d=n.previous;d&&d.outgoingInTheFutureAndPastTransactionCb(this,u=>{const h=i.get(u.identifier);h&&h.edgesFlow--})}if(n.edgesFlow<0&&n.previous&&n.previous.origin){n.setOrigin(n.previous.origin),n.size===0&&i.delete(r),n.cleanup(),t.pop();continue}if(n.hasValue()||n.proposedValue===O){n.cleanup(),t.pop();continue}const l=n.visitEpoch;let c=n.isCalculationStarted()?n.iterationResult:n.startCalculation(this.onEffectSync);for(;c&&!this.rejectedWith&&!this.stopped;){const d=c.value===void 0?null:c.value;if(n.isCalculationCompleted()){n.visitEpoch==l&&this.onQuarkCalculationCompleted(n,d),t.pop();break}else if(d instanceof re){const u=this.onReadIdentifier(d,n,t);u instanceof Fn?(this.walkContext.startNewEpoch(),this.graph.onComputationCycleHandlerSync(u,this),n.cleanupCalculation(),c=void 0):c=u}else if(d===xn){t.pop();break}else{const u=e(d);if(In(u))throw new Error("Effect resolved to promise in the synchronous context, check that you marked the asynchronous calculations accordingly");if(u===gt)break;if(n.visitEpoch===l)c=n.continueCalculation(u);else{t.pop();break}}}}this.activeStack=s}}const kn={rejectedWith:null};class Jr extends U{constructor(){super(...arguments),this.handlers=[]}trigger(e){for(let t=0;t<this.handlers.length;t++)this.handlers[t](e)}}class Zr extends U{constructor(){super(...arguments),this.baseRevisionStable=void 0,this.baseRevisionTentative=void 0,this.baseRevision=An.new(),this.topRevision=void 0,this.historyLimit=0,this.listeners=new Map,this.isWritingPreviousData=!1,this.$activeTransaction=void 0,this.isCommitting=!1,this.enableProgressNotifications=!1,this.ongoing=Promise.resolve(),this._isInitialCommit=!0,this.autoCommitTimeoutId=null,this.autoCommit=!1,this.autoCommitMode="sync",this.autoCommitHandler=null,this.onWriteDuringCommit="throw",this.onComputationCycle="throw",this.transactionClass=Ki,this.isJustCleared=!1,this.$followingRevision=void 0}initialize(...e){super.initialize(...e),this.topRevision||(this.topRevision=this.baseRevision),this.autoCommit&&(this.autoCommitHandler=this.autoCommitMode==="sync"?t=>this.commit(t):async t=>this.commitAsync(t)),this.markAndSweep()}hasPendingAutoCommit(){return this.autoCommitTimeoutId!==null}get dirty(){return this.activeTransaction.dirty}clear(){this.reject(),this.unScheduleAutoCommit(),this.baseRevision.scope&&this.baseRevision.scope.clear(),this.baseRevision.previous=null,this.listeners.clear(),this.topRevision=this.baseRevision,this.$followingRevision=void 0,this.$activeTransaction=void 0,this.markAndSweep(),this.isJustCleared=!0}*eachReachableRevision(){let e=!0,t=0;for(const i of this.topRevision.previousAxis())yield[i,e||t<this.historyLimit],i===this.baseRevision?e=!1:e||t++}get isInitialCommit(){return this._isInitialCommit}set isInitialCommit(e){this._isInitialCommit=e}markAndSweep(){let e;const t=[];for(const[i,s]of this.eachReachableRevision())s?(i.reachableCount++,e=i):t.push(i),i.referenceCount++;t.unshift(e);for(let i=t.length-1;i>=1&&t[i].reachableCount===0;i--)this.compactRevisions(t[i-1],t[i])}compactRevisions(e,t){if(t.reachableCount>0||e.previous!==t)throw new Error("Invalid compact operation");if(t.referenceCount<=1){for(const[i,s]of e.scope)if(s.getValue()===O)t.scope.delete(i);else{const n=t.scope.get(i);s.origin===s?n&&(n.clear(),n.clearProperties()):n&&s.origin===n?s.mergePreviousOrigin(e.scope):i.lazy&&!s.origin&&n&&n.origin&&(s.startOrigin().proposedValue=n.origin.value!==void 0?n.origin.value:n.origin.proposedValue),s.previous=void 0,t.scope.set(i,s)}yl(e.selfDependent,t.selfDependent),e.scope=t.scope,t.scope=null}else e.scope=new Map(Cr(t.scope,e.scope)),e.selfDependent=new Set(Cr(t.selfDependent,e.selfDependent)),t.referenceCount--;e.previous=null}get followingRevision(){if(this.$followingRevision!==void 0)return this.$followingRevision;const e=Array.from(this.topRevision.previousAxis()),t=[];for(let i=e.length-1;i>0;i--)t.push([e[i],e[i-1]]);return this.$followingRevision=new Map(t)}get activeTransaction(){return this.$activeTransaction?this.$activeTransaction:this.$activeTransaction=this.transactionClass.new({baseRevision:this.baseRevisionTentative||this.baseRevision,graph:this})}branch(e){return this.constructor.new(Object.assign({},e,{baseRevision:this.baseRevision}))}propagate(e){return this.commit(e)}reject(e){this.activeTransaction.reject(mt.new({reason:e})),this.ongoing=Promise.resolve(),this.$activeTransaction=void 0,this.baseRevisionTentative=void 0,this.baseRevisionStable&&(this.baseRevision=this.baseRevisionStable,this.baseRevisionStable=void 0)}commit(e){this.isJustCleared=!1,this.unScheduleAutoCommit(),this.baseRevisionStable=this.baseRevision;const i=this.activeTransaction.commit(e);this.$activeTransaction=void 0;const s=this.finalizeCommit(i);return this.baseRevisionStable=void 0,this.isInitialCommit=!1,s}async propagateAsync(e){return this.commitAsync(e)}async commitAsync(e){return this.isCommitting?this.ongoing:(this.isJustCleared=!1,this.isCommitting=!0,this.baseRevisionStable=this.baseRevision,this.ongoing=this.ongoing.then(()=>this.doCommitAsync(e)).then(t=>t).finally(()=>{this.baseRevisionStable=void 0,this.baseRevisionTentative=void 0,this.isInitialCommit=!1,this.isCommitting=!1}))}async doCommitAsync(e){this.unScheduleAutoCommit();const t=this.activeTransaction,i=await t.commitAsync(e),s=!!t.rejectedWith,n=this.baseRevisionTentative;if(s||(this.baseRevisionTentative=t.candidate),this.$activeTransaction=void 0,await this.finalizeCommitAsync(i),this.isJustCleared)return{rejectedWith:mt.new({reason:"Graph cleared"})};t.rejectedWith&&!s&&(this.baseRevisionTentative=n,this.$activeTransaction=void 0);const r=this.finalizeCommit(i);return t.rejectedWith&&t.clearRejected(),this.dirty&&!t.rejectedWith&&await this.doCommitAsync(e),r}finalizeCommit(e){const{revision:t,entries:i,transaction:s}=e;if(s.rejectedWith)this.baseRevisionStable&&(this.baseRevision=this.baseRevisionStable),this.baseRevisionStable=void 0,this.baseRevisionTentative=void 0;else{if(t.previous!==this.baseRevision)throw new Error("Invalid revisions chain");for(const[n,r]of this.eachReachableRevision())r&&n.reachableCount--,n.referenceCount--;this.baseRevision=this.topRevision=t;for(const[n,r]of i){if(r.cleanup(),r.isShadow()||!r.hasValue())continue;const a=this.listeners.get(n);a&&a.trigger(r.getValue())}this.$followingRevision=void 0,this.markAndSweep()}return{rejectedWith:s.rejectedWith}}async finalizeCommitAsync(e){}*onComputationCycleHandler(e){const t=new Error(`Computation cycle:
`+e);switch(t.cycle=e,this.onComputationCycle){case"ignore":console.log(t.message);const{requestedEntry:i,activeEntry:s}=e;return s.continueCalculation(i.proposedValue!==void 0?i.proposedValue:i.value);case"throw":throw t;case"reject":this.reject(t);break}}onComputationCycleHandlerSync(e,t){const i=new Error(`Computation cycle:
`+e);switch(i.cycle=e,this.onComputationCycle){case"ignore":console.log(i.message);const{requestedEntry:s,activeEntry:n}=e;return n.continueCalculation(s.proposedValue!==void 0?s.proposedValue:s.value);case"throw":throw i;case"reject":this.reject(i);break}}scheduleAutoCommit(){this.autoCommitTimeoutId===null&&!this.isCommitting&&(this.autoCommitTimeoutId=setTimeout(this.autoCommitHandler,10))}unScheduleAutoCommit(){this.autoCommitTimeoutId!==null&&(clearTimeout(this.autoCommitTimeoutId),this.autoCommitTimeoutId=null)}variable(e){const t=Ui();return this.addIdentifier(t,e===void 0?null:e)}variableNamed(e,t){const i=Ui({name:e});return this.addIdentifier(i,t===void 0?null:t)}identifier(e,t){const i=Ri(e)?qi({calculation:e,context:t}):Hi({calculation:e,context:t});return this.addIdentifier(i)}identifierNamed(e,t,i){const s=t.constructor.name==="GeneratorFunction"?qi({name:e,calculation:t,context:i}):Hi({name:e,calculation:t,context:i});return this.addIdentifier(s)}addIdentifier(e,t,...i){if(this.isCommitting){if(this.onWriteDuringCommit==="throw")throw new Error("Adding identifier during commit");this.onWriteDuringCommit}return this.activeTransaction.addIdentifier(e,t,...i),this.autoCommit&&this.scheduleAutoCommit(),e}removeIdentifier(e){if(this.isCommitting){if(this.onWriteDuringCommit==="throw")throw new Error("Removing identifier during commit");this.onWriteDuringCommit}this.activeTransaction.removeIdentifier(e),this.listeners.delete(e),this.autoCommit&&this.scheduleAutoCommit()}hasIdentifier(e){return this.activeTransaction.hasIdentifier(e)}write(e,t,...i){if(this.isCommitting){if(this.onWriteDuringCommit==="throw")throw new Error("Write during commit");this.onWriteDuringCommit}this.activeTransaction.write(e,t,...i),this.autoCommit&&this.scheduleAutoCommit()}readPrevious(e){return this.activeTransaction.readPrevious(e)}readPreviousAsync(e){return this.activeTransaction.readPreviousAsync(e)}read(e){return this.activeTransaction.read(e)}readAsync(e){return this.activeTransaction.readAsync(e)}get(e){return this.activeTransaction.get(e)}observe(e,t){const i=this.addIdentifier(Re.new({lazy:!1,calculation:e}));return this.addListener(i,t),i}observeContext(e,t,i){const s=this.addIdentifier(Re.new({lazy:!1,calculation:e,context:t}));return this.addListener(s,i),s}addListener(e,t){let i=this.listeners.get(e);i||(i=Jr.new(),this.listeners.set(e,i)),i.handlers.push(t)}undo(){const t=this.baseRevision.previous;return t?(this.baseRevision=t,this.$activeTransaction=void 0,!0):!1}redo(){const e=this.baseRevision;if(e===this.topRevision)return!1;const t=this.followingRevision.get(e);return this.baseRevision=t,this.$activeTransaction=void 0,!0}onPropagationProgressNotification(e){}[Ii](e,t){const i=t.getActiveEntry();i.usedProposedOrPrevious=!0;const s=i.getProposedValue(t);return s!==void 0?s:i.previous?i.identifier.lazy?i.previous.hasValue()?i.previous.getValue():i.previous.hasProposedValue()?i.previous.getProposedValue(t):null:t.readPrevious(i.identifier):void 0}[Ut](e,t){return this.reject(e.reason),gt}[Mi](e,t){return t}[Oi](e,t){return t.getActiveEntry()}[xi](e,t){return t.getActiveEntry().identifier}[ji](e,t){const i=t.getActiveEntry();if(i.identifier.lazy)throw new Error("Lazy identifiers can not use `Write` effect");const s=e.identifier.level>i.identifier.level;return s||t.walkContext.startNewEpoch(),t.write(e.identifier,...e.proposedArgs),s?void 0:gt}[Fi](e,t){const i=t.getActiveEntry();if(i.identifier.lazy)throw new Error("Lazy identifiers can not use `Write` effect");let s=!0;return e.writes.forEach(n=>{n.identifier.level<=i.identifier.level&&s&&(t.walkContext.startNewEpoch(),s=!1),t.write(n.identifier,...n.proposedArgs)}),s?void 0:gt}[Bi](e,t){const i=t.getActiveEntry(),s=e.identifier;return t.addEdge(s,i,Ke),t.readPrevious(s)}[_i](e,t){const i=t.getActiveEntry(),s=e.identifier;t.addEdge(s,i,Ke);const n=t.entries.get(s);return n&&!n.isShadow()?n.getProposedValue(t):void 0}[Li](e,t){const i=t.getActiveEntry(),s=e.identifier;t.addEdge(s,i,Ke);const n=t.entries.get(s);return n?n.hasProposedValue():!1}[Vi](e,t){const i=t.getActiveEntry(),s=e.identifier;t.addEdge(s,i,Ke);const n=t.entries.get(s);return n?n.hasProposedValue()&&!n.proposedIsPrevious:!1}[Ni](e,t){const i=t.getActiveEntry(),s=e.identifier;return t.addEdge(s,i,Ke),t.readProposedOrPrevious(s)}[zi](e,t){return t.readProposedOrPrevious(e.identifier)}[Gi](e,t){return t.readPrevious(e.identifier)}[Wi](e,t){const i=t.getActiveEntry(),s=e.identifier;t.addEdge(s,i,Ke);const n=t.entries.get(s);return n&&!n.isShadow()?n.proposedArguments:void 0}}class Yr extends U{constructor(){super(...arguments),this.name=void 0,this.ownFields=new Map,this.schema=void 0,this.$skeleton={},this.$allFields=void 0}hasField(e){return this.getField(e)!==void 0}getField(e){return this.allFields.get(e)}addField(e){const t=e.name;if(!t)throw new Error("Field must have a name");if(this.ownFields.has(t))throw new Error(`Field with name [${t}] already exists`);return e.entity=this,this.ownFields.set(t,e),e}forEachParent(e){let t=this;for(;t;)e(t),t=t.parentEntity}get allFields(){if(this.$allFields!==void 0)return this.$allFields;const e=new Map,t=new Set;return this.forEachParent(i=>{i.ownFields.forEach((s,n)=>{t.has(n)||(t.add(n),e.set(n,s))})}),this.$allFields=e}forEachField(e){this.allFields.forEach(e)}}var je;(function(o){o[o.Current=0]="Current",o[o.Previous=1]="Previous",o[o.ProposedOrPrevious=2]="ProposedOrPrevious",o[o.CurrentOrProposedOrPrevious=3]="CurrentOrProposedOrPrevious"})(je||(je={}));class Qi extends y([Zr],e=>class extends e{constructor(){super(...arguments),this.autoCommit=!0,this.readMode=je.Current}addEntity(i){i.enterGraph(this)}addEntities(i){i.forEach(s=>this.addEntity(s))}removeEntity(i){i.leaveGraph(this)}removeEntities(i){i.forEach(s=>this.removeEntity(s))}}){}class ue extends y([re],e=>class extends e{constructor(){super(...arguments),this.field=void 0,this.self=void 0,this.DATA=void 0}getFromGraph(i){return i?i.readMode===je.Current?i.get(this):i.readMode===je.Previous?i.activeTransaction.readPrevious(this):(i.readMode===je.ProposedOrPrevious&&i.activeTransaction.readProposedOrPrevious(this),i.activeTransaction.readCurrentOrProposedOrPrevious(this)):this.DATA}readFromGraph(i){return i?i.read(this):this.DATA}writeToGraph(i,s,...n){i?i.write(this,s,...n):this.DATA=s}leaveGraph(i){const s=i.activeTransaction.getLatestStableEntryFor(this);s&&(this.DATA=s.getValue()),super.leaveGraph(i)}toString(){return this.name}}){}class Xt extends ue.mix(Dt){}class Xi extends ue.mix(Re){}class Ji extends ue.mix(Kt){}class ea extends y([re],e=>class extends e{constructor(){super(...arguments),this.entity=void 0,this.self=void 0}equality(){return!1}toString(){return`Entity identifier [${this.self}]`}}){}class ta extends ea.mix(Re){}class St extends qt{constructor(){super(...arguments),this.persistent=!0}getIdentifierClass(e){return this.identifierCls?this.identifierCls:e?Ri(e)?Xi:Xt:Ji}}const na=Symbol("isEntity");class Te extends y([],e=>{class t extends e{[na](){}get $entity(){return Zi(this.constructor.prototype)}get $(){const s={};return this.$entity.forEachField((n,r)=>{s[r]=this.createFieldIdentifier(n)}),wi(this,"$",s)}get $$(){return wi(this,"$$",ta.new({name:this.$entityName,entity:this.$entity,calculation:this.calculateSelf,context:this,self:this}))}get $entityName(){return this.constructor.name||this.$entity.name}*calculateSelf(){return this}createFieldIdentifier(s){const n=s.name,r=this.$entity,a=this.constructor,l=r.$skeleton;l[n]||(l[n]=a.getIdentifierTemplateClass(this,s));const c=new l[n];return c.context=this,c.self=this,c.name=`${this.$$.name}.$.${s.name}`,c}forEachFieldIdentifier(s){this.$entity.forEachField((n,r)=>s(this.$[r],r,n))}enterGraph(s){if(this.graph)throw new Error("Already entered replica");this.graph=s,s.addIdentifier(this.$$),this.$entity.forEachField((n,r)=>{const a=this.$[r];s.addIdentifier(a,a.DATA),a.DATA=void 0})}leaveGraph(s){const n=this.graph,r=s||n;r&&(this.$entity.forEachField((a,l)=>r.removeIdentifier(this.$[l])),r.removeIdentifier(this.$$),r===n&&(this.graph=void 0))}propagate(s){return this.commit(s)}commit(s){const n=this.graph;return n?n.commit(s):kn}async propagateAsync(){return this.commitAsync()}async commitAsync(s){const n=this.graph;return n?n.commitAsync(s):Promise.resolve(kn)}static get $entity(){return Qe(this.prototype)}static getIdentifierTemplateClass(s,n){const r=n.name,a={name:`${s.$$.name}.$.${r}`,field:n};n.hasOwnProperty("sync")&&(a.sync=n.sync),n.hasOwnProperty("lazy")&&(a.lazy=n.lazy),n.hasOwnProperty("equality")&&(a.equality=n.equality);const l=s.$calculations&&s[s.$calculations[r]];l&&(a.calculation=l);const c=s.$writes&&s[s.$writes[r]];c&&(a.write=c);const d=s.$buildProposed&&s[s.$buildProposed[r]];d&&(a.buildProposedValue=d,a.proposedValueIsBuilt=!0);const u=n.getIdentifierClass(l).new(a),h=function(){};return h.prototype=u,h}run(s,...n){const r=d=>{if(d instanceof re)return this.graph.read(d);throw new Error("Helper methods can not yield effects during computation")},a=this.graph.activeTransaction,l=a.activeStack;a.activeStack=[];const c=qr(r,this[s],n,this);return a.activeStack=l,c}static createPropertyAccessorsFor(s){const n=s,r=this.prototype;Object.defineProperty(r,n,{get:function(){return this.$[n].getFromGraph(this.graph)},set:function(a){this.$[n].writeToGraph(this.graph,a)}})}static createMethodAccessorsFor(s){const n=s,r=this.prototype,a=`get${bi(n)}`,l=`set${bi(n)}`,c=`put${bi(n)}`;a in r||(r[a]=function(){return this.$[n].getFromGraph(this.graph)}),l in r||(r[l]=function(d,...u){return this.$[n].writeToGraph(this.graph,d,...u),this.graph?this.graph.autoCommitMode==="sync"?this.graph.commit():this.graph.commitAsync():Promise.resolve(kn)}),c in r||(r[c]=function(d,...u){this.$[n].writeToGraph(this.graph,d,...u)})}}return t}){}const Zi=o=>{let e=Object.getPrototypeOf(o);return wi(o,"$entity",Yr.new({parentEntity:e.hasOwnProperty(na)?null:e.$entity,name:o.constructor.name}))},Qe=o=>(o.hasOwnProperty("$entity")||Zi(o),o.$entity),te=(o,e=St)=>function(t,i){Qe(t).addField(e.new(Object.assign(o||{},{name:i})));const n=t.constructor;n.createPropertyAccessorsFor(i),n.createMethodAccessorsFor(i)},M=te,D=function(o){return function(e,t,i){Qe(e);let s;e.$calculations?e.hasOwnProperty("$calculations")?s=e.$calculations:s=e.$calculations=Object.create(e.$calculations):s=e.$calculations={},s[o]=t}},Ae=function(o){return function(e,t,i){Qe(e);let s;e.$writes?e.hasOwnProperty("$writes")?s=e.$writes:s=e.$writes=Object.create(e.$writes):s=e.$writes={},s[o]=t}},ia=function(o){return function(e,t,i){Qe(e);let s;e.$buildProposed?e.hasOwnProperty("$buildProposed")?s=e.$buildProposed:s=e.$buildProposed=Object.create(e.$buildProposed):s=e.$buildProposed={},s[o]=t}};var sa=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Yi extends y([St],e=>class extends e{constructor(){super(...arguments),this.identifierCls=aa}}){}const ra=(o,e=Yi)=>te(o,e);class es extends y([ue],e=>{class t extends e{constructor(){super(...arguments),this.field=void 0,this.proposedValueIsBuilt=!0}hasBucket(){return!!this.field.bucket}getBucket(s){return s.$[this.field.bucket]}buildProposedValue(s,n,r){const a=n.proposedValue;if(a===null)return null;const l=bn(a,Te)?a:s.resolve(a);return l&&s.hasBucket()&&s.getBucket(l).addToBucket(r,s.self),l}resolve(s){const n=this.field.resolver;return n?n.call(this.self,s):null}enterGraph(s){if(this.hasBucket()){const n=s.activeTransaction.readProposedOrPrevious(this);n instanceof Te&&this.getBucket(n).addToBucket(s.activeTransaction,this.self)}super.enterGraph(s)}leaveGraph(s){if(this.hasBucket()){const n=s.activeTransaction.readProposedOrPrevious(this);n instanceof Te&&this.getBucket(n).removeFromBucket(s.activeTransaction,this.self)}super.leaveGraph(s)}write(s,n,r,a,...l){const c=r||n.acquireQuarkIfExists(s);if(s.hasBucket()){if(c){const d=c.getValue();d instanceof Te&&s.getBucket(d).removeFromBucket(n,s.self)}else if(n.baseRevision.hasIdentifier(s)){const d=n.readPrevious(s);d instanceof Te&&s.getBucket(d).removeFromBucket(n,s.self)}}super.write(s,n,r,a)}}return sa([E(Pe.DependsOnlyOnUserInput)],t.prototype,"level",void 0),sa([E(Ct)],t.prototype,"quarkClass",void 0),t}){}class aa extends es.mix(ue.mix(Dt)){}var oa=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class ts extends y([St],e=>class extends e{constructor(){super(...arguments),this.persistent=!1,this.identifierCls=ua}}){}const la=(o,e=ts)=>te(o,e);var Et;(function(o){o.Add="Add",o.Remove="Remove"})(Et||(Et={}));class ca extends y([jn],e=>class extends e{constructor(){super(...arguments),this.mutations=[],this.previousValue=void 0}hasProposedValueInner(){return this.mutations.length>0}}){}const da=ca.mix(Ct);class ns extends y([ue],e=>{class t extends e{constructor(){super(...arguments),this.proposedValueIsBuilt=!0}addToBucket(s,n){const r=s.getWriteTarget(this);r.mutations.push({type:Et.Add,entity:n});const a=s.baseRevision;!r.previousValue&&a.hasIdentifier(this)&&(r.previousValue=s.readPrevious(this))}removeFromBucket(s,n){const r=s.entries.get(this);if(r&&r.getValue()===O)return;const a=s.getWriteTarget(this);a.mutations.push({type:Et.Remove,entity:n});const l=s.baseRevision;!a.previousValue&&l.hasIdentifier(this)&&(a.previousValue=s.readPrevious(this))}buildProposedValue(s,n,r){const a=n,l=new Set(a.previousValue);for(let c=0;c<a.mutations.length;c++){const{type:d,entity:u}=a.mutations[c];d===Et.Remove?l.delete(u):d===Et.Add&&l.add(u)}return l}leaveGraph(s){super.leaveGraph(s),this.DATA=void 0}}return oa([E(Pe.DependsOnlyOnDependsOnlyOnUserInput)],t.prototype,"level",void 0),oa([E(da)],t.prototype,"quarkClass",void 0),t}){}class ua extends ns.mix(ue.mix(Dt)){}class ha extends U{constructor(){super(...arguments),this.entities=new Map}hasEntity(e){return this.entities.has(e)}getEntity(e){return this.entities.get(e)}addEntity(e){const t=e.name;if(!t)throw new Error("Entity must have a name");if(this.hasEntity(t))throw new Error(`Entity with name [${String(t)}] already exists`);return e.schema=this,this.entities.set(t,e),e}getEntityDecorator(){return e=>{const t=is(e);return this.addEntity(t),e}}}const is=o=>{if(!o.name)throw new Error("Can't add entity - the target class has no name");return Qe(o.prototype)},jl=()=>o=>(is(o),o);var Bn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const bt=function(o,e){return o===e||(e!=null&&e.isBase?this.serialize(e):e)===(o!=null&&o.isBase?this.serialize(o):o)};class _n extends St{constructor(){super(...arguments),this.modelFieldConfig={}}getIdentifierClass(e){return this.identifierCls?this.identifierCls:e?Ri(e)?ga:pa:ma}}class Xe extends Yi.mix(_n){constructor(){super(...arguments),this.identifierCls=Jt}}class Je extends ts.mix(St){constructor(){super(...arguments),this.identifierCls=Vn}}const Ln=Symbol("IsChronoModelSymbol");class wt extends y([ue],e=>{const t=e.prototype;class i extends e{[Ln](){}getFromGraph(n){var a;if(n){if(n.readMode===je.CurrentOrProposedOrPrevious){var r;const l=n.isCommitting&&this.level>((a=(r=n.activeTransaction.getActiveEntry())===null||r===void 0?void 0:r.level)!=null?a:Number.MAX_SAFE_INTEGER);return this.sync&&!this.context.project.isDelayingCalculation&&!l?n.get(this):n.activeTransaction.readCurrentOrProposedOrPrevious(this)}return t.getFromGraph.call(this,n)}else return this.DATA}writeToGraph(n,r,...a){n?t.writeToGraph.call(this,n,r,...a):(this.DATA=r,!this.self.inSetting&&!this.self.isConstructing&&this.self.set(this.field.name,r,!1,!1,!0))}write(n,r,a,l,...c){l=n.convert(l),t.write.call(this,n,r,a,l,...c)}convert(n){const r=this.field,a=this.self.getFieldDefinition(r.name);return a!=null&&a.convert?n=a.convert(n,this.context.data,this.context):r.converter&&(n=r.converter(n,r)),n}equality(n,r){return n instanceof Date&&r instanceof Date?n.getTime()===r.getTime():n===r}}return Bn([E(!1)],i.prototype,"sync",void 0),i}){}class fa extends y([Ct],e=>{const t=e.prototype;class i extends e{setValue(n){t.setValue.call(this,n),n!==O&&(this.identifier.DATA=n)}}return i}){}class Jt extends es.mix(wt.mix(Xt)){buildProposedValue(e,t,i){const s=t,n=s.proposedValue;if(n==null)return i.candidate.failedResolutionReferences.delete(s.identifier),null;if(bn(n,Te)&&n.graph)return e.hasBucket()&&e.getBucket(n).addToBucket(i,e.self),i.candidate.failedResolutionReferences.delete(s.identifier),n;const r=e.resolve(n);return bn(r,Te)&&r.graph?(e.hasBucket()&&e.getBucket(r).addToBucket(i,e.self),i.candidate.failedResolutionReferences.delete(s.identifier),r):(i.candidate.failedResolutionReferences.set(s.identifier,n),null)}}Bn([E(!0)],Jt.prototype,"sync",void 0),Bn([E(fa)],Jt.prototype,"quarkClass",void 0);class Vn extends ns.mix(wt.mix(Xt)){}Bn([E(!0)],Vn.prototype,"sync",void 0);class pa extends wt.mix(Xt){}class ga extends wt.mix(Xi){}class ma extends wt.mix(Ji){}const S=function(o={},e={},t=_n){return function(i,s){te({modelFieldConfig:o,...e},t)(i,s),Nn(i.constructor)}},Nn=o=>{o.hasOwnProperty("fields")||Object.defineProperty(o,"fields",{get:function(){return ya(this)}})},ya=o=>{const e=o.prototype,t=[];return e.hasOwnProperty("$entity")&&e.$entity.ownFields.forEach(i=>{if(i instanceof _n){const s=i.modelFieldConfig||{};!s.convert&&i.converter&&i.converter!==Ze&&(s.convert=i.converter),t.push(Object.assign(s,{$chrono:i,name:i.name}))}}),t},Ze=(o,e)=>{if(o===null)return null;if(!(o instanceof Date)){var t,i;o=I.parse(o,((t=e.modelFieldConfig)===null||t===void 0?void 0:t.format)||((i=e.modelFieldConfig)===null||i===void 0?void 0:i.dateFormat)||I.defaultParseFormat)}return o||void 0};class Wn extends y([Te,ut],e=>{const t=e.prototype;class i extends e{get isEntity(){return!0}construct(n,...r){this.constructor.exposeProperties(),this.originalData=n=n||{},t.construct.call(this,n,...r);for(const a in this.originalData)this.$[a]&&!this.getFieldDefinition(a)&&(this[a]=n[a])}*userProvidedValue(){return yield A}copy(n=null,r=null){const a=t.copy.call(this,n,r),{creatingOccurrence:l}=r!=null?r:{};return(K.isObject(r)&&!r.skipFieldIdentifiers||!K.isObject(r))&&this.forEachFieldIdentifier((c,d,u)=>{var h;!u.lazy&&((h=this.getFieldDefinition(d))===null||h===void 0?void 0:h.type)!=="store"&&(!l||c instanceof Vn||c instanceof Jt)&&(a[d]=this[d])}),a}applyValue(n,r,a,l,c){var u;this.$entity.getField((c==null?void 0:c.name)||r)&&(n=!0),l&&(n=!1),t.applyValue.call(this,n,n&&(u=c==null?void 0:c.name)!=null?u:r,a,l,c)}get isInActiveTransaction(){var n;const r=(n=this.graph)===null||n===void 0?void 0:n.activeTransaction;return!!(r!=null&&r.getLatestEntryFor(this.$$))}get data(){return this._data}set data(n){this._data=n;const{fields:r,$:a,graph:l,generation:c}=this;for(let d=0;d<r.length;d++){const{name:u,dataSource:h,complexMapping:f}=r[d],p=a[u];if(p){const g=f?K.getPath(n,h):n[h];(f||h in n)&&(c!=null||g!==void 0)&&p.writeToGraph(l,g)}}}get $entityName(){const n=this.constructor.name||this.$entity.name,r=this.id;return`${n}${r!=null?"-"+String(r):""}`}}return i}){}const Al={localeName:"En",localeDesc:"English (US)",localeCode:"en-US",RemoveDependencyCycleEffectResolution:{descriptionTpl:"Remove dependency"},DeactivateDependencyCycleEffectResolution:{descriptionTpl:"Deactivate dependency"},CycleEffectDescription:{descriptionTpl:"A cycle has been found, formed by: {0}"},EmptyCalendarEffectDescription:{descriptionTpl:'"{0}" calendar does not provide any working time intervals.'},Use24hrsEmptyCalendarEffectResolution:{descriptionTpl:"Use 24 hours calendar with non-working Saturdays and Sundays."},Use8hrsEmptyCalendarEffectResolution:{descriptionTpl:"Use 8 hours calendar (08:00-12:00, 13:00-17:00) with non-working Saturdays and Sundays."},ConflictEffectDescription:{descriptionTpl:"A scheduling conflict has been found: {0} is conflicting with {1}"},ConstraintIntervalDescription:{dateFormat:"LLL"},ProjectConstraintIntervalDescription:{startDateDescriptionTpl:"Project start date {0}",endDateDescriptionTpl:"Project end date {0}"},DependencyType:{long:["Start-to-Start","Start-to-Finish","Finish-to-Start","Finish-to-Finish"]},ManuallyScheduledParentConstraintIntervalDescription:{startDescriptionTpl:'Manually scheduled "{2}" forces its children to start no earlier than {0}',endDescriptionTpl:'Manually scheduled "{2}" forces its children to finish no later than {1}'},DisableManuallyScheduledConflictResolution:{descriptionTpl:'Disable manual scheduling for "{0}"'},DependencyConstraintIntervalDescription:{descriptionTpl:'Dependency ({2}) from "{3}" to "{4}"'},RemoveDependencyResolution:{descriptionTpl:'Remove dependency from "{1}" to "{2}"'},DeactivateDependencyResolution:{descriptionTpl:'Deactivate dependency from "{1}" to "{2}"'},DateConstraintIntervalDescription:{startDateDescriptionTpl:'Task "{2}" {3} {0} constraint',endDateDescriptionTpl:'Task "{2}" {3} {1} constraint',constraintTypeTpl:{startnoearlierthan:"Start-No-Earlier-Than",finishnoearlierthan:"Finish-No-Earlier-Than",muststarton:"Must-Start-On",mustfinishon:"Must-Finish-On",startnolaterthan:"Start-No-Later-Than",finishnolaterthan:"Finish-No-Later-Than"}},RemoveDateConstraintConflictResolution:{descriptionTpl:'Remove "{1}" constraint of task "{0}"'}};Sr.publishLocale(Al);class zn extends U{initialize(...e){super.initialize(...e),this.startDate||(this.startDate=ve),this.endDate||(this.endDate=le)}equalTo(e){return this.startDate.getTime()===e.startDate.getTime()&&this.endDate.getTime()===e.endDate.getTime()}isInfinite(){return this.startDate.getTime()===ve.getTime()&&this.endDate.getTime()===le.getTime()}startDateIsFinite(){return!this.isIntervalEmpty()&&this.startDate.getTime()!==ve.getTime()}endDateIsFinite(){return!this.isIntervalEmpty()&&this.endDate.getTime()!==le.getTime()}containsDate(e,t=vi.Left){return t===vi.Left&&e>=this.startDate&&e<this.endDate||t===vi.Right&&e>this.startDate&&e<=this.endDate}isIntervalEmpty(){return this.startDate>this.endDate}intersect(e){const t=e.startDate,i=e.endDate,s=this.startDate,n=this.endDate;if(n<t||s>i)return va;const r=new Date(Math.max(s.getTime(),t.getTime())),a=new Date(Math.min(n.getTime(),i.getTime()));return this.constructor.new({startDate:r,endDate:a})}intersectMut(e,t=!1){const i=e.startDate,s=e.endDate,n=this.startDate,r=this.endDate;if(t){var a;this.intersectionOf||(this.intersectionOf=new Set),((a=e.intersectionOf)===null||a===void 0?void 0:a.size)>0?(e.intersectionOf.forEach(this.intersectionOf.add,this.intersectionOf),this.intersectedAsEmpty=e.intersectedAsEmpty):this.intersectionOf.add(e)}if(!this.isIntervalEmpty()){if(r<i||n>s)return this.startDate=le,this.endDate=ve,t&&(this.intersectedAsEmpty=e),this;this.startDate=new Date(Math.max(n.getTime(),i.getTime())),this.endDate=new Date(Math.min(r.getTime(),s.getTime()))}return this}getCopyProperties(e){return e}copyWith(e){const t=this.getCopyProperties(e);return this.constructor.new(t)}}const va=zn.new({startDate:le,endDate:ve}),Le=(o,e=!1)=>o.reduce((t,i)=>t.intersectMut(i,e),zn.new());var Ca=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n},me;(function(o){o.Cancel="Cancel",o.Resume="Resume"})(me||(me={}));class Zt extends de{getDescription(){throw new Error("Abstract method")}resolve(...e){throw new Error("Abstract method")}}class Yt extends W{getResolutions(){return this._resolutions}getDescriptionBuilderClass(){return this._descriptionBuilderClass}setDescriptionBuilderClass(e){this._descriptionBuilderClass=e}getDescription(){return this.getDescriptionBuilderClass().getDescription(this)}}Ca([E("schedulingIssueEffect")],Yt.prototype,"type",void 0),Ca([E(!1)],Yt.prototype,"sync",void 0);var ss=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const rs=Symbol("ConflictSymbol");class Da extends pe(de){static get $name(){return"ConflictEffectDescription"}static getDescription(e){return Be(this.L("L{descriptionTpl}"),e.intervals[0].getDescription(),e.intervals[1].getDescription())}}class Pt extends Yt{constructor(){super(...arguments),this.handler=rs}initialize(e){super.initialize(e),this.intervals=this.filterConflictingIntervals(this.intervals)}getResolutions(){return this._resolutions||(this._resolutions=[].concat(...this.intervals.map(e=>e.getResolutions()))),this._resolutions}filterConflictingIntervals(e){const t=[],i=[...e].filter(n=>!n.isInfinite()),s=i.find(n=>n.isAffectedByTransaction());if(s){const n=i.sort((l,c)=>l===s?-1:0),a=Le(n,!0).intersectedAsEmpty;t.push(a,s)}else t.push(Le(i,!0).intersectedAsEmpty,Le(i.reverse(),!0).intersectedAsEmpty);return t}}ss([E("schedulingConflict")],Pt.prototype,"type",void 0),ss([E(Da)],Pt.prototype,"_descriptionBuilderClass",void 0);class as extends Zt{resolve(){throw new Error("Abstract method")}}class Gn extends pe(de){static get $name(){return"ConstraintIntervalDescription"}static getDescription(e){return Be(this.L("L{descriptionTpl}"),...this.getDescriptionParameters(e))}static getDescriptionParameters(e){return[I.format(e.startDate,this.L("L{dateFormat}")),I.format(e.endDate,this.L("L{dateFormat}"))]}}class Rt extends zn{constructor(){super(...arguments),this.owner=void 0,this.reflectionOf=void 0,this.side=void 0,this.resolutions=void 0}get isConstraintInterval(){return!0}getDescription(){return this.descriptionBuilderClass.getDescription(this)}getResolutions(){return[]}isAffectedByTransaction(e){return!1}getCopyProperties(e){const{owner:t,reflectionOf:i,side:s}=this;return Object.assign({owner:t,reflectionOf:i,side:s},e)}}ss([E(Gn)],Rt.prototype,"descriptionBuilderClass",void 0);class os extends y([Io],e=>{e.prototype;class t extends e{getGraph(){const s=this.getProject();return s==null?void 0:s.getGraph()}getEventById(s){var n;return(n=this.getEventStore())===null||n===void 0?void 0:n.getById(s)}getDependencyById(s){var n;return(n=this.getDependencyStore())===null||n===void 0?void 0:n.getById(s)}getResourceById(s){var n;return(n=this.getResourceStore())===null||n===void 0?void 0:n.getById(s)}getAssignmentById(s){var n;return(n=this.getAssignmentStore())===null||n===void 0?void 0:n.getById(s)}getCalendarById(s){var n;return(n=this.getCalendarManagerStore())===null||n===void 0?void 0:n.getById(s)}}return t}){}class Sa extends y([xe],e=>class extends e{}){}class Ye extends y([Mo,os,Sa],e=>{const t=e.prototype;class i extends e{constructor(){super(...arguments),this.removalOrder=0}setStoreData(n){var r;(r=this.project)===null||r===void 0||r.repopulateStore(this),t.setStoreData.call(this,n)}register(n){var r,a;t.register.call(this,n),!n.isRoot&&!((r=this.project)!==null&&r!==void 0&&r.graph)&&((a=this.project)===null||a===void 0||a.scheduleDelayedCalculation())}onModelChange(n,r,a,l,c,d){!d&&!(this.syncDataOnLoad&&this.isLoadingData)&&Object.keys(a).some(u=>u!=="intervals"&&n.$entity.getField(u))&&(l=!0),super.onModelChange(n,r,a,l,c,d)}}return i}){}class Tt extends y([Oo,os,Wn],e=>{const t=e.prototype;class i extends e{joinProject(){var n;(n=this.project)!==null&&n!==void 0&&n.delayEnteringReplica||(this.graph&&this.graph!=this.getGraph()&&(this.graph=null),this.getGraph().addEntity(this))}leaveProject(n=!1){t.leaveProject.call(this,n);const r=this.getGraph();r==null||r.removeEntity(this),this.graph=null}getProject(){return t.getProject.call(this)}calculateProject(){const n=this.stores.find(r=>bn(r,Ye)&&!!r.getProject());return n==null?void 0:n.getProject()}get graph(){var n;return(n=this.project)!==null&&n!==void 0&&n.delayEnteringReplica?null:this._graph}set graph(n){this._graph=n}}return i}){}var en=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const Fl=Symbol("CalendarMixin"),ls=Symbol("EmptyCalendarSymbol");class $t extends y([xo,Tt],e=>{class t extends e{constructor(){super(...arguments),this.version=1}[Fl](){}}return en([S({},{persistent:!1})],t.prototype,"version",void 0),en([S({type:"boolean",defaultValue:!0})],t.prototype,"unspecifiedTimeIsWorking",void 0),en([S()],t.prototype,"intervals",void 0),t}){}class Ea extends pe(de){static get $name(){return"EmptyCalendarEffectDescription"}static getDescription(e){const t=e.getCalendar();return Be(this.L("L{descriptionTpl}"),t.name||t.id)}}class tn extends Yt{constructor(){super(...arguments),this.handler=ls}getResolutions(){const e=this.getCalendar();return this._resolutions||(this._resolutions=[ba.new({calendar:e}),wa.new({calendar:e})])}getCalendar(){const{calendars:e}=this;if((e==null?void 0:e.length)>1){for(const t of e)if(!(t.skipNonWorkingTime(this.date,this.isForward)instanceof Date))return t}return e[0]}}en([E("emptyCalendar")],tn.prototype,"type",void 0),en([E(Ea)],tn.prototype,"_descriptionBuilderClass",void 0);class cs extends pe(Zt){static get $name(){return"BaseEmptyCalendarEffectResolution"}static get configurable(){return{calendarData:{intervals:[{isWorking:!0}]}}}getDescription(){const{calendar:e}=this;return Be(this.L("L{descriptionTpl}"),e.name||e.id)}fixCalendarData(e){var t;e.clearIntervals(!0),Object.assign(e,this.calendarData),(t=e.intervals)!==null&&t!==void 0&&t.length&&e.addIntervals(e.intervals)}resolve(){const{calendar:e}=this;this.fixCalendarData(e)}}class ba extends cs{static get $name(){return"Use24hrsEmptyCalendarEffectResolution"}static get configurable(){return{calendarData:{unspecifiedTimeIsWorking:!1,intervals:[{recurrentStartDate:"on Mon at 0:00",recurrentEndDate:"on Sat at 0:00",isWorking:!0}]}}}}class wa extends cs{static get $name(){return"Use8hrsEmptyCalendarEffectResolution"}static get configurable(){return{calendarData:{unspecifiedTimeIsWorking:!1,intervals:[{recurrentStartDate:"every weekday at 08:00",recurrentEndDate:"every weekday at 12:00",isWorking:!0},{recurrentStartDate:"every weekday at 13:00",recurrentEndDate:"every weekday at 17:00",isWorking:!0}]}}}}var ds=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const us=Symbol("CycleSymbol");class hs extends An{constructor(){super(...arguments),this.failedResolutionReferences=new Map}}class Pa extends Ki{constructor(){super(...arguments),this.candidateClass=hs}initialize(e){var t;(t=e.graph.project)!==null&&t!==void 0&&t.delayCalculation&&(e.startProgressNotificationsAfterMs=0,e.emitProgressNotificationsEveryMs=100),super.initialize(e),this.candidate.failedResolutionReferences=new Map(this.baseRevision.failedResolutionReferences)}addIdentifier(e,t,...i){return this.candidate.failedResolutionReferences.size&&(this.candidate.failedResolutionReferences.forEach((s,n)=>{this.write(n,s)}),this.candidate.failedResolutionReferences.clear()),super.addIdentifier(e,t,...i)}}class Ra extends y([Qi],e=>{const t=e.prototype;class i extends e{constructor(){super(...arguments),this.baseRevision=hs.new(),this.transactionClass=Pa,this.autoCommitMode="async",this.onComputationCycle="effect",this.cycleEffectClass=et,this.silenceInitialCommit=!0,this.ignoreInitialCommitComputationCycles=!1}get dirty(){const n=this.activeTransaction;return n.entries.size>0&&(n.hasVariableEntry||n.hasEntryWithProposedValue)}onPropagationProgressNotification(n){var r,a;this.enableProgressNotifications&&this.project&&((r=(a=this.project).trigger)===null||r===void 0||r.call(a,"progress",n))}async commitAsync(n){if(!this.project||this.project.isDestroyed)return;this.project.trigger("beforeCommit"),this.isInitialCommit&&this.ignoreInitialCommitComputationCycles&&(this._onComputationCycle=this._onComputationCycle||this.onComputationCycle,this.onComputationCycle="ignore");const r=this.project.beforeCommitAsync();return r||t.commitAsync.call(this,n)}get isInitialCommit(){return this.project.isInitialCommit||super.isInitialCommit}set isInitialCommit(n){super.isInitialCommit=n}write(n,r,...a){var l;const c=(l=n.field)===null||l===void 0?void 0:l.name,d=n.self;if(c&&d){var u,h;const f=(u=d.beforeChronoFieldSet)===null||u===void 0?void 0:u.call(d,c,r);t.write.call(this,n,r,...a),(h=d.afterChronoFieldSet)===null||h===void 0||h.call(d,c,r,f)}else t.write.call(this,n,r,...a)}async finalizeCommitAsync(n){const{project:r}=this;if(!r||r.isDestroyed)return;const{entries:a}=n,l=new Set;globalThis.DEBUG&&console.timeEnd("Time to visible");const{isInitialCommit:c,silenceInitialCommit:d}=this,u=c&&d;c&&(r.isInitialCommitPerformed=!0,this.ignoreInitialCommitComputationCycles&&(this.onComputationCycle=this._onComputationCycle)),r.isWritingData=!0,r.hasLoadedDataToCommit=!1,this.enableProgressNotifications&&r.trigger("progress",{total:n.entries.size,remaining:0,phase:"finalizing"}),n.transaction.rejectedWith&&r.trigger("commitRejected",{transactionResult:n,isInitialCommit:c,silenceCommit:u}),r.trigger("refresh",{isInitialCommit:c,isCalculated:!0}),await new Promise(f=>{setTimeout(()=>{if(!r.isDestroyed){if(n.transaction.rejectedWith)r.isWritingData=!1;else{var p,g;(p=r.suspendChangesTracking)===null||p===void 0||p.call(r),globalThis.DEBUG&&console.time("Finalize propagation");const m=new Set;for(const C of a.values()){const z=C.identifier,T=C.getValue(),{field:$}=z;if(C.isShadow()||!z[Ln]||T===O||$ instanceof Je)continue;const F=z.self,w=F.firstStore;m.has(F)||(F.beginBatch(!0),m.add(F)),w!=null&&w.autoCommit&&!l.has(w)&&(w.suspendAutoCommit(),l.add(w)),F.meta.batchChanges[$.name]=T}let v=!1;for(const C of m)if(!C.triggerBeforeUpdate({...C.meta.batchChanges})){v=!0;break}if(v){for(const C of m)C.cancelBatch();n.transaction.reject(),r.trigger("commitRejected",{transactionResult:n,isInitialCommit:c,silenceCommit:u}),r.trigger("refresh",{isInitialCommit:c,isCalculated:!0})}else for(const C of m)C.ignoreBag=u||r.ignoreRecordChanges,C.generation++,C.endBatch(u,!0,!0),C.ignoreBag=!1;r.ignoreRecordChanges=!1,globalThis.DEBUG&&console.timeEnd("Finalize propagation"),r.isWritingData=!1,v||r.trigger("dataReady",{records:m,isInitialCommit:c}),(g=r.resumeChangesTracking)===null||g===void 0||g.call(r,u),l.forEach(C=>C.resumeAutoCommit()),u&&(r.eventStore.acceptChanges(),r.dependencyStore.acceptChanges(),r.resourceStore.acceptChanges(),r.assignmentStore.acceptChanges(),r.calendarManagerStore.acceptChanges(),r.acceptChanges())}r.trigger("commitFinalized",{isInitialCommit:c,transactionResult:n})}f()},0)})}*onComputationCycleHandler(n){if(this.onComputationCycle==="effect"){const r=this.project.cycleEffectClass.new({cycle:n});(yield r)===me.Cancel&&(yield He(r))}else return yield*super.onComputationCycleHandler(n)}async[us](n,r){return this.project.onCycleSchedulingIssue(n,r)}async[ls](n,r){return r.walkContext.startNewEpoch(),this.project.onEmptyCalendarSchedulingIssue(n,r)}async[rs](n,r){return r.walkContext.startNewEpoch(),this.project.onConflictSchedulingIssue(n,r)}[Ut](n,r){return super[Ut](n,r)}}return i}){}class Ta extends pe(Zt){static get $name(){return"RemoveDependencyCycleEffectResolution"}getDescription(){return this.L("L{descriptionTpl}")}resolve(e){e.remove()}}class $a extends pe(de){static get $name(){return"CycleEffectDescription"}static getDescription(e){return Be(this.L("L{descriptionTpl}"),this.getShortDescription(e))}static getShortDescription(e){const t=e.getEvents().slice();return t.push(t[0]),'"'+t.map(i=>i.name||"#"+i.id).join('" -> "')+'"'}}class et extends Yt{constructor(){super(...arguments),this.handler=us}getEvents(){if(!this._events){const e=new Set;this.cycle.cycle.forEach(({context:t})=>e.add(t)),this._events=[...e]}return this._events}matchDependencyBySourceAndTargetEvent(e,t,i){return e.fromEvent===t&&e.toEvent===i}getDependencyForSourceAndTargetEvents(e,t){return this.getEvents()[0].project.getDependencyStore().find(r=>this.matchDependencyBySourceAndTargetEvent(r,e,t))}getDependencies(){if(!this._dependencies){const e=new Set,t=this.getEvents(),i=t.length;let s=t[0],n;if(i===1)(n=this.getDependencyForSourceAndTargetEvents(s,s))&&e.add(n);else for(const r of t)for(const a of t)(n=this.getDependencyForSourceAndTargetEvents(r,a))&&e.add(n),(n=this.getDependencyForSourceAndTargetEvents(a,r))&&e.add(n);this._dependencies=[...e]}return this._dependencies}getResolutions(){return this._resolutions||(this._resolutions=[this.removeDependencyCycleEffectResolutionClass.new()]),this._resolutions}}ds([E("cycle")],et.prototype,"type",void 0),ds([E($a)],et.prototype,"_descriptionBuilderClass",void 0),ds([E(Ta)],et.prototype,"removeDependencyCycleEffectResolutionClass",void 0);var Ia=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Un extends y([Tt],e=>{e.prototype;class t extends e{}return Ia([te({bucket:"assigned",resolver:function(i){return this.getEventById(i)},modelFieldConfig:{serialize:i=>i==null?void 0:i.id,isEqual:bt,persist:!1}},Xe)],t.prototype,"event",void 0),Ia([te({bucket:"assigned",resolver:function(i){return this.getResourceById(i)},modelFieldConfig:{serialize:i=>i==null?void 0:i.id,isEqual:bt,persist:!1}},Xe)],t.prototype,"resource",void 0),Nn(t),t}){}class fs extends y([jo,Ye],e=>{e.prototype;class t extends e{constructor(){super(...arguments),this.removalOrder=100}static get defaultConfig(){return{modelClass:Un}}set data(s){this.allAssignmentsForRemoval=!0,super.data=s,this.allAssignmentsForRemoval=!1}}return t}){}class ps extends y([Ao,Ye],e=>{e.prototype;class t extends e{constructor(){super(...arguments),this.removalOrder=500}static get defaultConfig(){return{tree:!0,modelClass:$t}}}return t}){}class gs extends y([Fo,Ye],e=>{e.prototype;class t extends e{constructor(){super(...arguments),this.removalOrder=200}set data(s){this.allDependenciesForRemoval=!0,super.data=s,this.allDependenciesForRemoval=!1}}return t}){}var ne;(function(o){o.KeepDuration="KeepDuration",o.KeepStartDate="KeepStartDate",o.KeepEndDate="KeepEndDate"})(ne||(ne={}));const P=Symbol("StartDate"),R=Symbol("EndDate"),k=Symbol("Duration"),$e=L.new({output:P,inputs:new Set([k,R])}),Ie=L.new({output:R,inputs:new Set([k,P])}),Ve=L.new({output:k,inputs:new Set([P,R])}),ms=pt.new({variables:new Set([P,R,k]),formulas:new Set([$e,Ie,Ve])}),Ma=Ee.new({description:ms,defaultResolutionFormulas:new Set([Ie])}),Oa=Ee.new({description:ms,defaultResolutionFormulas:new Set([$e])});class ys extends Gr{addInstruction(e){e===ne.KeepStartDate&&this.addKeepIfPossibleFlag(P),e===ne.KeepEndDate&&this.addKeepIfPossibleFlag(R),e===ne.KeepDuration&&this.addKeepIfPossibleFlag(k)}}class vs extends ue.mix(Re){equality(e,t){const i=e.resolution,s=t.resolution;return i.get(P)===s.get(P)&&i.get(R)===s.get(R)&&i.get(k)===s.get(k)||i.get(P)===J&&i.get(R)===J&&i.get(k)===J}}var Hn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class qn extends y([Tt],e=>{class t extends e{writeCalendar(s,n,r,a){const l=this.getCalendarManagerStore(),c=a;a&&l&&a instanceof $t&&!l.includes(c)&&l.add(a),s.constructor.prototype.write.call(this,s,n,r,a)}resolveCalendar(s){var n;return(n=this.getCalendarManagerStore())===null||n===void 0?void 0:n.getById(s)}*calculateEffectiveCalendar(){let s=yield this.$.calendar;return s||(s=yield this.getProject().$.effectiveCalendar),yield s.$.version,s}shouldRecordFieldChange(s,n,r){if(!super.shouldRecordFieldChange(s,n,r))return!1;const{project:a}=this;if(s==="calendar"&&a){const{calendarManagerStore:l}=a;return l.oldIdMap[n]!==l.getById(r)}return!0}}return Hn([M({equality:()=>!1})],t.prototype,"effectiveCalendar",void 0),Hn([te({modelFieldConfig:{persist:!0,serialize:i=>i===void 0?void 0:(i==null?void 0:i.id)||null,isEqual:bt},resolver:function(i){return this.resolveCalendar(i)},sync:!0},Xe)],t.prototype,"calendar",void 0),Hn([Ae("calendar")],t.prototype,"writeCalendar",null),Hn([D("effectiveCalendar")],t.prototype,"calculateEffectiveCalendar",null),Nn(t),t}){}class xa extends y([],e=>{class t extends e{constructor(){super(...arguments),this.combinedcalendarscache=new Map}combineCalendars(s){const n=ko(s);if(n.length===0)throw new Error("No calendars to combine");n.sort((d,u)=>d.internalId<u.internalId?-1:1);const r=n.map(d=>d.internalId+"/").join(""),a=n.map(d=>d.version+"/").join(""),l=this.combinedcalendarscache.get(r);let c;return l&&l.versionsHash===a?c=l.cache:(c=new ol({calendarCaches:n.map(d=>d.calendarCache)}),this.combinedcalendarscache.set(r,{versionsHash:a,cache:c})),c}}return t}){}var Q=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class tt extends y([qn],e=>{e.prototype;class t extends e{*calculateDispatcher(s){yield A;const n=yield*this.prepareDispatcher(s),r=yield qe(this.$.startDate),a=r?r[0]?ne.KeepDuration:ne.KeepEndDate:void 0;a&&n.addInstruction(a);const l=yield qe(this.$.endDate),c=l?l[0]?ne.KeepDuration:ne.KeepStartDate:void 0;c&&n.addInstruction(c);const d=yield this.$.direction,u=yield qe(this.$.duration);let h;if(u)switch(u[0]){case!0:h=ne.KeepStartDate;break;case!1:h=ne.KeepEndDate;break}return!h&&n.hasProposedValue(k)&&(h=d===G.Forward||d===G.None?ne.KeepStartDate:ne.KeepEndDate),h&&n.addInstruction(h),n}*prepareDispatcher(s){const r=this.dispatcherClass(s).new({context:this.cycleResolutionContext(s)});return r.collectInfo(s,this.$.startDate,P),r.collectInfo(s,this.$.endDate,R),r.collectInfo(s,this.$.duration,k),r}cycleResolutionContext(s){const n=s(this.$.direction);return n===G.Forward||n===G.None?Ma:Oa}dispatcherClass(s){return ys}buildProposedDispatcher(s,n,r){const a=this.dispatcherClass(r.onEffectSync).new({context:this.cycleResolutionContext(r.onEffectSync)});return a.addPreviousValueFlag(P),a.addPreviousValueFlag(R),a.addPreviousValueFlag(k),a}*skipNonWorkingTime(s,n){const r=yield this.$.effectiveCalendar;if(!s)return null;const a=r.skipNonWorkingTime(s,n);if(a instanceof Date)return a;{const l=tn.new({calendars:[r],event:this,date:s,isForward:n});if((yield l)===me.Cancel)yield He(l);else return null}}*skipWorkingTime(s,n,r,a){const l=yield this.$.durationUnit;return a&&a!==l&&(r=yield*this.getProject().$convertDuration(r,a,l)),yield*this.calculateProjectedXDateWithDuration(s,n,r)}setStartDate(s,n=!0){const{graph:r,project:a}=this;return r?(r.write(this.$.startDate,s,n),r.commitAsync()):(this.$.startDate.DATA=s,a==null?void 0:a.delayedCalculationPromise)}writeStartDate(s,n,r,a,l=!0){!n.baseRevision.hasIdentifier(s)&&a==null||(this.getProject().isStmRestoring||this.$.unscheduled.write(this.$.unscheduled,n,void 0,a==null),s.constructor.prototype.write.call(this,s,n,r,a,l))}*calculateStartDate(){const n=(yield this.$.dispatcher).resolution.get(P);if(n===J)return yield*this.calculateStartDateProposed();if(n===$e.formulaId)return yield*this.calculateStartDatePure();throw new Error("Unknown formula for `startDate`")}*calculateStartDatePure(){return yield*this.calculateProjectedXDateWithDuration(yield this.$.endDate,!1,yield this.$.duration)}*calculateStartDateProposed(){const s=this.getProject(),n=yield A;return!(yield this.$.manuallyScheduled)||s.skipNonWorkingTimeWhenSchedulingManually?yield*this.skipNonWorkingTime(n,!0):n}*calculateProjectedXDateWithDuration(s,n,r){const a=yield this.$.durationUnit,l=yield this.$.effectiveCalendar,c=this.getProject();return!s||Bo(r)?null:(n=n===void 0?!0:n,n?l.calculateEndDate(s,yield*c.$convertDuration(r,a,b.Millisecond)):l.calculateStartDate(s,yield*c.$convertDuration(r,a,b.Millisecond)))}setEndDate(s,n=!1){const{graph:r,project:a}=this;return r?(r.write(this.$.endDate,s,n),r.commitAsync()):(this.$.endDate.DATA=s,a==null?void 0:a.delayedCalculationPromise)}writeEndDate(s,n,r,a,l=!1){!n.baseRevision.hasIdentifier(s)&&a==null||(this.getProject().isStmRestoring||this.$.unscheduled.write(this.$.unscheduled,n,void 0,a==null),s.constructor.prototype.write.call(this,s,n,r,a,l))}*calculateEndDate(){const n=(yield this.$.dispatcher).resolution.get(R);if(n===J)return yield*this.calculateEndDateProposed();if(n===Ie.formulaId)return yield*this.calculateEndDatePure();throw new Error("Unknown formula for `endDate`")}*calculateEndDatePure(){return yield*this.calculateProjectedXDateWithDuration(yield this.$.startDate,!0,yield this.$.duration)}*calculateEndDateProposed(){const s=this.getProject(),n=yield A;return!(yield this.$.manuallyScheduled)||s.skipNonWorkingTimeWhenSchedulingManually?yield*this.skipNonWorkingTime(n,!1):n}getDuration(s){const n=this.duration;return s!==void 0?this.getProject().convertDuration(n,this.durationUnit,s):n}setDuration(s,n,r){const{graph:a,project:l}=this;if(a){if(s!==void 0)return a.write(this.$.duration,s,n,r),a.commitAsync()}else{const c={duration:s};return this.$.duration.DATA=s,n!=null&&(c.durationUnit=this.$.durationUnit.DATA=n),this.set(c),l==null?void 0:l.delayedCalculationPromise}}setDurationUnit(s){throw new Error("Use `setDuration` instead")}writeDuration(s,n,r,a,l,c=void 0){a<0&&(a=0),!(!n.baseRevision.hasIdentifier(s)&&a==null)&&(this.getProject().isStmRestoring||this.$.unscheduled.write(this.$.unscheduled,n,void 0,a==null),s.constructor.prototype.write.call(this,s,n,r,a,c),l!=null&&n.write(this.$.durationUnit,l))}*calculateDuration(){const n=(yield this.$.dispatcher).resolution.get(k);if(n===J)return yield*this.calculateDurationProposed();if(n===Ve.formulaId)return yield*this.calculateDurationPure();throw new Error("Unknown formula for `duration`")}*calculateDurationPure(){const s=yield this.$.startDate,n=yield this.$.endDate;if(!s||!n)return null;if(s>n)yield xr(this.$.duration,0,null);else return yield*this.calculateProjectedDuration(s,n)}*calculateDurationProposed(){return yield A}*calculateProjectedDuration(s,n,r){if(!s||!n)return null;r||(r=yield this.$.durationUnit);const a=yield this.$.effectiveCalendar;return yield*this.getProject().$convertDuration(a.calculateDurationMs(s,n),b.Millisecond,r)}*calculateEffectiveDuration(){const s=yield this.$.dispatcher;let n;const r=s.resolution.get(k);return r===J?n=yield this.$.duration:r===Ve.formulaId&&(n=yield*this.calculateProjectedDuration(yield V(this.$.startDate),yield V(this.$.endDate))),n}*calculateEffectiveCalendar(){const s=yield this.$.manuallyScheduled,n=this.getProject();return s&&!n.skipNonWorkingTimeInDurationWhenSchedulingManually?n.defaultCalendar:yield*super.calculateEffectiveCalendar()}}return Q([S({type:"date"},{converter:Ze})],t.prototype,"startDate",void 0),Q([S({type:"date"},{converter:Ze})],t.prototype,"endDate",void 0),Q([S({type:"number",allowNull:!0})],t.prototype,"duration",void 0),Q([S({type:"string",defaultValue:b.Day},{converter:i=>I.normalizeUnit(i)||b.Day})],t.prototype,"durationUnit",void 0),Q([S({type:"string",defaultValue:G.Forward},{sync:!0})],t.prototype,"direction",void 0),Q([M({identifierCls:vs})],t.prototype,"dispatcher",void 0),Q([S({type:"boolean",defaultValue:!1})],t.prototype,"manuallyScheduled",void 0),Q([S({type:"boolean",defaultValue:!1})],t.prototype,"unscheduled",void 0),Q([D("dispatcher")],t.prototype,"calculateDispatcher",null),Q([ia("dispatcher")],t.prototype,"buildProposedDispatcher",null),Q([Ae("startDate")],t.prototype,"writeStartDate",null),Q([D("startDate")],t.prototype,"calculateStartDate",null),Q([Ae("endDate")],t.prototype,"writeEndDate",null),Q([D("endDate")],t.prototype,"calculateEndDate",null),Q([Ae("duration")],t.prototype,"writeDuration",null),Q([D("duration")],t.prototype,"calculateDuration",null),t}){}var kl=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Cs extends y([tt,_o],e=>{e.prototype;class t extends e{get assignments(){return this.assigned?[...this.assigned]:[]}}return kl([te({},Je)],t.prototype,"assigned",void 0),t}){}var ja=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Ds extends y([tt],e=>{const t=e.prototype;class i extends e{leaveProject(){var n,r;if(this.isInActiveTransaction){const a=this.graph.activeTransaction,l=this.getDependencyStore(),c=[];for(const d of(n=a.readCurrentOrProposedOrPrevious(this.$.outgoingDeps))!=null?n:[])l.includes(d)&&c.push(d);for(const d of(r=a.readCurrentOrProposedOrPrevious(this.$.incomingDeps))!=null?r:[])l.includes(d)&&c.push(d);this.project.dependencyStore.remove(c)}t.leaveProject.call(this)}}return ja([te({},Je)],i.prototype,"outgoingDeps",void 0),ja([te({},Je)],i.prototype,"incomingDeps",void 0),i}){}class Kn extends y([tt,Cs,Ds],e=>{e.prototype;class t extends e{}return t}){}class Qn extends y([Lo,Ye],e=>{class t extends e{constructor(){super(...arguments),this.removalOrder=400}static get defaultConfig(){return{modelClass:Kn}}set data(s){super.data=s,this.afterEventRemoval()}}return t}){}class Bl extends y([Qn],e=>{class t extends e{buildRootNode(){return this.getProject()||{}}static get defaultConfig(){return{tree:!0}}}return t}){}var _l=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Xn extends y([qn,Tt],e=>{const t=e.prototype;class i extends e{get assignments(){return[...this.assigned]}leaveProject(n=!1){if(!this.isStmRestoring&&this.assigned&&!n){const r=this.getResourceStore();this.assigned.forEach(a=>r.assignmentsForRemoval.add(a))}t.leaveProject.call(this)}static get fields(){return[{name:"parentId"},{name:"children",persist:!1}]}}return _l([te({},Je)],i.prototype,"assigned",void 0),i}){}class Ss extends y([Vo,Ye],e=>{e.prototype;class t extends e{constructor(){super(...arguments),this.removalOrder=300}static get defaultConfig(){return{modelClass:Xn}}}return t}){}var nn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Aa extends y([Wn],e=>{e.prototype;class t extends e{*calculateUnitsInMs(){const s=yield this.$.hoursPerDay,n=yield this.$.daysPerWeek,r=yield this.$.daysPerMonth;return{millisecond:1,second:1e3,minute:60*1e3,hour:60*60*1e3,day:s*60*60*1e3,week:n*s*60*60*1e3,month:r*s*60*60*1e3,quarter:3*r*s*60*60*1e3,year:4*3*r*s*60*60*1e3}}convertDuration(s,n,r){let a=s;return n!==r&&(a=s*this.unitsInMs[n]/this.unitsInMs[r]),a}*$convertDuration(s,n,r){if(!n||!r)throw new Error("Conversion unit not provided");const a=yield this.$.unitsInMs;let l=s;return n!==r&&(l=s*a[n]/a[r]),l}}return nn([M()],t.prototype,"unitsInMs",void 0),nn([S({type:"number",defaultValue:24})],t.prototype,"hoursPerDay",void 0),nn([S({type:"number",defaultValue:7})],t.prototype,"daysPerWeek",void 0),nn([S({type:"number",defaultValue:30})],t.prototype,"daysPerMonth",void 0),nn([D("unitsInMs")],t.prototype,"calculateUnitsInMs",null),t}){}var sn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Es extends y([Tt],e=>{e.prototype;class t extends e{get isValid(){const{$:s,graph:n}=this;return n&&(!n.hasIdentifier(s.fromEvent)||!n.hasIdentifier(s.toEvent))?!1:super.isValid}}return sn([te({bucket:"outgoingDeps",resolver:function(i){return this.getEventById(i)},modelFieldConfig:{persist:!0,serialize:i=>i==null?void 0:i.id,isEqual:bt}},Xe)],t.prototype,"fromEvent",void 0),sn([te({bucket:"incomingDeps",resolver:function(i){return this.getEventById(i)},modelFieldConfig:{persist:!0,serialize:i=>i==null?void 0:i.id,isEqual:bt}},Xe)],t.prototype,"toEvent",void 0),sn([S({type:"int",defaultValue:_t.EndToStart})],t.prototype,"type",void 0),sn([S({type:"string"})],t.prototype,"fromSide",void 0),sn([S({type:"string"})],t.prototype,"toSide",void 0),t}){}class Fa extends y([Wn,No],e=>{e.prototype;class t extends e{get isDelayingCalculation(){return!!(this.delayEnteringReplica||this.delayedCalculationPromise)}getGraph(){return this.replica}beforeCommitAsync(){return null}enterReplica(s){}acceptChanges(){}async commitAsync(){var s;return this.delayedCalculationPromise||((s=this.replica)===null||s===void 0?void 0:s.commitAsync())}getSchedulingIssueEventArguments(s,n,r,a){const l=[s.type,{continueWithResolutionResult:r,schedulingIssue:s}];return s instanceof Pt&&(l[1].conflict=s),l}async onSchedulingIssueCall(s,n){return s.type&&this.hasListener(s.type)?new Promise((r,a)=>{this.trigger(...this.getSchedulingIssueEventArguments(s,n,r,a))}):me.Cancel}async onCycleSchedulingIssue(s,n){return this.onSchedulingIssueCall(s,n)}async onEmptyCalendarSchedulingIssue(s,n){return this.onSchedulingIssueCall(s,n)}async onConflictSchedulingIssue(s,n){return this.onSchedulingIssueCall(s,n)}setModelCalculations(s,n){if(!n)return;const r={};for(const a in n)r[a]=s.prototype.$calculations[a];return Object.assign(s.prototype.$calculations,n),r}setRecordCalculations(s,n){const r=this.setModelCalculations(s.constructor,n),a=s.$entity.$skeleton;return Object.keys(n).forEach(l=>{a[l].prototype.calculation=s[n[l]]}),r}setStoreCalculations(s,n){if(!n)return;const r=s.first;return r?this.setRecordCalculations(r,n):this.setModelCalculations(s.modelClass,n)}async setCalculations(s){this.replica&&await this.commitAsync();const n={},r={tasks:this.eventStore,events:this.eventStore,dependencies:this.dependencyStore,resources:this.resourceStore,assignments:this.assignmentStore,calendars:this.calendarManagerStore};Object.keys(r).forEach(l=>{s[l]&&(n[l]=this.setStoreCalculations(r[l],s[l]))});let a=s.project;return a&&(n.project=this.setRecordCalculations(this,a)),this.replica&&this.repopulateReplica.now(),this.replica&&await this.commitAsync(),n}}return t}){}class Jn extends y([tt],e=>{const t=e.prototype;class i extends e{static get $name(){return"HasSubEventsMixin"}*hasSubEvents(){throw new Error("Abstract method `hasSubEvents` has been called")}*subEventsIterable(){throw new Error("Abstract method `subEventsIterable` has been called")}*calculateStartDatePure(){const n=yield this.$.manuallyScheduled,r=yield*this.hasSubEvents();return!n&&r?yield*this.calculateMinChildrenStartDate():yield*t.calculateStartDatePure.call(this)}*calculateEndDatePure(){const n=yield this.$.manuallyScheduled,r=yield*this.hasSubEvents();return!n&&r?yield*this.calculateMaxChildrenEndDate():yield*t.calculateEndDatePure.call(this)}*calculateStartDateProposed(){const n=yield this.$.manuallyScheduled,r=yield*this.hasSubEvents();return!n&&r?yield*this.calculateStartDatePure():yield*t.calculateStartDateProposed.call(this)}*calculateEndDateProposed(){const n=yield this.$.manuallyScheduled,r=yield*this.hasSubEvents();return!n&&r?yield*this.calculateEndDatePure():yield*t.calculateEndDateProposed.call(this)}*calculateDurationProposed(){const n=yield this.$.manuallyScheduled,r=yield*this.hasSubEvents();return!n&&r?yield*this.calculateDurationPure():yield*t.calculateDurationProposed.call(this)}*shouldRollupChildStartDate(n){return!0}*calculateMinChildrenStartDate(){const n=yield*this.subEventsIterable();let r=le.getTime();for(const a of n)if(yield*this.shouldRollupChildStartDate(a)){let l=yield a.$.startDate;l||(l=yield a.$.endDate),l&&l.getTime()<r&&(r=l.getTime())}return r===ve.getTime()||r===le.getTime()?null:new Date(r)}*shouldRollupChildEndDate(n){return!0}*calculateMaxChildrenEndDate(){const n=yield*this.subEventsIterable();let r=ve.getTime();for(const a of n)if(yield*this.shouldRollupChildEndDate(a)){let l=yield a.$.endDate;l||(l=yield a.$.startDate),l&&l.getTime()>r&&(r=l.getTime())}return r===ve.getTime()||r===le.getTime()?null:new Date(r)}}return i}){}var ka=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class rn extends y([Jn],e=>{e.prototype;class t extends e{*hasSubEvents(){return(yield this.$.childEvents).size>0}*subEventsIterable(){return yield this.$.childEvents}get parent(){return this._parent}set parent(s){this._parent=s,this.parentEvent=s}}return ka([ra({bucket:"childEvents"})],t.prototype,"parentEvent",void 0),ka([la()],t.prototype,"childEvents",void 0),t}){}var bs=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Ba extends vr([Fa,tt,Jn,qn,Aa,xa],e=>{const t=e.prototype;class i extends e{construct(n={}){this.delayCalculation=n.delayCalculation!==!1,this.enableProgressNotifications=n.enableProgressNotifications||n.delayCalculation!==!1,"expanded"in n||(n.expanded=!0),this.delayCalculation&&(this.delayEnteringReplica=!0),"skipNonWorkingTimeWhenSchedulingManually"in n||(n.skipNonWorkingTimeWhenSchedulingManually=!1),t.construct.call(this,n),this.repopulateStores=new Set,this.ignoreInitialCommitComputationCycles="ignoreInitialCommitComputationCycles"in n?n.ignoreInitialCommitComputationCycles:!1,this.ignoreInitialCommitComputationCycles&&console.warn('Project "ignoreInitialCommitComputationCycles" option is deprecated and will be dropped in the next major release'),this.eventModelClass||(this.eventModelClass=this.getDefaultEventModelClass()),this.eventStoreClass||(this.eventStoreClass=this.getDefaultEventStoreClass()),this.dependencyModelClass||(this.dependencyModelClass=this.getDefaultDependencyModelClass()),this.dependencyStoreClass||(this.dependencyStoreClass=this.getDefaultDependencyStoreClass()),this.resourceModelClass||(this.resourceModelClass=this.getDefaultResourceModelClass()),this.resourceStoreClass||(this.resourceStoreClass=this.getDefaultResourceStoreClass()),this.assignmentModelClass||(this.assignmentModelClass=this.getDefaultAssignmentModelClass()),this.assignmentStoreClass||(this.assignmentStoreClass=this.getDefaultAssignmentStoreClass()),this.calendarModelClass||(this.calendarModelClass=this.getDefaultCalendarModelClass()),this.calendarManagerStoreClass||(this.calendarManagerStoreClass=this.getDefaultCalendarManagerStoreClass()),this.cycleEffectClass||(this.cycleEffectClass=this.getDefaultCycleEffectClass()),this.initializeStm(),this.defaultCalendar=new this.calendarModelClass({unspecifiedTimeIsWorking:this.unspecifiedTimeIsWorking}),this.defaultCalendar.project=this,this.delayEnteringReplica||this.enterReplica(!1),this.setCalendarManagerStore(this.calendarManagerStore),this.setEventStore(this.eventStore),this.setDependencyStore(this.dependencyStore),this.setResourceStore(this.resourceStore),this.setAssignmentStore(this.assignmentStore),!!(this.calendarsData||this.eventsData||this.dependenciesData||this.resourcesData||this.assignmentsData)?(this.loadInlineData({calendarsData:this.calendarsData,eventsData:this.eventsData,dependenciesData:this.dependenciesData,resourcesData:this.resourcesData,assignmentsData:this.assignmentsData}),delete this.calendarsData,delete this.eventsData,delete this.dependenciesData,delete this.resourcesData,delete this.assignmentsData):this.delayCalculation&&this.hasDataInStores&&this.scheduleDelayedCalculation()}get hasDataInStores(){return[this.calendarManagerStore,this.eventStore,this.dependencyStore,this.resourceStore,this.assignmentStore].some(n=>n.allCount>0)}enterReplica(n){const r=this;r.replica||(r.replica=r.createReplica(),r.replica.addEntity(r),r.replica.addEntity(r.defaultCalendar),r.trigger("graphReady")),n&&!r.isRepopulatingStores&&(r.calendarManagerStore.forEach(a=>{!a.graph&&a.joinProject()},void 0,{includeFilteredOutRecords:!0}),r.eventStore.forEach(a=>{!a.graph&&a.joinProject()},void 0,{includeFilteredOutRecords:!0}),r.resourceStore.forEach(a=>{!a.graph&&a.joinProject()},void 0,{includeFilteredOutRecords:!0}),r.dependencyStore.forEach(a=>{!a.graph&&a.joinProject()},void 0,{includeFilteredOutRecords:!0}),r.assignmentStore.forEach(a=>{!a.graph&&a.joinProject()},void 0,{includeFilteredOutRecords:!0}))}resetStmQueue(){const n=this.stm.disabled;this.stm.disable(),this.stm.resetQueue(),n||this.stm.enable()}doDestroy(){var n,r,a,l,c,d,u,h;const f=this;(n=f.eventStore)===null||n===void 0||n.destroy(),(r=f.dependencyStore)===null||r===void 0||r.destroy(),(a=f.assignmentStore)===null||a===void 0||a.destroy(),(l=f.resourceStore)===null||l===void 0||l.destroy(),(c=f.calendarManagerStore)===null||c===void 0||c.destroy(),(d=f.defaultCalendar)===null||d===void 0||d.destroy(),(u=f.replica)===null||u===void 0||u.clear(),(h=f.stm)===null||h===void 0||h.destroy(),t.doDestroy.call(this)}getReplicaConfig(){return{project:this,schema:ha.new(),enableProgressNotifications:this.enableProgressNotifications,silenceInitialCommit:this.silenceInitialCommit,ignoreInitialCommitComputationCycles:this.ignoreInitialCommitComputationCycles,cycleEffectClass:this.cycleEffectClass,onWriteDuringCommit:"ignore",readMode:je.CurrentOrProposedOrPrevious}}createReplica(){return Ra.mix(Qi).new(this.getReplicaConfig())}*hasSubEvents(){return this.getEventStore().count>0}*subEventsIterable(){return this.getEventStore().getRange()}getType(){return Lt.SchedulerBasic}get enableProgressNotifications(){return this._enableProgressNotifications}set enableProgressNotifications(n){this._enableProgressNotifications=n,this.replica&&(this.replica.enableProgressNotifications=n)}getDefaultCycleEffectClass(){return et}getDefaultEventModelClass(){return Kn}getDefaultEventStoreClass(){return Qn}getDefaultDependencyModelClass(){return Es}getDefaultDependencyStoreClass(){return gs}getDefaultResourceModelClass(){return Xn}getDefaultResourceStoreClass(){return Ss}getDefaultAssignmentModelClass(){return Un}getDefaultAssignmentStoreClass(){return fs}getDefaultCalendarModelClass(){return $t}getDefaultCalendarManagerStoreClass(){return ps}usingSyncDataOnLoad(){return[this.eventStore,this.resourceStore,this.dependencyStore,this.assignmentStore].some(n=>n.syncDataOnLoad)}async loadInlineData(n){const{calendarManagerStore:r,eventStore:a,dependencyStore:l,assignmentStore:c,resourceStore:d,replica:u}=this;if(!this.isInitialCommitPerformed)u==null||u.unScheduleAutoCommit();else for(;this.replica.isCommitting;)await this.commitAsync();u!=null&&u.enableProgressNotifications&&!this.delayCalculation&&(await zt(0),await this.commitAsync(),u.onPropagationProgressNotification({total:0,remaining:0,phase:"storePopulation"}),await zt(50)),this.isInitialCommitPerformed=!1,this.isLoadingInlineData=!0,globalThis.DEBUG&&(console.log("%cInitializing project","font-weight:bold;color:darkgreen;text-transform:uppercase;margin-top: 2em"),console.time("Time to visible"),console.time("Populating project")),this.delayCalculation&&!this.delayedCalculationPromise&&!this.usingSyncDataOnLoad()&&this.scheduleDelayedCalculation(),n.calendarsData&&(this.repopulateStore(r),r.data=n.calendarsData),(n.eventsData||n.tasksData)&&(this.repopulateStore(a),a.data=n.eventsData||n.tasksData),n.dependenciesData&&(this.repopulateStore(l),l.data=n.dependenciesData),n.resourcesData&&(this.repopulateStore(d),d.data=n.resourcesData),n.assignmentsData&&(this.repopulateStore(c),c.data=n.assignmentsData),n.project&&this.applyProjectResponse(n.project),globalThis.DEBUG&&console.timeEnd("Populating project");const h=await this.commitLoad();return this.isLoadingInlineData=!1,h}setupTemporaryIndices(){const{storage:n}=this.assignmentStore||{};n&&(n.addIndex({property:"event",unique:!1}),n.addIndex({property:"resource",unique:!1}))}removeTemporaryIndices(){const{storage:n}=this.assignmentStore;n.removeIndex("event"),n.removeIndex("resource")}async internalDelayCalculation(n){const r=this;if(r.delayEnteringReplica=!0,r.setupTemporaryIndices(),await zt(0),r.isDestroyed){n();return}if(r.trigger("delayCalculationStart"),r.trigger("refresh",{isCalculated:!1}),await zt(0),r.isDestroyed){n();return}r.delayEnteringReplica=!1,r.isRepopulatingStores?r.repopulateReplica.now():(r.trigger("recordsUnlinked"),r.enterReplica(!0));const a=await r.replica.commitAsync();if(r.isDestroyed){n();return}n(a),r.delayedCalculationPromise=null,r.trigger("delayCalculationEnd"),r.removeTemporaryIndices()}scheduleDelayedCalculation(){if(this.delayedCalculationPromise)return this.delayedCalculationPromise;if(this.delayCalculation!==!1)return this.delayedCalculationPromise=new Promise(n=>this.internalDelayCalculation(n).then())}async commitLoad(){const n=await this.commitAsync();return this.isDestroyed||this.trigger("load"),n}initializeStm(){const n=this.stmClass||Si;this.stm instanceof Si||this.setStm(n.new({disabled:!0},this.stm)),this.resetUndoRedoQueuesAfterLoad&&this.ion({load:this.resetStmQueue,thisObj:this}),this.ion({beforeCommit:this.onCommitInitialization,commitFinalized:this.onCommitFinalization,commitRejected:this.onCommitRejection,thisObj:this})}removeRejectedRecordsAdd({transactionResult:n,silenceCommit:r}){var a,l;const c=new Map;for(const h of n.entries.values()){var d;const f=h.identifier,{field:p}=f;if(h.isShadow()||!f[Ln]||p instanceof Je)continue;const g=f.self,m=g.firstStore;m&&!h.previous&&!((d=n.transaction.getLatestStableEntryFor(g.$$))!==null&&d!==void 0&&d.previous)&&(c.has(m)?c.get(m).has(g)||c.get(m).add(g):c.set(m,new Set([g])))}(a=this.suspendChangesTracking)===null||a===void 0||a.call(this),Array.from(c.keys()).sort((h,f)=>h.removalOrder-f.removalOrder).forEach(h=>h.remove(c.get(h))),(l=this.resumeChangesTracking)===null||l===void 0||l.call(this,r),r&&(this.eventStore.acceptChanges(),this.dependencyStore.acceptChanges(),this.resourceStore.acceptChanges(),this.assignmentStore.acceptChanges(),this.calendarManagerStore.acceptChanges())}onCommitRejection(n){this._stmDisabled?(this.replica.isWritingPreviousData=!0,this.isRestoringData=!0,this.removeRejectedRecordsAdd(n),this.isRestoringData=!1,this.replica.isWritingPreviousData=!1):this.rejectStmTransaction()}onCommitInitialization(){const{stm:n}=this;this._stmDisabled=n.disabled,n.isRecording&&n.autoRecord&&(this._stmAutoRecord=!0,n.autoRecord=!1)}onCommitFinalization(){this._stmAutoRecord&&(this.stm.autoRecord=!0,this._stmAutoRecord=!1)}onSTMRestoringStart({source:n}){this.replica&&(this.replica.isWritingPreviousData=!0)}async onSTMRestoringStop({source:n}){this.replica&&(this.replica.isWritingPreviousData=!1);const r=n;r.disable(),await this.commitAsync(),this.isDestroyed||(r.enable(),this.trigger("stateRestoringDone"))}deferUntilRepopulationIfNeeded(n,r,a){this.isRepopulatingStores?(this.detachListeners(n),this.ion({name:n,repopulateReplica:{fn:async()=>{await this.commitAsync(),this.isDestroyed||r(...a)},once:!0}})):r(...a)}get isRepopulatingStores(){var n;return!!(!((n=this.repopulateStores)===null||n===void 0)&&n.size)}repopulateStore(n){const r=this;if(r.repopulateOnDataset&&n.allCount&&!n.syncDataOnLoad){var a;(a=r.replica)===null||a===void 0||a.activeTransaction.stop(),r.repopulateStores||(r.repopulateStores=new Set),r.repopulateStores.add(n),r.repopulateReplica()}}repopulateReplica(){const n=this;if(n.delayEnteringReplica)return;const{calendarManagerStore:r,eventStore:a,dependencyStore:l,assignmentStore:c,resourceStore:d,replica:u}=n;u?(n.unlinkStoreRecords(r,a,l,d,c),n.unlinkRecord(n),n.unlinkRecord(n.defaultCalendar),n.trigger("recordsUnlinked"),u.clear()):n.trigger("recordsUnlinked");const h=n.replica=n.createReplica();h.addEntity(n),h.addEntity(n.defaultCalendar),n.joinStoreRecords(r,!0),n.joinStoreRecords(a,!0),n.joinStoreRecords(l,!0),n.joinStoreRecords(d,!0),n.joinStoreRecords(c,!0),n.repopulateStores.clear(),n.trigger("repopulateReplica")}beforeCommitAsync(){return this.repopulateReplica.isPending&&!this.isDelayingCalculation?(this.repopulateReplica.now(),this.replica.commitAsync()):null}unlinkRecord(n){var a;if(n!=null&&n.graph){const{activeTransaction:l}=this.replica,{$:c}=n,d=Object.keys(c);for(let u=0;u<d.length;u++){const h=d[u],f=c[h],p=l.getLatestEntryFor(f);if(p){let g=p.getValue();if(g===void 0&&(g=p.proposedValue),g!==void 0){var r;f.DATA=f.field instanceof Xe&&(a=(r=g)===null||r===void 0?void 0:r.id)!=null?a:g}}}n.graph=null}}unlinkStoreRecords(...n){n.forEach(r=>{(!this.repopulateStores.has(r)||r.syncDataOnLoad)&&r.traverse(a=>{this.unlinkRecord(a)},!1,!1,{includeFilteredOutRecords:!0,includeCollapsedGroupRecords:!0})})}getGraph(){return this.replica}async addEvents(n){return this.eventStore.add(n),this.commitAsync()}async addEvent(n){return this.eventStore.add(n),this.commitAsync()}includeEvent(n){this.eventStore.add(n)}async removeEvents(n){return this.eventStore.remove(n),this.commitAsync()}excludeEvent(n){this.eventStore.remove(n)}async removeEvent(n){return this.eventStore.remove(n),this.commitAsync()}getStm(){return this.stm}setStm(n){this.stm=n,this.stm.ion({restoringStart:this.onSTMRestoringStart,restoringStop:this.onSTMRestoringStop,thisObj:this})}calculateProject(){return this}*calculateEffectiveCalendar(){let n=yield this.$.calendar;return n?yield n.$.version:n=this.defaultCalendar,n}joinStoreRecords(n,r=!1){const a=l=>{l.setProject(this),l.joinProject()};n.rootNode?n.rootNode.traverse(a,r,!0):n.forEach(a,null,{includeFilteredOutRecords:!0,includeCollapsedGroupRecords:!0})}unjoinStoreRecords(n){const r=a=>{a.leaveProject(),a.setProject(this)};n.rootNode?n.rootNode.traverse(a=>{a!==n.rootNode&&r(a)},!1,!0):n.forEach(r,null,{includeFilteredOutRecords:!0,includeCollapsedGroupRecords:!0})}setEventStore(n){const r=this.eventStore;if(r&&this.stm.hasStore(r)){this.stm.removeStore(r),this.unjoinStoreRecords(r),this.detachStore(r);const a=r.assignmentsForRemoval;a.forEach(l=>{const c=l.event;if(c){const d=n.getById(c.id);d&&(l.event=d,a.delete(l))}}),r.afterEventRemoval()}if(!n||!(n instanceof xe)){const a=(n==null?void 0:n.storeClass)||this.eventStoreClass;this.eventStore=new a(K.assign({modelClass:this.eventModelClass,project:this,stm:this.stm},n||{}))}else this.eventStore=n,n.setProject(this),this.stm.addStore(n),n.tree&&n.rootNode!==this?(this.appendChild(n.rootNode.children||[]),n.rootNode=this):this.joinStoreRecords(n);this.attachStore(this.eventStore),this.trigger("eventStoreChange",{store:this.eventStore})}setDependencyStore(n){const r=this.dependencyStore;if(r&&this.stm.hasStore(r)&&(this.stm.removeStore(r),this.detachStore(r)),!n||!(n instanceof xe)){const a=(n==null?void 0:n.storeClass)||this.dependencyStoreClass;this.dependencyStore=new a(K.assign({modelClass:this.dependencyModelClass,project:this,stm:this.stm},n||{}))}else this.dependencyStore=n,n.setProject(this),this.stm.addStore(n),this.joinStoreRecords(n);this.attachStore(this.dependencyStore),this.trigger("dependencyStoreChange",{store:this.dependencyStore})}setResourceStore(n){const r=this.resourceStore;if(r&&this.stm.hasStore(r)){this.stm.removeStore(r),this.unjoinStoreRecords(r),this.detachStore(r);const a=r.assignmentsForRemoval;a.forEach(l=>{const c=l.resource;if(c){const d=n.getById(c.id);d&&(l.resource=d,a.delete(l))}}),r.afterResourceRemoval()}if(!n||!(n instanceof xe)){const a=(n==null?void 0:n.storeClass)||this.resourceStoreClass;this.resourceStore=new a(K.assign({modelClass:this.resourceModelClass,project:this,stm:this.stm},n||{}))}else this.resourceStore=n,n.setProject(this),this.stm.addStore(n),this.joinStoreRecords(n);this.attachStore(this.resourceStore),this.trigger("resourceStoreChange",{store:this.resourceStore})}setAssignmentStore(n){const r=this.assignmentStore;if(r&&this.stm.hasStore(r)&&(this.stm.removeStore(r),this.unjoinStoreRecords(r),this.detachStore(r)),!n||!(n instanceof xe)){const a=(n==null?void 0:n.storeClass)||this.assignmentStoreClass;this.assignmentStore=new a(K.assign({modelClass:this.assignmentModelClass,project:this,stm:this.stm},n||{}))}else this.assignmentStore=n,n.setProject(this),this.stm.addStore(n),this.joinStoreRecords(n);this.isDelayingCalculation&&this.setupTemporaryIndices(),this.attachStore(this.assignmentStore),this.trigger("assignmentStoreChange",{store:this.assignmentStore})}setCalendarManagerStore(n){const r=this.calendarManagerStore;if(r&&this.stm.hasStore(r)&&(this.stm.removeStore(r),this.detachStore(r)),!n||!(n instanceof xe)){const a=(n==null?void 0:n.storeClass)||this.calendarManagerStoreClass;this.calendarManagerStore=new a(K.assign({modelClass:this.calendarModelClass,project:this,stm:this.stm},n||{}))}else this.calendarManagerStore=n,n&&(n.setProject(this),this.stm.addStore(n),this.joinStoreRecords(n));this.attachStore(this.calendarManagerStore),this.trigger("calendarManagerStoreChange",{store:this.calendarManagerStore})}async isValidDependency(...n){return!0}rejectStmTransaction(n){n=n||this.stm,n.transaction&&(n.transaction.length?(n.forEachStore(r=>r.beginBatch()),n.rejectTransaction(),n.forEachStore(r=>r.endBatch())):n.stopTransaction())}async tryPropagateWithChanges(n){const r=this.stm,a=r.disabled,l=r.autoRecord;a?r.enable():(l&&(r.autoRecord=!1),r.isRecording&&r.stopTransaction()),r.startTransaction(),n();let c=!0;try{c=!(await this.commitAsync()).rejectedWith}catch(d){if(!/cycle/i.test(d))throw d;c=!1}return c?(r.stopTransaction(),a&&r.resetQueue()):(this.replica.reject(),this.rejectStmTransaction(r)),r.disabled=a,r.autoRecord=l,c}isEngineReady(){const{replica:n}=this;return this.delayEnteringReplica||!this.isRepopulatingStores&&(n?!(n.dirty&&(n.hasPendingAutoCommit()||n.isCommitting)):!0)}static get defaultConfig(){return{assignmentsData:null,calendarsData:null,dependenciesData:null,eventsData:null,resourcesData:null,eventStore:null,resourceStore:null,assignmentStore:null,dependencyStore:null,calendarManagerStore:null,eventModelClass:null,resourceModelClass:null,assignmentModelClass:null,dependencyModelClass:null,calendarModelClass:null,repopulateOnDataset:!0}}static get delayable(){return{repopulateReplica:10}}}return i.applyConfigs=!0,bs([S({type:"boolean",defaultValue:!0})],i.prototype,"unspecifiedTimeIsWorking",void 0),bs([S({type:"boolean",defaultValue:!1})],i.prototype,"skipNonWorkingTimeWhenSchedulingManually",void 0),bs([S({type:"boolean",defaultValue:!0})],i.prototype,"skipNonWorkingTimeInDurationWhenSchedulingManually",void 0),i}){}var _=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const _a=function*(o,e,t,i,s){if(t.isIntervalEmpty())return t;if(s&&t.intersectionOf){const a=new Set;for(const l of t.intersectionOf)if(l.isInfinite())a.add(l);else{const c=l.startDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(l.startDate,!1,i):l.startDate,d=l.endDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(l.endDate,!1,i):l.endDate,u=l;a.add(u.copyWith({reflectionOf:u,side:u.side===ce.Start?ce.End:ce.Start,startDate:c,endDate:d}))}t.intersectionOf=a}const n=t.startDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(t.startDate,!1,i):null,r=t.endDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(t.endDate,!1,i):null;return Le([e,Rt.new({intersectionOf:t.intersectionOf,startDate:n,endDate:r})],s)},La=function*(o,e,t,i,s){if(e.isIntervalEmpty())return e;if(s){const a=new Set;for(const l of e.intersectionOf)if(l.isInfinite())a.add(l);else{const c=l.startDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(l.startDate,!0,i):l.startDate,d=l.endDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(l.endDate,!0,i):l.endDate,u=l;a.add(u.copyWith({reflectionOf:u,side:u.side===ce.Start?ce.End:ce.Start,startDate:c,endDate:d}))}e.intersectionOf=a}const n=e.startDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(e.startDate,!0,i):null,r=e.endDateIsFinite()?yield*o.calculateProjectedXDateWithDuration(e.endDate,!0,i):null;return Le([t,Rt.new({reflectionOf:n||r?e:void 0,intersectionOf:n||r?e.intersectionOf:void 0,startDate:n,endDate:r})],s)},Fe=!0;class an extends y([Jn],e=>{const t=e.prototype;class i extends e{*maybeSkipNonWorkingTime(n,r=!0){if(yield*this.hasSubEvents())return n;let a=yield*this.calculateEffectiveDuration();return n&&a>0?yield*this.skipNonWorkingTime(n,r):n}*calculateEffectiveConstraintInterval(n,r,a,l=!1){const c=yield*this.calculateEffectiveDuration();return c==null?null:yield*(n?_a:La)(this,Le(r,l),Le(a,l),c,l)}*calculateStartDateConstraintIntervals(){return[]}*calculateEndDateConstraintIntervals(){return[]}*calculateEarlyStartDateConstraintIntervals(){return[]}*calculateEarlyEndDateConstraintIntervals(){return[]}*doCalculateEarlyEffectiveStartDateInterval(n=!1){const r=yield this.$.earlyStartDateConstraintIntervals,a=yield this.$.earlyEndDateConstraintIntervals;return yield*this.calculateEffectiveConstraintInterval(!0,r.concat(yield this.$.startDateConstraintIntervals),a.concat(yield this.$.endDateConstraintIntervals),n)}*calculateEarlyEffectiveStartDateInterval(){return yield*this.doCalculateEarlyEffectiveStartDateInterval()}*doCalculateEarlyEffectiveEndDateInterval(n=!1){const r=yield this.$.earlyStartDateConstraintIntervals,a=yield this.$.earlyEndDateConstraintIntervals;return yield*this.calculateEffectiveConstraintInterval(!1,r.concat(yield this.$.startDateConstraintIntervals),a.concat(yield this.$.endDateConstraintIntervals),n)}*calculateEarlyEffectiveEndDateInterval(){return yield*this.doCalculateEarlyEffectiveEndDateInterval()}*shouldRollupChildEarlyStartDate(n){return!0}*calculateMinChildrenEarlyStartDate(){let n=le;const r=yield*this.subEventsIterable();for(let a of r){let l;(yield*this.shouldRollupChildEarlyStartDate(a))&&((yield a.$.manuallyScheduled)&&(yield*a.hasSubEvents())&&(l=yield a.$.minChildrenEarlyStartDate),l=l||(yield a.$.earlyStartDate),l&&l<n&&(n=l))}return n.getTime()-le.getTime()?n:null}*shouldRollupChildEarlyEndDate(n){return!0}*calculateMaxChildrenEarlyEndDate(){let n=ve;const r=yield*this.subEventsIterable();for(let a of r){let l;(yield*this.shouldRollupChildEarlyEndDate(a))&&((yield a.$.manuallyScheduled)&&(yield*a.hasSubEvents())&&(l=yield a.$.maxChildrenEarlyEndDate),l=l||(yield a.$.earlyEndDate),l&&l>n&&(n=l))}return n.getTime()-ve.getTime()?n:null}*calculateEarlyStartDateRaw(){if((yield this.$.manuallyScheduled)&&(yield this.$.direction)===G.Forward)return yield this.$.startDate;if(yield*this.hasSubEvents())return yield this.$.minChildrenEarlyStartDate;if(!(yield*this.isConstrainedEarly()))return yield this.$.startDate;let n=yield this.$.earlyEffectiveStartDateInterval;if(n===null)return null;if(n.isIntervalEmpty()){n=yield*this.doCalculateEarlyEffectiveStartDateInterval(!0);const r=Pt.new({intervals:[...n.intersectionOf]});if((yield r)===me.Cancel)yield He(r);else return null}return ct(n.startDate)?n.startDate:null}*calculateEarlyStartDate(){const n=yield this.$.earlyStartDateRaw;return yield*this.maybeSkipNonWorkingTime(n,!0)}*calculateEarlyEndDateRaw(){if((yield this.$.manuallyScheduled)&&(yield this.$.direction)===G.Forward)return yield this.$.endDate;if(yield*this.hasSubEvents())return yield this.$.maxChildrenEarlyEndDate;if(!(yield*this.isConstrainedEarly()))return yield this.$.endDate;let n=yield this.$.earlyEffectiveEndDateInterval;if(n===null)return null;if(n.isIntervalEmpty()){n=yield*this.doCalculateEarlyEffectiveEndDateInterval(!0);const r=Pt.new({intervals:[...n.intersectionOf]});if((yield r)===me.Cancel)yield He(r);else return null}return ct(n.startDate)?n.startDate:null}*calculateEarlyEndDate(){return yield this.$.earlyEndDateRaw}*isConstrainedEarly(){const n=yield this.$.startDateConstraintIntervals,r=yield this.$.endDateConstraintIntervals,a=yield this.$.earlyStartDateConstraintIntervals,l=yield this.$.earlyEndDateConstraintIntervals;return!!(n!=null&&n.length||r!=null&&r.length||a!=null&&a.length||l!=null&&l.length)}*calculateStartDatePure(){return(yield this.$.direction)===G.Forward?!(yield*this.isConstrainedEarly())||(yield this.$.manuallyScheduled)||(yield this.$.unscheduled)?yield*t.calculateStartDatePure.call(this):(yield this.$.earlyStartDate)||(yield*t.calculateStartDatePure.call(this)):yield*t.calculateStartDatePure.call(this)}*calculateStartDateProposed(){switch(yield this.$.direction){case G.Forward:if(!(yield*this.isConstrainedEarly())||(yield this.$.manuallyScheduled)||(yield this.$.unscheduled))return yield*t.calculateStartDateProposed.call(this);const r=yield this.$.earlyStartDate;if(r){if(ct(r))return r;const a=yield*t.calculateStartDateProposed.call(this),l=yield this.$.earlyEffectiveStartDateInterval;return l.containsDate(a)?a:ct(l.endDate)?l.endDate:a}else return yield*t.calculateStartDateProposed.call(this);default:return yield*t.calculateStartDateProposed.call(this)}}*calculateEndDatePure(){return(yield this.$.direction)===G.Forward?!(yield*this.isConstrainedEarly())||(yield this.$.manuallyScheduled)||(yield this.$.unscheduled)?yield*t.calculateEndDatePure.call(this):(yield this.$.earlyEndDate)||(yield*t.calculateEndDatePure.call(this)):yield*t.calculateEndDatePure.call(this)}*calculateEndDateProposed(){switch(yield this.$.direction){case G.Forward:if(!(yield*this.isConstrainedEarly())||(yield this.$.manuallyScheduled)||(yield this.$.unscheduled))return yield*t.calculateEndDateProposed.call(this);const r=yield this.$.earlyEndDate;if(r){if(ct(r))return r;const a=yield*t.calculateEndDateProposed.call(this),l=yield this.$.earlyEffectiveEndDateInterval;return l.containsDate(a)?a:ct(l.endDate)?l.endDate:a}else return yield*t.calculateEndDateProposed.call(this);default:return yield*t.calculateEndDateProposed.call(this)}}*calculateDirection(){return yield this.getProject().$.direction}}return _([M({lazy:Fe})],i.prototype,"minChildrenEarlyStartDate",void 0),_([M({lazy:Fe})],i.prototype,"earlyStartDateRaw",void 0),_([S({type:"date",persist:!1},{lazy:Fe,converter:Ze,persistent:!1})],i.prototype,"earlyStartDate",void 0),_([M({lazy:Fe})],i.prototype,"maxChildrenEarlyEndDate",void 0),_([M({lazy:Fe})],i.prototype,"earlyEndDateRaw",void 0),_([S({type:"date",persist:!1},{lazy:Fe,converter:Ze,persistent:!1})],i.prototype,"earlyEndDate",void 0),_([M()],i.prototype,"startDateConstraintIntervals",void 0),_([M()],i.prototype,"endDateConstraintIntervals",void 0),_([M({lazy:Fe})],i.prototype,"earlyStartDateConstraintIntervals",void 0),_([M({lazy:Fe})],i.prototype,"earlyEndDateConstraintIntervals",void 0),_([M()],i.prototype,"earlyEffectiveStartDateInterval",void 0),_([M()],i.prototype,"earlyEffectiveEndDateInterval",void 0),_([D("startDateConstraintIntervals")],i.prototype,"calculateStartDateConstraintIntervals",null),_([D("endDateConstraintIntervals")],i.prototype,"calculateEndDateConstraintIntervals",null),_([D("earlyStartDateConstraintIntervals")],i.prototype,"calculateEarlyStartDateConstraintIntervals",null),_([D("earlyEndDateConstraintIntervals")],i.prototype,"calculateEarlyEndDateConstraintIntervals",null),_([D("earlyEffectiveStartDateInterval")],i.prototype,"calculateEarlyEffectiveStartDateInterval",null),_([D("earlyEffectiveEndDateInterval")],i.prototype,"calculateEarlyEffectiveEndDateInterval",null),_([D("minChildrenEarlyStartDate")],i.prototype,"calculateMinChildrenEarlyStartDate",null),_([D("maxChildrenEarlyEndDate")],i.prototype,"calculateMaxChildrenEarlyEndDate",null),_([D("earlyStartDateRaw")],i.prototype,"calculateEarlyStartDateRaw",null),_([D("earlyStartDate")],i.prototype,"calculateEarlyStartDate",null),_([D("earlyEndDateRaw")],i.prototype,"calculateEarlyEndDateRaw",null),_([D("earlyEndDate")],i.prototype,"calculateEarlyEndDate",null),_([D("direction")],i.prototype,"calculateDirection",null),i}){}var It=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Va extends y([an,rn],e=>{const t=e.prototype;class i extends e{constructor(){super(...arguments),this.ignorePinningConstraint=!1}writeStartDate(n,r,a,l,c=!0){const d=this.getProject();if(d!=null&&d.addConstraintOnDateSet&&r.graph.hasIdentifier(this.$.direction)&&!(d!=null&&d.eventStore.isSyncingDataOnLoad)&&!this.isReverting&&!(d!=null&&d.getStm().isRestoring)){const u=this.getStartDatePinConstraintType();u&&(this.constraintType=u,this.constraintDate=l)}return t.writeStartDate.call(this,n,r,a,l,c)}writeEndDate(n,r,a,l,c=!1){const d=this.getProject();if(d!=null&&d.addConstraintOnDateSet&&r.graph.hasIdentifier(this.$.direction)&&c&&!(d!=null&&d.eventStore.isSyncingDataOnLoad)&&!(d!=null&&d.getStm().isRestoring)){const u=this.getEndDatePinConstraintType();u&&(this.constraintType=u,this.constraintDate=l)}return t.writeEndDate.call(this,n,r,a,l,c)}*calculateConstraintType(){let n=yield A;return(yield*this.isConstraintTypeApplicable(n))||(n=null),n}*calculateConstraintDate(n){let r=yield A;const a=yield this.$.constraintType;return a?r||(r=this.getConstraintTypeDefaultDate(n,a)):r=null,r}getStartDatePinConstraintType(){const{direction:n}=this;if(!this.isTaskPinnableWithConstraint())return null;switch(n){case G.Forward:return j.StartNoEarlierThan;case G.Backward:return j.StartNoLaterThan}}getEndDatePinConstraintType(){const{direction:n}=this;if(!this.isTaskPinnableWithConstraint())return null;switch(n){case G.Forward:return j.FinishNoEarlierThan;case G.Backward:return j.FinishNoLaterThan}}isTaskPinnableWithConstraint(){const{manuallyScheduled:n,ignorePinningConstraint:r,constraintType:a}=this;let l=!1;if(!n&&!r)if(a)switch(a){case j.StartNoEarlierThan:case j.StartNoLaterThan:case j.FinishNoEarlierThan:case j.FinishNoLaterThan:l=!0}else l=!0;return l}applyChangeset(n,r,a){this.ignorePinningConstraint=a;const l=super.applyChangeset(n,r,a);return this.ignorePinningConstraint=!1,l}getConstraintTypeDefaultDate(n,r){switch(r){case j.StartNoEarlierThan:case j.StartNoLaterThan:case j.MustStartOn:return n(V(this.$.startDate));case j.FinishNoEarlierThan:case j.FinishNoLaterThan:case j.MustFinishOn:return n(V(this.$.endDate))}return null}*isConstraintTypeApplicable(n){const r=yield*this.hasSubEvents();switch(n){case j.FinishNoEarlierThan:case j.StartNoLaterThan:case j.MustFinishOn:case j.MustStartOn:return!r}return!0}async setConstraint(n,r){return this.constraintType=n,r!==void 0&&(this.constraintDate=r),this.commitAsync()}*calculateEndDateConstraintIntervals(){const n=yield*t.calculateEndDateConstraintIntervals.call(this),r=yield this.$.manuallyScheduled,a=yield this.$.constraintType,l=yield this.$.constraintDate,c=this.project.dateConstraintIntervalClass;if(!r&&a&&l)switch(a){case j.MustFinishOn:n.unshift(c.new({owner:this,side:ce.End,startDate:l,endDate:l}));break;case j.FinishNoEarlierThan:n.unshift(c.new({owner:this,side:ce.End,startDate:l}));break;case j.FinishNoLaterThan:n.unshift(c.new({owner:this,side:ce.End,endDate:l}));break}return n}*calculateStartDateConstraintIntervals(){const n=yield*t.calculateStartDateConstraintIntervals.call(this),r=yield this.$.manuallyScheduled,a=yield this.$.constraintType,l=yield this.$.constraintDate,c=this.project.dateConstraintIntervalClass;if(!r&&a&&l)switch(a){case j.MustStartOn:n.unshift(c.new({owner:this,side:ce.Start,startDate:l,endDate:l}));break;case j.StartNoEarlierThan:n.unshift(c.new({owner:this,side:ce.Start,startDate:l}));break;case j.StartNoLaterThan:n.unshift(c.new({owner:this,side:ce.Start,endDate:l}));break}return n}}return It([S({type:"string"},{sync:!0})],i.prototype,"constraintType",void 0),It([S({type:"date"},{converter:Ze,sync:!0})],i.prototype,"constraintDate",void 0),It([D("constraintType")],i.prototype,"calculateConstraintType",null),It([D("constraintDate")],i.prototype,"calculateConstraintDate",null),i}){}class Na extends pe(as){static get $name(){return"RemoveDateConstraintConflictResolution"}construct(){super.construct(...arguments),this.event=this.interval.owner}getDescription(){const{event:e}=this;return Be(this.L("L{descriptionTpl}"),e.name||e.id,this.interval.getConstraintName(e.constraintType))}resolve(){this.event.constraintType=null}}class Wa extends Gn{static get $name(){return"DateConstraintIntervalDescription"}static getDescription(e){let t;switch(e.owner.constraintType){case j.StartNoEarlierThan:case j.FinishNoEarlierThan:case j.MustStartOn:case j.MustFinishOn:t=this.L("L{startDateDescriptionTpl}");break;case j.StartNoLaterThan:case j.FinishNoLaterThan:t=this.L("L{endDateDescriptionTpl}");break}return Be(t,...this.getDescriptionParameters(e))}static getConstraintName(e){return this.L("L{constraintTypeTpl}")[e]}static getDescriptionParameters(e){const t=e.owner;return[I.format(e.startDate,this.L("L{dateFormat}")),I.format(e.endDate,this.L("L{dateFormat}")),t.name||t.id,this.getConstraintName(t.constraintType)]}}class Zn extends Rt{getConstraintName(e){return this.descriptionBuilderClass.getConstraintName(e||this.owner.constraintType)}getDescription(){return this.descriptionBuilderClass.getDescription(this)}isAffectedByTransaction(e){const t=this.owner;e=e||t.graph.activeTransaction;const i=e.entries.get(t.$.constraintDate),s=e.entries.get(t.$.constraintType);return!e.baseRevision.hasIdentifier(t.$$)||i&&!i.isShadow()||s&&!s.isShadow()}getResolutions(){return this.resolutions||(this.resolutions=[this.removeDateConstraintConflictResolutionClass.new({interval:this})])}}It([E(Na)],Zn.prototype,"removeDateConstraintConflictResolutionClass",void 0),It([E(Wa)],Zn.prototype,"descriptionBuilderClass",void 0);var Yn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class za extends y([an,Ds],e=>{const t=e.prototype;class i extends e{*shouldPredecessorAffectScheduling(n){const r=yield n.$.fromEvent;return r&&!$n(r)&&(yield n.$.active)&&(!(yield r.$.inactive)||(yield this.$.inactive))}*calculateEarlyStartDateConstraintIntervals(){const n=yield*t.calculateEarlyStartDateConstraintIntervals.call(this),r=this.getProject(),a=r.dependencyConstraintIntervalClass;for(const l of yield this.$.incomingDeps){if(!(yield*this.shouldPredecessorAffectScheduling(l)))continue;const c=yield l.$.fromEvent;let d;switch(yield l.$.type){case _t.EndToStart:d=yield c.$.earlyEndDateRaw;break;case _t.StartToStart:d=yield c.$.earlyStartDateRaw;break}if(d){const u=yield l.$.lag,h=yield l.$.lagUnit,f=yield l.$.calendar;yield f.$.version;const p=a.new({owner:l,startDate:f.calculateEndDate(d,yield*r.$convertDuration(u,h,b.Millisecond)),endDate:null});n.unshift(p)}}return n}*calculateEarlyEndDateConstraintIntervals(){const n=yield*t.calculateEarlyEndDateConstraintIntervals.call(this),r=this.getProject(),a=r.dependencyConstraintIntervalClass;for(const l of yield this.$.incomingDeps){if(!(yield*this.shouldPredecessorAffectScheduling(l)))continue;const c=yield l.$.fromEvent;let d;switch(yield l.$.type){case _t.EndToEnd:d=yield c.$.earlyEndDateRaw;break;case _t.StartToEnd:d=yield c.$.earlyStartDateRaw;break}if(d){const u=yield l.$.lag,h=yield l.$.lagUnit,f=yield l.$.calendar;yield f.$.version;const p=a.new({owner:l,startDate:f.calculateEndDate(d,yield*r.$convertDuration(u,h,b.Millisecond)),endDate:null});n.unshift(p)}}return n}}return Yn([S({type:"boolean"})],i.prototype,"inactive",void 0),i}){}class ws extends pe(as){static get $name(){return"BaseDependencyResolution"}getDescription(){const{dependency:e}=this,{type:t,fromEvent:i,toEvent:s}=e;return Be(this.L("L{descriptionTpl}"),this.L("L{DependencyType.long}")[t],i.name||i.id,s.name||s.id)}}class Ps extends ws{static get $name(){return"RemoveDependencyResolution"}resolve(){this.dependency.remove()}}class Rs extends ws{static get $name(){return"DeactivateDependencyResolution"}resolve(){this.dependency.active=!1}}class Ga extends Gn{static get $name(){return"DependencyConstraintIntervalDescription"}static getDescriptionParameters(e){const t=e.owner;return[I.format(e.startDate,this.L("L{dateFormat}")),I.format(e.endDate,this.L("L{dateFormat}")),this.L("L{DependencyType.long}")[t.type],t.fromEvent.name,t.toEvent.name]}}class on extends Rt{isAffectedByTransaction(e){const t=this.owner;e=e||t.graph.activeTransaction;const{entries:i}=e,{fromEvent:s,toEvent:n,lag:r,lagUnit:a,type:l}=t.$,c=i.get(s),d=i.get(n),u=i.get(r),h=i.get(a),f=i.get(l);return!e.baseRevision.hasIdentifier(t.$$)||c&&!c.isShadow()||d&&!d.isShadow()||u&&!u.isShadow()||h&&!h.isShadow()||f&&!f.isShadow()}getResolutions(){return this.resolutions||(this.resolutions=[this.deactivateDependencyConflictResolutionClass.new({dependency:this.owner}),this.removeDependencyConflictResolutionClass.new({dependency:this.owner})])}}Yn([E(Ps)],on.prototype,"removeDependencyConflictResolutionClass",void 0),Yn([E(Rs)],on.prototype,"deactivateDependencyConflictResolutionClass",void 0),Yn([E(Ga)],on.prototype,"descriptionBuilderClass",void 0);var Ne=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Ts extends y([Un],e=>{e.prototype;class t extends e{*calculateUnits(){const s=yield this.$.event;return s?yield*s.calculateAssignmentUnits(this):yield A}*calculateEffort(){const s=yield this.$.event;if(s){const n=yield s.$.startDate,r=yield s.$.endDate,a=yield s.$.effectiveCalendar;if(n&&r){const l=new Map;return l.set(a,[this]),yield*s.calculateProjectedEffort(n,r,l)}}return null}*calculateActualDate(){const s=yield this.$.event;if(s){const n=yield s.$.startDate,r=yield s.$.duration,a=yield s.$.percentDone;return yield*s.calculateProjectedXDateWithDuration(n,!0,r*.01*a)}return null}*calculateActualEffort(){const s=yield this.$.event;if(s){const n=yield s.$.startDate,r=yield s.$.effectiveCalendar,a=yield this.$.actualDate,l=new Map;return l.set(r,[this]),yield*s.calculateProjectedEffort(n,a,l)}return null}}return Ne([S({type:"number",defaultValue:100})],t.prototype,"units",void 0),Ne([D("units")],t.prototype,"calculateUnits",null),Ne([M({lazy:!0})],t.prototype,"effort",void 0),Ne([M({lazy:!0})],t.prototype,"actualDate",void 0),Ne([M({lazy:!0})],t.prototype,"actualEffort",void 0),Ne([D("effort")],t.prototype,"calculateEffort",null),Ne([D("actualDate")],t.prototype,"calculateActualDate",null),Ne([D("actualEffort")],t.prototype,"calculateActualEffort",null),t}){}var Mt=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class $s extends y([Es],e=>{e.prototype;class t extends e{*calculateCalendar(){const s=this.getProject(),n=yield s.$.dependenciesCalendar;let r;switch(n){case wn.Project:r=yield s.$.effectiveCalendar;break;case wn.FromEvent:const a=yield this.$.fromEvent;r=a&&!$n(a)?yield a.$.effectiveCalendar:null;break;case wn.ToEvent:const l=yield this.$.toEvent;r=l&&!$n(l)?yield l.$.effectiveCalendar:null;break}return r||(r=yield s.$.effectiveCalendar),r}async setLag(s,n){if(this.graph)return this.graph.write(this.$.lag,s,n),this.graph.commitAsync();this.$.lag.DATA=s,n!=null&&(this.$.lagUnit.DATA=n)}writeLag(s,n,r,a,l=void 0){s.constructor.prototype.write.call(this,s,n,r,a),l!=null&&n.write(this.$.lagUnit,l)}}return Mt([S({type:"number",defaultValue:0})],t.prototype,"lag",void 0),Mt([S({type:"string",defaultValue:b.Day},{converter:I.normalizeUnit})],t.prototype,"lagUnit",void 0),Mt([M()],t.prototype,"calendar",void 0),Mt([S({type:"boolean",defaultValue:!0,persist:!0})],t.prototype,"active",void 0),Mt([D("calendar")],t.prototype,"calculateCalendar",null),Mt([Ae("lag")],t.prototype,"writeLag",null),t}){}var ei=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Is extends y([rn],e=>{e.prototype;class t extends e{*calculatePercentDone(){const s=yield this.$.childEvents,r=yield this.getProject().$.autoCalculatePercentDoneForParentTasks;if(s.size&&r){const a=yield this.$.percentDoneSummaryData;return a.totalDuration>0?a.completedDuration/a.totalDuration:a.milestonesNum>0?a.milestonesTotalPercentDone/a.milestonesNum:null}else return yield A}*shouldRollupChildPercentDoneSummaryData(s){return!0}*calculatePercentDoneSummaryData(){const s=yield this.$.childEvents;if(s.size){let n={totalDuration:0,completedDuration:0,milestonesNum:0,milestonesTotalPercentDone:0};for(const r of s){if(!(yield*this.shouldRollupChildPercentDoneSummaryData(r)))continue;const a=yield r.$.percentDoneSummaryData;a&&(n.totalDuration+=a.totalDuration,n.completedDuration+=a.completedDuration,n.milestonesNum+=a.milestonesNum,n.milestonesTotalPercentDone+=a.milestonesTotalPercentDone)}return n}else{const n=yield this.$.duration;if(typeof n=="number"){const r=yield*this.getProject().$convertDuration(n,yield this.$.durationUnit,b.Millisecond),a=yield this.$.percentDone;return{totalDuration:r,completedDuration:r*a,milestonesNum:r===0?1:0,milestonesTotalPercentDone:r===0?a:0}}else return null}}}return ei([S({type:"number",defaultValue:0})],t.prototype,"percentDone",void 0),ei([M()],t.prototype,"percentDoneSummaryData",void 0),ei([D("percentDone")],t.prototype,"calculatePercentDone",null),ei([D("percentDoneSummaryData")],t.prototype,"calculatePercentDoneSummaryData",null),t}){}var ln=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class ti extends y([Cs],e=>{const t=e.prototype;class i extends e{*hasProposedValueForUnits(){const n=yield this.$.assigned;for(const r of n)if((yield r.$.resource)&&(yield we(r.$.units)))return!0;return!1}async assign(n,r=100){const a=this.getProject().assignmentStore.modelClass;return this.addAssignment(new a({event:this,resource:n,units:r})),this.commitAsync()}*forEachAvailabilityInterval(n,r){const a=yield this.$.effectiveCalendar,l=yield this.$.assignmentsByCalendar,c=yield this.$.effectiveCalendarsCombination,d=(yield this.$.ignoreResourceCalendar)||n.ignoreResourceCalendar||!l.size,u=this.getProject().maxCalendarRange;return u&&(n=Object.assign({maxRange:u},n)),c.forEachAvailabilityInterval(n,(h,f,p)=>{const g=p.getCalendarsWorkStatus(),m=p.getCalendarsWorking();if(g.get(a)&&(d||m.some(v=>l.has(v))))return r(h,f,p)})}*calculateEffectiveCalendarsCombination(){const n=yield this.$.manuallyScheduled,r=this.getProject(),a=[yield this.$.effectiveCalendar];if(!n||r.skipNonWorkingTimeInDurationWhenSchedulingManually){const l=yield this.$.assignmentsByCalendar;a.push(...l.keys())}return this.getProject().combineCalendars(a)}*calculateAssignmentsByCalendar(){const n=yield this.$.assigned,r=new Map;for(const a of n){const l=yield a.$.resource;if(l){const c=yield l.$.effectiveCalendar;let d=r.get(c);d||(d=[],r.set(c,d)),d.push(a)}}return r}*getBaseOptionsForDurationCalculations(){return{ignoreResourceCalendar:!1}}*useEventAvailabilityIterator(){return(yield this.$.assignmentsByCalendar).size>0}*skipNonWorkingTime(n,r=!0,a){if(!n)return null;const l=yield this.$.assignmentsByCalendar,c=yield this.$.ignoreResourceCalendar;if(yield*this.useEventAvailabilityIterator()){const d=Object.assign(yield*this.getBaseOptionsForDurationCalculations(),r?{startDate:n,isForward:r}:{endDate:n,isForward:r},a);let u;const h=yield*this.forEachAvailabilityInterval(d,(f,p,g)=>(u=r?f:p,!1));if(h===Ci.MaxRangeReached||h===Ci.FullRangeIterated){const f=[yield this.$.effectiveCalendar];!d.ignoreResourceCalendar&&!c&&f.push(...l.keys());const p=tn.new({event:this,calendars:f,date:n,isForward:r});if((yield p)===me.Cancel)yield He(p);else return null}return new Date(u)}else return yield*t.skipNonWorkingTime.call(this,n,r)}*calculateProjectedDuration(n,r,a,l){if(!n||!r)return null;if(yield*this.useEventAvailabilityIterator()){const c=Object.assign(yield*this.getBaseOptionsForDurationCalculations(),{startDate:n,endDate:r,isForward:!0},l),d=this.getProject().adjustDurationToDST;let u=0;return yield*this.forEachAvailabilityInterval(c,(h,f)=>{if(u+=f.getTime()-h.getTime(),d){const p=h.getTimezoneOffset()-f.getTimezoneOffset();u+=p*60*1e3}}),a||(a=yield this.$.durationUnit),yield*this.getProject().$convertDuration(u,b.Millisecond,a)}else return yield*t.calculateProjectedDuration.call(this,n,r,a)}*calculateProjectedXDateWithDuration(n,r=!0,a,l,c){if(a==null||isNaN(a)||n==null)return null;if(a==0)return n;l=l||(yield this.$.durationUnit);const d=yield*this.getProject().$convertDuration(a,l,b.Millisecond);let u=n.getTime(),h=d;const f=yield this.$.effectiveCalendar;if(yield*this.useEventAvailabilityIterator()){const p=Object.assign(yield*this.getBaseOptionsForDurationCalculations(),r?{startDate:n,isForward:r}:{endDate:n,isForward:r},c),g=this.getProject().adjustDurationToDST;return(yield*this.forEachAvailabilityInterval(p,(v,C,z)=>{const T=v.getTime(),$=C.getTime(),F=$-T;if(F>=h){if(g){const w=r?v.getTimezoneOffset()-new Date(T+h).getTimezoneOffset():new Date($-h).getTimezoneOffset()-C.getTimezoneOffset();h-=w*60*1e3}return u=r?T+h:$-h,!1}else if(h-=F,g){const w=v.getTimezoneOffset()-C.getTimezoneOffset();h-=w*60*1e3}}))===Ci.StoppedByIterator?new Date(u):null}else return f.accumulateWorkingTime(n,d,r).finalDate}}return ln([M()],i.prototype,"effectiveCalendarsCombination",void 0),ln([M()],i.prototype,"assignmentsByCalendar",void 0),ln([S({type:"boolean"})],i.prototype,"ignoreResourceCalendar",void 0),ln([D("effectiveCalendarsCombination")],i.prototype,"calculateEffectiveCalendarsCombination",null),ln([D("assignmentsByCalendar")],i.prototype,"calculateAssignmentsByCalendar",null),i}){}var ae=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const Me=Symbol("MasterStartDateVar"),cn=Symbol("MasterEndDateVar"),dn=Symbol("MasterDurationVar"),un=Symbol("MasterTotalDurationVar"),ie=Symbol("StartOffsetVar"),oe=Symbol("EndOffsetVar"),Ua=L.new({output:k,inputs:new Set([ie,oe])}),Ha=L.new({output:P,inputs:new Set([ie,Me])}),Ms=L.new({output:R,inputs:new Set([oe,Me])}),qa=L.new({output:ie,inputs:new Set([P,Me])}),Os=L.new({output:oe,inputs:new Set([R,Me])}),Ka=L.new({output:ie,inputs:new Set([oe,k])}),xs=L.new({output:oe,inputs:new Set([ie,k])}),Qa=L.new({output:oe,inputs:new Set([ie,un])}),Xa=L.new({output:oe,inputs:new Set([ie,dn])}),Ja=L.new({output:k,inputs:new Set([ie,cn])}),Ll=pt.new({variables:new Set([P,R,k,Me,cn,dn,un,ie,oe]),formulas:new Set([Ua,Ha,Ms,Ka,qa,xs,Qa,Xa,Os,Ja])}),Vl=Ee.new({description:Ll,defaultResolutionFormulas:new Set([Ms,Os,xs])});class Nl extends ue.mix(Re){equality(e,t){const i=e.resolution,s=t.resolution;return i.get(P)===s.get(P)&&i.get(R)===s.get(R)&&i.get(k)===s.get(k)&&i.get(Me)===s.get(Me)&&i.get(cn)===s.get(cn)&&i.get(dn)===s.get(dn)&&i.get(un)===s.get(un)&&i.get(ie)===s.get(ie)&&i.get(oe)===s.get(oe)}}class js extends y([tt],e=>{class t extends e{get isEventSegment(){return!0}get stm(){var s;return(s=this.event)===null||s===void 0?void 0:s.stm}set stm(s){}writeStartDate(s,n,r,a,l=!0){const c=this.event,d=this.getProject();if(c&&!this.previousSegment&&n.baseRevision.hasIdentifier(s)&&!(d&&d.getStm().isRestoring)?c.$.startDate.constructor.prototype.write.call(this,c.$.startDate,n,null,a,l):s.constructor.prototype.write.call(this,s,n,r,a,l),l&&this.nextSegment){const u=this.endOffset-this.nextSegment.startOffset;if(u>0){let h=this;for(;h=h.nextSegment;)h.startOffset+=u,h.endOffset+=u}}}shouldRecordFieldChange(s,n,r){return s==="startOffset"||s==="endOffset"||super.shouldRecordFieldChange(s,n,r)}*calculateStartOffset(){const n=(yield this.$.dispatcher).resolution.get(ie);if(!this.event)return yield A;let r;if(n===J)r=yield A;else if(n===Ka.formulaId)r=yield*this.calculateStartOffsetByEndOffsetAndDuration();else if(n===qa.formulaId){const a=yield V(this.event.$.startDate),l=yield V(this.$.startDate);r=yield*this.event.calculateProjectedDuration(a,l,b.Millisecond,{ignoreSegments:!0})}return r}*calculateEndOffset(){const n=(yield this.$.dispatcher).resolution.get(oe);if(!this.event)return yield A;let r;if(n===J)r=yield A;else if(n===xs.formulaId)r=yield*this.calculateEndOffsetByStartOffsetAndDuration();else if(n===Os.formulaId){const a=yield V(this.event.$.startDate),l=yield V(this.$.endDate);r=yield*this.event.calculateProjectedDuration(a,l,b.Millisecond,{ignoreSegments:!0})}else n===Xa.formulaId?r=yield*this.calculateEndOffsetByMasterDurationAndStartOffset():n===Qa.formulaId&&(r=yield*this.calculateEndOffsetByMasterTotalDurationAndStartOffset());return r}*calculateStartDate(){const n=(yield this.$.dispatcher).resolution.get(P);if(!this.event)return yield A;let r;return n===Ha.formulaId?r=yield*this.calculateStartDateByMasterStartAndStartOffset():r=yield*super.calculateStartDate(),r}*calculateEndDate(){const n=(yield this.$.dispatcher).resolution.get(R);if(!this.event)return yield A;let r;return n===Ms.formulaId?r=yield*this.calculateEndDateByMasterStartAndEndOffset():r=yield*super.calculateEndDate(),r}*calculateDuration(){const n=(yield this.$.dispatcher).resolution.get(k);if(!this.event)return yield A;let r;return n===Ua.formulaId?r=yield*this.calculateDurationByOffsets():n===Ja.formulaId?r=yield*this.calculateDurationByOffsets():r=yield*super.calculateDuration(),r}buildProposedDispatcher(s,n,r){const a=super.buildProposedDispatcher(s,n,r);return a.addPreviousValueFlag(Me),a.addPreviousValueFlag(ie),a.addPreviousValueFlag(oe),a}*prepareDispatcher(s){const n=yield*super.prepareDispatcher(s);if(!this.event)return n;if(s(On(this.event.$.startDate))!=null&&n.addPreviousValueFlag(Me),s(we(this.event.$.startDate))&&n.addProposedValueFlag(Me),!s(we(this.event.$.segments))){if(n.collectInfo(s,this.event.$.duration,dn),s(we(this.event.$.endDate))){const a=s(qe(this.event.$.endDate));a!=null&&a[0]||n.addProposedValueFlag(cn)}const r=s(this.event.$.dispatcher);r.resolution.get(P)===J&&r.resolution.get(R)===J&&n.addProposedValueFlag(un)}return n.collectInfo(s,this.$.startOffset,ie),n.collectInfo(s,this.$.endOffset,oe),n}cycleResolutionContext(s){return Vl}*calculateEndOffsetByMasterDurationAndStartOffset(){const s=yield V(this.event.$.duration),n=yield this.event.$.durationUnit,r=yield this.$.startOffset,a=this.nextSegment;let l,c=yield*this.getProject().$convertDuration(s,n,b.Millisecond);const d=[];let u=this;for(;u=u.previousSegment;)d.push(u);for(let h=d.length-1;h>=0;h--){const f=d[h],p=yield V(f.$.startOffset),m=(yield V(f.$.endOffset))-p;c-=m}return c>0?a?l=r+Math.min(c,(yield V(this.$.endOffset))-r):l=r+c:l=r,l}*calculateEndOffsetByMasterTotalDurationAndStartOffset(){const s=yield V(this.event.$.startDate),n=yield V(this.event.$.endDate),r=yield*this.event.calculateProjectedDuration(s,n,b.Millisecond,{ignoreSegments:!0}),a=yield V(this.$.startOffset);let l=yield V(this.$.endOffset),c=this.nextSegment;return a<=r?l<=r?!c||(yield V(c.$.startOffset))>=r?r:l:r:yield this.$.startOffset}*calculateStartOffsetByEndOffsetAndDuration(){const s=yield this.$.duration,n=yield this.$.durationUnit;return(yield this.$.endOffset)-(yield*this.event.getProject().$convertDuration(s,n,b.Millisecond))}*calculateEndOffsetByStartOffsetAndDuration(){const s=yield this.$.duration,n=yield this.$.durationUnit;return(yield this.$.startOffset)+(yield*this.event.getProject().$convertDuration(s,n,b.Millisecond))}*calculateEndDateByMasterStartAndEndOffset(){const s=yield this.event.$.startDate,n=yield this.$.endOffset,r=yield*this.event.calculateProjectedXDateWithDuration(s,!0,n,b.Millisecond,{ignoreSegments:!0});return(yield this.$.manuallyScheduled)&&!this.getProject().skipNonWorkingTimeWhenSchedulingManually?r:yield*this.event.skipNonWorkingTime(r,!1)}*calculateStartDateByMasterStartAndStartOffset(){const s=yield this.event.$.startDate,n=yield this.$.startOffset,r=yield*this.event.calculateProjectedXDateWithDuration(s,!0,n,b.Millisecond,{ignoreSegments:!0});return(yield this.$.manuallyScheduled)&&!this.getProject().skipNonWorkingTimeWhenSchedulingManually?r:yield*this.event.skipNonWorkingTime(r)}*calculateDurationByOffsets(){const s=yield this.$.startOffset,n=yield this.$.endOffset,r=yield this.$.durationUnit;return yield*this.getProject().$convertDuration(n-s,b.Millisecond,r)}*calculatePercentDone(){let s=0;if(!this.event)return yield A;const n=yield this.event.$.segments;if(n){const r=yield this.event.$.percentDone,a=yield this.event.$.duration,l=yield this.event.$.durationUnit;let c=yield*this.getProject().$convertDuration(a,l,b.Millisecond),d=r*.01*c;for(const u of n){const h=u.startOffset,p=u.endOffset-h;if(u===this)return d>=p?100:d>0?100*d/p:0;d-=p}}return s}*calculateMinPercent(){const s=this.previousSegment;return this.event?s?yield s.$.endPercentDone:0:yield A}*calculateMaxPercent(){if(!this.event)return yield A;const s=yield this.event.$.duration,n=yield this.event.$.durationUnit;let r=yield*this.getProject().$convertDuration(s,n,b.Millisecond);const a=yield this.$.startOffset,l=yield this.$.endOffset;return(yield this.$.startPercentDone)+100*(l-a)/r}*calculateProjectedXDateWithDuration(s,n,r,a){return a||(a=yield this.$.durationUnit),yield*this.event.calculateProjectedXDateWithDuration(s,n,r,a,{ignoreSegments:!0})}*calculateProjectedDuration(s,n,r){return r||(r=yield this.$.durationUnit),yield*this.event.calculateProjectedDuration(s,n,r,{ignoreSegments:!0})}*calculateManuallyScheduled(){return this.event?yield this.event.$.manuallyScheduled:yield A}}return ae([M({identifierCls:Nl})],t.prototype,"dispatcher",void 0),ae([S({persist:!1})],t.prototype,"startOffset",void 0),ae([S({persist:!1})],t.prototype,"endOffset",void 0),ae([M()],t.prototype,"percentDone",void 0),ae([M()],t.prototype,"startPercentDone",void 0),ae([M()],t.prototype,"endPercentDone",void 0),ae([Ae("startDate")],t.prototype,"writeStartDate",null),ae([D("startOffset")],t.prototype,"calculateStartOffset",null),ae([D("endOffset")],t.prototype,"calculateEndOffset",null),ae([D("percentDone")],t.prototype,"calculatePercentDone",null),ae([D("startPercentDone")],t.prototype,"calculateMinPercent",null),ae([D("endPercentDone")],t.prototype,"calculateMaxPercent",null),ae([D("manuallyScheduled")],t.prototype,"calculateManuallyScheduled",null),t}){}var nt=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};const it=Symbol("SegmentsVar"),Wl=(o,e,t)=>t.processSegmentsValue(o),As=L.new({output:P,inputs:new Set([R,it])}),Fs=L.new({output:R,inputs:new Set([P,it])});L.new({output:k,inputs:new Set([P,R,it])});const Za=pt.new({variables:new Set([P,R,k,it]),formulas:new Set([Fs,As,$e,Ie,Ve])}),zl=Ee.new({description:Za,defaultResolutionFormulas:new Set([Ie,Fs])}),Gl=Ee.new({description:Za,defaultResolutionFormulas:new Set([$e,As])});class Ul extends ue.mix(Re){equality(e,t){const i=e.resolution,s=t.resolution;return i.get(P)===s.get(P)&&i.get(R)===s.get(R)&&i.get(k)===s.get(k)&&i.get(it)===s.get(it)}}function Hl(o,e){return!o&&!e?!0:this._skipSegmentsIsEqual||!o&&e||o&&!e||o.length!==e.length?!1:o.every((t,i)=>ql(t,e[i]))}const ql=(o,e)=>{if(o===e)return!0;const i=(o.isModel?o:e).fieldMap,s=o.startDate instanceof Date?o.startDate.getTime():i.startDate.convert(o.startDate).getTime(),n=e.startDate instanceof Date?e.startDate.getTime():i.startDate.convert(e.startDate).getTime(),r=o.endDate instanceof Date?o.endDate.getTime():i.endDate.convert(o.endDate).getTime(),a=e.endDate instanceof Date?e.endDate.getTime():i.endDate.convert(e.endDate).getTime();return s===n&&r===a};class Kl extends y([ti,Is],e=>{class t extends e{constructor(){super(...arguments),this._segmentGeneration={}}static get $name(){return"SplitEventMixin"}construct(){this.segmentModelClass=this.getDefaultSegmentModelClass(),super.construct(...arguments)}get rawModifications(){let s=super.rawModifications;if(this.segments&&(!s||!("segments"in s))){for(const n of this.segments)if(n.rawModifications){s=s||{},s.segments=this.getFieldPersistentValue("segments");break}}return s}clearChanges(s,n,r){for(const a of this.segments||[])a.clearChanges(s,n,null);super.clearChanges(s,n,r)}getDefaultSegmentModelClass(){return js}*prepareDispatcher(s){const n=yield*super.prepareDispatcher(s);return(yield*this.hasSegmentChangesProposed())&&n.addProposedValueFlag(it),n}cycleResolutionContext(s){const n=s(this.$.direction);return n===G.Forward||n===G.None?zl:Gl}*hasSegmentChangesProposed(){const s=yield kr(this.$.segments);let n=!1;(yield we(this.$.segments))&&(n=!!s);const r=yield V(this.$.segments);if(!r)return!1;for(const a of r){const l=yield we(a.$.startDate),c=yield we(a.$.endDate),d=yield we(a.$.duration);(l||c||d)&&(n=!0)}return n}writeSegments(s,n,r,a){var l;const c=(l=n.getLatestEntryFor(s))===null||l===void 0?void 0:l.getValue(),d=c!==O?c!=null?c:[]:[],u=new Set(d),h=a!=null?a:[],f=new Set(h);this.project.ion({commitFinalized:()=>g.removeEntities(d.filter(m=>!f.has(m))),once:!0}),s.constructor.prototype.write.call(this,s,n,r,a),this.$.isSegmented.write.call(this,this.$.isSegmented,n,null,!!(a!=null&&a.length));const p=this.project,g=p.replica;for(const m of h)!u.has(m)&&m.graph!==g&&(m.setProject(p),g.addEntity(m))}*doWriteSegments(s,n){if(n=n||[],s.length<=1){const r=s.length?yield*this.getProject().$convertDuration(s[0].endOffset-s[0].startOffset,b.Millisecond,yield this.$.durationUnit):0;n.push({identifier:this.$.duration,proposedArgs:[r,null]}),s=null}n.push({identifier:this.$.segments,proposedArgs:[s]}),yield jr(n)}*calculateSegments(){var s;yield this.$.dispatcher;const{graph:n,project:r}=this,a=yield On(this.$.segments);let l=yield A;const c=[];let d=!1;if(l){const u=new Set;let h=null,f=!1;const{baseRevision:p}=n.$activeTransaction;for(const g of l){const m=yield g.$.startOffset,v=yield g.$.endOffset,C=p.hasIdentifier(g.$.startDate)&&(yield qe(g.$.startDate)),z=p.hasIdentifier(g.$.endDate)&&(yield qe(g.$.endDate));if(f=f||(C==null?void 0:C[0])||(z==null?void 0:z[0]),m===v)c.push(g);else if(h&&m<=h.endOffset){const T=h.endOffset;if(c.push(g),h.graph){c.push(h);const $=h.startOffset,F=f?v+T-m:Math.max(v,T),w=h.cls;h=this.segmentModelClass.new({event:this,cls:w,startOffset:$,endOffset:F})}else h.endOffset=f?v+h.endOffset-m:Math.max(v,h.endOffset)}else h&&u.add(h),h=g}h&&u.add(h),u.size===1&&c.push(...u),d=c.length>0,d&&(l=Array.from(u)),l.reduce((g,m,v)=>(g&&(g.nextSegment=m),m.previousSegment=g,m.segmentIndex=v,m),null),l.length&&(l[l.length-1].nextSegment=null)}else a&&c.push(...a);return c.length&&(c.forEach(u=>u.event=null),r.ion({commitFinalized:()=>n.removeEntities(c),once:!0})),d&&(yield*this.doWriteSegments(l)),l=((s=l)===null||s===void 0?void 0:s.length)>1?l:null,l}*calculateAdjustedSegments(){yield this.$.dispatcher;let s=yield this.$.segments;yield this.$.startDate;const n=yield this.$.endDate;yield this.$.duration;let r=yield A;if(s){const a=this.project,l=this.graph,c=[],d=[];let u=-1;for(let p=s.length-1;p>=0;p--){const g=s[p],m=yield g.$.startDate,v=yield g.$.endDate;if(m>n)c.push(g),u=p;else{if(v.getTime()!==n.getTime()){const C=g.endOffset+(n.getTime()-v.getTime())-g.startOffset,z=yield*a.$convertDuration(C,b.Millisecond,yield g.$.durationUnit);d.push({identifier:g.$.duration,proposedArgs:[z,null]},{identifier:g.$.endDate,proposedArgs:[n,!1]},{identifier:g.$.endOffset,proposedArgs:[g.endOffset+(n.getTime()-v.getTime())]})}break}}let h=!1;u>-1&&(h=!0,s.splice(u),s.length&&(s[s.length-1].nextSegment=null),a.ion({commitFinalized:()=>l.removeEntities(c),once:!0}));let f="";s&&(f=this.getSegmentsSnapshot(s)),f!==this._lastSegmentsSnapshot&&(h=!0,s=s&&s.slice(),this._lastSegmentsSnapshot=f),h&&(yield*this.doWriteSegments(s,d))}return r}getSegmentsSnapshot(s){var n;return s=s||this.segments,(n=s)===null||n===void 0?void 0:n.map(r=>{var a,l;return""+r.startOffset+"-"+((a=r.startDate)===null||a===void 0?void 0:a.getTime())+"-"+r.endOffset+"-"+((l=r.endDate)===null||l===void 0?void 0:l.getTime())}).join(";")}processSegmentsValue(s){let n=s;if(s)for(let r=0;r<s.length;r++){const a=s[r],l=a.isModel?a:this.segmentModelClass.new(a);l.event||(l.event=this),s[r]=l}return n}*calculateStartDate(){const n=(yield this.$.dispatcher).resolution.get(P);let r;return n===As.formulaId?r=yield*this.calculateStartDateBySegments():r=yield*super.calculateStartDate(),r}*calculateStartDateBySegments(){yield this.$.dispatcher;const s=yield this.$.segments,n=yield this.$.endDate;let r;if(s){const l=yield s[s.length-1].$.endOffset,c=yield*this.calculateProjectedXDateWithDuration(n,!1,l,b.Millisecond,{ignoreSegments:!0});r=(yield this.$.manuallyScheduled)&&!this.getProject().skipNonWorkingTimeWhenSchedulingManually?c:yield*this.skipNonWorkingTime(c,!0)}return r}*calculateEndDateBySegments(){yield this.$.dispatcher;const s=yield this.$.segments,n=yield this.$.startDate;let r;if(s){const l=yield s[s.length-1].$.endOffset,c=yield*this.calculateProjectedXDateWithDuration(n,!0,l,b.Millisecond,{ignoreSegments:!0});r=(yield this.$.manuallyScheduled)&&!this.getProject().skipNonWorkingTimeWhenSchedulingManually?c:yield*this.skipNonWorkingTime(c,!1)}return r}*calculateEndDate(){const n=(yield this.$.dispatcher).resolution.get(R);let r;return n===Fs.formulaId?r=yield*this.calculateEndDateBySegments():r=yield*super.calculateEndDate(),r}*calculateDurationProposed(){let s;return(yield*this.hasSegmentChangesProposed())?s=yield*this.calculateDurationBySegments():s=yield*super.calculateDurationProposed(),s}*skipNonWorkingTime(s,n=!0,r){return s?(r=Object.assign({ignoreSegments:!0},r),yield*super.skipNonWorkingTime(s,n,r)):null}*calculateDurationBySegments(){let s;yield this.$.dispatcher;const n=yield this.$.durationUnit,r=yield this.$.segments;if(r){let a=0;for(const l of r)a+=l.endOffset-l.startOffset;s=yield*this.getProject().$convertDuration(a,b.Millisecond,n)}return s}*forEachAvailabilityInterval(s,n){const r=yield this.$.effectiveCalendar,a=yield this.$.assignmentsByCalendar,l=yield this.$.effectiveCalendarsCombination,c=s.isForward!==!1,d=(yield this.$.ignoreResourceCalendar)||s.ignoreResourceCalendar||!a.size,u=this.getProject().maxCalendarRange;let h=s.ignoreSegments,f=1,p,g,m,v,C;h||(v=yield this.$.segments,h=h||!v,h||(v=v.slice(),c?(p=v.shift(),g=0,f=1,C=p.nextSegment?p.endOffset:le.getTime()):(p=v.pop(),g=p.endOffset,f=-1,C=p.endOffset),m=C-p.startOffset));const z=yield this.$.manuallyScheduled,T=this.getProject();return l.forEachAvailabilityInterval(Object.assign({maxRange:u},s),($,F,w)=>{const q=w.getCalendarsWorkStatus(),fe=w.getCalendarsWorking();if(q.get(r)&&(d||fe.some(x=>a.has(x))||z&&!T.skipNonWorkingTimeInDurationWhenSchedulingManually)){if(h)return n($,F,w);{const x=$.getTime();let H=F.getTime()-$.getTime();if(this.getProject().adjustDurationToDST){const ke=$.getTimezoneOffset()-F.getTimezoneOffset();H+=ke*60*1e3}let Y,X;for(c?(Y=g,X=g+H):(Y=g-H,X=g);p&&Y<=C&&X>p.startOffset;){const ke=Math.max(Y,p.startOffset),Ge=Math.min(X,C),Sn=new Date(x+ke-Y),ee=new Date(x+Ge-Y);if(n(Sn,ee,w)===!1)return!1;if(m-=ee.getTime()-Sn.getTime(),!m)p=c?v.shift():v.pop(),p&&(C=!c||p.nextSegment?p.endOffset:le.getTime(),m=C-p.startOffset);else break}g+=f*H}}})}*useEventAvailabilityIterator(){return(yield this.$.isSegmented)?!0:!(yield this.$.manuallyScheduled)}getSegmentByDate(s,n){if(n=n||this.getSegments(),n){const r=this.getSegmentIndexByDate(s,n);return n[r]}}getSegmentIndexByDate(s,n){return n=n||this.getSegments(),n?n.findIndex(r=>s>=r.startDate&&s<r.endDate):-1}get firstSegment(){const s=this.getSegments();return s?s[0]:null}get lastSegment(){const s=this.getSegments();return s?s[s.length-1]:null}getSegment(s){const n=this.getSegments();return n==null?void 0:n[s]}async splitToSegments(s,n=1,r){var a;const l=this.getProject();await l.commitAsync();const c=this;if(!s||c.isHasSubEventsMixin&&(a=c.childEvents)!==null&&a!==void 0&&a.size)return;const d=c.duration,u=c.durationUnit,h=c.startDate,f=c.endDate;if(r=r?I.normalizeUnit(r):u,!h||!f||h>=s||s>=f||!d)return;const p=c.isSegmented;let g=c.segments||[],m,v;if(p&&(v=c.getSegmentIndexByDate(s,g),m=g[v],!m))return;const C=m||c,z=m?C.startDate:h,T=C.duration,$=C.durationUnit,F=c.run("calculateProjectedDuration",z,s,$,{ignoreSegments:!0}),w=T-F,q=l.run("$convertDuration",n,r,b.Millisecond),fe=q+c.run("calculateProjectedDuration",h,s,b.Millisecond,{ignoreSegments:!0});if(m){m.duration=F;const x=this.segmentModelClass.new({duration:w,durationUnit:$,startOffset:fe});g=g.slice(0),g.splice(v+1,0,x),c.segments=g,c.duration=d;for(let H=v+2,Y=g.length;H<Y;H++){const X=g[H];X&&(X.startOffset+=q,X.endOffset+=q)}}else{const x=this.segmentModelClass.new({duration:F,durationUnit:$,startOffset:0}),H=this.segmentModelClass.new({duration:d-F,durationUnit:$,startOffset:fe});c.duration=d,c.segments=[x,H]}return l.commitAsync()}async mergeSegments(s,n){if(this.isSegmented){if(s=s||this.firstSegment,n=n||this.lastSegment,s.startOffset>n.startOffset){let r=n;n=s,s=r}return s.endDate=n.startDate,this.getProject().commitAsync()}}storeFieldChange(s,n){if(s==="segments"&&n){const r=[];for(const a of n){const l=a.toJSON();(!this._segmentGeneration[a.internalId]||a.generation>this._segmentGeneration[a.internalId])&&Object.assign(l,a.meta.modified),r.push(l),this._segmentGeneration[a.internalId]=a.generation}n=r}super.storeFieldChange(s,n)}leaveProject(){const s=this.segments;s&&this.graph.removeEntities(s),super.leaveProject()}endBatch(...s){this.fieldMap.segments._skipSegmentsIsEqual++,super.endBatch(...s),this.fieldMap.segments._skipSegmentsIsEqual--}copy(s=null,n=null){const r=super.copy(s,n);return r.data.segments=void 0,r.segments&&(r.segments=r.segments.map(a=>Object.assign(a.copy(),{event:r}))),r}}return nt([M({identifierCls:Ul})],t.prototype,"dispatcher",void 0),nt([S({type:"array",isEqual:Hl,convert:Wl,_skipSegmentsIsEqual:0})],t.prototype,"segments",void 0),nt([M()],t.prototype,"adjustedSegments",void 0),nt([M()],t.prototype,"isSegmented",void 0),nt([Ae("segments")],t.prototype,"writeSegments",null),nt([D("segments")],t.prototype,"calculateSegments",null),nt([D("adjustedSegments")],t.prototype,"calculateAdjustedSegments",null),t}){}var ni=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class ks extends y([ti,rn],e=>{e.prototype;class t extends e{getEffort(s){const n=this.effort;return s?this.getProject().convertDuration(n,this.effortUnit,s):n}writeEffort(s,n,r,a,l){a<0&&(a=0),!(!n.baseRevision.hasIdentifier(s)&&a==null)&&(l!=null&&l!==this.effortUnit&&this.$.effortUnit.write.call(this,this.$.effortUnit,n,null,l),s.constructor.prototype.write(s,n,r,a))}setEffortUnit(s){throw new Error("Use `setEffort` instead")}*shouldRollupChildEffort(s){return!0}*calculateTotalChildrenEffort(){const s=yield this.$.childEvents,n=this.getProject();let r=0;for(const a of s){if(!(yield*this.shouldRollupChildEffort(a)))continue;const l=yield a.$.effortUnit;r+=yield*n.$convertDuration(yield a.$.effort,l,b.Millisecond)}return yield*n.$convertDuration(r,b.Millisecond,yield this.$.effortUnit)}*calculateEffort(){if((yield this.$.childEvents).size>0)return yield*this.calculateTotalChildrenEffort();{const n=yield A;return n!==void 0?n:yield*this.calculateEffortPure()}}*calculateEffortPure(){return(yield this.$.childEvents).size>0?yield*this.calculateTotalChildrenEffort():yield*this.calculateProjectedEffort(yield this.$.startDate,yield this.$.endDate)}*calculateEffortProposed(){return yield A}*calculateAssignmentUnits(s){return yield*this.calculateAssignmentUnitsProposed(s)}*calculateAssignmentUnitsPure(s){return yield*this.calculateUnitsByStartEndAndEffort(s)}*calculateAssignmentUnitsProposed(s){return yield A}*getBaseOptionsForEffortCalculations(){return{ignoreResourceCalendar:!1}}*calculateProjectedEffort(s,n,r){if(s==null||n==null||s>n)return null;r||(r=yield this.$.assignmentsByCalendar);const a=new Map;for(const[d,u]of r){let h=0;for(const f of u)h+=yield f.$.units;a.set(d,h)}let l=0;const c=Object.assign(yield*this.getBaseOptionsForEffortCalculations(),{startDate:s,endDate:n});return a.size===0&&(a.set(yield this.$.effectiveCalendar,100),c.ignoreResourceCalendar=!0),yield*this.forEachAvailabilityInterval(c,(d,u,h)=>{const f=h.getCalendarsWorking(),p=d.getTime(),g=u.getTime(),m=g-p;let v=0;for(const C of f)v+=a.get(C)||0;l+=v*m*.01}),yield*this.getProject().$convertDuration(l,b.Millisecond,yield this.$.effortUnit)}*calculateUnitsByStartEndAndEffort(s){const n=yield this.$.effort,r=yield this.$.effortUnit,a=yield*this.getProject().$convertDuration(n,r,b.Millisecond);let l=0;const c=Object.assign(yield*this.getBaseOptionsForEffortCalculations(),{startDate:yield this.$.startDate,endDate:yield this.$.endDate}),d=yield this.$.assignmentsByCalendar;return yield*this.forEachAvailabilityInterval(c,(u,h,f)=>{const p=f.getCalendarsWorking(),g=u.getTime(),m=h.getTime(),v=m-g;for(const C of p)l+=(d.has(C)?d.get(C).length:0)*v}),l?100*a/l:100}*calculateProjectedXDateByEffort(s,n=!0,r,a){r=r!==void 0?r:yield this.$.effort,a=a!==void 0?a:yield this.$.effortUnit;const l=yield*this.getProject().$convertDuration(r,a,b.Millisecond);if(s==null||r==null)return null;let c=s.getTime(),d=l;if(d===0)return new Date(c);const u=yield this.$.effectiveCalendar,h=yield this.$.assignmentsByCalendar,f=new Map;let p=!1;for(const[g,m]of h){let v=0;for(const C of m)v+=yield C.$.units;f.set(g,v),v>0&&(p=!0)}if(p&&(yield*this.useEventAvailabilityIterator())){const g=Object.assign(yield*this.getBaseOptionsForDurationCalculations(),n?{startDate:s,isForward:n}:{endDate:s,isForward:n});return yield*this.forEachAvailabilityInterval(g,(m,v,C)=>{const z=C.getCalendarsWorking(),T=m.getTime(),$=v.getTime(),F=$-T;let w=0;for(const fe of z)w+=f.get(fe)||0;const q=w*F*.01;if(q>=d)return c=n?T+d/(.01*w):$-d/(.01*w),!1;d-=q}),new Date(c)}else return u.accumulateWorkingTime(s,l,n).finalDate}}return ni([S({type:"number"})],t.prototype,"effort",void 0),ni([S({type:"string",defaultValue:b.Hour},{converter:i=>I.normalizeUnit(i)||b.Hour})],t.prototype,"effortUnit",void 0),ni([Ae("effort")],t.prototype,"writeEffort",null),ni([D("effort")],t.prototype,"calculateEffort",null),t}){}const Z=Symbol("EffortVar"),se=Symbol("UnitsVar"),hn=L.new({output:Z,inputs:new Set([P,R,se])}),Ot=L.new({output:se,inputs:new Set([P,R,Z])}),Bs=L.new({output:R,inputs:new Set([P,Z,se])}),_s=L.new({output:P,inputs:new Set([R,Z,se])});class Ya extends ys{}class eo extends vs{equality(e,t){const i=e.resolution,s=t.resolution;return(e!==O||t===O)&&(e===O||t!==O)&&i.get(Z)===s.get(Z)&&i.get(se)===s.get(se)&&super.equality(e,t)}}var st=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Ls extends y([ks],e=>{const t=e.prototype;class i extends e{*calculateSchedulingMode(){return(yield A)||N.Normal}*effectiveSchedulingMode(){return(yield this.$.assignmentsByCalendar).size>0?yield this.$.schedulingMode:N.Normal}effectiveSchedulingModeSync(n){return n(this.$.assignmentsByCalendar).size>0?n(this.$.schedulingMode):N.Normal}*prepareDispatcher(n){if((yield*this.effectiveSchedulingMode())!==N.Normal){const a=yield*t.prepareDispatcher.call(this,n);return a.collectInfo(n,this.$.effort,Z),(yield*this.hasProposedValueForUnits())&&a.addProposedValueFlag(se),a.addPreviousValueFlag(se),a}else return yield*t.prepareDispatcher.call(this,n)}dispatcherClass(n){return this.effectiveSchedulingModeSync(n)!==N.Normal?Ya:t.dispatcherClass.call(this,n)}buildProposedDispatcher(n,r,a){const l=t.buildProposedDispatcher.call(this,n,r,a);return l.addPreviousValueFlag(Z),l.addPreviousValueFlag(se),l}*calculateAssignmentUnits(n){if((yield*this.effectiveSchedulingMode())!==N.Normal){const l=(yield this.$.dispatcher).resolution.get(se);if(l===J)return yield*this.calculateAssignmentUnitsProposed(n);if(l===Ot.formulaId)return yield*this.calculateAssignmentUnitsPure(n);throw new Error("Unknown formula for `units`")}else return yield*t.calculateAssignmentUnits.call(this,n)}*calculateEffort(){if((yield*this.effectiveSchedulingMode())!==N.Normal){const a=(yield this.$.dispatcher).resolution.get(Z);if(a===J)return yield*this.calculateEffortProposed();if(a===hn.formulaId)return yield*this.calculateEffortPure();throw new Error("Unknown formula for `effort`")}else return yield*t.calculateEffort.call(this)}*calculateStartDate(){return(yield*this.effectiveSchedulingMode())!==N.Normal?(yield this.$.dispatcher).resolution.get(P)===_s.formulaId?yield*this.calculateProjectedXDateByEffort(yield this.$.endDate,!1):yield*t.calculateStartDate.call(this):yield*t.calculateStartDate.call(this)}*calculateEndDate(){return(yield*this.effectiveSchedulingMode())!==N.Normal?(yield this.$.dispatcher).resolution.get(R)===Bs.formulaId?yield*this.calculateProjectedXDateByEffort(yield this.$.startDate,!0):yield*t.calculateEndDate.call(this):yield*t.calculateEndDate.call(this)}*calculateEffectiveDuration(){const n=yield this.$.dispatcher,r=yield*this.effectiveSchedulingMode(),a=n.resolution.get(k);n.resolution.get(Z);let l;if(a===Ve.formulaId&&r!=N.Normal){const c=yield V(this.$.startDate),d=yield V(this.$.endDate),u=n.resolution.get(P),h=n.resolution.get(R);yield this.$.effortDriven,d&&u===_s.formulaId?l=yield*this.calculateProjectedDuration(yield*this.calculateProjectedXDateByEffort(d,!1),d):c&&h===Bs.formulaId?l=yield*this.calculateProjectedDuration(c,yield*this.calculateProjectedXDateByEffort(c,!0)):(c&&d||!c&&!d)&&(l=yield*t.calculateEffectiveDuration.call(this))}else l=yield*t.calculateEffectiveDuration.call(this);return l}}return st([S({type:"boolean",defaultValue:!1})],i.prototype,"effortDriven",void 0),st([S({type:"string",defaultValue:N.Normal},{sync:!0})],i.prototype,"schedulingMode",void 0),st([M({identifierCls:eo})],i.prototype,"dispatcher",void 0),st([D("schedulingMode")],i.prototype,"calculateSchedulingMode",null),st([D("effort")],i.prototype,"calculateEffort",null),st([D("startDate")],i.prototype,"calculateStartDate",null),st([D("endDate")],i.prototype,"calculateEndDate",null),i}){}const Vs=pt.new({variables:new Set([P,R,k,Z,se]),formulas:new Set([$e,Ie,Ve,Ot,hn])}),Ns=pt.new({variables:new Set([P,R,k,Z,se]),formulas:new Set([$e,Ie,Ve,Ot])}),to=Ee.new({description:Vs,defaultResolutionFormulas:new Set([Ie,hn])}),no=Ee.new({description:Ns,defaultResolutionFormulas:new Set([Ie,Ot])}),io=Ee.new({description:Vs,defaultResolutionFormulas:new Set([$e,hn])}),so=Ee.new({description:Ns,defaultResolutionFormulas:new Set([$e,Ot])});class ro extends y([Ls],e=>{const t=e.prototype;class i extends e{*prepareDispatcher(n){if((yield*this.effectiveSchedulingMode())===N.FixedDuration){const a=yield*t.prepareDispatcher.call(this,n),l=yield this.$.effortDriven;return l&&a.addKeepIfPossibleFlag(Z),(yield we(this.$.assigned))&&(l?a.addProposedValueFlag(Z):a.addProposedValueFlag(se)),a}else return yield*t.prepareDispatcher.call(this,n)}cycleResolutionContext(n){if(this.effectiveSchedulingModeSync(n)===N.FixedDuration){const a=n(this.$.direction),l=n(this.$.effortDriven);return a===G.Forward||a===G.None?l?no:to:l?so:io}else return t.cycleResolutionContext.call(this,n)}*getBaseOptionsForDurationCalculations(){return(yield*this.effectiveSchedulingMode())===N.FixedDuration?{ignoreResourceCalendar:!0}:yield*t.getBaseOptionsForDurationCalculations.call(this)}}return i}){}class ao extends y([Kn,Va,Is,ti,ks,Ls,ro,an,za,Kl],e=>{class t extends e{}return t}){}var fn=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class oo extends Dr{static get fields(){return[{name:"isWorking",type:"boolean",defaultValue:!0}]}}class lo extends Wo{static get defaultConfig(){return{modelClass:oo}}}class Ws extends $t{get intervalStoreClass(){return lo}}fn([S({type:"boolean",defaultValue:!1})],Ws.prototype,"unspecifiedTimeIsWorking",void 0);class ii extends U{constructor(){super(...arguments),this.effort=0,this.units=0}}class co extends ii{}class zs extends ii{constructor(){super(...arguments),this.maxEffort=0,this.isOverallocated=!1,this.isUnderallocated=!1,this.assignments=null,this.assignmentIntervals=null}}class si extends Te.mix(U){getDefaultAllocationIntervalClass(){return ii}initialize(e){e=Object.assign({includeInactiveEvents:!1,allocationIntervalClass:this.getDefaultAllocationIntervalClass()},e),super.initialize(e)}}fn([M()],si.prototype,"includeInactiveEvents",void 0),fn([M()],si.prototype,"allocation",void 0);class ri extends si{enterGraph(e){super.enterGraph(e)}leaveGraph(e){super.leaveGraph(e),this.resource&&this.resource.entities.delete(this)}getDefaultAllocationIntervalClass(){return zs}*shouldIncludeAssignmentInAllocation(e){const t=yield e.$.event,i=yield e.$.units,s=yield this.$.includeInactiveEvents,n=t&&(yield t.$.inactive),r=t&&(yield t.$.startDate),a=t&&(yield t.$.endDate);return!!(t&&i&&r&&a&&(s||!n))}*calculateAllocation(){const e=[],t=yield this.ticks,i=yield this.$.resource;yield this.$.includeInactiveEvents;const s=yield i.$.assigned,n=yield i.$.effectiveCalendar,r=new Map,a=[],l=new Map,c=new Map;let d=!1;for(const T of s){if(!(yield*this.shouldIncludeAssignmentInAllocation(T)))continue;yield T.$.units;const $=yield T.$.event,F=yield $.$.ignoreResourceCalendar,w=yield $.$.startDate,q=yield $.$.endDate,fe=yield $.$.segments,x=yield $.$.effectiveCalendar;if(d=d||F,fe)for(const Y of fe){const X=yield Y.$.startDate,ke=yield Y.$.endDate;a.push({startDate:X,endDate:ke,assignment:T})}else a.push({startDate:w,endDate:q,assignment:T});let H=r.get(x);H||(H=[],r.set(x,H)),l.set(T,new Map),c.set(T,[]),H.push(T)}const u=new Ws({intervals:a}),h=[t,u,...r.keys()],f=new Map;t.intervalStore.forEach(T=>{const $=zs.new({tick:T,resource:i});f.set(T,$),e.push($),l.forEach((F,w)=>{const q=co.new({tick:T,assignment:w});F.set(T,q),c.get(w).push(q)})});let p,g;const m=e[0].tick.startDate,v=e[e.length-1].tick.endDate,C={startDate:m,endDate:v,calendars:h,includeNonWorkingIntervals:d},z=v.getTime()-m.getTime();return z>i.getProject().maxCalendarRange&&(C.maxRange=z),yield*i.forEachAvailabilityInterval(C,(T,$,F)=>{const w=F.getCalendarsWorkStatus();if(w.get(t)){const q=F.intervalsByCalendar.get(t)[0],fe=$.getTime()-T.getTime(),x=f.get(q),H=x.assignments||new Set,Y=x.assignmentIntervals||new Map;x.assignments||(p=0,g=0);let X=0,ke=!1,Ge;F.intervalsByCalendar.get(u).forEach(Sn=>{const ee=Sn.assignment,En=ee==null?void 0:ee.event;if(En&&w.get(En.effectiveCalendar)&&(!d||En.ignoreResourceCalendar||w.get(n))){const bo=Math.max(T.getTime(),ee.event.startDate.getTime()),wo=Math.min($.getTime(),ee.event.endDate.getTime());ke=!0,Ge=wo-bo;const mi=l.get(ee).get(q),yr=Ge*ee.units/100;mi.effort+=yr,mi.units=ee.units,x.effort+=yr,X+=ee.units,H.add(ee),Y.set(ee,mi)}}),w.get(n)&&(x.maxEffort+=fe),X&&(Ge?(p+=Ge*X,g+=Ge,x.units=p/g):p||(x.units=X)),ke&&(x.assignments=H,x.assignmentIntervals=Y,x.isOverallocated=x.isOverallocated||x.effort>x.maxEffort||x.units>100,x.isUnderallocated=x.effort<x.maxEffort||x.units<100)}}),{total:e,byAssignments:c}}}fn([M()],ri.prototype,"resource",void 0),fn([D("allocation")],ri.prototype,"calculateAllocation",null);class Gs extends y([Xn],e=>{const t=e.prototype;class i extends e{constructor(){super(...arguments),this.observers=new Set,this.entities=new Set}addObserver(n){this.graph.addIdentifier(n),this.observers.add(n)}removeObserver(n){this.graph&&this.graph.removeIdentifier(n),this.observers.delete(n)}addEntity(n){this.graph.addEntity(n),this.entities.add(n)}removeEntity(n){this.graph&&this.graph.removeEntity(n),this.entities.delete(n)}leaveGraph(n){for(const r of this.observers)this.removeObserver(r);for(const r of this.entities)this.removeEntity(r);t.leaveGraph.call(this,n)}*forEachAvailabilityInterval(n,r){const a=this.getProject(),l=yield this.$.effectiveCalendar,c=a.combineCalendars([l].concat(n.calendars||[])),d=a.maxCalendarRange,u=n.includeNonWorkingIntervals;return d&&(n=Object.assign({maxRange:d},n)),c.forEachAvailabilityInterval(n,(h,f,p)=>{const g=p.getCalendarsWorkStatus();if(u||g.get(l))return r(h,f,p)})}}return i}){}var xt=function(o,e,t,i){var s=arguments.length,n=s<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,t):i,r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")n=Reflect.decorate(o,e,t,i);else for(var a=o.length-1;a>=0;a--)(r=o[a])&&(n=(s<3?r(n):s>3?r(e,t,n):r(e,t))||n);return s>3&&n&&Object.defineProperty(e,t,n),n};class Ql extends y([Ba,an,rn],e=>{const t=e.prototype;class i extends e{construct(n={}){this.eventSegmentModelClass=n.eventSegmentModelClass||this.getDefaultEventSegmentModelClass(),t.construct.call(this,n),this.resourceAllocationInfoClass||(this.resourceAllocationInfoClass=this.getDefaultResourceAllocationInfoClass())}getDefaultEventStoreClass(){return Qn}getDefaultEventSegmentModelClass(){return js}getDefaultResourceAllocationInfoClass(){return ri}*calculateDirection(){return yield A}afterConfigure(){t.afterConfigure.apply(this,arguments),this.dateConstraintIntervalClass=this.dateConstraintIntervalClass||Zn,this.dependencyConstraintIntervalClass=this.dependencyConstraintIntervalClass||on}getType(){return Lt.SchedulerPro}getDefaultCycleEffectClass(){return pn}getDefaultEventModelClass(){return ao}getDefaultDependencyModelClass(){return $s}getDefaultAssignmentModelClass(){return Ts}getDefaultResourceModelClass(){return Gs}async validateDependency(n,r,a,l){let c;return l&&(c=Array.isArray(l)?l:[l]),Oe(n.outgoingDeps).some(u=>{var h;return u.toEvent===r&&!((h=c)!==null&&h!==void 0&&h.includes(u))})?dt.DuplicatingDependency:await this.isDependencyCyclic(n,r,a,c)?dt.CyclicDependency:dt.NoError}async isValidDependency(n,r,a,l){return await this.validateDependency(n,r,a,l)===dt.NoError}getDependencyCycleDetectionIdentifiers(n,r){return[r.$.earlyStartDateConstraintIntervals,r.$.earlyEndDateConstraintIntervals]}async isDependencyCyclic(n,r,a,l){const c=this.getDependencyStore().modelClass,d=new c({fromEvent:n,toEvent:r,type:a}),u=this.replica.branch({autoCommit:!1,onComputationCycle:"throw"});l&&(Array.isArray(l)||(l=[l]),l.forEach(h=>u.removeEntity(h))),u.addEntity(d),d.project=this;try{return await Promise.all(this.getDependencyCycleDetectionIdentifiers(n,r).map(h=>u.readAsync(h))),!1}catch(h){if(/cycle/i.test(h))return!0;if(!/conflict/i.test(h))throw h}}async isValidDependencyModel(n,r){return this.isValidDependency(n.fromEvent,n.toEvent,n.type,r)}}return xt([S({type:"string",defaultValue:wn.ToEvent})],i.prototype,"dependenciesCalendar",void 0),xt([S({type:"boolean",defaultValue:!0})],i.prototype,"autoCalculatePercentDoneForParentTasks",void 0),xt([S({type:"boolean",defaultValue:!0})],i.prototype,"addConstraintOnDateSet",void 0),i}){}class uo extends pe(Zt){static get $name(){return"DeactivateDependencyCycleEffectResolution"}getDescription(){return this.L("L{descriptionTpl}")}resolve(e){e.active=!1}}class pn extends et{getInvalidDependencies(){if(!this._invalidDependencies){const e=this.getDependencies();this._invalidDependencies=e.filter(t=>t.fromEvent===t.toEvent||t.fromEvent.contains(t.toEvent)||t.toEvent.contains(t.fromEvent))}return this._invalidDependencies}buildInvalidDependencyResolutions(e){return[this.removeDependencyConflictResolutionClass.new(e),this.deactivateDependencyConflictResolutionClass.new(e)]}matchDependencyBySourceAndTargetEvent(e,t,i){return e.active&&super.matchDependencyBySourceAndTargetEvent(e,t,i)}getResolutions(){if(!this._resolutions){const e=this.getInvalidDependencies(),t=[];for(const i of e)t.push(...this.buildInvalidDependencyResolutions({dependency:i}));e.length||t.push(this.deactivateDependencyCycleEffectResolutionClass.new(),...super.getResolutions()),this._resolutions=t}return this._resolutions}}xt([E(uo)],pn.prototype,"deactivateDependencyCycleEffectResolutionClass",void 0),xt([E(Ps)],pn.prototype,"removeDependencyConflictResolutionClass",void 0),xt([E(Rs)],pn.prototype,"deactivateDependencyConflictResolutionClass",void 0);class ai extends Pn{static get $name(){return"ModelCombo"}static get type(){return"modelcombo"}get value(){const e=super.value;return this.store.getById(e)||e}set value(e){super.value=e}}ai.initClass(),ai._$name="ModelCombo";class Us extends ai{static get $name(){return"CalendarField"}static get type(){return"calendarfield"}static get defaultConfig(){return{valueField:"id",displayField:"name",editable:!1,store:null,listItemTpl:e=>e.name||this.L("L{Default calendar}"),displayValueRenderer:(e,t)=>{var i,s,n;return e=e||((i=t.store)===null||i===void 0||(s=i.project)===null||s===void 0?void 0:s.effectiveCalendar),((n=e)===null||n===void 0?void 0:n.name)||this.L("L{Default calendar}")}}}get value(){return super.value}set value(e){e&&e.isDefault&&e.isDefault()&&(e=null),super.value=e}}Us.initClass(),Us._$name="CalendarField";const gn=(o,e)=>{if(o!==e)throw new Error("Store set is prohibited for Scheduler Pro entity!")};var he=o=>class extends(o||de){static get $name(){return"PartOfProject"}get taskStore(){return this.eventStore}set taskStore(t){this.eventStore=t}get eventStore(){var t;return(t=this.project)===null||t===void 0?void 0:t.eventStore}get leftProjectEventStore(){const t=this.leftProject;return(t==null?void 0:t.getEventStore())||null}set eventStore(t){gn(this.eventStore,t)}get dependencyStore(){var t;return(t=this.project)===null||t===void 0?void 0:t.dependencyStore}set dependencyStore(t){gn(this.dependencyStore,t)}get assignmentStore(){var t;return(t=this.project)===null||t===void 0?void 0:t.assignmentStore}set assignmentStore(t){gn(this.assignmentStore,t)}get resourceStore(){var t;return(t=this.project)===null||t===void 0?void 0:t.resourceStore}set resourceStore(t){gn(this.resourceStore,t)}get calendarManagerStore(){var t;return(t=this.project)===null||t===void 0?void 0:t.calendarManagerStore}set calendarManagerStore(t){gn(this.calendarManagerStore,t)}};class rt extends he(zo(Ts.derive(ut))){get event(){const{project:e}=this,t=super.event;return e!=null&&e.isDelayingCalculation?e.eventStore.getById(t):t}set event(e){super.event=e}get resource(){var e;const{project:t}=this;let i=super.resource;return t!=null&&t.isDelayingCalculation&&(i=t.resourceStore.getById(i)),(e=i)===null||e===void 0?void 0:e.$original}set resource(e){super.resource=e}get eventResourceKey(){return this.isInActiveTransaction?this.buildEventResourceKey(this.event,this.resource):this.buildEventResourceKey(this.$.event.DATA,this.$.resource.DATA)}}B(rt,"$name","AssignmentModel"),B(rt,"isProAssignmentModel",!0),rt._$name="AssignmentModel";class Hs extends he(Go(fs.derive(Rn))){static get defaultConfig(){return{modelClass:rt}}}B(Hs,"$name","AssignmentStore"),Hs._$name="AssignmentStore";class qs extends he(Dr.derive(ut)){static get $name(){return"CalendarIntervalModel"}}qs._$name="CalendarIntervalModel";class Ks extends he($t.derive(ut)){static get $name(){return"CalendarModel"}static get fields(){return[{name:"expanded",internal:!0,defaultValue:!0}]}toString(){return this.name||""}static get defaultConfig(){return{calendarIntervalModelClass:qs}}}Ks._$name="CalendarModel";class ho extends he(ps.derive(Rn)){static get defaultConfig(){return{tree:!0,modelClass:Ks,loadPriority:100,syncPriority:100,storeId:"calendars"}}}ho._$name="CalendarManagerStore";class mn extends he($s.derive(Uo)){static get $name(){return"DependencyModel"}static get isProDependencyModel(){return!0}get fromEvent(){var e;return(e=this.project)!==null&&e!==void 0&&e.isDelayingCalculation?this.project.eventStore.getById(super.fromEvent):super.fromEvent}set fromEvent(e){super.fromEvent=e}get toEvent(){var e;return(e=this.project)!==null&&e!==void 0&&e.isDelayingCalculation?this.project.eventStore.getById(super.toEvent):super.toEvent}set toEvent(e){super.toEvent=e}}mn._$name="DependencyModel";class fo extends he(Ho(gs.derive(Rn))){static get defaultConfig(){return{modelClass:mn}}}fo._$name="DependencyStore";var po=o=>class extends o{static get $name(){return"PercentDoneMixin"}get isStarted(){return this.percentDone>0}get isCompleted(){return this.percentDone>=100}get isInProgress(){return this.isStarted&&!this.isCompleted}copy(){const t=super.copy(...arguments);return t.percentDone=0,t.clearChanges(),t}get renderedPercentDone(){const t=typeof this.percentDone=="number"&&!isNaN(this.percentDone)?this.percentDone:0;return this.getFormattedPercentDone(t)}getFormattedPercentDone(t=0){return t<=99?Math.round(t):Math.floor(t)}set renderedPercentDone(t){this.percentDone=t}};class go extends js.derive(qo).mixin(Ko,po){static get $name(){return"EventSegmentModel"}get task(){return this.event}}go._$name="EventSegmentModel";class Qs extends wr{get type(){return"EventUpdateAction"}construct(e){let{model:t,newData:i,oldData:s}=e;if(i.segments&&s.segments){s={...s},i={...i};const n=s.segments.slice(),r=i.segments.slice();let a=!1;s.segments.forEach((l,c)=>{const d=i.segments.indexOf(l);d>-1&&(n[c]=r[d]=l,a=!0)}),a&&(s.segments=n,i.segments=r)}return super.construct({model:t,newData:i,oldData:s})}}Qs._$name="EventUpdateAction";class oi extends he(Qo(Gs.derive(gl))){static get $name(){return"ResourceModel"}get assigned(){var i;var e;const{project:t}=this;return t!=null&&(e=t.assignmentStore.storage._indices)!==null&&e!==void 0&&e.resource?(i=t.assignmentStore.storage.findItem("resource",this))!=null?i:new Set:super.assigned}set assigned(e){super.assigned=e}}oi._$name="ResourceModel";class mo extends he(Xo(Ss.derive(Rn))){static get defaultConfig(){return{modelClass:oi}}}mo._$name="ResourceStore";const Xl=(o,e,t)=>o.isSplitEventMixin?new Qs({model:o,newData:e,oldData:t}):new wr({model:o,newData:e,oldData:t});class yo extends Si{static get defaultConfig(){return{makeModelUpdateAction:Xl}}}yo._$name="StateTrackingManager";class jt extends pe(ut){static get $name(){return"VersionModel"}onBeforeSave(){}get description(){var e;return(e=this.name)!=null?e:this.defaultDescription}get defaultDescription(){return`${this.isAutosave?"Auto-saved":"Saved"} at ${I.format(this.savedAt,this.L("L{Versions.versionDateFormat}"))}`}}B(jt,"fields",[{name:"name",type:"string"},{name:"isAutosave",type:"boolean"},{name:"content",type:"object"},{name:"savedAt",type:"date"}]),jt.exposeProperties(),jt._$name="VersionModel";class At extends xe.mixin(he){}B(At,"$name","VersionStore"),B(At,"configurable",{modelClass:jt,storeId:"versions"}),At._$name="VersionStore";class at extends pe(ut){get description(){var e;return(e=this.get("description"))!=null?e:this.defaultDescription}get actions(){var e;return(e=this.get("actions"))!=null?e:[]}get defaultDescription(){var d,u;if(this.actions.length===0)return this.L("L{Versions.noChanges}");const e=this,t=ht.unique(e.actions.map(({actionType:h})=>h.startsWith("add")?"add":h.startsWith("remove")?"remove":h.startsWith("update")?"update":h)),i=ht.unique(e.actions.map(({entity:h})=>h.type)),s=ht.unique(e.actions.map(({entity:h})=>`${h.type}.${h.id}`)).length,n=e.L("L{Versions.transactionDescriptions}"),r=e.L("L{Versions.entityNames}"),a=e.L("L{Versions.entityNamesPlural}"),l=i[0],c=i.length>1;return n[t.length>1?"mixed":t[0]].replace("{n}",s).replace("{entities}",s>1?(d=a[c?"other":l])!=null?d:a.other:(u=r[l])!=null?u:r.other)}}B(at,"$name","ChangeLogTransactionModel"),B(at,"fields",[{name:"versionId"},{name:"actions",type:"array"},{name:"occurredAt",type:"date"},{name:"description",type:"string"}]),at.exposeProperties(),at._$name="ChangeLogTransactionModel";class Ft extends xe.mixin(he){}B(Ft,"$name","ChangeLogStore"),B(Ft,"configurable",{modelClass:at,storeId:"changelogs"}),Ft._$name="ChangeLogStore";var Jl=o=>class extends(o||de).mixin(Jo){static get configurable(){return{crudLoadValidationWarningPrefix:"Project load response error(s):",crudSyncValidationWarningPrefix:"Project sync response error(s):",trackProjectModelChanges:!1}}construct(...t){const i=this;super.construct(...t),i.addPrioritizedStore(i.calendarManagerStore),i.addPrioritizedStore(i.assignmentStore),i.addPrioritizedStore(i.dependencyStore),i.addPrioritizedStore(i.resourceStore),i.addPrioritizedStore(i.eventStore),i.timeRangeStore&&i.addPrioritizedStore(i.timeRangeStore),i.resourceTimeRangeStore&&i.addPrioritizedStore(i.resourceTimeRangeStore)}get project(){return this}set project(t){super.project=t}get crudLoadValidationMandatoryStores(){return[this.getStoreDescriptor(this.eventStore).storeId]}loadCrudManagerData(...t){this.delayCalculation&&!this.isDelayingCalculation&&!this.usingSyncDataOnLoad()&&this.scheduleDelayedCalculation(),super.loadCrudManagerData(...t)}acceptChanges(){super.acceptChanges(),this.clearChanges(!0,!1)}revertChanges(){this.revertCrudStoreChanges(),this.set(this.meta.modified,void 0,!0)}crudStoreHasChanges(t){const i=this.getCrudStore(t);let s;return i?s=super.crudStoreHasChanges(i):s=this.hasPersistableChanges||super.crudStoreHasChanges(),s}get changes(){let t=super.changes;if(this.trackProjectModelChanges){const i=this.modificationDataToWrite;i&&(t=t||{},t.project=i)}return t}shouldClearRecordFieldChange(t,i,s){return t.isCalendarModel&&i==="intervals"?!t.get("intervals").changes:super.shouldClearRecordFieldChange(...arguments)}};class li extends ll{static get $name(){return"EventResize"}render(){const e=this,{client:t}=e;super.render(...arguments),e.dragSelector=e.dragItemSelector=t.eventSelector+":not(.b-sch-event-segment)"}}li._$name="EventResize",De.registerFeature(li,!0,"SchedulerPro");class yn extends li{static get pluginConfig(){return{chain:[...super.pluginConfig.chain,"isEventSegmentElementDraggable"]}}render(){super.render(...arguments),this.dragSelector=this.dragItemSelector=".b-sch-event-segment"}isEventSegmentElementDraggable(e,t,i,s){return this.isEventElementDraggable(...arguments)}isEventElementDraggable(e,t,i,s){const n=this,r=t==null?void 0:t.resizable;if(n.disabled||!r||t.isMilestone)return!0;if(t.segments){const a=n.client.scheduledEventName;return t.segments.every((l,c)=>{const d=l.resizable,u=Ce.getChild(e,`${a}.segments.${c}`);return!d||(d!==!0&&d!=="start"||!n.isOverStartHandle(s,u))&&(d!==!0&&d!=="end"||!n.isOverEndHandle(s,u))})}return super.isEventElementDraggable(...arguments)}get tipId(){return`${this.client.id}-event-segment-resize-tip`}dragStart(e){return this._segmentsSlices=null,this._segmentsSlicesIndex=0,super.dragStart(...arguments)}beginEventRecordBatch(e){super.beginEventRecordBatch(e),e.isEventSegment&&e.event.beginBatch()}triggerBeforeResize(e){const{client:t}=this,i=t.scheduledEventName,s=t.resolveTimeSpanRecord(e.itemElement);return t.trigger(`before${t.capitalizedEventName}SegmentResize`,{[i+"Record"]:s,event:e.event,...this.getBeforeResizeParams({event:e.startEvent,element:e.itemElement})})}triggerEventResizeStart(e,t){const{client:i}=this;i.trigger(`${i.scheduledEventName}SegmentResizeStart`,t)}triggerEventResizeEnd(e,t){const{client:i}=this;i.trigger(`${i.scheduledEventName}SegmentResizeEnd`,t)}triggerEventPartialResize(e,t){const{client:i}=this;i.trigger(`${i.scheduledEventName}SegmentPartialResize`,t)}triggerBeforeEventResizeFinalize(e,t){const{client:i}=this;i.trigger(`before${i.capitalizedEventName}SegmentResizeFinalize`,t)}applyDateConstraints(e,t,i){var s,n;let r=(s=i.dateConstraints)===null||s===void 0?void 0:s.start,a=(n=i.dateConstraints)===null||n===void 0?void 0:n.end;if(t.isEventSegment){const{previousSegment:l,nextSegment:c}=t;l&&(r=r?I.max(l.endDate,r):l.endDate),c&&(a=a?I.min(c.startDate,a):c.startDate)}return(r||a)&&(e=I.constrain(e,r,a),i.snappedDate=I.constrain(i.snappedDate,r,a)),e}resizeEventPartiallyInternal(e,t){const{toSet:i}=t;if(super.resizeEventPartiallyInternal(...arguments),e.isEventSegment){const{event:s}=e;if(!e.nextSegment&&i==="endDate")s.set("endDate",t[i]);else if(!e.previousSegment&&i==="startDate")s.set("startDate",t[i]);else{const n=s.fieldMap.segments;n._skipSegmentsIsEqual++,s.set("segments",s.get("segments")),n._skipSegmentsIsEqual--}}}cancelEventRecordBatch(e){super.cancelEventRecordBatch(e),e.isEventSegment&&e.event.cancelBatch()}highlightHandle(){const{overItem:e}=this;e.classList.add("b-resize-handle","b-over-resize-handle")}unHighlightHandle(e=this.overItem){e==null||e.classList.remove("b-resize-handle",this.resizingItemInnerCls,"b-over-resize-handle",this.draggingItemCls)}}B(yn,"$name","EventSegmentResize"),yn._$name="EventSegmentResize",De.registerFeature(yn,!0,"SchedulerPro"),De.registerFeature(yn,!1,"ResourceHistogram");class ot extends Tn{onElementMouseOut(e){const t=this,{client:i}=t,{target:s,relatedTarget:n}=e,r=s.closest(i.eventSelector),a=i.resolveTimeSpanRecord(s);a!=null&&a.isEventSegment&&r&&i.hoveredEvents.has(r)&&n&&Vt.isDescendant(r,n)||this.overridden.onElementMouseOut(...arguments)}getElementsFromEventRecord(e,t){if(e!=null&&e.isEventSegment){const i=this.overridden.getElementsFromEventRecord(e.event,t)[0];return[Ce.getChild(i,"segments."+e.segmentIndex)]}return this.overridden.getElementsFromEventRecord(...arguments)}resolveEventRecord(e){var t;const i=e instanceof Event?e.target:e,s=i==null?void 0:i.closest(".b-sch-event-segment");let n=this.overridden.resolveEventRecord(e);return(t=n)!==null&&t!==void 0&&t.segments&&s&&(n=n.segments[s.dataset.segment]),n}resolveTaskRecord(e){var t;const i=e==null?void 0:e.closest(".b-sch-event-segment");let s=this.overridden.resolveTaskRecord(e);return(t=s)!==null&&t!==void 0&&t.segments&&i&&(s=s.segments[i.dataset.segment]),s}populateTaskMenu(e){e.eventRecord=e.taskRecord,e.targetElement.closest(e.feature.client.eventSelector)&&this.populateEventMenu(e)}populateEventMenu({eventRecord:e,taskRecord:t,items:i,domEvent:s}){const n=this;if(!n.client.readOnly&&!e.isParent&&!e.milestone){i[`split${t?"Task":"Event"}`]={localeClass:n,text:`L{split${t?"Task":"Event"}}`,icon:"b-icon b-icon-cut",disabled:e.readOnly,weight:650,separator:!0,onItem(a){n.splitEvent(a)}};const r=s.target.closest(".b-sch-event-segment");if(r){const a=n.client.resolveEventRecord(r);i.renameSegment={localeClass:n,text:"L{renameSegment}",icon:"b-icon b-icon-rename",disabled:e.readOnly||a.readOnly,weight:660,onItem(){n.rename(a,r)}}}}}getSplitDate(e){const{eventRecord:t,date:i,timeAxis:s}=e;return s.roundDate(i,t.startDate)}getSplitDuration(e){const{splitDuration:t,minSplitDuration:i,maxSplitDuration:s}=this;if(t!=null&&t.magnitude)return t.magnitude;const{eventRecord:n,tick:r}=e;if(r){const a=this.getSplitDurationUnit(e),{project:l}=n;let c=r.endDate-r.startDate;if(s){const d=l.run("$convertDuration",s.magnitude,s.unit||a,"millisecond");c=Math.min(c,d)}if(i){const d=l.run("$convertDuration",i.magnitude,i.unit||a,"millisecond");c=Math.max(c,d)}return l.run("$convertDuration",c,"millisecond",a)}}getSplitDurationUnit(e){const{splitDuration:t}=this;return(t==null?void 0:t.unit)||e.eventRecord.durationUnit}splitEvent(e){const{client:t}=e.feature,{timeAxis:i}=t;e.date=t.getDateFromXY(e.point,void 0,!1),e.tick=i.getAt(Math.floor(i.getTickFromDate(e.date))),e.timeAxis=i,e.eventRecord.splitToSegments(this.getSplitDate(e),this.getSplitDuration(e),this.getSplitDurationUnit(e))}rename(e,t){const{client:i}=this;new Zo({owner:i,appendTo:i.timeAxisSubGridElement,scrollAction:"realign",align:{align:"c-c"},cls:"b-event-segment-renamer",internalListeners:{complete(){i.refresh()},thisObj:this}}).startEdit({target:t,record:e,field:"name"})}doDisable(e){this.client.isPainted&&this.client.refresh(),super.doDisable(e)}generateSegmentRenderData(e,t){let i,s;if(this.client.isGantt){const r=this.client.currentOrientation,a=r.getTaskBox(e),l={taskRecord:e,task:e,row:t.row,children:[]};a&&Object.assign(l,{isTask:!0,top:a.top,left:a.left,width:a.width,height:a.height}),r.internalPopulateTaskRenderData(l,e),s=l}else s=this.client.generateRenderData(e,t.resourceRecord,!0);if(s){var n;const{eventColor:r}=s;i={segmentRecord:e,eventContent:s.eventContent||s.taskContent,cls:s.cls||((n=e.cls)===null||n===void 0?void 0:n.clone())||new Yo,top:t.top,left:s.left-t.left,width:s.width,height:t.height,style:""},Object.assign(i.cls,{"b-sch-event-segment":!0,"b-first":!e.previousSegment,"b-last":!e.nextSegment},s.cls),Vt.isNamedColor(r)?i.cls[`b-sch-color-${r}`]=r:r?(i.style=`background-color:${r};`+i.style,i.cls["b-sch-custom-color"]=1):t.wrapperCls["b-sch-color-none"]=1}return i}appendDOMConfig(e){const t=e.eventRecord||e.taskRecord;if(t.segments&&!this.disabled){const i=e.eventContent||e.taskContent,s=e.children.indexOf(i);s>-1&&e.children.splice(s,1),delete e.eventContent,delete e.taskContent,e.cls["b-segmented"]=!0,e.segments=t.segments.map(n=>this.generateSegmentRenderData(n,e)),e.segmentsDOMConfig=e.segments.map(this.getSegmentDOMConfig.bind(this)),e.children.unshift({syncOptions:{syncIdField:"segment",releaseThreshold:0},className:"b-sch-event-segments",dataset:{taskBarFeature:"segments"},children:e.segmentsDOMConfig})}}getSegmentDOMConfig(e,t){return{className:e.cls,style:{style:e.style,left:e.left,height:e.height,width:e.width},dataset:{segment:t},syncOptions:{syncIdField:"taskBarFeature"},children:[e.eventContent]}}onEventDataGenerated(e){this.appendDOMConfig(e)}onTaskDataGenerated(e){this.appendDOMConfig(e)}get featureClass(){}}B(ot,"$name","EventSegments"),B(ot,"configurable",{splitDuration:0,maxSplitDuration:{magnitude:1,unit:"day"},minSplitDuration:0}),B(ot,"pluginConfig",{override:["getElementsFromEventRecord","resolveEventRecord","resolveTaskRecord","onElementMouseOut"],chain:["populateTaskMenu","populateEventMenu","onTaskDataGenerated","onEventDataGenerated"]}),ot._$name="EventSegments",De.registerFeature(ot,!0,"SchedulerPro"),De.registerFeature(ot,!0,"Gantt");function lt(o){return`b-task-percent-bar${o[0]?`-${o[0]}`:""}`}class ci extends Tn{static get $name(){return"PercentBar"}static get configurable(){return{allowResize:!0,showPercentage:!0,instantUpdate:!0,valueField:"percentDone",displayField:"renderedPercentDone"}}static get pluginConfig(){return{chain:["onPaint",{fn:"onTaskDataGenerated",prio:-1e4},{fn:"onEventDataGenerated",prio:-1e4}]}}onPaint({firstPaint:e}){if(e){const t=this,{client:i}=t;t.drag=new cl({name:"percentBarHandle",lockX:i.isVertical,lockY:i.isHorizontal,targetSelector:`${i.eventSelector} .b-task-percent-bar-handle`,dragThreshold:1,outerElement:i.timeAxisSubGridElement,internalListeners:{beforeDragStart:"onBeforeDragStart",dragStart:"onDragStart",drag:"onDrag",drop:"onDrop",abort:"onDragAbort",thisObj:t}}),t.detachListeners("view"),t.client.ion({name:"view",[`${i.scheduledEventName}mouseenter`]:"onTimeSpanMouseEnter",[`${i.scheduledEventName}mouseleave`]:"onTimeSpanMouseLeave",thisObj:t})}}get sizeProp(){return this.client.isVertical?"height":"width"}get offsetSizeProp(){return this.client.isVertical?"offsetHeight":"offsetWidth"}get positionProp(){return this.client.isVertical?"top":this.client.rtl?"right":"left"}get offsetPositionProp(){return this.client.isVertical?"offsetTop":this.client.rtl?"offsetRight":"offsetLeft"}updateAllowResize(e){this.client.element.classList.toggle(lt`drag-disabled`,!e)}updateShowPercentage(e){this.client.element.classList.toggle(lt`show-percentage`,!!e)}doDestroy(){var e;(e=this.drag)===null||e===void 0||e.destroy(),super.doDestroy()}doDisable(e){this.client.isPainted&&this.client.refresh(),super.doDisable(e)}reset(e){const t=this,{project:i}=t.client;if(t.client.element.classList.remove(lt`resizing-task`),t.isMouseInsideEvent||(t.handle.remove(),t.handle=null),t.instantUpdate){const{stm:s}=i;s.disabled||(t._stmTransactionStarted&&(e.valid?s.stopTransaction():s.rejectTransaction()),s.autoRecord=t.oldStmAutoRecord,t._stmTransactionStarted=!1),i.resumeAutoSync(),t.client.eventStore.resumeAutoCommit()}}getPercentBarDOMConfig(e){return{className:lt`outer`,dataset:{taskBarFeature:"percentBar"},children:[{className:lt``,dataset:{percent:e[this.displayField]},style:{[this.sizeProp]:e[this.valueField]+"%"}}]}}appendDOMConfig(e,t,i){if((e.isEvent||e.isTask)&&!e.isMilestone&&!this.disabled){const{eventSegments:s}=this.client.features;e.isSegmented&&s!==null&&s!==void 0&&s.enabled?e.segments.forEach((n,r)=>{i.segmentsDOMConfig[r].children.unshift(this.getPercentBarDOMConfig(n))}):t.unshift(this.getPercentBarDOMConfig(e))}}onEventDataGenerated(e){this.appendDOMConfig(e.eventRecord,e.children,e)}onTaskDataGenerated(e){this.appendDOMConfig(e.taskRecord,e.children,e)}getHoverSegment(e){const t=(e.toElement||e.target).closest(".b-sch-event-segment");if(t){const i=Nt.from(t);if(i!=null&&i.contains(el.getPagePoint(e)))return t}}isOverSegment(e){return!!this.getHoverSegment(e)}onTimeSpanMouseEnter(e){const t=this,{client:i,sizeProp:s}=t,n=e[`${i.scheduledEventName}Record`];if(!(n.isMilestone||n.readOnly||t.disabled||n.isParent||!n.isEditable(t.valueField)))if(t.drag.context)n===t.drag.context.taskRecord&&(t.isMouseInsideEvent=!0);else{const r=e[`${i.scheduledEventName}Element`],a=Ce.getChild(r,i.scheduledEventName);if(!t.handle){const l={percent:n[t.valueField]};let c=n[t.valueField]+"%";const{eventSegments:d}=i.features;if(n.isSegmented&&d!==null&&d!==void 0&&d.enabled){l.segment=0;const u=Nt.from(a);let h,f;n.segments.some((p,g)=>{if(!p[t.valueField]&&h!==100)return!0;h=p[t.valueField],l.segment=g;const m=Ce.getChild(a,`segments.${g}.percentBar`).firstChild;f=Nt.from(m)}),i.isVertical?c=f?f.top+f[s]-u.top:0:i.rtl?c=f?f.right+f[s]-u.right:0:c=f?f.left+f[s]-u.left:0}t.handle=Vt.createElement({parent:a,className:lt`handle`,style:{[t.positionProp]:c},dataset:l})}t.isMouseInsideEvent=!0}}onTimeSpanMouseLeave(e){const t=this;!t.drag.context&&t.handle&&e.event.toElement!==t.handle&&(t.handle.remove(),t.handle=null),t.isMouseInsideEvent=!1}onBeforeDragStart({source:e,context:t,event:i}){const{client:s,offsetPositionProp:n,offsetSizeProp:r}=this,{eventSegments:a}=s.features,{element:l}=t,c=s.resolveEventRecord(l);let d,u,h,f;if(c.isSegmented&&a!==null&&a!==void 0&&a.enabled){const p=l.dataset.segment;d=Ce.getChild(l.parentElement,`segments.${p}.percentBar`),u=d.firstElementChild,f=l.parentElement[r],h=Ce.getChild(l.parentElement,`segments.${p}`)[n]+u[r]}else d=Ce.getChild(l.parentElement,"percentBar"),u=d.firstElementChild,f=d[r],h=u[r];s.isVertical?(e.minY=-h,e.maxY=f-h):s.rtl?(e.maxX=h,e.minX=-(f-h)):(e.minX=-h,e.maxX=f-h),Object.assign(t,{percentBar:u,initialPos:h,size:f,taskRecord:c,initialValue:c[this.valueField],domEvent:i})}onDragStart({context:e,event:t}){const{client:i}=this,{project:s}=i;i.element.classList.add(lt`resizing-task`),e.element.retainElement=!0,e.domEvent=t,i.trigger("percentBarDragStart",e),this.instantUpdate&&(s.suspendAutoSync(),i.eventStore.suspendAutoCommit(),s.stm.disabled||(this.oldStmAutoRecord=s.stm.autoRecord,s.stm.autoRecord=!1))}onDrag({context:e,event:t}){const i=this,{sizeProp:s,offsetSizeProp:n,client:r}=i,a=r.isHorizontal?Math.round((e.initialPos+e.newX*(r.rtl?-1:1))/e.size*100):Math.round((e.initialPos+e.newY)/e.size*100),{eventSegments:l}=r.features;if(i.instantUpdate){const{stm:c}=r.project;!c.disabled&&!c.transaction&&(c.startTransaction(),i._stmTransactionStarted=!0),e.taskRecord[i.valueField]=a}e.domEvent=t,e.percent=e.element.dataset.percent=a,e.taskRecord.isSegmented&&l!==null&&l!==void 0&&l.enabled&&e.taskRecord.segments.forEach((c,d)=>{const u=Ce.getChild(e.element.parentElement,`segments.${d}.percentBar`).firstChild,h=Ce.getChild(e.element.parentElement,`segments.${d}`);if(e.percent>=c.endPercentDone)u.style[s]=h[n]+"px";else if(e.percent<=c.startPercentDone)u.style[s]="0";else if(e.percent>=c.startPercentDone&&e.percent<=c.endPercentDone){const f=c.endPercentDone-c.startPercentDone;u.style[s]=(a-c.startPercentDone)*h[n]/f+"px"}}),r.trigger("percentBarDrag",e)}onDragAbort({context:e,event:t}){e.taskRecord.isSegmented&&(e.percentBar.style[this.sizeProp]=e.taskRecord.segments[e.element.dataset.segment][this.valueField]+"%"),e.taskRecord[this.valueField]=e.initialValue,e.domEvent=t,this.reset(e),this.client.trigger("percentBarDragAbort",e)}onDrop({context:e}){const t=this,{taskRecord:i}=e,{eventSegments:s}=t.client.features;i[t.valueField]=e.percent,i.isSegmented&&s!==null&&s!==void 0&&s.enabled?i.segments.some((n,r)=>{if(e.percent>=n.startPercentDone&&e.percent<=n.endPercentDone){const a=n.endPercentDone-n.startPercentDone,l=Ce.getChild(e.element.parentElement,`segments.${r}`),c=parseInt(l.style[t.sizeProp])+(e.percent-n.startPercentDone)*l[t.offsetSizeProp]/a;return e.element.style.cssText=`${t.positionProp}: ${c}px`,e.element.dataset.segment=r,!0}}):e.element.style.cssText=`${t.positionProp}: ${t.client.rtl?100-e.percent:e.percent}%`,t.reset(e),t.client.trigger("percentBarDrop",e)}get featureClass(){}}ci._$name="PercentBar",De.registerFeature(ci,!1,"SchedulerPro"),De.registerFeature(ci,!0,"Gantt");var Xs=o=>class extends(o||tl(de)){get isReadyStatePropagator(){return!0}get canSave(){return!0}requestReadyStateChange(){this.trigger("readystatechange",{canSave:this.canSave})}get widgetClass(){}};const Zl={localeName:"En",localeDesc:"English (US)",localeCode:"en-US",ConstraintTypePicker:{none:"None",muststarton:"Must start on",mustfinishon:"Must finish on",startnoearlierthan:"Start no earlier than",startnolaterthan:"Start no later than",finishnoearlierthan:"Finish no earlier than",finishnolaterthan:"Finish no later than"},CalendarField:{"Default calendar":"Default calendar"},TaskEditorBase:{Information:"Information",Save:"Save",Cancel:"Cancel",Delete:"Delete",calculateMask:"Calculating...",saveError:"Can't save, please correct errors first",repeatingInfo:"Viewing a repeating event",editRepeating:"Edit"},TaskEdit:{"Edit task":"Edit task",ConfirmDeletionTitle:"Confirm deletion",ConfirmDeletionMessage:"Are you sure you want to delete the event?"},GanttTaskEditor:{editorWidth:"44em"},SchedulerTaskEditor:{editorWidth:"34em"},SchedulerGeneralTab:{labelWidth:"6em",General:"General",Name:"Name",Resources:"Resources","% complete":"% complete",Duration:"Duration",Start:"Start",Finish:"Finish",Effort:"Effort",Preamble:"Preamble",Postamble:"Postamble"},GeneralTab:{labelWidth:"6.5em",General:"General",Name:"Name","% complete":"% complete",Duration:"Duration",Start:"Start",Finish:"Finish",Effort:"Effort",Dates:"Dates"},SchedulerAdvancedTab:{labelWidth:"13em",Advanced:"Advanced",Calendar:"Calendar","Scheduling mode":"Scheduling mode","Effort driven":"Effort driven","Manually scheduled":"Manually scheduled","Constraint type":"Constraint type","Constraint date":"Constraint date",Inactive:"Inactive","Ignore resource calendar":"Ignore resource calendar"},AdvancedTab:{labelWidth:"11.5em",Advanced:"Advanced",Calendar:"Calendar","Scheduling mode":"Scheduling mode","Effort driven":"Effort driven","Manually scheduled":"Manually scheduled","Constraint type":"Constraint type","Constraint date":"Constraint date",Constraint:"Constraint",Rollup:"Rollup",Inactive:"Inactive","Ignore resource calendar":"Ignore resource calendar"},DependencyTab:{Predecessors:"Predecessors",Successors:"Successors",ID:"ID",Name:"Name",Type:"Type",Lag:"Lag",cyclicDependency:"Cyclic dependency",invalidDependency:"Invalid dependency"},NotesTab:{Notes:"Notes"},ResourcesTab:{unitsTpl:({value:o})=>`${o}%`,Resources:"Resources",Resource:"Resource",Units:"Units"},RecurrenceTab:{title:"Repeat"},SchedulingModePicker:{Normal:"Normal","Fixed Duration":"Fixed Duration","Fixed Units":"Fixed Units","Fixed Effort":"Fixed Effort"},ResourceHistogram:{barTipInRange:'<b>{resource}</b> {startDate} - {endDate}<br><span class="{cls}">{allocated} of {available}</span> allocated',barTipOnDate:'<b>{resource}</b> on {startDate}<br><span class="{cls}">{allocated} of {available}</span> allocated',groupBarTipAssignment:'<b>{resource}</b> - <span class="{cls}">{allocated} of {available}</span>',groupBarTipInRange:'{startDate} - {endDate}<br><span class="{cls}">{allocated} of {available}</span> allocated:<br>{assignments}',groupBarTipOnDate:'On {startDate}<br><span class="{cls}">{allocated} of {available}</span> allocated:<br>{assignments}',plusMore:"+{value} more"},ResourceUtilization:{barTipInRange:'<b>{event}</b> {startDate} - {endDate}<br><span class="{cls}">{allocated}</span> allocated',barTipOnDate:'<b>{event}</b> on {startDate}<br><span class="{cls}">{allocated}</span> allocated',groupBarTipAssignment:'<b>{event}</b> - <span class="{cls}">{allocated}</span>',groupBarTipInRange:'{startDate} - {endDate}<br><span class="{cls}">{allocated} of {available}</span> allocated:<br>{assignments}',groupBarTipOnDate:'On {startDate}<br><span class="{cls}">{allocated} of {available}</span> allocated:<br>{assignments}',plusMore:"+{value} more",nameColumnText:"Resource / Event"},SchedulingIssueResolutionPopup:{"Cancel changes":"Cancel the change and do nothing",schedulingConflict:"Scheduling conflict",emptyCalendar:"Calendar configuration error",cycle:"Scheduling cycle",Apply:"Apply"},CycleResolutionPopup:{dependencyLabel:"Please select a dependency:",invalidDependencyLabel:"There are invalid dependencies involved that need to be addressed:"},DependencyEdit:{Active:"Active"},SchedulerProBase:{propagating:"Calculating project",storePopulation:"Loading data",finalizing:"Finalizing results"},EventSegments:{splitEvent:"Split event",renameSegment:"Rename"},NestedEvents:{deNestingNotAllowed:"De-nesting not allowed",nestingNotAllowed:"Nesting not allowed"},VersionGrid:{compare:"Compare",description:"Description",occurredAt:"Occurred At",rename:"Rename",restore:"Restore",stopComparing:"Stop Comparing"},Versions:{entityNames:{TaskModel:"task",AssignmentModel:"assignment",DependencyModel:"link",ProjectModel:"project",ResourceModel:"resource",other:"object"},entityNamesPlural:{TaskModel:"tasks",AssignmentModel:"assignments",DependencyModel:"links",ProjectModel:"projects",ResourceModel:"resources",other:"objects"},transactionDescriptions:{update:"Changed {n} {entities}",add:"Added {n} {entities}",remove:"Removed {n} {entities}",move:"Moved {n} {entities}",mixed:"Changed {n} {entities}"},addEntity:"Added {type} **{name}**",removeEntity:"Removed {type} **{name}**",updateEntity:"Changed {type} **{name}**",moveEntity:"Moved {type} **{name}** from {from} to {to}",addDependency:"Added link from **{from}** to **{to}**",removeDependency:"Removed link from **{from}** to **{to}**",updateDependency:"Edited link from **{from}** to **{to}**",addAssignment:"Assigned **{resource}** to **{event}**",removeAssignment:"Removed assignment of **{resource}** from **{event}**",updateAssignment:"Edited assignment of **{resource}** to **{event}**",noChanges:"No changes",nullValue:"none",versionDateFormat:"M/D/YYYY h:mm a",undid:"Undid changes",redid:"Redid changes",editedTask:"Edited task properties",deletedTask:"Deleted a task",movedTask:"Moved a task",movedTasks:"Moved tasks"}};Sr.publishLocale(Zl);class vn extends Er.mixin(Xs){static get $name(){return"TaskEditorBase"}static get type(){return"taskeditorbase"}static get configurable(){return{localizableProperties:["width"],title:"L{Information}",cls:"b-schedulerpro-taskeditor",closable:!0,layout:"fit",draggable:{handleSelector:":not(button,.b-field-inner)"},items:null,bbar:{hideWhenEmpty:!0,defaults:{localeClass:this},items:{saveButton:{text:"L{Save}",color:"b-blue",cls:"b-raised",weight:100},deleteButton:{text:"L{Delete}",weight:200},cancelButton:{text:"L{Object.Cancel}",weight:300}}},strips:{occurrenceInfoToolbar:{cls:"occurrence-info-toolbar",hidden:!0,ignoreParentReadOnly:!0,items:[{type:"widget",tag:"i",cls:"b-icon b-icon-locked"},{ref:"occurrenceInfoText",type:"label",localeClass:this,text:"L{repeatingInfo}"},"->",{ref:"editOccurrenceButton",localeClass:this,text:"L{editRepeating}",onClick:"up.onEditOccurrenceClick"}]}},width:{$config:{localeKey:"L{editorWidth}"}}}}static get defaultConfig(){return{axisLock:"flexible",autoClose:!0,onChange:null,onCancel:null,onSave:null,autoShow:!1,blurAction:"cancel",scrollAction:"realign",durationDisplayPrecision:1,tabPanelItems:null,defaultTabs:null,calculateMask:null,calculateMaskDelay:100,localizableProperties:["calculateMask"],project:null,dependencyIdField:null}}processWidgetConfig(e){var t;if((t=e.type)!==null&&t!==void 0&&t.includes("date")&&e.weekStartDay==null&&(e.weekStartDay=this.weekStartDay),e.ref==="tabs"&&this.extraItems){const i={};for(const s in this.extraItems){const n=s.replace("tab","Tab");i[n]={items:Array.isArray(this.extraItems[s])?K.transformArrayToNamedObject(this.extraItems[s]):this.extraItems[s]}}K.merge(e.items,i)}return e}changeItems(e){const{tabPanelItems:t={}}=this,i=K.clone(e),s=i.find(n=>n.ref==="tabs");return this.cleanItemsConfig(t),K.merge(s.items,t),super.changeItems(i)}cleanItemsConfig(e){for(const t in e){const i=e[t];i===!0?delete e[t]:i!=null&&i.items&&this.cleanItemsConfig(i.items)}}afterConfigure(){var e;const t=this,{widgetMap:i}=t,{tabs:s}=i,{cancelButton:n,deleteButton:r,saveButton:a}=((e=t.bbar)===null||e===void 0?void 0:e.widgetMap)||{};a==null||a.ion({click:"onSaveClick",thisObj:t}),n==null||n.ion({click:"onCancelClick",thisObj:t}),r==null||r.ion({click:"onDeleteClick",thisObj:t}),Object.values(i).forEach(l=>{l.isDurationField?l.decimalPrecision=this.durationDisplayPrecision:l.ref==="startDate"||l.ref==="endDate"?l.project=this.project:(l.ref==="predecessorsTab"||l.ref==="successorsTab")&&(l.grid.durationDisplayPrecision=this.durationDisplayPrecision,l.dependencyIdField=l.dependencyIdField||t.dependencyIdField),l.isReadyStatePropagator&&l.ion({readyStateChange:"onReadyStateChange",thisObj:t})}),s.onFieldChange=({source:l})=>{const{name:c,isValid:d,value:u}=l;t.loadedRecord&&c&&d&&!t.isLoadingEvent&&!l.up("recurrenceeditorpanel")&&(t.loadedRecord[c]=u)}}get canSave(){let e=!0;return Object.values(this.widgetMap).forEach(t=>{t.isReadyStatePropagator&&(e=e&&t.canSave)}),e}async hide(){const e=this;e.detachListeners("project"),e.detachListeners("eventStore"),e._delayedAction=null;const t=await super.hide(this.element.matches(":focus-within"));return e.isDestroyed||e.trigger(e.blurAction),t}toggleFieldsDisabled(e){this.eachWidget(t=>{t.isField&&t.name&&!t.up("recurrenceeditorpanel")&&e.isEditable(t.name)!==void 0&&(t.disabled=!e.isEditable(t.name))})}loadEvent(e,t=!1){var n;const i=this,s=(n=i.project)!=null?n:e.project;i.isLoadingEvent=!0,i.widgetMap.occurrenceInfoToolbar.hidden=!e.isOccurrence&&!e.isRecurring||i.editingRecurring,i.toggleFieldsDisabled(e),i.callWidgetHook("loadEvent",e,t),i.detachListeners("project"),i.loadedRecord=e,s.ion({name:"project",beforeCommit:"onProjectBeforeCommit",dataReady:"onProjectDataReady",thisObj:i}),i.detachListeners("eventStore"),s.eventStore.ion({name:"eventStore",remove:"onTaskRemove",thisObj:i}),i.isLoadingEvent=!1,i.trigger("loadEvent")}callWidgetHook(e,...t){this.eachWidget(i=>{typeof i[e]=="function"&&i[e](...t)})}onDocumentMouseDown(e){const t=this,i=Object.values(t.widgetMap).some(n=>n._activeCellEdit);let s=null;if(i){const{event:n}=e,{saveButton:r,cancelButton:a,deleteButton:l}=t.widgetMap,c=n.target.closest("button");if(c)switch(c){case(r==null?void 0:r.element):s=t.onSaveClick;break;case(a==null?void 0:a.element):s=t.onCancelClick;break;case(l==null?void 0:l.element):s=t.onDeleteClick;break}}t._delayedAction=s,super.onDocumentMouseDown(e)}onSaveClick(){const e=this;e._delayedAction=null,e.canSave?e.trigger("save"):nl.show({rootElement:e.rootElement,html:e.L("L{saveError}")})}onCancelClick(){this.close()}onDeleteClick(){this._delayedAction=null,this.trigger("delete")}onPropagationRequested(){this.trigger("requestPropagation")}onReadyStateChange({source:e,canSave:t}){this.requestReadyStateChange(),e.couldSaveTitle||(e.couldSaveTitle=e.title),e.parent===this.widgetMap.tabs&&(t?(e.tab.element.classList.remove("b-invalid"),e.tab.icon=null,e.title=e.couldSaveTitle,e.couldSaveTitle=null):(e.tab.element.classList.add("b-invalid"),e.tab.icon="b-icon-warning",e.title=e.couldSaveTitle))}onTaskRemove(){this.afterDelete()}onProjectBeforeCommit(){this.calculateMask&&this.mask({text:this.calculateMask,showDelay:this.calculateMaskDelay})}onProjectDataReady({records:e}){var t;const i=this;i.calculateMask&&i.unmask(),e.has(i.loadedRecord)&&i.callWidgetHook("afterProjectChange"),(t=i._delayedAction)===null||t===void 0||t.call(i)}beforeSave(){this.callWidgetHook("beforeSave")}afterSave(){this.loadedRecord=void 0,this.callWidgetHook("afterSave")}beforeCancel(){this.callWidgetHook("beforeCancel")}afterCancel(){this.loadedRecord=void 0,this.callWidgetHook("afterCancel")}beforeDelete(){this.callWidgetHook("beforeDelete")}afterDelete(){this.loadedRecord=void 0,this.callWidgetHook("afterDelete")}onInternalKeyDown(e){if(!e.handled&&e.key==="Enter"&&this.saveAndCloseOnEnter&&e.target.tagName.toLowerCase()==="input"){if(e.target.matches("input")){const t=Di.fromElement(e.target);t!=null&&t.internalOnChange&&!t.isCheckbox&&!t.isSlider&&t.internalOnChange()}e.preventDefault(),this.onSaveClick()}super.onInternalKeyDown(e)}onEditOccurrenceClick(){const e=this;Di.create({type:"recurrenceconfirmation",owner:e}).confirm({actionType:"update",eventRecord:e.loadedRecord,changerFn:i=>{var n;const s=(n=i.recurringTimeSpan)!=null?n:i;e.resetRecurrenceData={recurringTimeSpan:s,originalExceptionDates:{...s.exceptionDates}},i.isRecurring||(i.convertToRealEvent({startDate:i.startDate}),i.constraintDate=null)},finalizerFn:i=>{i.isRecurring&&(e.editingRecurring=!0,e.readOnly=!1),e.loadEvent(i)}})}updateReadOnly(e){const{deleteButton:t,saveButton:i,cancelButton:s,tabs:n}=this.widgetMap,{items:r}=n;super.updateReadOnly(e),t&&(t.hidden=e),i&&(i.hidden=e),s&&(s.hidden=e);for(let a=0,{length:l}=r;a<l;a++)r[a].readOnly=e}}vn.initClass(),vn._$name="TaskEditorBase";var vo=o=>class extends(o||br){get project(){var s;var t,i;return(s=(t=this.up(n=>n.isTaskEditorBase))===null||t===void 0?void 0:t.project)!=null?s:(i=this.record)===null||i===void 0?void 0:i.project}loadEvent(t,i){this.setRecord(t,i)}resetData(){this.record=null}beforeSave(){}afterSave(){this.resetData()}beforeCancel(){}afterCancel(){this.resetData()}beforeDelete(){}afterDelete(){this.resetData()}get widgetClass(){}};class kt extends br.mixin(vo,Xs){static get $name(){return"EditorTab"}static get type(){return"editortab"}static get configurable(){return{title:null,strictRecordMapping:!0}}}kt._$name="EditorTab";class We extends kt{static get $name(){return"FormTab"}static get type(){return"formtab"}static get defaultConfig(){return{layoutStyle:{flexFlow:"row wrap",alignItems:"flex-start",alignContent:"flex-start"},autoUpdateRecord:!0}}onFieldChange({source:e,valid:t,userAction:i}){i&&(t=t!==void 0?t:typeof e.isValid=="function"?e.isValid():e.isValid,t&&super.onFieldChange(...arguments))}}We.initClass(),We._$name="FormTab";const Yl=new Date(2300,0,1);class Js extends Pr{static get $name(){return"StartDateField"}static get type(){return"startdatefield"}static get alias(){return"startdate"}static get defaultConfig(){return{project:null,eventRecord:null,strictParsing:!0,minDateDelta:"-10 years",maxDateDelta:"200 years"}}get calendarProvider(){var t;var e;return((t=(e=this.eventRecord)===null||e===void 0?void 0:e.recurringEvent)!=null?t:this.eventRecord)||this.project}get backShiftDate(){const e=this;return e.calendarProvider.run("skipWorkingTime",e.value,!1,e._step.magnitude,e._step.unit)}get forwardShiftDate(){const e=this;let t=e.calendarProvider.run("skipWorkingTime",e.value,!0,e._step.magnitude,e._step.unit);return t=t&&e.calendarProvider.run("skipNonWorkingTime",t,!0),t}transformTimeValue(e){const{calendarProvider:t,keepTime:i}=this;if(t&&i!=="entered"){const s=I.clearTime(e),n=t.run("skipNonWorkingTime",s);if(I.isValidDate(n)&&I.isEqual(n,s,"day"))return I.copyTimeValues(s,n)}return super.transformTimeValue(e)}get min(){var e;return super.min||(e=this.project)!==null&&e!==void 0&&e.startDate?I.add(this.project.startDate,this.minDateDelta):null}set min(e){super.min=e}get max(){var e;return super.max||(e=this.project)!==null&&e!==void 0&&e.startDate?I.add(this.project.startDate,this.maxDateDelta):Yl}set max(e){super.max=e}}Js.initClass(),Js._$name="StartDateField";const ec=new Date(2300,0,1);class Zs extends Pr{static get $name(){return"EndDateField"}static get type(){return"enddatefield"}static get alias(){return"enddate"}static get defaultConfig(){return{project:null,eventRecord:null,strictParsing:!0}}get min(){var e;let t=this._min;const i=(e=this.eventRecord)===null||e===void 0?void 0:e.startDate;return i&&(t=I.max(t||i,i)),t}set min(e){super.min=e}get max(){var e;return super.max||(e=this.project)!==null&&e!==void 0&&e.startDate?I.add(this.project.startDate,200,"year"):ec}set max(e){super.max=e}get calendarProvider(){var t;var e;return((t=(e=this.eventRecord)===null||e===void 0?void 0:e.recurringEvent)!=null?t:this.eventRecord)||this.project}get backShiftDate(){const e=this;let t=e.calendarProvider.run("skipWorkingTime",e.value,!1,e._step.magnitude,e._step.unit);return t=t&&e.calendarProvider.run("skipNonWorkingTime",t,!1),t}get forwardShiftDate(){const e=this;return e.calendarProvider.run("skipWorkingTime",e.value,!0,e._step.magnitude,e._step.unit)}transformTimeValue(e){const{calendarProvider:t,keepTime:i}=this;if(t&&i!=="entered"){const s=I.clearTime(e),n=I.add(s,1,"day"),r=t.run("skipNonWorkingTime",n,!1);if(I.isValidDate(r)&&I.isEqual(r,s,"day"))return I.copyTimeValues(s,r)}return!i&&e&&this.min&&I.clearTime(e,!1)<this.min?this.min:super.transformTimeValue(e)}}Zs.initClass(),Zs._$name="EndDateField";class Ys extends dl{static get $name(){return"EffortField"}static get type(){return"effort"}static get alias(){return"effortfield"}}Ys.initClass(),Ys._$name="EffortField";class er extends We{static get $name(){return"GeneralTab"}static get type(){return"generaltab"}static get defaultConfig(){return{title:"L{General}",cls:"b-general-tab",defaults:{localeClass:this},items:{name:{type:"text",weight:100,required:!0,label:"L{Name}",clearable:!0,name:"name",cls:"b-name"},percentDone:{type:"number",weight:200,label:"L{% complete}",name:"renderedPercentDone",cls:"b-percent-done b-inline",flex:"1 0 50%",min:0,max:100},effort:{type:"effort",weight:300,label:"L{Effort}",name:"fullEffort",flex:"1 0 50%"},divider:{html:"",weight:400,dataset:{text:this.L("L{Dates}")},cls:"b-divider",flex:"1 0 100%"},startDate:{type:"startdate",weight:500,label:"L{Start}",name:"startDate",cls:"b-start-date b-inline",flex:"1 0 50%"},endDate:{type:"enddate",weight:600,label:"L{Finish}",name:"endDate",cls:"b-end-date b-last-row",flex:"1 0 50%"},duration:{type:"durationfield",weight:700,label:"L{Duration}",name:"fullDuration",flex:".5 0",cls:"b-inline"}}}}loadEvent(e){const t={unit:e.durationUnit,magnitude:1},{startDate:i,endDate:s,effort:n}=this.widgetMap;i&&(i.step=t,i.eventRecord=e),s&&(s.step=t,s.eventRecord=e),n&&(n.unit=e.effortUnit),super.loadEvent(e)}}er.initClass(),er._$name="GeneralTab";const Co=o=>o.map((e,t)=>[t,e]);class tr extends Pn{static get $name(){return"DependencyTypePicker"}static get type(){return"dependencytypepicker"}construct(e){super.construct(e),il.ion({locale:()=>{this.items=Co(this.L("L{DependencyType.long}"))},thisObj:this})}get store(){return this._items||(this.items=this._items=Co(this.L("L{DependencyType.long}"))),super.store}set store(e){super.store=e}}tr.initClass(),tr._$name="DependencyTypePicker";const tc=(o,e)=>{o.instanceMeta(e).valid=!0},Do=(o,e)=>{o.instanceMeta(e).valid=!1},nr=(o,e)=>o.instanceMeta(e).valid!==!1;class di extends kt{static get $name(){return"DependencyTab"}static get type(){return"dependencytab"}static get configurable(){return{dependencyIdField:null,layoutStyle:{flexFlow:"column nowrap"},sortField:null,taskComboSortField:"name",items:{grid:{type:"grid",weight:100,flex:"1 1 auto",emptyText:"",asyncEventSuffix:"PreCommit",disableGridRowModelWarning:!0,features:{group:!1},columns:{data:{id:{localeClass:this,text:"L{ID}",flex:1,editor:!1,htmlEncode:!1,hidden:!0,sortable(e,t){var i,s;const{dependencyIdField:n,direction:r}=this.grid.parent,a=(i=e[r])===null||i===void 0?void 0:i[n],l=(s=t[r])===null||s===void 0?void 0:s[n];return a===l?0:a<l?-1:1},renderer:({record:e,row:t,grid:i,column:s})=>{let n;const{direction:r}=i.parent,a=e[r];if(a&&nr(e,i)){const l=i.parent.dependencyIdField,c=a[l];l==="id"?n=!a||a.hasGeneratedId?"*":a.id:n=c}else t.addCls("b-invalid"),n='<div class="b-icon b-icon-warning"></div>';return n}},name:{localeClass:this,text:"L{Name}",flex:5,renderer:({value:e,grid:t,cellElement:i})=>{if(e){i.classList.toggle("b-inactive",e.inactive);const s=e[t.parent.dependencyIdField];return e.name+(s!=null&&!e.hasGeneratedId?` (${s})`:"")}return""},finalizeCellEdit:"up.finalizeLinkedTaskCellEdit",editor:{type:"modelcombo",displayField:"name",valueField:"id",filterOperator:"*",allowInvalid:!0,listItemTpl(e){const t=this,i=t._dependencyTab||(t._dependencyTab=t.up("dependencytab",!0)),{dependencyIdField:s}=i,n=e.hasGeneratedId&&s==="id"?null:e[s];return Wt.xss`${e.name}${n!=null?` (${n})`:""}`}}},type:{localeClass:this,text:"L{Type}",field:"type",flex:3,sortable:!1,editor:"dependencytypepicker",renderer({value:e}){return this.L("L{DependencyType.long}")[e]}},lag:{localeClass:this,text:"L{Lag}",type:"duration",field:"fullLag",flex:2,editor:{allowNegative:!0}}}}},toolbar:{type:"toolbar",dock:"bottom",cls:"b-compact-bbar",items:{add:{type:"button",weight:210,cls:"b-add-button b-green",icon:"b-icon b-icon-add",onAction:"up.onAddClick"},remove:{type:"button",weight:220,cls:"b-remove-button b-red",icon:"b-icon b-icon-trash",disabled:!0,onAction:"up.onRemoveClick"}}}}}}async finalizeLinkedTaskCellEdit({grid:e,value:t,record:i}){const{project:s}=e.store.masterStore,n=this.direction==="toEvent",r=n?i.fromEvent:t,a=n?t:i.toEvent;switch(await s.validateDependency(r,a,i.type,i)){case dt.NoError:return!0;case dt.CyclicDependency:return"L{DependencyTab.cyclicDependency}"}return"L{DependencyTab.invalidDependency}"}afterConstruct(){super.afterConstruct(),(this.grid=this.widgetMap.grid).ion({selectionChange:"onGridSelectionChange",startCellEdit:"onGridStartCellEdit",finishCellEdit:"onGridFinishCellEdit",cancelCellEdit:"onGridCancelCellEdit",thisObj:this})}get taskCombo(){const{grid:e}=this,t=e==null?void 0:e.columns.get(this.direction);return t==null?void 0:t.editor}loadEvent(e){const t=this,{grid:i,taskCombo:s,record:n}=t;super.loadEvent(e);const{dependencyStore:r,eventStore:a}=t.project,l=i.store.masterStore!==r,c=!l&&e!==n;if(l){t.depStoreGeneration=r.storage.generation,t.eventStoreGeneration=a.storage.generation,t.detachListeners("taskCombo"),i.store=r.chain(u=>u[t.negDirection]===t.record,null);const d=s.store=a.chain(u=>u!==t.record,null,{doRelayToMaster:[],excludeCollapsedRecords:!1});d.sort(t.taskComboSortField),d.filterBy(u=>!i.store.find(h=>{const f=h[t.direction],p=t._activeCellEdit,g=p&&f===p.record[t.direction];return f===u&&!g})),s.ion({name:"taskCombo",change:"onGridCellEditChange",thisObj:t})}else c||r.storage.generation!==t.depStoreGeneration?(i.store.fillFromMaster(),t.depStoreGeneration=r.storage.generation):i.refreshRows(),(c||a.storage.generation!==t.eventStoreGeneration)&&(s.store.fillFromMaster(),t.eventStoreGeneration=a.storage.generation);c&&i.store.sort(t.sortField),t.requestReadyStateChange()}async insertNewDependency(){const e=this,{grid:t}=e,{cellEdit:i}=t.features;i.isEditing&&!i.editor.isValid&&i.cancelEditing();const[s]=t.store.insert(0,{[e.negDirection]:e.record});return e.depStoreGeneration=e.project.dependencyStore.storage.generation,await t.features.cellEdit.startEditing({field:e.direction,id:s.id}),Do(s,t),s}onAddClick(){this.insertNewDependency()}onRemoveClick(){const e=this,{grid:t}=e,i=t.selectedRecords;t.features.cellEdit.cancelEditing(!0),e.project.dependencyStore.remove(i),t.selectedRecord=t.store.getNext(i[0]),e.taskCombo.store.fillFromMaster()}onGridSelectionChange({selection:e}){const t=this.widgetMap.remove,i=!!(!(e!=null&&e.length)||this.up(s=>s.readOnly));t.containsFocus&&i&&this.grid.focusCell({rowIndex:-1,columnIndex:0}),t.disabled=i}clearActiveEditorErrors(){const e=this._activeCellEdit;e&&e.column.field===this.direction&&e.editor.inputField.clearError()}onGridCellEditChange(){this.clearActiveEditorErrors()}onGridStartCellEdit({editorContext:e}){const t=this,i=t._editingDependency=e.record,{grid:s,direction:n}=t;t._activeCellEdit=e,e.column.field===n&&(nr(i,s)?t.clearActiveEditorErrors():i[n]?e.editor.inputField.setError("L{DependencyTab.cyclicDependency}"):e.editor.inputField.setError("L{DependencyTab.invalidDependency}"))}async onGridFinishCellEdit({editorContext:e}){const t=this,{record:i,column:s}=e,{grid:n,direction:r}=t;s.field===r?(tc(i,n),t.taskCombo.store.fillFromMaster()):t.redrawDependencyRow(i),t._activeCellEdit=t._editingDependency=null,t.requestReadyStateChange()}afterCancel(){this._activeCellEdit&&this.grid.features.cellEdit.cancelEditing(!0)}onGridCancelCellEdit(){const e=this,t=e._editingDependency;t&&(t[e.direction]||(Do(t,e.grid),e.redrawDependencyRow(t)),e._activeCellEdit=e._editingDependency=null),e.requestReadyStateChange()}redrawDependencyRow(e){const{grid:t}=this,i=t.rowManager.getRowById(e);i&&t.store.indexOf(e)>=0&&i.render(t.store.indexOf(e),e)}get canSave(){const{grid:e}=this;return e.store.every(t=>nr(t,e))}updateReadOnly(e){const{add:t,remove:i}=this.widgetMap;super.updateReadOnly(...arguments),t.hidden=i.hidden=e}}di._$name="DependencyTab";class ir extends di{static get $name(){return"SuccessorsTab"}static get type(){return"successorstab"}static get configurable(){return{cls:"b-successors-tab",direction:"toEvent",negDirection:"fromEvent",title:"L{DependencyTab.Successors}",sortField:"toEventName",items:{grid:{columns:{data:{name:{field:"toEvent"}}}}}}}}ir.initClass(),ir._$name="SuccessorsTab";class sr extends di{static get $name(){return"PredecessorsTab"}static get type(){return"predecessorstab"}static get configurable(){return{cls:"b-predecessors-tab",direction:"fromEvent",negDirection:"toEvent",title:"L{DependencyTab.Predecessors}",sortField:"fromEventName",items:{grid:{columns:{data:{name:{field:"fromEvent"}}}}}}}}sr.initClass(),sr._$name="PredecessorsTab";class rr extends kt{static get $name(){return"ResourcesTab"}static get type(){return"resourcestab"}static get configurable(){return{title:"L{Resources}",cls:"b-resources-tab",layoutStyle:{flexFlow:"column nowrap"},showUnits:null,items:{grid:{type:"grid",weight:100,flex:"1 1 auto",columns:{data:{resource:{localeClass:this,text:"L{Resource}",field:"resource",flex:7,renderer:({value:e})=>(e==null?void 0:e.name)||"",editor:{type:"modelcombo",displayField:"name",valueField:"id"}},units:{type:"number",localeClass:this,text:"L{Units}",field:"units",flex:3,renderer:e=>this.L("L{unitsTpl}",e),min:0,max:100,step:10}}},disableGridRowModelWarning:!0,asyncEventSuffix:"PreCommit"},toolbar:{type:"toolbar",dock:"bottom",cls:"b-compact-bbar",items:{add:{type:"button",weight:210,cls:"b-add-button b-green",icon:"b-icon b-icon-add"},remove:{type:"button",weight:220,cls:"b-remove-button b-red",icon:"b-icon b-icon-trash",disabled:!0}}}}}}afterConstruct(){super.afterConstruct();const e=this,t=e.addButton=e.widgetMap.add,i=e.removeButton=e.widgetMap.remove,s=e.grid=e.widgetMap.grid;t==null||t.ion({click:"onAddClick",thisObj:e}),i==null||i.ion({click:"onRemoveClick",thisObj:e}),s.ion({selectionChange:"onGridSelectionChange",startCellEdit:"onGridStartCellEdit",finishCellEdit:"onGridFinishCellEdit",cancelCellEdit:"onGridCancelCellEdit",thisObj:e})}updateReadOnly(e){const{add:t,remove:i}=this.widgetMap;super.updateReadOnly(...arguments),t.hidden=i.hidden=e}get resourceCombo(){var e;const t=(e=this.grid)===null||e===void 0?void 0:e.columns.get("resource");return t==null?void 0:t.editor}updateShowUnits(e){const t=this.widgetMap.grid.columns.get("units");t&&(t.hidden=!e)}loadEvent(e){const t=this,{resourceCombo:i,grid:s,record:n}=t;super.loadEvent(e);const{assignmentStore:r,resourceStore:a}=t.project,l=s.store.masterStore!==r,c=!l&&e!==n;typeof this.showUnits!="boolean"&&(s.columns.get("units").hidden=!e.isTask),l?(t.assignmentStoreGeneration=r.storage.generation,t.resourceStoreGeneration=a.storage.generation,s.store=r.chain(d=>t.record&&d.event===t.record,null),i.store=a.chain(d=>!d.isSpecialRow&&t.record&&!t.record.isAssignedTo(d)||!t.activeAssignment||t.activeAssignment.resource===d,null,{groupers:a.groupers})):((c||r.storage.generation!==t.assignmentStoreGeneration)&&s.store.fillFromMaster(),(c||a.storage.generation!==t.resourceStoreGeneration)&&i.store.fillFromMaster())}get activeAssignment(){return this.grid.features.cellEdit.activeRecord}async insertNewAssignment(){const e=this,{project:t,grid:i}=e,s=t.assignmentStore,[n]=s.insert(0,{event:e.record,resource:null,units:100});return e.assignmentStoreGeneration=s.storage.generation,await i.features.cellEdit.startEditing({field:"resource",id:n.id}),n}beforeSave(){this.pruneInvalidAssignments()}onAddClick(){this.insertNewAssignment()}onRemoveClick(){const e=this,{grid:t}=e;t.store.remove(t.selectedRecords),t.selectedRecords=null,e.removeButton.disable()}onGridSelectionChange({selection:e}){const{removeButton:t}=this,i=!(e!=null&&e.length)||this.up(s=>s.readOnly);t.containsFocus&&i&&this.grid.focus(),t.disabled=i}onGridStartCellEdit({editorContext:e}){e.column.field==="resource"&&(this.resourceCombo.store.fillFromMaster(),this._editingAssignment=e.record,this._activeCellEdit=e)}onGridFinishCellEdit(){this._activeCellEdit=this._editingAssignment=null}onGridCancelCellEdit(){this._activeCellEdit=this._editingAssignment=null}pruneInvalidAssignments(){const{store:e}=this.grid;e.remove(e.query(t=>!t.isValid))}}rr.initClass(),rr._$name="ResourcesTab";class ar extends Pn{static get $name(){return"ConstraintTypePicker"}static get type(){return"constrainttypepicker"}static get configurable(){return{valueField:"id"}}updateLocalization(){super.updateLocalization(),this.store.data=this.buildStoreData()}buildStoreData(){const e=this;return[{id:"none",text:e.L("L{none}")},{id:"muststarton",text:e.L("L{muststarton}")},{id:"mustfinishon",text:e.L("L{mustfinishon}")},{id:"startnoearlierthan",text:e.L("L{startnoearlierthan}")},{id:"startnolaterthan",text:e.L("L{startnolaterthan}")},{id:"finishnoearlierthan",text:e.L("L{finishnoearlierthan}")},{id:"finishnolaterthan",text:e.L("L{finishnolaterthan}")}]}set value(e){super.value=e}get value(){const e=super.value;return e==="none"?null:e}get store(){return this._store||(this.store=new xe({data:this.buildStoreData(),allowNullId:!0})),this._store}set store(e){super.store=e}}ar.initClass(),ar._$name="ConstraintTypePicker";class or extends Pn{static get $name(){return"SchedulingModePicker"}static get type(){return"schedulingmodecombo"}static get configurable(){return{allowedModes:null,store:{data:this.defaultStoreData}}}static get defaultStoreData(){return[{id:N.Normal,text:this.L("L{Normal}")},{id:N.FixedDuration,text:this.L("L{Fixed Duration}")},{id:N.FixedUnits,text:this.L("L{Fixed Units}")},{id:N.FixedEffort,text:this.L("L{Fixed Effort}")}]}changeAllowedModes(e){return typeof e=="string"?e.split(","):e}updateAllowedModes(e){this._allowedModes=e,e?this.store.addFilter({id:"allowed-mode-filter",filterBy:t=>this._allowedModes.includes(t.id)}):this.store.removeFilter("allowed-mode-filter")}updateLocalization(){super.updateLocalization(),this.store.data=this.constructor.defaultStoreData}}or.initClass(),or._$name="SchedulingModePicker";class lr extends We{static get $name(){return"AdvancedTab"}static get type(){return"advancedtab"}static get defaultConfig(){const e={flex:"0 0 64%",labelWidth:"30%",cls:"b-inline"},t={flex:"0 0 34%",labelWidth:"80%"};return{localeClass:this,title:"L{Advanced}",cls:"b-advanced-tab",defaults:{localeClass:this},items:{calendarField:{type:"calendarfield",weight:100,ref:"",name:"calendar",label:"L{Calendar}",...e},ignoreResourceCalendarField:{type:"checkbox",weight:100,name:"ignoreResourceCalendar",label:"L{Ignore resource calendar}",cls:"b-ignore-resource-calendar",...t},schedulingModeField:{type:"schedulingmodecombo",weight:300,name:"schedulingMode",label:"L{Scheduling mode}",...e},effortDrivenField:{type:"checkbox",weight:400,name:"effortDriven",label:"L{Effort driven}",...t},divider:{weight:500,html:"",dataset:{text:this.L("L{Constraint}")},cls:"b-divider",flex:"1 0 100%"},constraintTypeField:{type:"constrainttypepicker",weight:600,name:"constraintType",label:"L{Constraint type}",clearable:!0,...e},rollupField:{type:"checkbox",weight:700,name:"rollup",label:"L{Rollup}",...t},constraintDateField:{type:"date",weight:800,name:"constraintDate",label:"L{Constraint date}",keepTime:"entered",...e},inactiveField:{type:"checkbox",weight:900,name:"inactive",label:"L{Inactive}",...t},manuallyScheduledField:{type:"checkbox",weight:1e3,name:"manuallyScheduled",label:"L{Manually scheduled}",cls:"b-last-row",style:"margin-left:auto",...t}}}}get calendarField(){return this.widgetMap.calendarField}get constraintTypeField(){return this.widgetMap.constraintTypeField}get constraintDateField(){return this.widgetMap.constraintDateField}get effortDrivenField(){return this.widgetMap.effortDrivenField}get manuallyScheduledField(){return this.widgetMap.manuallyScheduledField}get rollupField(){return this.widgetMap.rollupField}get schedulingModeField(){return this.widgetMap.schedulingModeField}loadEvent(e){const t=this,{calendarField:i,constraintTypeField:s}=t,{calendarManagerStore:n}=e.project,r=(i==null?void 0:i.store)!==n;if(i&&r&&(i.store=n.chain(void 0,void 0,{excludeCollapsedRecords:!1})),s!=null&&s.isConstraintTypePicker){const{store:a}=s;a.removeFilter("constraintTypeApplicable"),a.filter({id:"constraintTypeApplicable",filterBy:l=>e.run("isConstraintTypeApplicable",l.id)})}super.loadEvent(e)}afterDelete(){const{constraintTypeField:e}=this;e!=null&&e.isConstraintTypePicker&&e.store.removeFilter("constraintTypeApplicable"),super.afterDelete(...arguments)}}lr.initClass(),lr._$name="AdvancedTab";class cr extends We{static get $name(){return"NotesTab"}static get type(){return"notestab"}static get configurable(){return{cls:"b-notes-tab",title:this.L("L{Notes}"),tab:{icon:"b-icon-note",titleProperty:"tooltip"},layoutConfig:{alignItems:"flex-start",alignContent:"stretch"},items:{noteField:{weight:100,type:"textfield",inputAttributes:{tag:"textarea"},cls:"b-taskeditor-notes-field",name:"note"}}}}}cr.initClass(),cr._$name="NotesTab";class dr extends vn{static get type(){return"gantttaskeditor"}static get $name(){return"GanttTaskEditor"}static get defaultConfig(){return{items:[{type:"tabpanel",defaultType:"formtab",ref:"tabs",flex:"1 0 100%",autoHeight:!0,layoutConfig:{alignItems:"stretch",alignContent:"stretch"},defaults:{scrollable:{overflowY:!0}},items:{generalTab:{type:"generaltab",weight:100},predecessorsTab:{type:"predecessorstab",weight:200},successorsTab:{type:"successorstab",weight:300},resourcesTab:{type:"resourcestab",weight:400},advancedTab:{type:"advancedtab",weight:500},notesTab:{type:"notestab",weight:600}}}]}}}dr.initClass(),dr._$name="GanttTaskEditor";class ur extends We{static get $name(){return"SchedulerGeneralTab"}static get type(){return"schedulergeneraltab"}static get defaultConfig(){return{title:"L{General}",cls:"b-general-tab",defaults:{localeClass:this,weight:10},items:{nameField:{type:"text",required:!0,label:"L{Name}",clearable:!0,name:"name",cls:"b-name",weight:100},resourcesField:{type:"combo",label:"L{Resources}",name:"resources",editable:!0,valueField:"id",displayField:"name",highlightExternalChange:!1,cls:"b-resources",weight:200},startDateField:{type:"datetime",label:"L{Start}",name:"startDate",cls:"b-start-date",flex:"1 0 100%",weight:300,dateField:{type:"startdatefield"}},endDateField:{type:"datetime",label:"L{Finish}",name:"endDate",cls:"b-end-date",flex:"1 0 100%",weight:400,dateField:{type:"enddatefield"}},durationField:{type:"durationfield",label:"L{Duration}",name:"fullDuration",flex:"1 0 50%",cls:"b-inline",min:0,weight:500},percentDoneField:{type:"number",label:"L{% complete}",name:"renderedPercentDone",flex:"1 0 50%",min:0,max:100,weight:600},effortField:{type:"durationfield",label:"L{Effort}",name:"fullEffort",weight:620},preambleField:{type:"durationfield",hidden:!0,useAbbreviation:!0,weight:650,label:"L{SchedulerGeneralTab.Preamble}",name:"preamble",flex:"1 0 50%",cls:"b-inline"},postambleField:{type:"durationfield",hidden:!0,useAbbreviation:!0,weight:660,label:"L{SchedulerGeneralTab.Postamble}",name:"postamble",flex:"1 0 50%"}}}}loadEvent(e){var h;const t=this,{project:i}=t,s={unit:e.durationUnit,magnitude:1},{isParent:n}=e,{durationField:r,percentDoneField:a,startDateField:l,endDateField:c,resourcesField:d}=t.widgetMap,u=(d==null?void 0:d.store.masterStore)!==i.resourceStore;r&&(r.disabled=n,a||r.element.classList.remove("b-inline")),a&&(a.disabled=n),l&&(l.dateField.eventRecord=e,I.compareUnits(s.unit,"hour")>0?l.dateField.step=s:l.timeField.step=s),c&&(c.dateField.eventRecord=e,I.compareUnits(s.unit,"hour")>0?c.dateField.step=s:c.timeField.step=s,c.disabled=n),d&&(d.multiSelect=(h=d.config.multiSelect)!=null?h:!i.eventStore.usesSingleAssignment,u&&(d.store=i.resourceStore.chain(f=>!f.isSpecialRow))),super.loadEvent(...arguments)}onFieldChange({source:e,valid:t,userAction:i,value:s}){if(i&&t){const{eventStore:n}=this.record,r=e.name==="resources"&&s.length===0&&this.autoUpdateRecord&&n.removeUnassignedEvent;r&&(n.removeUnassignedEvent=!1),super.onFieldChange(...arguments),r&&(n.removeUnassignedEvent=!0)}}beforeSave(){this.record.resources.length===0&&this.record.eventStore.removeUnassignedEvent&&this.record.remove(),super.beforeSave()}}ur.initClass(),ur._$name="SchedulerGeneralTab";class Bt extends kt{get recurrenceEditor(){return this.widgetMap.recurrenceEditor}loadEvent(e){var t;this.recurrenceEditor&&(this.loadingRecord=!0,this.recurrenceEditor.record=(t=e.recurrence)!=null?t:null,this.loadingRecord=!1),super.loadEvent(e)}onFieldChange({source:e,value:t}){const i=this;if(!i.isConfiguring&&!i.recurrenceEditor.assigningValues&&!i.loadingRecord){const{record:s}=i;s.recurrence?e===i.recurrenceEditor.widgetMap.frequencyField&&t==="NONE"?s.recurrence=null:i.recurrenceEditor.syncEventRecord(s.recurrence):s.recurrence=new s.recurrenceModel({}),i.up(n=>n.isTaskEditorBase).editingRecurring=!0}}}B(Bt,"$name","RecurrenceTab"),B(Bt,"type","recurrencetab"),B(Bt,"configurable",{title:"L{title}",cls:"b-recurrence-tab",scrollable:!0,items:{recurrenceEditor:{type:"recurrenceeditorpanel",addNone:!0}}}),Bt.initClass(),Bt._$name="RecurrenceTab";class hr extends We{static get $name(){return"SchedulerAdvancedTab"}static get type(){return"scheduleradvancedtab"}static get configurable(){return{cls:"b-advanced-tab",tab:{icon:"b-icon-advanced",tooltip:"L{SchedulerAdvancedTab.Advanced}"},defaults:{localeClass:this},items:{calendarField:{type:"calendarfield",name:"calendar",label:"L{Calendar}",weight:100},constraintTypeField:{type:"constrainttypepicker",name:"constraintType",label:"L{Constraint type}",clearable:!0,weight:200},constraintDateField:{type:"date",name:"constraintDate",label:"L{Constraint date}",keepTime:"entered",weight:300},manuallyScheduledField:{type:"checkbox",name:"manuallyScheduled",label:"L{Manually scheduled}",weight:400},schedulingModeField:{type:"schedulingmodecombo",name:"schedulingMode",label:"L{Scheduling mode}",hidden:!0,weight:450,allowedModes:`${N.Normal},${N.FixedDuration}`},effortDrivenField:{type:"checkbox",weight:460,name:"effortDriven",label:"L{Effort driven}",hidden:!0,flex:"1 0 50%"},inactiveField:{type:"checkbox",weight:500,name:"inactive",label:"L{Inactive}"},ignoreResourceCalendarField:{type:"checkbox",weight:600,name:"ignoreResourceCalendar",label:"L{Ignore resource calendar}",flex:"1 0 50%"}}}}get calendarField(){return this.widgetMap.calendarField}get constraintTypeField(){return this.widgetMap.constraintTypeField}get constraintDateField(){return this.widgetMap.constraintDateField}get effortDrivenField(){return this.widgetMap.effortDrivenField}get manuallyScheduledField(){return this.widgetMap.manuallyScheduledField}get schedulingModeField(){return this.widgetMap.schedulingModeField}loadEvent(e){const t=this,{project:i}=t;t.record;const{calendarField:s}=t;s&&(s.store=i.calendarManagerStore,s.hidden=!i.calendarManagerStore.count),super.loadEvent(...arguments)}}hr.initClass(),hr._$name="SchedulerAdvancedTab";const nc=/(pre|post)amble/;class fr extends vn{static get type(){return"schedulertaskeditor"}static get $name(){return"SchedulerTaskEditor"}static get defaultConfig(){return{enableEventSpanBuffer:!1,items:[{type:"tabpanel",defaultType:"formtab",ref:"tabs",flex:"1 0 100%",autoHeight:!0,layoutConfig:{alignItems:"stretch",alignContent:"stretch"},defaults:{scrollable:{overflowY:!0}},items:{generalTab:{type:"schedulergeneraltab",weight:100},recurrenceTab:{type:"recurrencetab",weight:150},predecessorsTab:{type:"predecessorstab",weight:200},successorsTab:{type:"successorstab",weight:300},advancedTab:{type:"scheduleradvancedtab",weight:500},notesTab:{type:"notestab",weight:600}}}]}}processWidgetConfig(e){var t;if((t=e.ref)!==null&&t!==void 0&&t.match(nc)&&(e.hidden=!this.enableEventSpanBuffer),e.ref==="recurrenceTab"){var i;e.hidden=!((i=this.owner)!==null&&i!==void 0&&i.enableRecurringEvents)}return super.processWidgetConfig(e)}onFocusOut({relatedTarget:e}){var t;const i=e==null||(t=e.closest(".b-sch-event-wrap"))===null||t===void 0?void 0:t.elementData.eventRecord;if(i&&i===this.loadedRecord)this.setTimeout(()=>this.focus(),100);else return super.onFocusOut(...arguments)}}fr.initClass(),fr._$name="SchedulerTaskEditor";class ui extends Tn.mixin(sl,ul){static get $name(){return"TaskEdit"}static get pluginConfig(){return{chain:["populateEventMenu","onEventEnterKey"],assign:["editEvent"]}}static get defaultConfig(){return{triggerEvent:"eventdblclick",editorClassMap:{[Lt.SchedulerBasic]:"schedulertaskeditor",[Lt.SchedulerPro]:"schedulertaskeditor",[Lt.Gantt]:"gantttaskeditor"},editorClass:null,editorConfig:null,confirmDelete:!0,saveAndCloseOnEnter:!0,blurAction:"cancel",weekStartDay:null,scrollIntoView:!0}}static get configurable(){return{items:null,suspendHasChangesEvent:!1}}construct(e,t){var i;e.taskEdit=this,super.construct(e,K.assign({weekStartDay:e.weekStartDay,enableEventSpanBuffer:(i=e.features.eventBuffer)===null||i===void 0?void 0:i.enabled},t)),e.ion({[this.triggerEvent]:"onActivateEditor",readOnly:"onClientReadOnlyToggle",dragCreateEnd:"onDragCreateEnd",afterEventDrop:"onEventDropped",eventResizeEnd:"onEventResized",thisObj:this})}doDestroy(){var e;this.detachFromProject(),(e=this.editor)===null||e===void 0||e.destroy(),this.deleteConfirmationPromise&&Ei.hide(),super.doDestroy()}onClientReadOnlyToggle({readOnly:e}){this.editor&&(this.editor.readOnly=e)}get scheduler(){return this.client}getElementFromTaskRecord(e,t){return this.client.getElementFromEventRecord(e,t)}scrollEventIntoView(e,t){this.client.scrollResourceEventIntoView(t,e)}get isValid(){return this.editor.eachWidget(e=>e.isValid===!0||e.hidden||e.disabled||e.isField&&!e.name?!0:e.isValid!==!1,!0)}get project(){return this.scheduler.project}attachToProject(){this.detachFromProject(),this.project.ion({name:"project",loadstart:()=>this.save(),dataReady:"onDataReady",thisObj:this})}detachFromProject(){this.detachListeners("project")}onDataReady(){const{record:e}=this;e!=null&&e.project&&this.scheduler.taskStore.includes(e)?this.load(e,!0):this.editor.close()}get isEditing(){return!!this._editing}onActivateEditor({eventRecord:e,resourceRecord:t,eventElement:i}){e===this.record&&this.isEditing||this.editEvent(e,t,i)}async editEvent(e,t=null,i=null,s=null){const n=this,{scheduler:r}=n;e=e.isEventSegment?e.event:e;const a=!n.disabled&&!e.readOnly&&!r.project.isDelayingCalculation&&(e.project||!r.usesDisplayStore);if(a&&s&&(s.transferred=!0),n.isEditing&&await n.cancel(),await Promise.all([n._cancelling,n._hiding]).catch(()=>{}),!r.isGanttBase&&!t){var l;t=e.resource||((l=e.resources)===null||l===void 0?void 0:l[0])}if(a){const{taskStore:c}=r;if(n._editing=!0,s?(n.stmInitiallyAutoRecord=s.stmInitiallyAutoRecord,n.stmInitiallyDisabled=s.stmInitiallyDisabled,n.hasStmCapture=!0):n.hasStmCapture||n.captureStm(!0),r.project.suspendAutoSync(),typeof e=="function"&&(e=e()),e=e.$original,!e.isOccurrence&&!c.includes(e)&&!e.isCreating&&(e.isCreating=!0,c.add(e),t&&r.assignmentStore.assignEventToResource(e,t),await r.project.commitAsync(),n.isDestroyed)||n.scrollIntoView&&!r.timeAxisSubGrid.collapsed&&!i&&c.includes(e)&&(t||r.isGantt)&&(await n.scrollEventIntoView(e,t),n.isDestroyed))return;const d=i||Vt.down(n.getElementFromTaskRecord(e,t),r.eventInnerSelector),u=n.getEditor(e);if(await n.triggerOnClient("beforeTaskEdit",{taskEdit:n,taskRecord:e,taskElement:d})!==!1){if(n.suspendHasChangesEvent&&r.project.suspendChangesTracking(),r.element.classList.add("b-taskeditor-editing"),await r.project.commitAsync(),n.isDestroyed)return;n.load(e),n.triggerOnClient("beforeTaskEditShow",{taskEdit:n,taskRecord:e,taskElement:d,editor:u});const{widgetMap:h}=u,f=e.parent&&!e.parent.isRoot;h.deleteButton&&(h.deleteButton.hidden=r.readOnly||e.isCreating||u.readOnly),r.features.nestedEvents&&(h.predecessorsTab&&(h.predecessorsTab.disabled=f),h.successorsTab&&(h.successorsTab.disabled=f),h.resourcesField&&(h.resourcesField.disabled=f)),n.attachToProject(),u.centered?await u.show():!r.timeAxisSubGrid.collapsed&&d&&(!r.isGanttBase||n.scrollIntoView||Nt.from(d).intersect(Nt.from(r.timeAxisSubGridElement)))?await u.showBy({target:d,anchor:!0,offset:-5}):await u.showBy({target:r.element,anchor:!1,align:"c-c",clippedBy:null})}else{if(r.project.resumeAutoSync(),await n.rejectStmTransaction(),n.isDestroyed)return;n.disableStm(),n.freeStm(),n._editing=!1}}}getEditor(e=this.record){const t=this,{client:i}=t;let{editor:s}=t;if(!s){var n;const r=K.merge({clippedBy:[i.timeAxisSubGridElement,i.bodyContainer],eventEditFeature:t,weekStartDay:t.weekStartDay,enableEventSpanBuffer:t.enableEventSpanBuffer,saveAndCloseOnEnter:t.saveAndCloseOnEnter,blurAction:t.blurAction,owner:i,dependencyIdField:((n=t.editorConfig)===null||n===void 0?void 0:n.dependencyIdField)||i.dependencyIdField,project:t.project,durationDisplayPrecision:i.durationDisplayPrecision,tabPanelItems:t.items,internalListeners:{beforeHide:{fn:"onBeforeHide",prio:-1e3},cancel:"onCancel",delete:"onDelete",save:"onSave",thisObj:t},tabsConfig:t.tabsConfig},t.editorConfig);if(t.editorClass&&!r.type)s=t.editor=t.editorClass.new(r);else{const a=(e==null?void 0:e.project)||t.project,l=a.getType();s=t.editor=Di.create(Object.assign({type:t.editorClassMap[l]||"schedulertaskeditor"},r))}}return s.readOnly=(i.readOnly||(e==null?void 0:e.isOccurrence)||(e==null?void 0:e.isRecurring))&&!s.editingRecurring,s.project=t.project,s}load(e,t){const i=this,s=i.getEditor(e);i._loading=!0,e.isEventSegment&&(e=e.event),i.record=e,s.loadEvent(e,t),i._loading=!1}async save(){const e=this,{scheduler:t,record:i}=e;if(e.isEditing){const s=e.getEditor();if(!e.isValid||await e.triggerOnClient("beforeTaskSave",{taskRecord:i,editor:s})===!1)return;e.detachFromProject(),s.beforeSave(),i.isCreating=!1,s.resetRecurrenceData=s.editingRecurring=null,e.freeStm(!0),e._editing=!1,await s.close(),t.project.resumeAutoSync(!0),t.element.classList.remove("b-taskeditor-editing"),e.triggerOnClient("afterTaskSave",{taskRecord:i,editor:s}),s.afterSave(),e.suspendHasChangesEvent&&t.project.resumeChangesTracking(),e.triggerOnClient("afterTaskEdit",{taskRecord:i,editor:s})}}async doCancel(){const e=this,{scheduler:t,record:i}=e;if(e.isEditing){e._editing=!1,e.detachFromProject();const{project:a}=e,l=e.getEditor();if(l.editingRecurring=null,l.beforeCancel(),e.isDestroyed){var s;(s=a.resumeAutoSync)===null||s===void 0||s.call(a,!1);return}if(i!=null&&i.isCreating?i.remove():await e.rejectStmTransaction(),e.isDestroyed){var n;(n=a.resumeAutoSync)===null||n===void 0||n.call(a,!1);return}if(e.disableStm(),await a.commitAsync(),e.isDestroyed){var r;(r=a.resumeAutoSync)===null||r===void 0||r.call(a,!1);return}e.freeStm(),l.afterCancel(),a.resumeAutoSync(!1),t.element.classList.remove("b-taskeditor-editing"),e.trigger("afterTaskEdit"),e.triggerOnClient("taskEditCanceled",{taskRecord:i,editor:l}),e.suspendHasChangesEvent&&a.resumeChangesTracking(),e.triggerOnClient("afterTaskEdit",{taskRecord:i,editor:l})}}async cancel(){const e=this,{editor:t}=e,{resetRecurrenceData:i}=t;return i&&(i.recurringTimeSpan.exceptionDates=i.originalExceptionDates,t.resetRecurrenceData=null),e._cancelling||(e._cancelling=e.doCancel().finally(()=>e._cancelling=void 0))}async delete(){const e=this,{editor:t,scheduler:i,record:s,project:n}=e;!s.isCreating&&await e.triggerOnClient("beforeTaskDelete",{taskRecord:s,editor:t})===!1||(e.detachFromProject(),t.beforeDelete(),s.remove(),e.freeStm(),await n.commitAsync(),n.resumeAutoSync(!s.isCreating),!e.isDestroyed&&(e._editing=!1,t.close(),t.afterDelete(),i.element.classList.remove("b-taskeditor-editing"),e.suspendHasChangesEvent&&i.project.resumeChangesTracking(),e.triggerOnClient("afterTaskEdit",{editor:t,taskRecord:s})))}onSave(){this.requestAnimationFrame(()=>this.save())}onCancel(){this.cancel().then()}async onDelete(){const e=this;if(e.confirmDelete){const{editor:t}=e,i=t.autoClose;t.autoClose=!1,e.deleteConfirmationPromise=Ei.confirm({title:"L{TaskEdit.ConfirmDeletionTitle}",message:"L{TaskEdit.ConfirmDeletionMessage}",okButton:"L{TaskEditorBase.Delete}",rootElement:e.rootElement});const s=await e.deleteConfirmationPromise;t.autoClose=i,e.deleteConfirmationPromise=null,s===Ei.yesButton&&e.delete()}else e.requestAnimationFrame(()=>e.delete())}onBeforeHide({source:e,animate:t}){e.hideAnimation&&t!==!1&&(this._hiding=new Promise(i=>{e.ion({hideAnimationEnd:i})}).finally(()=>this._hiding=void 0))}onDragCreateEnd({eventRecord:e,resourceRecord:t,proxyElement:i,stmCapture:s}){!this.disabled&&e.isCreating&&this.editEvent(e,t,null,s)}populateEventMenu({eventRecord:e,resourceRecord:t,items:i}){this.scheduler.readOnly||(i.editEvent={text:"L{Edit task}",localeClass:this,icon:"b-icon b-icon-edit",weight:-200,disabled:this.disabled||e.readOnly,onItem:()=>this.editEvent(e,t)})}onEventEnterKey({assignmentRecord:e,eventRecord:t}){e?this.editEvent(t,e.resource):t&&this.editEvent(t,t.resource)}async triggerOnClient(e,t){const i=e.replace(/task/,"event").replace(/Task/,"Event"),s=await this.scheduler.trigger(...arguments);t.eventRecord=t.taskRecord,t.eventRecords=[t.taskRecord];const n=await this.scheduler.trigger(i,t);return s&&n}onEventDropped({eventRecords:e}){var t;const i=((t=this.editor)===null||t===void 0?void 0:t.loadedRecord)&&e.find(s=>s===this.editor.loadedRecord);i&&this.onEventResized({eventRecord:i})}onEventResized({eventRecord:e}){const{editor:t}=this;t!=null&&t.isVisible&&e===t.loadedRecord&&t.realign()}}ui._$name="TaskEdit",De.registerFeature(ui,!0,"SchedulerPro"),De.registerFeature(ui,!1,"ResourceHistogram");const gr=class{constructor({model:e,type:t}){var i,s,n;Object.assign(this,{id:(i=e.id)!=null?i:e.$entityName,type:(s=t==null?void 0:t.$$name)!=null?s:e.constructor.name,name:(n=e.name)!=null?n:e.$entityName}),new.target===gr&&Object.freeze(this)}};let ze=gr;B(ze,"$name","ChangeLogEntity"),ze._$name="ChangeLogEntity";class hi extends ze{constructor({model:e,fromTask:t,toTask:i}){super({model:e,type:mn}),Object.assign(this,{fromTask:t,toTask:i}),Object.freeze(this)}}B(hi,"$name","ChangeLogDependencyEntity"),hi._$name="ChangeLogDependencyEntity";class fi extends ze{constructor({model:e,event:t,resource:i}){super({model:e,type:rt}),Object.assign(this,{event:t,resource:i}),Object.freeze(this)}}B(fi,"$name","ChangeLogAssignmentEntity"),fi._$name="ChangeLogAssignmentEntity";const mr=class{constructor({entity:e,actionType:t}){Object.assign(this,{entity:e,actionType:t}),this.constructor===mr&&Object.freeze(this)}};let ye=mr;B(ye,"$name","ChangeLogAction"),ye._$name="ChangeLogAction";class So extends ye{static get $name(){return"ChangeLogMoveAction"}constructor({entity:e,from:t,to:i}){super({entity:e,actionType:"move"}),Object.assign(this,{from:t,to:i}),Object.freeze(this)}}So._$name="ChangeLogMoveAction";class Eo extends ye{static get $name(){return"ChangeLogUpdateAction"}constructor({entity:e,propertyUpdates:t,isInitialUserAction:i}){super({entity:e,actionType:"update"}),Object.assign(this,{propertyUpdates:t,isUser:i}),Object.freeze(this)}}Eo._$name="ChangeLogUpdateAction";class Cn extends Tn.mixin(hl){constructor(){super(...arguments);B(this,"_remoteActionRanges",[]);B(this,"_comparingVersionId")}construct(t,i){super.construct(t,i);const s=this;s.versionStore=new At({modelClass:s.versionModelClass,internalListeners:{change:s.onStoreChangeExternal,thisObj:s},id:At.configurable.storeId}),s.changeStore=new Ft({modelClass:s.transactionModelClass,internalListeners:{change:s.onStoreChangeExternal,thisObj:s},id:Ft.configurable.storeId}),s._currentChanges=[],s.client.ion({beforeTaskDelete:s.onBeforeTaskDelete,beforeTaskSave:s.onBeforeTaskSave,gridRowBeforeDropFinalize:s.onGridRowBeforeDropFinalize,thisObj:s})}attachToProject(t){const i=this;super.attachToProject(t),t.addCrudStore([i.versionStore,i.changeStore]),t.ion({name:"project",load:i.onProjectLoad,once:!0,thisObj:i}),i.detachProjectListeners(),i.attachProjectListeners(t)}onBeforeTaskDelete(){this.transactionDescription=this.L("L{Versions.deletedTask}")}onBeforeTaskSave(){this.transactionDescription=this.L("L{Versions.editedTask}")}onGridRowBeforeDropFinalize({context:{valid:t,records:i}}){t&&(this.transactionDescription=i.length===1?this.L("L{Versions.movedTask}"):this.L("L{Versions.movedTasks}"))}attachProjectListeners(t){var i;const s=this;t==null||(i=t.stm)===null||i===void 0||i.ion({recordingStart:s.onStmRecordingStart,recordingStop:s.handleTransactionStop,restoringStop:s.onStmRestoringStop,thisObj:s,name:"stmListeners"}),t==null||t.ion({wsBeforeReceiveChanges:s.onBeforeApplyRemoteChanges,wsReceiveChanges:s.onAfterApplyRemoteChanges,thisObj:s,name:"stmListeners"})}detachProjectListeners(){this.detachListeners("stmListeners")}updateVersionModelClass(t){if(!t.isVersionModel)throw new Error("versionModelClass config must be a subclass of SchedulerPro.model.VersionModel.")}updateTransactionModelClass(t){if(!t.isChangeLogTransactionModel)throw new Error("transactionModelClass config must be a subclass of SchedulerPro.model.changelog.ChangeLogTransactionModel.")}onStoreChangeExternal(){this.triggerVersionChange()}tryAutoSave(){const t=this,{project:i}=t.client;t.changeStore.find(({versionId:s})=>!s)&&(i!=null&&i.wsSend?(i.wsSend("requestVersionAutoSave",{project:i.wsProjectId}),t.detachListeners("autoSave"),i.ion({name:"autoSave",wsVersionAutoSaveOK:t.autoSave,thisObj:t,once:!0})):t.saveVersionWithConfig({isAutosave:!0}))}autoSave(){this.saveVersionWithConfig({isAutosave:!0})}autoSaveHourly(){new Date().getMinutes()===0&&this.tryAutoSave()}updateAutoSaveInterval(t){const i=this,{client:s}=i;i._autoSaveInterval&&s.clearInterval(i._autosaveInterval),t==="hourly"?i._autoSaveInterval=s.setInterval(i.autoSaveHourly.bind(i),10*1e3):t&&(i._autoSaveInterval=s.setInterval(i.tryAutoSave.bind(i),t*60*1e3))}saveVersion(t=null){return this.saveVersionWithConfig({name:t})}saveVersionWithConfig(t){const i=this,s=i.captureVersionContent(),n=new i.versionModelClass({savedAt:new Date,content:s,...t});return n.onBeforeSave(),i.versionStore.add(n),i.changeStore.query(r=>r.versionId==null).forEach(r=>r.versionId=n.id),i.triggerVersionChange(),i.triggerTransactionChange(),n}async loadVersionContent(t){const i=this,{client:s}=i,{project:n}=s,r={version:t,content:null};if(await i.trigger("beforeLoadVersionContent",{context:r})){if(n!=null&&n.wsSend){n.wsSend("loadVersionContent",{project:n.wsProjectId,versionId:t.id});const a=await new Promise((l,c)=>{const d=Date.now();n.ion({name:"loadVersionContent",loadVersionContent({project:u,versionId:h,content:f}){if(u===n.wsProjectId&&h===t.id)return n.detachListeners("loadVersionContent"),l(f)},thisObj:i,expires:{delay:i.versionContentLoadTimeout-(Date.now()-d),alt:()=>c(`Failed to receive version content within ${this.versionContentLoadTimeout} ms`)}})});return a&&i._versionContentCache.set(t.id,a),a}}else if(r.content)return r.content}async getVersionContent(t){var i;return(i=t.content)!=null?i:await this.loadVersionContent(t)}triggerTransactionChange(){this.client.trigger("transactionChange",{hasUnattachedTransactions:this.hasUnattachedTransactions})}triggerVersionChange(){this.client.trigger("versionChange",{versions:this.versionStore.records})}captureVersionContent(){return this.client.project.toJSON()}async restoreVersion(t){var i,s,n;const r=await this.getVersionContent(t),{project:a}=this.client,l=(i=a.stm)===null||i===void 0?void 0:i.enabled;if((s=a.stm)===null||s===void 0||s.disable(),a.json=r,await a.commitAsync(),l){var c;(c=a.stm)===null||c===void 0||c.enable()}(n=a.stm)===null||n===void 0||n.resetQueue()}async compareVersion(t){var i,s;const n=await this.getVersionContent(t),r={},{project:a}=this.client,l=(i=a.stm)===null||i===void 0?void 0:i.enabled;(s=a.stm)===null||s===void 0||s.disable();for(const d of n.eventsData)rl.preWalk(d,u=>u.children,({id:u,startDate:h,endDate:f})=>{r[u]={startDate:h,endDate:f}});if(a.taskStore.traverse(d=>{r[d.id]&&(d.baselines.removeAll(),d.baselines.loadData([{task:d,...r[d.id]}]))}),l){var c;(c=a.stm)===null||c===void 0||c.enable()}this._comparingVersionId=t.id}stopComparing(){var t,i;if(!this._comparingVersionId)return;const{project:s}=this.client,n=(t=s.stm)===null||t===void 0?void 0:t.enabled;if((i=s.stm)===null||i===void 0||i.disable(),s.taskStore.traverse(a=>{a.baselines.removeAll()}),n){var r;(r=s.stm)===null||r===void 0||r.enable()}this._comparingVersionId=null}doDisable(t){super.doDisable(t),t?this.detachProjectListeners():this.attachProjectListeners(this.client.project),this.client.refresh()}getEntityDescriptor(t){var s;const i=(s=this.knownBaseTypes.find(n=>t instanceof n))!=null?s:t.constructor;return t.isDependencyModel?new hi({model:t,fromTask:this.getEntityDescriptor(t.fromTask),toTask:this.getEntityDescriptor(t.toTask)}):t.isAssignmentModel?new fi({model:t,event:this.getEntityDescriptor(t.event),resource:this.getEntityDescriptor(t.resource)}):new ze({model:t,type:i})}getUpdateAction(t){const i=t[0].model,s=t.flatMap(({newData:l,oldData:c})=>Object.entries(l).map(([d,u])=>({property:d,value:u,oldValue:c[d]})).filter(({property:d,value:u,oldValue:h})=>{var f;return!K.isEqual(u,h)&&((f=i.getFieldDefinition(d))===null||f===void 0?void 0:f.persist)})),n=ht.groupBy(s,"property"),r=Object.entries(n).map(([l,c])=>({property:l,before:c[0].oldValue,after:c[c.length-1].value})),a=t.some(({isInitialUserAction:l})=>l);return new Eo({actionType:"update",entity:this.getEntityDescriptor(i),propertyUpdates:r,isInitialUserAction:a})}onProjectLoad(){this._currentStmTransaction=null,this.stopTransaction()}onStmRecordingStart({transaction:t}){this._transactionStart=new Date,this._currentStmTransaction=t,this.triggerTransactionChange()}stopTransaction(){var t;if((t=this.client.project)!==null&&t!==void 0&&t.stm.isRecording){var i;(i=this.client.project)===null||i===void 0||i.stm.stopTransaction()}this.handleTransactionStop()}async onStmRestoringStop({cause:t,transactions:i}){const s=this;t==="undo"?s.transactionDescription=s.L("L{undid}"):t==="redo"&&(s.transactionDescription=s.L("L{redid}")),await s.client.project.commitAsync(),s._transactionStart=new Date,s.finalizeTransaction({queue:i.flatMap(n=>n.queue)})}onBeforeApplyRemoteChanges(){var i;if(this._remoteChangesStartPos==null){var t;this._remoteChangesStartPos=(i=(t=this._currentStmTransaction)===null||t===void 0?void 0:t.queue.length)!=null?i:0}}async onAfterApplyRemoteChanges(){this.endCurrentRemoteActionRange(),await this.client.project.commitAsync()}endCurrentRemoteActionRange(){var s;const t=this;if(t._remoteChangesStartPos!=null){var i;const n=(s=(i=t._currentStmTransaction)===null||i===void 0?void 0:i.queue.length)!=null?s:0;n!==t._remoteChangesStartPos&&t._remoteActionRanges.push({start:t._remoteChangesStartPos,end:n}),t._remoteChangesStartPos=null}}handleTransactionStop(){const t=this;t.hasChanges&&t.finalizeTransaction(t._currentStmTransaction),t._currentTransactionDescription=null,t._currentStmTransaction=null,t._remoteActionRanges=[],t.triggerTransactionChange()}excludeRanges(t,i){let s=[],n=0;for(const{start:r,end:a}of i)s=s.concat(t.slice(n,r)),n=a;return s.concat(t.slice(n))}finalizeTransaction(t){const i=this;i.endCurrentRemoteActionRange();const s=i.excludeRanges(t.queue,i._remoteActionRanges);if(s.length===0)return;const n=({model:c})=>c.$entityName,r=ht.groupBy(s,"type"),a=[];for(const c of["UpdateAction","EventUpdateAction"]){const d=ht.groupBy(r[c]||[],n);for(const u of Object.values(d))a.push(i.getUpdateAction(u))}for(const{modelList:c,isInitialUserAction:d}of r.RemoveAction||[])for(const u of c)a.push(new ye({actionType:"remove",entity:i.getEntityDescriptor(u),isInitialUserAction:d}));for(const{childModels:c}of r.RemoveChildAction||[])for(const d of c)a.push(new ye({actionType:"remove",entity:i.getEntityDescriptor(d)}));for(const{modelList:c}of r.AddAction||[])for(const d of c)a.push(new ye({actionType:"add",entity:i.getEntityDescriptor(d)}));for(const{childModels:c,parentModel:d,context:u,insertIndex:h}of r.InsertChildAction||[])for(const f of c){const p=u.get(f);p!=null?a.push(new So({actionType:"move",entity:i.getEntityDescriptor(f),from:{parent:i.getEntityDescriptor(p.parent),index:p.index},to:{parent:i.getEntityDescriptor(d),index:h}})):a.push(new ye({actionType:"add",entity:i.getEntityDescriptor(f)}))}const l=new i.transactionModelClass({description:i._currentTransactionDescription,actions:a,occurredAt:i._transactionStart});i.changeStore.add(l)}set transactionDescription(t){this._currentTransactionDescription=t}get hasChanges(){var t,i;return((t=this._currentStmTransaction)===null||t===void 0||(i=t.queue)===null||i===void 0?void 0:i.length)>0}get hasUnattachedTransactions(){return this.changeStore.find(t=>t.versionId==null)}get isComparing(){return this._comparingVersionId!=null}}B(Cn,"$name","Versions"),B(Cn,"configurable",{versionModelClass:jt,transactionModelClass:at,autoSaveInterval:"hourly",knownBaseTypes:[rt,mn,oi],versionContentLoadTimeout:6e4}),Cn._$name="Versions",De.registerFeature(Cn,!1,"SchedulerPro");const pr=(o,e,t)=>{const i=t.getFieldDefinition(o),{dataSource:s}=i,n=t.constructor.processField(o,e[s],t);return s in e&&!i.isEqual(n,t[o])};var ic=o=>class extends(o||de){startConfigure(t){this.getConfig("project"),super.startConfigure(t)}beforeApplyProjectChanges(){const{stm:t}=this;let i=!1;return this.suspendChangesTracking(),t.enabled&&(i=!0,t.isRecording&&t.stash(),this.ignoreRemoteChangesInSTM?t.disable():t.startTransaction()),i}async applyProjectChanges(t){var n,r;const i=this,s=i.beforeApplyProjectChanges();i.applyingChangeset=!0,t.project&&i.applyProjectResponse(t.project),i.applyChangeset(K.clone(t),(a,l)=>{if(l.id==="tasks"||l.id==="events"){const{modelClass:c}=l,d=c.getFieldDataSource("startDate"),u=c.getFieldDataSource("endDate");if(a.updated)for(const h of a.updated){const f=l.getById(h[c.idField]);pr("constraintType",h,f)||pr("constraintDate",h,f)||(delete h[d],delete h[u])}}}),await i.commitAsync(),i.commitRespondedChanges();for(const a in t){const l=i.getStoreDescriptor(a);if(l){const{store:c}=l,d=t[a],u=[...(n=d.updated)!=null?n:[],...(r=d.added)!=null?r:[]];if(c)for(const h of u){const f=c.getById(h[c.modelClass.idField]);if(f)for(const p in f.modifications)pr(p,h,f)||delete f.meta.modified[p]}}}i.afterApplyProjectChanges(s),i.applyingChangeset=!1,await i.commitAsync()}afterApplyProjectChanges(t){if(t){const{stm:i}=this;this.ignoreRemoteChangesInSTM?i.enable():i.stopTransaction(),i.applyStash()}this.resumeChangesTracking()}},sc=o=>{var e;return e=class extends(o||de){doDestroy(){var i;(i=this.websocketManager)===null||i===void 0||i.destroy(),super.doDestroy()}updateWsAddress(i){var s;const n=this;(s=n.websocketManager)===null||s===void 0||s.destroy(),i&&(n.websocketManager=new fl({address:i,userName:n.wsUserName,internalListeners:{message:"handleWebsocketMessage",close:"handleWebsocketClose",error:"handleWebsocketError",thisObj:n}}),n.wsAutoLoad&&n.wsLoad()),n.toggleAutoSyncListener()}toggleAutoSyncListener(){const i=this;i.detachListeners("websocketlisteners"),i._wsAutoSync&&i._wsAddress&&i.ion({name:"websocketlisteners",hasChanges:"scheduleWebsocketMessage"})}updateWsAutoSync(){this.toggleAutoSyncListener()}updateWsProjectId(i){i!=null&&this.wsAutoLoad&&this.wsLoad()}scheduleWebsocketMessage(){const i=this;!i.hasTimeout("wsAutoSync")&&!i.isAutoSyncSuspended&&i.setTimeout({name:"wsAutoSync",fn:()=>{i.wsSync()},delay:i.autoSyncTimeout})}resumeAutoSync(i=!0){super.resumeAutoSync(i),this.websocketManager&&!this.isAutoSyncSuspended&&this.changes&&this.wsSync()}async wsSend(i,s,n=!1){return await this.wsOpen()?(this.websocketManager.send(i,s),n||this.trigger("wsSendMessage",{command:i,data:s}),!0):!1}wsReceive(i){}handleWebsocketClose(){this.trigger("wsClose")}handleWebsocketError({error:i}){this.trigger("wsError",{error:i})}async handleWebsocketMessage({data:i}){const s=this,{wsProjectId:n}=s,{project:r}=i;if(s.trigger("wsMessage",{data:i}),r===n&&i.command==="projectChange")s.trigger("wsBeforeReceiveChanges"),await s.applyProjectChanges(i.changes),s.trigger("wsReceiveChanges");else if(r===n&&i.command==="dataset")await s.loadInlineData(i.dataset),s.trigger("wsReceiveDataset");else if(r===n&&i.command==="versionAutoSaveOK")s.trigger("wsVersionAutoSaveOK");else if(r===n&&i.command==="loadVersionContent"){const{versionId:a,project:l,content:c}=i;s.trigger("loadVersionContent",{versionId:a,project:l,content:c})}else s.wsReceive(i)}async wsOpen(){const{websocketManager:i}=this;return i?(!i.isOpened&&await i.open()&&this.trigger("wsOpen"),i.isOpened):!1}async wsLoad(){const i=this;i.wsProjectId!=null&&(await i.wsSend("dataset",{project:i.wsProjectId}),await new Promise(s=>{const n=i.ion({wsReceiveDataset(){n(),s(!0)},expires:{delay:i.wsConnectionTimeout,alt:()=>{n(),s(!1)}}})}),await i.commitAsync(),i.trigger("wsLoad"))}async wsSync(){const i=this,{wsProjectId:s}=i;if(s==null)return;await this.commitAsync();const{changes:n}=this;n&&i.wsAutoSync&&!i.autoSyncSuspendCounter&&(i.acceptChanges(),await i.wsSend("projectChange",{project:s,changes:n})&&i.trigger("wsSendChanges"))}wsClose(){var i;(i=this.websocketManager)===null||i===void 0||i.close()}},B(e,"configurable",{wsAddress:null,wsUserName:"",wsAutoLoad:!0,wsAutoSync:!0,wsConnectionTimeout:6e4,wsProjectId:null}),e},rc=o=>{var e;return e=class extends(o||de){static get $name(){return"ProjectProgressMixin"}updateProject(i,s){super.updateProject(i,s),this.setupProgressListener(),this.detachListeners("delayedCalculation"),i!=null&&i.delayCalculation&&i.ion({name:"delayedCalculation",delayCalculationStart:"internalOnProjectDelayCalculationStart",delayCalculationEnd:"internalOnProjectDelayCalculationEnd",thisObj:this})}setupProgressListener(){const i=this;if(i.detachListeners("projectProgress"),i.projectProgressReporting){var s;(s=i.project)===null||s===void 0||s.ion({name:"projectProgress",progress:"onProjectProgress",thisObj:i})}}updateProjectProgressReporting(){this.isConfiguring||this.setupProgressListener()}onProjectProgress({total:i,remaining:s,phase:n="propagating"}){const r=this;if(!r.isPainted||i<r.projectProgressThreshold)return;let a=r.projectProgressReporting;if(a==="auto"&&(a=r.project.delayCalculation?"progressbar":"mask"),a==="progressbar"){let l=r.calculationProgressElement;l||(l=r.calculationProgressElement=Vt.createElement({parent:r.timeAxisSubGrid.header.element,retainElement:!0,className:"b-calculation-progress-wrap",children:[{className:"b-calculation-progress"}]})),l.firstElementChild.style.width=`${(i-s)/i*100}%`,i>0&&s===0?r.calculationProgressTimeout=r.setTimeout(()=>{var c;(c=l)===null||c===void 0||c.remove(),r.calculationProgressElement=null},50):r.clearTimeout(r.calculationProgressTimeout)}else{const l=r.L(`L{SchedulerProBase.${n}}`),c=i?`${l} ${Math.round(100*(i-s)/i)}%`:l;r.masked||r.mask({maxProgress:i,useTransition:!1,text:c}),r.masked.text=c,i&&(r.masked.maxProgress=i,r.masked.progress=i-s),i>0&&s===0&&r.unmask()}}internalOnProjectDelayCalculationStart(){this.readOnly||(this.$delayCalculationReadOnly=this.readOnly=!0)}internalOnProjectDelayCalculationEnd(){this.$delayCalculationReadOnly&&(this.$delayCalculationReadOnly=this.readOnly=!1)}get widgetClass(){}},B(e,"configurable",{projectProgressReporting:"auto",projectProgressThreshold:5e3}),e};class Dn extends Er{static get $name(){return"SchedulingIssueResolutionPopup"}static get type(){return"schedulingissueresolutionpopup"}static get configurable(){return{localizableProperties:[],schedulingIssue:null,align:"b-t",autoShow:!1,autoClose:!1,closeAction:"onCloseButtonClick",modal:!0,centered:!0,scrollAction:"realign",constrainTo:globalThis,draggable:!1,closable:!0,floating:!0,cls:"b-schedulerpro-issueresolutionpopup",layout:"vbox",resolutionsGroup:{type:"radiogroup",name:"resolutions"},items:{description:{type:"widget",cls:"b-error-description",weight:-100}},bbar:{defaults:{localeClass:this},items:{applyButton:{weight:100,color:"b-raised b-blue",text:"L{Apply}",onClick:"up.onApplyButtonClick",disabled:!0},cancelButton:{weight:200,color:"b-gray",text:"L{Object.Cancel}",onClick:"up.onCancelButtonClick"}}}}}get selectedResolutions(){var e,t;const i=new Set,s=(e=this.resolutionsGroup)===null||e===void 0||(t=e.selected)===null||t===void 0?void 0:t.resolution;return s&&i.add(s),i}changeResolutionsGroup(e,t){return pl.reconfigure(t,e,this)}updateResolutionsGroup(e){e&&this.add(e)}getResolutionParameters(e){return[]}onApplyButtonClick(){const e=this,{selectedResolutions:t}=e;t.size?(t.forEach(i=>i.resolve(...e.getResolutionParameters(i))),e.continueWithResolutionResult(me.Resume),e.doResolve(t)):e.onCancelButtonClick()}onCancelButtonClick(){this.continueWithResolutionResult(me.Cancel),this.doResolve()}onCloseButtonClick(){this.canCancel&&this.onCancelButtonClick()}get isResolving(){return!!this.resolving}async resolve({source:e,schedulingIssue:t,continueWithResolutionResult:i}){const s=this;return s.project=e,s.schedulingIssue=t,s.continueWithResolutionResult=i,s.updatePopupContent(t,i),s.onResolutionChange({}),s.show(),s.resolving=new al,s.resolving.promise}doResolve(e){const t=this,{resolving:i}=t;i&&(t.resolving.resolve(e),t.resolving=null,t.schedulingIssue=null,t.hide())}getResolutionWidgetConfig(e){return{text:Wt.encodeHtml(e.getDescription()),cls:"b-resolution",checkedValue:e.$$name,localeClass:this,name:"resolutions",internalListeners:{change:"up.onResolutionChange"},resolution:e}}getResolutions(){var e;return(e=this.schedulingIssue)===null||e===void 0?void 0:e.getResolutions()}updatePopupContent(e,t){var i,s;const n=this,{resolutionsGroup:r}=n;t&&(n.continueWithResolutionResult=t),e?n.schedulingIssue=e:e=n.schedulingIssue,n.title=(i=e)!==null&&i!==void 0&&i.type?n.optionalL(e.type):"Unknown error",n.widgetMap.description.content=e&&Wt.encodeHtml(e.getDescription());const a=n.getResolutions(),l=(a==null?void 0:a.map(d=>n.getResolutionWidgetConfig(d)))||[],c=((s=l[0])===null||s===void 0?void 0:s.name)||"resolutions";r.removeAll(),r.name=c,r.add(...l,{ref:"cancelResolution",text:"L{Cancel changes}",name:c,checkedValue:"cancel",localeClass:this,cls:"b-resolution",internalListeners:{change:"up.onResolutionChange"}}),n.toggleControlsState()}get canApply(){return this.resolutionsGroup.value!=null}get canCancel(){var e;return!((e=this.project)!==null&&e!==void 0&&e.isInitialCommit)}get cancelResolution(){return this.resolutionsGroup.widgetMap.cancelResolution}onResolutionChange(){this.toggleControlsState()}toggleControlsState(){const e=this,{applyButton:t,cancelButton:i}=e.widgetMap;t.disabled=!e.canApply,e.cancelResolution.hidden=i.hidden=!e.canCancel}updateLocalization(){this.updatePopupContent(),super.updateLocalization()}}Dn.initClass(),Dn._$name="SchedulingIssueResolutionPopup";class pi extends Dn{static get $name(){return"CycleResolutionPopup"}static get type(){return"cycleresolutionpopup"}getDependencyTitle(e){return`"${Wt.encodeHtml(e.fromEvent.name)}" -> "${Wt.encodeHtml(e.toEvent.name)}"`}getResolutionWidgetConfig(e){const{dependency:t}=e,i=this.schedulingIssue.getInvalidDependencies(),s=super.getResolutionWidgetConfig(e);return i.includes(t)&&Object.assign(s,{name:"dependency-resolution",checked:!this._dependencyResolutionsChecked++}),s}getResolutions(){const{schedulingIssue:e}=this,t=e==null?void 0:e.getInvalidDependencies();let i=e==null?void 0:e.getResolutions();return i&&t.length&&(i=i.filter(s=>s.dependency&&t.includes(s.dependency))),i}updatePopupContent(e,t){const i=this,{invalidDependenciesDescription:s,dependencyField:n}=i.widgetMap;if(i._dependencyResolutionsChecked=0,super.updatePopupContent(...arguments),s==null||s.hide(),n==null||n.hide(),e=i.schedulingIssue,e){const r=e.getDependencies(),a=e.getInvalidDependencies(),l=r.filter(c=>!a.includes(c));if(a.length)s?s.show():i.add({type:"widget",ref:"invalidDependenciesDescription",weight:-50,width:"100%",cls:"b-invalid-dependencies-description",html:i.L("L{invalidDependencyLabel}")});else{const c=l==null?void 0:l.map(d=>({value:d.id,text:i.getDependencyTitle(d)}));n?(n.value=null,n.items=c,n.show()):i.add({type:"combo",ref:"dependencyField",weight:50,width:"100%",name:"dependency",label:i.L("L{dependencyLabel}"),labelPosition:"above",cls:"b-dependency-field",items:c,internalListeners:{change:"up.onDependencyChange"}})}}}get canApply(){const{widgetMap:e}=this;return super.canApply&&(e.cancelResolution.checked||!e.dependencyField||e.dependencyField.value)}onDependencyChange(){this.toggleControlsState()}getResolutionParameters(e){if(e.isRemoveDependencyCycleEffectResolution||e.isDeactivateDependencyCycleEffectResolution){const t=this.widgetMap.dependencyField.value;return[this.project.dependencyStore.getById(t)]}return super.getResolutionParameters(e)}}pi.initClass(),pi._$name="CycleResolutionPopup";var ac=o=>class extends(o||de){static get $name(){return"SchedulingIssueResolution"}static get configurable(){return{schedulingIssueResolutionPopupClass:Dn,cycleResolutionPopupClass:pi,displaySchedulingIssueResolutionPopup:!0}}updateProject(t,i){super.updateProject(t,i),this.unbindSchedulingIssueResolutionFromProject(i),this.displaySchedulingIssueResolutionPopup&&t&&this.bindSchedulingIssueResolutionToProject(t)}bindSchedulingIssueResolutionToProject(t){t.ion({name:"schedulingIssueResolution",schedulingConflict:"onProjectSchedulingIssueEvent",emptyCalendar:"onProjectSchedulingIssueEvent",cycle:"onProjectSchedulingIssueEvent",thisObj:this})}get isResolving(){var t;return(t=this._lastSchedulingIssueResolutionPopup)===null||t===void 0?void 0:t.isResolving}get activeSchedulingIssueResolutionPopup(){return this.isResolving&&this._lastSchedulingIssueResolutionPopup}unbindSchedulingIssueResolutionFromProject(t){this.detachListeners("schedulingIssueResolution")}getSchedulingIssueResolutionPopup(t){return t.type==="cycle"?this._cycleResolutionPopup||(this._cycleResolutionPopup=new this.cycleResolutionPopupClass({rootElement:this.rootElement})):this._schedulingIssueResolutionPopup||(this._schedulingIssueResolutionPopup=new this.schedulingIssueResolutionPopupClass({rootElement:this.rootElement}))}onProjectSchedulingIssueEvent({schedulingIssue:t}){const i=this.getSchedulingIssueResolutionPopup(t);this._lastSchedulingIssueResolutionPopup=i,i.resolve(...arguments)}get widgetClass(){}};export{lr as AdvancedTab,co as AssignmentAllocationInterval,rt as AssignmentModel,Hs as AssignmentStore,si as BaseAllocationInfo,ii as BaseAllocationInterval,Un as BaseAssignmentMixin,$t as BaseCalendarMixin,Es as BaseDependencyMixin,ws as BaseDependencyResolution,cs as BaseEmptyCalendarEffectResolution,tt as BaseEventMixin,Cs as BaseHasAssignmentsMixin,Xn as BaseResourceMixin,gt as BreakCurrentStackExecution,J as CalculateProposed,Re as CalculatedValueGen,qi as CalculatedValueGenC,Dt as CalculatedValueSync,Hi as CalculatedValueSyncC,Ur as CalculationGen,Hr as CalculationSync,Us as CalendarField,qs as CalendarIntervalModel,ho as CalendarManagerStore,Ks as CalendarModel,xa as CanCombineCalendarsMixin,ye as ChangeLogAction,fi as ChangeLogAssignmentEntity,hi as ChangeLogDependencyEntity,ze as ChangeLogEntity,Ft as ChangeLogStore,at as ChangeLogTransactionModel,Fa as ChronoAbstractProjectMixin,fs as ChronoAssignmentStoreMixin,ps as ChronoCalendarManagerStoreMixin,gs as ChronoDependencyStoreMixin,Qn as ChronoEventStoreMixin,Bl as ChronoEventTreeStoreMixin,Zr as ChronoGraph,wt as ChronoModelFieldIdentifier,Wn as ChronoModelMixin,Vn as ChronoModelReferenceBucketFieldIdentifier,Jt as ChronoModelReferenceFieldIdentifier,fa as ChronoModelReferenceFieldQuark,os as ChronoPartOfProjectGenericMixin,Tt as ChronoPartOfProjectModelMixin,Ye as ChronoPartOfProjectStoreMixin,Ss as ChronoResourceStoreMixin,Sa as ChronoStoreMixin,kn as CommitZero,Fn as ComputationCycle,Pt as ConflictEffect,Da as ConflictEffectDescription,as as ConflictResolution,rs as ConflictSymbol,an as ConstrainedEarlyEventMixin,Rt as ConstraintInterval,Gn as ConstraintIntervalDescription,ar as ConstraintTypePicker,Tl as ContextGen,Rl as ContextSync,pt as CycleDescription,et as CycleEffect,$a as CycleEffectDescription,Ee as CycleResolution,$i as CycleResolutionInput,Gr as CycleResolutionInputChrono,pi as CycleResolutionPopup,us as CycleSymbol,Zn as DateConstraintInterval,Wa as DateConstraintIntervalDescription,zn as DateInterval,uo as DeactivateDependencyCycleEffectResolution,Rs as DeactivateDependencyResolution,on as DependencyConstraintInterval,Ga as DependencyConstraintIntervalDescription,mn as DependencyModel,fo as DependencyStore,di as DependencyTab,tr as DependencyTypePicker,Aa as DurationConverterMixin,k as DurationVar,va as EMPTY_INTERVAL,Fe as EarlyLateLazyness,yt as EdgeType,Qt as EdgeTypeNormal,Ke as EdgeTypePast,kt as EditorTab,W as Effect,me as EffectResolutionResult,Ys as EffortField,Z as EffortVar,tn as EmptyCalendarEffect,Ea as EmptyCalendarEffectDescription,ls as EmptyCalendarSymbol,Zs as EndDateField,R as EndDateVar,Ra as EngineReplica,hs as EngineRevision,Pa as EngineTransaction,Te as Entity,ea as EntityIdentifier,Yr as EntityMeta,vo as EventLoader,li as EventResize,go as EventSegmentModel,yn as EventSegmentResize,ot as EventSegments,Qs as EventUpdateAction,St as Field,ue as FieldIdentifier,ro as FixedDurationMixin,We as FormTab,L as Formula,Mn as FormulasCache,dr as GanttTaskEditor,er as GeneralTab,Sl as GetTransaction,qn as HasCalendarMixin,rn as HasChildrenMixin,Va as HasDateConstraintMixin,Ds as HasDependenciesMixin,ks as HasEffortMixin,Is as HasPercentDoneMixin,Lr as HasProposedNotPreviousValue,_r as HasProposedNotPreviousValueEffect,Vi as HasProposedNotPreviousValueSymbol,we as HasProposedValue,Br as HasProposedValueEffect,Li as HasProposedValueSymbol,Ls as HasSchedulingModeMixin,Jn as HasSubEventsMixin,re as Identifier,Ml as IdentifierC,ne as Instruction,Ln as IsChronoModelSymbol,Pe as Levels,Jr as Listener,qt as Meta,ga as MinimalChronoModelFieldIdentifierGen,pa as MinimalChronoModelFieldIdentifierSync,ma as MinimalChronoModelFieldVariable,ta as MinimalEntityIdentifier,Xi as MinimalFieldIdentifierGen,Xt as MinimalFieldIdentifierSync,Ji as MinimalFieldVariable,ua as MinimalReferenceBucketIdentifier,da as MinimalReferenceBucketQuark,aa as MinimalReferenceIdentifier,Je as ModelBucketField,ai as ModelCombo,_n as ModelField,Xe as ModelReferenceField,ft as NOT_VISITED,cr as NotesTab,Se as OnCycleAction,bl as OwnIdentifier,xi as OwnIdentifierSymbol,El as OwnQuark,Oi as OwnQuarkSymbol,he as PartOfProject,ci as PercentBar,po as PercentDoneMixin,sr as PredecessorsTab,On as PreviousValueOf,Ar as PreviousValueOfEffect,Bi as PreviousValueOfSymbol,ic as ProjectChangeHandlerMixin,Jl as ProjectCrudManager,rc as ProjectProgressMixin,sc as ProjectWebSocketHandlerMixin,qe as ProposedArgumentsOf,Nr as ProposedArgumentsOfEffect,Wi as ProposedArgumentsOfSymbol,A as ProposedOrPrevious,Ii as ProposedOrPreviousSymbol,V as ProposedOrPreviousValueOf,Vr as ProposedOrPreviousValueOfEffect,Ni as ProposedOrPreviousValueOfSymbol,kr as ProposedValueOf,Fr as ProposedValueOfEffect,_i as ProposedValueOfSymbol,jn as Quark,Kr as QuarkGen,Ct as QuarkSync,je as ReadMode,Xs as ReadyStatePropagator,Bt as RecurrenceTab,ts as ReferenceBucketField,ns as ReferenceBucketIdentifier,ca as ReferenceBucketQuark,Yi as ReferenceField,es as ReferenceIdentifier,He as Reject,mt as RejectEffect,Ut as RejectSymbol,Na as RemoveDateConstraintConflictResolution,Ta as RemoveDependencyCycleEffectResolution,Ps as RemoveDependencyResolution,Qi as Replica,Ws as ResourceAllocationEventRangeCalendar,oo as ResourceAllocationEventRangeCalendarIntervalMixin,lo as ResourceAllocationEventRangeCalendarIntervalStore,ri as ResourceAllocationInfo,zs as ResourceAllocationInterval,oi as ResourceModel,mo as ResourceStore,rr as ResourcesTab,An as Revision,Oa as SEDBackwardCycleResolutionContext,ys as SEDDispatcher,vs as SEDDispatcherIdentifier,Ma as SEDForwardCycleResolutionContext,ms as SEDGraphDescription,Ya as SEDWUDispatcher,eo as SEDWUDispatcherIdentifier,za as ScheduledByDependenciesEarlyEventMixin,hr as SchedulerAdvancedTab,Kn as SchedulerBasicEvent,Ba as SchedulerBasicProjectMixin,ur as SchedulerGeneralTab,Ts as SchedulerProAssignmentMixin,pn as SchedulerProCycleEffect,$s as SchedulerProDependencyMixin,ao as SchedulerProEvent,ti as SchedulerProHasAssignmentsMixin,Ql as SchedulerProProjectMixin,Gs as SchedulerProResourceMixin,fr as SchedulerTaskEditor,Zt as SchedulingIssueEffectResolution,ac as SchedulingIssueResolution,Dn as SchedulingIssueResolutionPopup,or as SchedulingModePicker,ha as Schema,Js as StartDateField,P as StartDateVar,yo as StateTrackingManager,ir as SuccessorsTab,xn as SynchronousCalculationStarted,ui as TaskEdit,vn as TaskEditorBase,O as TombStone,Ki as Transaction,Qr as TransactionCycleDetectionWalkContext,Mi as TransactionSymbol,Xr as TransactionWalkDepth,se as UnitsVar,Pl as UnsafePreviousValueOf,zr as UnsafePreviousValueOfEffect,Gi as UnsafePreviousValueOfSymbol,wl as UnsafeProposedOrPreviousValueOf,Wr as UnsafeProposedOrPreviousValueOfEffect,zi as UnsafeProposedOrPreviousValueOfSymbol,ba as Use24hrsEmptyCalendarEffectResolution,wa as Use8hrsEmptyCalendarEffectResolution,Ue as VISITED_TOPOLOGICALLY,Kt as Variable,Ui as VariableC,be as VariableInputState,Or as VariableWalkContext,jt as VersionModel,At as VersionStore,Cn as Versions,Ti as WalkContext,$r as WalkSource,gi as WalkState,xr as Write,Ai as WriteEffect,jr as WriteSeveral,ki as WriteSeveralEffect,Fi as WriteSeveralSymbol,ji as WriteSymbol,la as bucket,ia as build_proposed,D as calculate,La as calculateEffectiveEndDateConstraintInterval,_a as calculateEffectiveStartDateConstraintInterval,Zi as createEntityOnPrototype,Ir as cycleInfo,Ze as dateConverter,Ve as durationFormula,hn as effortFormula,Bs as endDateByEffortFormula,Ie as endDateFormula,Qe as ensureEntityOnPrototype,jl as entity,is as entityDecoratorBody,M as field,Ns as fixedDurationAndEffortSEDWUGraphDescription,so as fixedDurationSEDWUBackwardEffortDriven,io as fixedDurationSEDWUBackwardNonEffortDriven,no as fixedDurationSEDWUForwardEffortDriven,to as fixedDurationSEDWUForwardNonEffortDriven,Vs as fixedDurationSEDWUGraphDescription,te as generic_field,ya as getDecoratedModelFields,Nn as injectStaticFieldsProperty,Le as intersectIntervals,$n as isAtomicValue,bt as isSerializableEqual,S as model_field,E as prototypeValue,ra as reference,Tr as required,Ht as runGeneratorAsyncWithEffect,qr as runGeneratorSyncWithEffect,_s as startDateByEffortFormula,$e as startDateFormula,ge as throwUnknownIdentifier,Ot as unitsFormula,Cl as validateRequiredProperties,Ae as write};
//# sourceMappingURL=SchedulingIssueResolution.js.map
